<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover" />
<meta name="theme-color" content="#000000" />
<meta name="description" content="Sistema di gestione ordini per Break Billiard Club" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="manifest.json" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Caveat+Brush&family=Cherry+Cream+Soda&family=Dokdo&family=DynaPuff:wght@400..700&family=Indie+Flower&family=Irish+Grover&family=Knewave&family=Mountains+of+Christmas:wght@400;700&family=Permanent+Marker&family=Rampart+One&family=Rubik+Vinyl&family=Swanky+and+Moo+Moo&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<title>Break Orders — Completo v2.1 (14:44)</title>
<style>
  /* v2.1 - Tasti grandi su tablet */
  :root{--tempo-color:#008800}
  *{scroll-behavior:smooth}
  html{height:100%;overflow:hidden}
  body{
    font-family:Arial,Helvetica,sans-serif;
    margin:20px;padding-bottom:140px;
    background:#000 url("https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4") no-repeat center center fixed;
    background-size:cover;color:#fff;box-sizing:border-box;
    touch-action:manipulation;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
    position:fixed;width:100%;height:100%;overflow-y:auto;top:0;left:0
  }
  button{padding:12px;font-size:16px;cursor:pointer;border-radius:8px;border:1px solid #444;background:#000;color:#fff;touch-action:manipulation;transition:transform 0.2s ease,background 0.2s ease,box-shadow 0.2s ease}
  button:active{transform:scale(0.95);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
  
  /* Layout ordini salvati */
  #saved-orders{
    position:fixed;
    top:10px;
    left:10px;
    right:10px;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:0.5vw;
    z-index:999;
  }
  #saved-orders button{
    background:#000 !important;
    color:#fff !important;
    border-radius:8px !important;
    padding:1.5vh 0.5vw !important;
    font-size:clamp(10px, 2.5vw, 20px) !important;
    font-weight:700 !important;
    min-height:auto !important;
    box-sizing:border-box !important;
    line-height:1.2 !important;
    transition:transform 0.2s ease,background 0.2s ease,box-shadow 0.2s ease !important;
  }
  #saved-orders button:active{
    transform:scale(0.95) !important;
    box-shadow:0 4px 12px rgba(0,0,0,0.5) !important;
  }
  #saved-orders button.has-orders{
    background:#cc0000 !important;
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{box-shadow:0 0 0 0 rgba(204,0,0,0.7)}
    50%{box-shadow:0 0 0 8px rgba(204,0,0,0)}
  }
  
  /* Barra tavoli in basso */
  .tables-wrapper{position:fixed;bottom:0.5vh;left:0;right:0;padding:0.5vh 1vw;z-index:1000;background:rgba(0,0,0,0.06);box-sizing:border-box;max-height:65vh;overflow-y:auto}
  .tables-container{display:flex;flex-direction:column;gap:0.5vh}
  .utility-row{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5vw}
  .tables-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5vw}
  .tables-grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:0.5vw}
  button.table-btn{background:#000 !important;color:#fff !important;border-radius:8px !important;padding:1.5vh 0.5vw !important;font-size:clamp(10px, 2.5vw, 20px) !important;font-weight:700 !important;min-height:auto !important;box-sizing:border-box !important;line-height:1.2 !important;transition:transform 0.2s ease,background 0.2s ease,box-shadow 0.2s ease !important}
  button.table-btn:active{transform:scale(0.95) !important;box-shadow:0 4px 12px rgba(0,0,0,0.5) !important}
  button.table-btn.has-orders{background:#cc0000 !important}
  .utility-btn{padding:1.2vh 0.3vw;font-size:clamp(9px, 2vw, 14px);line-height:1.2;transition:transform 0.2s ease,background 0.2s ease}
  .utility-btn:active{transform:scale(0.95)}
  .popup{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;overflow:hidden;z-index:4000;opacity:0;transition:opacity 0.3s ease-in-out}
  .popup.show{display:flex;animation:fadeIn 0.3s ease-in-out forwards}
  .popup.hide{animation:fadeOut 0.3s ease-in-out forwards}
  .popup.fullscreen-popup{align-items:flex-start;justify-content:flex-start;background:#000}
  .popup-content{background:#000 url("https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4") no-repeat center center fixed;
background-size:cover;padding:18px;border-radius:8px;width:90vw;height:90vh;margin:0;box-sizing:border-box;color:#fff;border:2px solid #444;overflow:hidden;display:flex;flex-direction:column;transform:translateY(20px);opacity:0;transition:all 0.3s ease-in-out}
  .popup.show .popup-content{transform:translateY(0);opacity:1}
  .popup-content.fullscreen{width:100vw !important;height:100vh !important;padding:20px;border-radius:0;margin:0}
  .popup-content.fullscreen .popup-main{display:block !important;grid-template-columns:1fr !important;overflow-y:auto !important;height:100% !important}
  .popup-content.fullscreen .popup-column-left{display:none !important}
  .popup-content.fullscreen .popup-column{background:transparent !important;padding:0 !important;overflow-y:auto !important;height:100% !important}
  .popup-content.spesa-popup{width:90vw !important;height:90vh !important;padding:20px;border-radius:12px;display:flex;flex-direction:column}
  .popup-content.spesa-popup .popup-header{margin-bottom:15px}
  .popup-content.spesa-popup .popup-main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
  .hidden{display:none}
  .popup-header{display:flex;flex-direction:column;gap:10px;margin-bottom:15px}
  .popup-header h3{margin:0;text-align:center;font-size:20px}
  .popup-main{display:flex;flex-direction:column;gap:15px;flex:1;overflow:hidden}
  .popup-column{display:flex;flex-direction:column;overflow-y:auto;background:transparent;padding:0;border-radius:0;flex:1}
  .popup-column-left{display:flex;flex-direction:column;gap:10px;overflow:hidden}
  .categories-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .subcats-modifiers-wrapper{display:flex;flex-direction:column;gap:10px;overflow-y:auto;background:transparent;padding:0;border-radius:0;flex:1}
  .column-title{font-size:14px;font-weight:700;margin-bottom:10px;text-align:center;color:#fff}
  #categories{display:contents}
  #subcats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;overflow-y:auto;align-content:start}
  .cat-btn,.subcat-btn{color:#fff;border:none;border-radius:8px;padding:20px;font-size:16px;font-weight:700;width:100%;text-align:center;background:#000;transition:transform 0.2s ease,box-shadow 0.2s ease,filter 0.2s ease}
  .cat-btn:active,.subcat-btn:active{transform:scale(0.95);box-shadow:0 4px 12px rgba(0,0,0,0.4)}
  .cat-btn:hover,.subcat-btn:hover{filter:brightness(1.2)}
  .back-btn{background:#555;color:#fff;border:none;border-radius:6px;padding:10px;margin:4px 0;font-size:14px;grid-column:span 2;cursor:pointer}
  .cat-caffe{background:#888}.cat-spina{background:#ff8800}.cat-frigo{background:#0099ff}.cat-super{background:#aaaa00}.cat-snack{background:#ff0000}.cat-tempo{background:var(--tempo-color)}.cat-quote{background:#0000ff}.cat-cassa{background:#000;color:#fff}
  .modifiers{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:0}
  .modifiers button{background:#444;color:#fff;font-weight:700;padding:10px;border:none;border-radius:6px;cursor:pointer;width:100%}
  .list div{padding:6px;border-bottom:1px solid #666;cursor:pointer}
  #order-list{background:transparent;color:#fff;padding:0;border-radius:8px;flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
  .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:100%}
  .actions button{padding:20px;font-size:18px;text-transform:uppercase;font-weight:700}
  #tempo-pad,#cassa-pad{width:90%;margin:0 auto;align-self:center}
  .numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .numpad button{font-size:18px;padding:14px;border-radius:8px;background:var(--tempo-color);color:#fff;border:none;width:100%;box-sizing:border-box;font-weight:700}
  .tempo-display{width:100%;padding:10px;font-size:18px;text-align:right;margin-bottom:8px;background:#111;border:1px solid #333;color:#fff;border-radius:6px}
  .order-row{display:grid;grid-template-columns:3fr 1fr;align-items:center;padding:4px 0;border-bottom:1px solid #333;animation:slideUp 0.3s ease-out}
  .order-name{text-align:left}
  .order-price{text-align:right;font-weight:bold}
  .order-row:hover{background:rgba(255,255,255,0.05);cursor:pointer}
  /* Animazioni */
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes fadeOut{from{opacity:1}to{opacity:0}}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes scaleIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
  
  /* Popup conferma personalizzato */
  #confirm-popup{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:10000;opacity:0;transition:opacity 0.3s ease-in-out}
  #confirm-popup.show{display:flex;animation:fadeIn 0.3s ease-in-out forwards}
  #confirm-popup.hide{animation:fadeOut 0.3s ease-in-out forwards}
  .confirm-box{background:#000 url("https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4") no-repeat center center;background-size:cover;padding:24px;border-radius:10px;border:2px solid #444;color:#fff;text-align:center;width:90vw;max-width:500px;transform:scale(0.9);opacity:0;transition:all 0.3s ease-in-out}
  #confirm-popup.show .confirm-box{animation:scaleIn 0.3s ease-in-out forwards}
  .confirm-box h3{margin:0 0 16px 0;font-size:20px}
  .confirm-box p{margin:0 0 20px 0;font-size:16px}
  .confirm-buttons{display:flex;gap:10px;justify-content:center}
  .confirm-buttons button{padding:12px 24px;font-size:16px;border-radius:8px;cursor:pointer;border:none;font-weight:700;transition:transform 0.2s ease,background 0.2s ease}
  .confirm-buttons button:active{transform:scale(0.95)}
  .btn-confirm{background:#00aa00;color:#fff}
  .btn-confirm:hover{background:#00cc00}
  .btn-cancel{background:#aa0000;color:#fff}
  .btn-cancel:hover{background:#cc0000}
  /* Smartphone - Layout a due colonne mantenuto */
  @media(max-width:768px){
    .popup-content{width:100vw;height:100vh}
    .popup-content.spesa-popup{width:100vw !important;height:100vh !important;padding:10px !important;border-radius:0 !important}
    #saved-orders{left:10px;right:10px;gap:0.5vw;grid-template-columns:repeat(4,1fr)}
    #saved-orders button{padding:1vh 0.5vw !important;font-size:clamp(10px, 2.5vw, 13px) !important}
    .popup-content{padding:10px; overflow-y: auto; -webkit-overflow-scrolling: touch;}
    .popup-header{flex-direction:column;gap:8px;margin-bottom:10px}
    .popup-header h3{text-align:center;font-size:18px}
    .actions{justify-content:center;margin-bottom:8px}
    .actions button{font-size:11px;padding:6px 10px}
    .popup-main{flex-direction:column;gap:10px;overflow:hidden}
    .popup-column{padding:0;overflow-y:auto;flex:1}
    .popup-column-left{display:flex;flex-direction:column;overflow:hidden}
    .column-title{font-size:12px;margin-bottom:6px}
    .categories-grid{grid-template-columns:repeat(4,1fr);gap:5px}
    #subcats{display:grid;grid-template-columns:repeat(2,1fr);gap:5px}
    .cat-btn,.subcat-btn{padding:8px 4px;font-size:11px}
    .modifiers{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:0}
    .modifiers button{width:100%;padding:6px;font-size:11px}
    #order-list{font-size:13px}
    .order-row{padding:5px 0;font-size:13px}
    .numpad button{font-size:14px;padding:10px}
    .confirm-box{padding:20px}
    .refill-categories-grid{grid-template-columns:1fr !important;gap:10px !important;padding:10px !important}
    .refill-products-grid{grid-template-columns:1fr !important;gap:8px !important;padding:10px !important}
      }
  /* Telefoni piccoli */
  @media(max-width:480px){
    .actions button{font-size:10px;padding:5px 8px}
    .cat-btn,.subcat-btn{font-size:10px;padding:6px 2px}
    #saved-orders button{padding:1vh 1vw;font-size:clamp(10px, 2.5vw, 13px)}
  }
</style>
</head>
<body>
  <!-- Indicatore stato offline -->
  <div id="offline-indicator" style="display:none;position:fixed;top:5px;right:5px;background:#ff6600;color:#fff;padding:8px 12px;border-radius:6px;font-size:12px;font-weight:700;z-index:10000;box-shadow:0 2px 8px rgba(0,0,0,0.3)">
    📡 OFFLINE
  </div>
  
  <!-- Ordini salvati in alto a sinistra -->
  <div id="saved-orders"></div>
  
  <!-- Barra tavoli in basso -->
  <div class="tables-wrapper">
    <div class="tables-container" id="tables-container"></div>
  </div>

  <!-- Popup conferma personalizzato -->
  <div id="confirm-popup">
    <div class="confirm-box">
      <h3 id="confirm-title">Conferma</h3>
      <p id="confirm-message">Sei sicuro?</p>
      <div class="confirm-buttons">
        <button class="btn-confirm" id="confirm-ok">OK</button>
        <button class="btn-cancel" id="confirm-cancel">Annulla</button>
      </div>
    </div>
  </div>

  <div class="popup" id="popup" aria-modal="true" role="dialog">
    <div class="popup-content">
      <div class="popup-header">
        <h3 id="popup-title">Tavolo</h3>
        <div class="actions" id="actions"></div>
        <div class="categories-grid">
          <button class="cat-btn cat-caffe" data-cat="c1">CAFFE</button>
          <button class="cat-btn cat-spina" data-cat="c2">SPINA</button>
          <button class="cat-btn cat-frigo" data-cat="c3">FRIGO</button>
          <button class="cat-btn cat-super" data-cat="c4">SUPER</button>
          <button class="cat-btn cat-snack" data-cat="c5">SNACK</button>
          <button class="cat-btn cat-tempo" data-cat="c6">TEMPO</button>
          <button class="cat-btn cat-quote" data-cat="c7">QUOTE</button>
          <button class="cat-btn cat-cassa" data-cat="c8">CASSA</button>
        </div>
      </div>
      
      <div class="popup-main">
        <!-- Sottocategorie a tutto schermo -->
        <div id="subcats" aria-live="polite"></div>
        
        <!-- Tempo e Cassa pad -->
        <div id="tempo-pad" class="hidden" aria-hidden="true">
          <input id="tempo-display" class="tempo-display" readonly value="0" />
          <div class="numpad" id="tempo-numpad">
            <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button>
            <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button>
            <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button>
            <button data-key=".">.</button><button data-key="0">0</button><button id="tempo-ok">OK</button>
          </div>
        </div>
        <div id="cassa-pad" class="hidden" aria-hidden="true">
          <input id="cassa-display" class="tempo-display" readonly value="0" style="background:#000;color:#fff;border:1px solid #fff" />
          <div class="numpad" id="cassa-numpad" style="margin-bottom:10px">
            <button data-key="7" style="background:#000;color:#fff">7</button><button data-key="8" style="background:#000;color:#fff">8</button><button data-key="9" style="background:#000;color:#fff">9</button>
            <button data-key="4" style="background:#000;color:#fff">4</button><button data-key="5" style="background:#000;color:#fff">5</button><button data-key="6" style="background:#000;color:#fff">6</button>
            <button data-key="1" style="background:#000;color:#fff">1</button><button data-key="2" style="background:#000;color:#fff">2</button><button data-key="3" style="background:#000;color:#fff">3</button>
            <button data-key="." style="background:#000;color:#fff">.</button><button data-key="0" style="background:#000;color:#fff">0</button><button data-key="C" style="background:#aa0000;color:#fff">C</button>
          </div>
          <button id="cassa-entrata" style="background:#00aa00;color:#fff;width:100%;padding:14px;font-size:16px;font-weight:700;border:none;border-radius:8px;margin-bottom:8px;cursor:pointer">ENTRATA</button>
          <button id="cassa-uscita" style="background:#aa0000;color:#fff;width:100%;padding:14px;font-size:16px;font-weight:700;border:none;border-radius:8px;cursor:pointer">USCITA</button>
        </div>
        
        <!-- Modificatori in una riga da 5 -->
        <div class="modifiers" id="modifiers">
          <button data-mod="SR">SR</button><button data-mod="M">M</button><button data-mod="K">K</button>
          <button data-mod="S">S</button><button data-mod="GH">GH</button>
        </div>
        
        <!-- Ordini a tutto schermo -->
        <div class="popup-column">
          <div class="column-title">ORDINE</div>
          <div id="order-list" class="list" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== FIREBASE CONFIGURATION ========== */
// Configurazione Firebase per sincronizzazione in tempo reale
const firebaseConfig = {
  apiKey: "AIzaSyBZn0t52sJ4W7hsJEAPjaCpuOlR5al7hOU",
  authDomain: "breakcounter-6ecc0.firebaseapp.com",
  databaseURL: "https://breakcounter-6ecc0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "breakcounter-6ecc0",
  storageBucket: "breakcounter-6ecc0.firebasestorage.app",
  messagingSenderId: "1078008487853",
  appId: "1:1078008487853:web:7145962aa0bc1772ec8b24"
};

let firebaseApp = null;
let database = null;
let firebaseEnabled = false;
let isUpdatingFromFirebase = false; // Flag per evitare loop di aggiornamenti

// Inizializza Firebase
try {
  // Verifica se la configurazione è stata personalizzata
  if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseEnabled = true;
    console.log("✅ Firebase inizializzato correttamente");
  } else {
    console.warn("⚠️ Firebase non configurato. Usando solo localStorage locale.");
  }
} catch (e) {
  console.error("❌ Errore inizializzazione Firebase:", e);
  firebaseEnabled = false;
}

function openSelectColor(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli il colore testo per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const inputRow = document.createElement('div');
  inputRow.style.display = 'grid';
  inputRow.style.gridTemplateColumns = '1fr 1fr';
  inputRow.style.gap = '10px';
  inputRow.style.marginBottom = '15px';

  const colorInput = document.createElement('input');
  colorInput.type = 'color';
  const current = (fontSettings[category].color || '#ffffff');
  colorInput.value = current.startsWith('#') ? current : ('#' + current);
  colorInput.style.width = '100%';
  colorInput.style.height = '42px';
  colorInput.style.borderRadius = '8px';
  colorInput.style.border = '2px solid #444';
  colorInput.style.background = '#222';

  const hexInput = document.createElement('input');
  hexInput.type = 'text';
  hexInput.placeholder = 'es. 00ff00 o #00ff00';
  hexInput.value = current;
  hexInput.style.width = '100%';
  hexInput.style.padding = '10px';
  hexInput.style.fontSize = '16px';
  hexInput.style.border = '2px solid #444';
  hexInput.style.background = '#222';
  hexInput.style.color = '#fff';
  hexInput.style.borderRadius = '8px';

  colorInput.oninput = ()=> {
    hexInput.value = colorInput.value;
  };
  hexInput.oninput = ()=> {
    let v = hexInput.value.trim();
    if(!v) return;
    if(!v.startsWith('#')) v = '#' + v;
    if(/^#([0-9a-fA-F]{6})$/.test(v)){
      colorInput.value = v;
    }
  };

  inputRow.appendChild(colorInput);
  inputRow.appendChild(hexInput);
  orderList.appendChild(inputRow);

  const preview = document.createElement('div');
  preview.textContent = 'Anteprima Testo';
  preview.style.fontWeight = '700';
  preview.style.padding = '12px';
  preview.style.border = '2px solid #444';
  preview.style.borderRadius = '8px';
  preview.style.background = '#222';
  preview.style.color = current;
  orderList.appendChild(preview);

  const updatePreview = ()=> {
    const v = colorInput.value;
    preview.style.color = v;
  };
  colorInput.addEventListener('input', updatePreview);
  hexInput.addEventListener('input', updatePreview);

  actionsDiv.innerHTML = "";
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Salva Colore';
  saveBtn.onclick = ()=> {
    let v = hexInput.value.trim();
    if(!v.startsWith('#')) v = '#' + v;
    if(!/^#([0-9a-fA-F]{6})$/.test(v)){
      alert('Inserisci un colore esadecimale valido (es. 00ff00)');
      return;
    }
    fontSettings[category].color = v.toLowerCase();
    applyFont();
    saveData();
    openCustomizeFontSettings();
  };
  const backBtn = document.createElement('button');
  backBtn.textContent = 'Indietro';
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(saveBtn);
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = 'Seleziona Colore';
  showPopup();
}

function openSelectColorForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = 'Scegli il colore testo per TUTTE le categorie:';
  title.style.fontWeight = '700';
  title.style.fontSize = '18px';
  title.style.marginBottom = '15px';
  orderList.appendChild(title);

  const inputRow = document.createElement('div');
  inputRow.style.display = 'grid';
  inputRow.style.gridTemplateColumns = '1fr 1fr';
  inputRow.style.gap = '10px';
  inputRow.style.marginBottom = '15px';

  const colorInput = document.createElement('input');
  colorInput.type = 'color';
  colorInput.value = '#ffffff';
  colorInput.style.width = '100%';
  colorInput.style.height = '42px';
  colorInput.style.borderRadius = '8px';
  colorInput.style.border = '2px solid #444';
  colorInput.style.background = '#222';

  const hexInput = document.createElement('input');
  hexInput.type = 'text';
  hexInput.placeholder = 'es. 00ff00 o #00ff00';
  hexInput.value = '#ffffff';
  hexInput.style.width = '100%';
  hexInput.style.padding = '10px';
  hexInput.style.fontSize = '16px';
  hexInput.style.border = '2px solid #444';
  hexInput.style.background = '#222';
  hexInput.style.color = '#fff';
  hexInput.style.borderRadius = '8px';

  colorInput.oninput = ()=> {
    hexInput.value = colorInput.value;
  };
  hexInput.oninput = ()=> {
    let v = hexInput.value.trim();
    if(!v) return;
    if(!v.startsWith('#')) v = '#' + v;
    if(/^#([0-9a-fA-F]{6})$/.test(v)){
      colorInput.value = v;
    }
  };

  inputRow.appendChild(colorInput);
  inputRow.appendChild(hexInput);
  orderList.appendChild(inputRow);

  const preview = document.createElement('div');
  preview.textContent = 'Anteprima Testo';
  preview.style.fontWeight = '700';
  preview.style.padding = '12px';
  preview.style.border = '2px solid #444';
  preview.style.borderRadius = '8px';
  preview.style.background = '#222';
  preview.style.color = '#ffffff';
  orderList.appendChild(preview);

  const updatePreview = ()=> {
    const v = colorInput.value;
    preview.style.color = v;
  };
  colorInput.addEventListener('input', updatePreview);
  hexInput.addEventListener('input', updatePreview);

  actionsDiv.innerHTML = "";
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Salva Colore per Tutti';
  saveBtn.onclick = ()=> {
    let v = hexInput.value.trim();
    if(!v.startsWith('#')) v = '#' + v;
    if(!/^#([0-9a-fA-F]{6})$/.test(v)){
      alert('Inserisci un colore esadecimale valido (es. 00ff00)');
      return;
    }
    Object.keys(fontSettings).forEach(key => {
      fontSettings[key].color = v.toLowerCase();
    });
    applyFont();
    saveData();
    openCustomizeFontSettings();
  };
  const backBtn = document.createElement('button');
  backBtn.textContent = 'Indietro';
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(saveBtn);
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = 'Seleziona Colore (Tutti)';
  showPopup();
}
/* Popup conferma personalizzato */
function showConfirm(message, onConfirm, title = "Conferma", needsInput = false, inputCallback = null){
  const confirmPopup = document.getElementById('confirm-popup');
  const confirmTitle = document.getElementById('confirm-title');
  const confirmMessage = document.getElementById('confirm-message');
  const confirmOk = document.getElementById('confirm-ok');
  const confirmCancel = document.getElementById('confirm-cancel');
  
  confirmTitle.textContent = title;
  
  // Se serve input numerico, crea un campo input
  if(needsInput){
    confirmMessage.innerHTML = `
      <p style="margin-bottom:15px">${message}</p>
      <input type="number" id="confirm-input" min="2" max="10" value="" placeholder="2" 
        style="width:100%;padding:10px;font-size:18px;text-align:center;border:2px solid #444;background:#222;color:#fff;border-radius:8px">
    `;
    confirmCallback = ()=> {
      const input = document.getElementById('confirm-input');
      const value = parseInt(input.value);
      if(inputCallback && value >= 2) inputCallback(value);
    };
  } else {
    confirmMessage.textContent = message;
    confirmCallback = onConfirm;
  }
  
  confirmPopup.style.display = 'flex';
  // Force reflow per attivare l'animazione
  void confirmPopup.offsetWidth;
  confirmPopup.classList.add('show');
}

function hideConfirm(){
  const confirmPopup = document.getElementById('confirm-popup');
  confirmPopup.classList.remove('show');
  confirmPopup.classList.add('hide');
  setTimeout(() => {
    confirmPopup.style.display = 'none';
    confirmPopup.classList.remove('hide');
    confirmCallback = null;
  }, 300);
}

document.getElementById('confirm-ok').addEventListener('click', ()=>{
  if(confirmCallback) confirmCallback();
  hideConfirm();
});

document.getElementById('confirm-cancel').addEventListener('click', ()=>{
  hideConfirm();
});

/* stato */
const tableNames = ["TAV-1","TAV-2","TAV-3","TAV-4","TAV-5","TAV-6","TAV-7","TAV-8","TAV-9","TAV-10","TAV-11","TAV-12","BANCO","SALA","SALAF"];
let tableOrders = {}; // {index: [{name,qty,price,cat}, ...], ...}
let savedOrders = []; // {id, tableName, items: [...], consegnato: false, timestampDone: null}
let totals = {caffe:0,spina:0,frigo:0,super:0,snack:0,tempo:0,quote:0,cassa:0};
let currentTarget = {type:null, id:null};
let accontoMode = false;
let storico = [];
let evasiOrders = []; // ordini pagati che possono essere ripristinati
let refillList = {}; // {productName: quantity} - lista prodotti refill
let currentBackground = "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4";
let currentFont = "Arial, Helvetica, sans-serif";
let currentFontSize = 16; // dimensione base in px
let fontSettings = {
  utility: {font: "Arial, Helvetica, sans-serif", size: 20, padding: 20, color: "#ffffff"},
  tavoli: {font: "Arial, Helvetica, sans-serif", size: 24, padding: 21, color: "#ffffff"},
  ordiniSalvati: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 12, color: "#ffffff"},
  categorie: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 20, color: "#ffffff"},
  sottocategorie: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 20, color: "#ffffff"},
  modificatori: {font: "Arial, Helvetica, sans-serif", size: 14, padding: 10, color: "#ffffff"},
  azioni: {font: "Arial, Helvetica, sans-serif", size: 18, padding: 20, color: "#ffffff"},
  ordini: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 6, color: "#ffffff"},
  conferma: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 12, color: "#ffffff"},
  refill: {font: "Arial, Helvetica, sans-serif", size: 18, padding: 30, color: "#ffffff"}
};
let modifiersList = ["SR", "M", "K", "S", "GH"];
let subcategories = {
  "CAFFÈ CORRETTO": [{name:"GRAPPA",price:1.50},{name:"SAMBUCA",price:1.50},{name:"BAILEYS",price:1.50},{name:"PRUGNA",price:1.50}],
  "SPRITZ": [{name:"LISCIO",price:2.50},{name:"APEROL",price:3.00},{name:"CAMPARI",price:3.00},{name:"CYNAR",price:3.00}],
  "AMARO": [{name:"MONTENEGRO",price:3.00},{name:"JAGERMEISTER",price:3.00},{name:"CAPO",price:3.00},{name:"BRAULIO",price:3.00},{name:"BRANCAMENTA",price:3.00},{name:"PETRUS",price:3.00}],
  "GRAPPA": [{name:"BIANCA",price:3.00},{name:"24k",price:3.00},{name:"MIELE",price:3.00},{name:"CAMOMILLA",price:3.00},{name:"PRUGNA",price:3.00},{name:"MIRTILLO",price:3.00}],
  "COCKTAILS": [{name:"GIN TONIC",price:6.00},{name:"GIN TONIC H",price:8.00},{name:"GIN LEMON",price:6.00},{name:"GIN LEMON H",price:8.00},{name:"JACK COLA",price:8.00},{name:"RUM COLA",price:6.00},{name:"VODKA TONIC",price:6.00},{name:"JAGERBOMB",price:6.00},{name:"VODKA LEMON",price:6.00},{name:"AMERICANO",price:4.00}]
};

const tablesContainer = document.getElementById('tables-container');
const savedOrdersDiv = document.getElementById('saved-orders');
const popup = document.getElementById('popup');
const popupTitle = document.getElementById('popup-title');
const categoriesDiv = document.querySelector('.categories-grid');
const subcatsDiv = document.getElementById('subcats');
const tempoPad = document.getElementById('tempo-pad');
const tempoDisplay = document.getElementById('tempo-display');
const cassaPad = document.getElementById('cassa-pad');
const cassaDisplay = document.getElementById('cassa-display');
const modifiersDiv = document.getElementById('modifiers');
const actionsDiv = document.getElementById('actions');
const orderList = document.getElementById('order-list');

let tempoValue = "";
let cassaValue = "";
let confirmCallback = null;
let refillHistoryHandler = null; // intercetta il tasto back mentre il REFILL è aperto

function enableRefillHistoryTrap(){
  try{
    if(refillHistoryHandler) return;
    refillHistoryHandler = (e)=>{
      const overlay = document.getElementById('refill-overlay');
      if(overlay){
        if(e && e.preventDefault) e.preventDefault();
        // ripristina lo stato per evitare di uscire
        try { history.pushState({refill:true}, ''); } catch(_){ }
        overlay.remove();
      }
    };
    window.addEventListener('popstate', refillHistoryHandler);
    try { history.pushState({refill:true}, ''); } catch(_){ }
  }catch(err){ console.warn('enableRefillHistoryTrap error', err); }
}

function disableRefillHistoryTrap(){
  try{
    if(!refillHistoryHandler) return;
    window.removeEventListener('popstate', refillHistoryHandler);
    refillHistoryHandler = null;
  }catch(err){ console.warn('disableRefillHistoryTrap error', err); }
}

/* Funzioni helper per animazioni popup */
function showPopup(){
  popup.classList.remove('hide');
  popup.style.display = 'flex';
  // Force reflow per attivare l'animazione
  void popup.offsetWidth;
  popup.classList.add('show');
}

function hidePopup(callback){
  popup.classList.remove('show');
  popup.classList.add('hide');
  setTimeout(() => {
    popup.style.display = 'none';
    popup.classList.remove('hide');
    if(callback) callback();
  }, 300); // Durata dell'animazione
}

/* Funzione helper per vibrazione tattile */
function vibrate(pattern = [10]){
  if ('vibrate' in navigator) {
    try {
      navigator.vibrate(pattern);
    } catch(e) {
      console.log('Vibration not supported:', e);
    }
  }
}

// Pattern di vibrazione predefiniti
const VIBRATION_PATTERNS = {
  tap: [10],           // Tap leggero
  click: [20],         // Click normale
  success: [30, 50, 30], // Successo (doppio tap)
  error: [100],        // Errore (vibrazione lunga)
  warning: [50, 30, 50], // Avviso
  longPress: [50]      // Pressione lunga
};

function saveData(){
  try{
    // Dati da sincronizzare su Firebase (ordini + nomi tavoli)
    const firebaseData = {
      tableOrders, 
      savedOrders, 
      totals, 
      storico, 
      evasiOrders,
      refillList,
      tableNames
    };
    
    // Dati completi da salvare in localStorage (ordini + impostazioni)
    const localData = {
      tableOrders, savedOrders, totals, tableNames, storico, evasiOrders, refillList,
      currentBackground, currentFont, currentFontSize, fontSettings, 
      modifiersList, subcategories
    };
    
    // Salva sempre in localStorage come backup
    localStorage.setItem('breakOrdersState', JSON.stringify(localData));
    
    // Se Firebase è abilitato, sincronizza SOLO gli ordini
    if (firebaseEnabled && database && !isUpdatingFromFirebase) {
      database.ref('breakOrders').set(firebaseData).catch(err => {
        console.error("Errore salvataggio Firebase:", err);
      });
    }
  }catch(e){ 
    console.error("Errore saveData:", e);
  }
}
function loadData(){
  try{
    const raw = localStorage.getItem('breakOrdersState');
    if(!raw) return;
    const parsed = JSON.parse(raw);
    applyParsedData(parsed);
  }catch(e){ 
    console.error("Errore loadData:", e);
  }
}

// Funzione helper per applicare i dati parsati
function applyParsedData(parsed, fromFirebase = false){
  if(!parsed) return;
  
  tableOrders = parsed.tableOrders || {};
  // normalize savedOrders to {id,tableName,items,consegnato}
  if(Array.isArray(parsed.savedOrders)){
    savedOrders = parsed.savedOrders.map(s=>{
      if(!s) return null;
      const id = s.id || s.name || (Date.now().toString(36)+Math.random().toString(36).slice(2,6));
      const tableName = s.tableName || s.name || s.table || "Riepilogo";
      const items = s.items || s.itemsList || [];
      const consegnato = s.consegnato || false;
      const timestampDone = s.timestampDone || null;
      return { id, tableName, items, consegnato, timestampDone };
    }).filter(Boolean);
  } else savedOrders = [];
  totals = parsed.totals || totals;
  // Assicura che tutte le categorie esistano
  if(!totals.cassa) totals.cassa = 0;
  storico = parsed.storico || parsed.storicoList || [];
  evasiOrders = parsed.evasiOrders || [];
  
  // RefillList: se arriva da Firebase e ha dati, usalo; altrimenti mantieni quello locale
  if(parsed.refillList && Object.keys(parsed.refillList).length > 0){
    refillList = parsed.refillList;
  } else if(!fromFirebase){
    refillList = parsed.refillList || {};
  }
  // Se fromFirebase è true e refillList è vuoto, non fare nulla (mantieni quello locale)
  
  // Sincronizza tableNames da Firebase
  if(parsed.tableNames) tableNames.splice(0, tableNames.length, ...parsed.tableNames);
  
  // Carica impostazioni SOLO da localStorage, NON da Firebase
  if(!fromFirebase){
    currentBackground = parsed.currentBackground || currentBackground;
    currentFont = parsed.currentFont || currentFont;
    currentFontSize = parsed.currentFontSize || currentFontSize;
    
    // Carica fontSettings e assicura che tutte le nuove categorie esistano
    if(parsed.fontSettings){
      fontSettings = parsed.fontSettings;
      // Aggiungi le nuove categorie se mancano
      if(!fontSettings.utility){
        fontSettings.utility = {font: "Arial, Helvetica, sans-serif", size: 20, padding: 20, color: "#ffffff"};
      }
      if(!fontSettings.ordiniSalvati){
        fontSettings.ordiniSalvati = {font: "Arial, Helvetica, sans-serif", size: 16, padding: 12, color: "#ffffff"};
      }
    }
    
    modifiersList = parsed.modifiersList || modifiersList;
    subcategories = parsed.subcategories || subcategories;
    if(parsed.tableNames) tableNames.splice(0, tableNames.length, ...parsed.tableNames);
    applyBackground();
    applyFont();
    renderModifiers();
  }
}

// Setup Firebase Real-time Sync
function setupFirebaseSync(){
  if(!firebaseEnabled || !database) return;
  
  console.log("🔄 Attivazione sincronizzazione Firebase...");
  
  // Listener per aggiornamenti in tempo reale
  database.ref('breakOrders').on('value', (snapshot) => {
    const data = snapshot.val();
    if(data){
      console.log("📥 Ricevuti dati da Firebase");
      isUpdatingFromFirebase = true;
      applyParsedData(data, true); // true = da Firebase, non caricare impostazioni
      renderTables();
      renderSavedButtons();
      isUpdatingFromFirebase = false;
    }
  }, (error) => {
    console.error("❌ Errore listener Firebase:", error);
  });
  
  // Carica i dati iniziali da Firebase
  database.ref('breakOrders').once('value').then((snapshot) => {
    const data = snapshot.val();
    if(data){
      console.log("📥 Caricamento iniziale da Firebase completato");
      isUpdatingFromFirebase = true;
      
      // Carica impostazioni locali PRIMA di applicare dati Firebase
      const localSettings = localStorage.getItem('breakOrdersState');
      if(localSettings){
        const parsed = JSON.parse(localSettings);
        applyParsedData(parsed, false); // Carica impostazioni locali
      }
      
      // Poi applica solo gli ordini da Firebase
      applyParsedData(data, true); // true = da Firebase, non caricare impostazioni
      renderTables();
      renderSavedButtons();
      isUpdatingFromFirebase = false;
    } else {
      console.log("📤 Nessun dato su Firebase, carico da localStorage");
      loadData();
      // Se c'è qualcosa in localStorage, sincronizza su Firebase
      const localData = localStorage.getItem('breakOrdersState');
      if(localData){
        saveData();
      }
    }
  }).catch((error) => {
    console.error("❌ Errore caricamento Firebase:", error);
    console.log("📂 Fallback a localStorage");
    loadData();
  });
}

/* catalogo */
const CATALOG = {
  c1: [ {name:"CAFFÈ LISCIO", price:1.00}, {name:"CAFFÈ DECA", price:1.00}, {name:"CAFFÈ CORRETTO", price:1.50} ],
  c2: [ {name:"PYRASER 0,3", price:3.50}, {name:"PYRASER 0,5", price:5.50}, {name:"ARIA 0,3", price:3.50}, {name:"ARIA 0,5", price:5.50}, {name:"GUINNESS 0,25", price:3.50}, {name:"GUINNESS 0,5", price:5.50}, {name:"SPRITZ", price:2.50} ],
  c3: [ {name:"ACQUA NATURALE", price:1.00}, {name:"ACQUA FRIZZANTE", price:1.00}, {name:"COCA COLA", price:2.50}, {name:"COCA ZERO", price:2.50}, {name:"TÈ LIMONE", price:2.50}, {name:"TÈ PESCA", price:2.50}, {name:"FANTA", price:2.50}, {name:"LEMON SODA", price:2.50}, {name:"RED BULL", price:2.50} ],
  c4: [ {name:"AMARO", price:3.00}, {name:"GRAPPA", price:3.00}, {name:"COCKTAILS", price:6.00}, {name:"BAILEYS", price:3.00}, {name:"JACK DANIELS", price:5.00}, {name:"TALISKER", price:5.00}, {name:"LIQUIRIZIA", price:3.00}, {name:"PRUGNA CM", price:3.00} ],
  c5: [ {name:"TOAST", price:6.50}, {name:"PIZZETTA", price:3.00}, {name:"HOT DOG", price:4.00} ],
  c6: null,
  c7: [ {name:"QUOTA SINGOLA", price:5.00} ],
  c8: null
};

/* render tavoli e saved */
function renderTables(){
  const container = document.getElementById('tables-container');
  container.innerHTML = "";
  
  // Riga 1: Totali, Storico, Evasi, Settings
  const utilityRow = document.createElement('div');
  utilityRow.className = "utility-row";
  
  const totBtn = document.createElement('button');
  totBtn.className = "utility-btn";
  totBtn.textContent = "TOTALI";
  totBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openTotals();
  };
  utilityRow.appendChild(totBtn);

  const storBtn = document.createElement('button');
  storBtn.className = "utility-btn";
  storBtn.textContent = "STORICO";
  storBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openStorico();
  };
  utilityRow.appendChild(storBtn);
  
  const evasiBtn = document.createElement('button');
  evasiBtn.className = "utility-btn";
  evasiBtn.textContent = "EVASI";
  evasiBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openEvasi();
  };
  utilityRow.appendChild(evasiBtn);
  
  const settingsBtn = document.createElement('button');
  settingsBtn.className = "utility-btn";
  settingsBtn.innerHTML = "&#9881;";
  settingsBtn.onclick = ()=> {
    console.log('⚙️ Settings button clicked');
    console.log('📱 Viewport:', window.innerWidth + 'x' + window.innerHeight);
    console.log('📱 User Agent:', navigator.userAgent);
    vibrate(VIBRATION_PATTERNS.tap);
    openSettings();
  };
  utilityRow.appendChild(settingsBtn);
  
  container.appendChild(utilityRow);
  
  // Riga 2: TAV-1, TAV-2, TAV-3, TAV-4
  const row1 = document.createElement('div');
  row1.className = "tables-grid";
  for(let i=1; i<=4; i++){
    const idx = tableNames.indexOf(`TAV-${i}`);
    if(idx !== -1){
      const b = document.createElement('button');
      b.className = "table-btn";
      // Aggiungi classe has-orders se il tavolo ha ordini o ordini salvati
      const tableName = `TAV-${i}`;
      // Rimuovo il comportamento rosso dai tavoli
      b.textContent = tableName;
      b.onclick = ()=> {
        vibrate(VIBRATION_PATTERNS.tap);
        openForTable(idx);
      };
      row1.appendChild(b);
    }
  }
  container.appendChild(row1);
  
  // Riga 3: TAV-5, TAV-6, TAV-7, TAV-8
  const row2 = document.createElement('div');
  row2.className = "tables-grid";
  for(let i=5; i<=8; i++){
    const idx = tableNames.indexOf(`TAV-${i}`);
    if(idx !== -1){
      const b = document.createElement('button');
      b.className = "table-btn";
      const tableName = `TAV-${i}`;
      // Rimuovo il comportamento rosso dai tavoli
      b.textContent = tableName;
      b.onclick = ()=> {
        vibrate(VIBRATION_PATTERNS.tap);
        openForTable(idx);
      };
      row2.appendChild(b);
    }
  }
  container.appendChild(row2);
  
  // Riga 4: TAV-9, TAV-10, TAV-11, TAV-12
  const row3 = document.createElement('div');
  row3.className = "tables-grid";
  for(let i=9; i<=12; i++){
    const idx = tableNames.indexOf(`TAV-${i}`);
    if(idx !== -1){
      const b = document.createElement('button');
      b.className = "table-btn";
      const tableName = `TAV-${i}`;
      // Rimuovo il comportamento rosso dai tavoli
      b.textContent = tableName;
      b.onclick = ()=> {
        vibrate(VIBRATION_PATTERNS.tap);
        openForTable(idx);
      };
      row3.appendChild(b);
    }
  }
  container.appendChild(row3);
  
  // Riga 5: BANCO, SALA, SALAF, +, REFILL, SPESA
  const row4 = document.createElement('div');
  row4.className = "tables-grid";
  
  const bancoIdx = tableNames.indexOf("BANCO");
  if(bancoIdx !== -1){
    const b = document.createElement('button');
    b.className = "table-btn";
    // Rimuovo il comportamento rosso dai tavoli
    b.textContent = "BANCO";
    b.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.tap);
      openForTable(bancoIdx);
    };
    row4.appendChild(b);
  }
  
  const salaIdx = tableNames.indexOf("SALA");
  if(salaIdx !== -1){
    const b = document.createElement('button');
    b.className = "table-btn";
    // Rimuovo il comportamento rosso dai tavoli
    b.textContent = "SALA";
    b.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.tap);
      openForTable(salaIdx);
    };
    row4.appendChild(b);
  }
  
  const salafIdx = tableNames.indexOf("SALAF");
  if(salafIdx !== -1){
    const b = document.createElement('button');
    b.className = "table-btn";
    // Rimuovo il comportamento rosso dai tavoli
    b.textContent = "SALAF";
    b.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.tap);
      openForTable(salafIdx);
    };
    row4.appendChild(b);
  }
  
  const plusBtn = document.createElement('button');
  plusBtn.className = "table-btn";
  // Rimuovo il comportamento rosso dal tasto +
  plusBtn.textContent = "+";
  plusBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomTablesPopup();
  };
  row4.appendChild(plusBtn);
  
  const refillBtn = document.createElement('button');
  refillBtn.className = "utility-btn";
  refillBtn.textContent = "REFILL";
  refillBtn.style.background = "#0099ff !important"; // Colore blu come categoria FRIGO
  refillBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openRefillSimple();
  };
  row4.appendChild(refillBtn);
  
  const spesaBtn = document.createElement('button');
  spesaBtn.className = "utility-btn";
  spesaBtn.textContent = "SPESA";
  spesaBtn.style.background = "#00aa00 !important"; // Colore verde
  spesaBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openSpesaPopup();
  };
  row4.appendChild(spesaBtn);
  
  
  container.appendChild(row4);
}

function renderSavedButtons(){
  // Ordini salvati in griglia 4x4
  savedOrdersDiv.innerHTML = "";
  savedOrders.forEach(s=>{
    const b = document.createElement('button');
    // Diventa rosso se ha prodotti e non è stato consegnato
    if(s.items && s.items.length > 0 && !s.consegnato) {
      b.classList.add('has-orders');
    }
    b.textContent = s.tableName;
    
    let pressTimer;
    
    // Click normale = apri ordine
    b.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.tap);
      openForSaved(s.id);
    };
    
    // Pressione lunga = rinomina ordine
    b.addEventListener('touchstart', (e) => {
      pressTimer = setTimeout(() => {
        const newName = prompt("Nuovo nome per l'ordine:", s.tableName);
        if(newName && newName.trim()){
          s.tableName = newName.trim();
          saveData();
          renderSavedButtons();
        }
      }, 800);
    });
    
    b.addEventListener('touchend', () => {
      clearTimeout(pressTimer);
    });
    
    b.addEventListener('touchmove', () => {
      clearTimeout(pressTimer);
    });
    
    // Supporto mouse per desktop
    b.addEventListener('mousedown', () => {
      pressTimer = setTimeout(() => {
        const newName = prompt("Nuovo nome per l'ordine:", s.tableName);
        if(newName && newName.trim()){
          s.tableName = newName.trim();
          saveData();
          renderSavedButtons();
        }
      }, 800);
    });
    
    b.addEventListener('mouseup', () => {
      clearTimeout(pressTimer);
    });
    
    b.addEventListener('mouseleave', () => {
      clearTimeout(pressTimer);
    });
    
    savedOrdersDiv.appendChild(b);
  });
}

/* Popup Refill - Versione Semplice */
function openRefillSimple(){
  currentTarget = {type:null, id:null};
  
  // Setup popup come SPESA
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  popupTitle.textContent = "REFILL - Seleziona Categoria";
  orderList.innerHTML = "";
  
  // Crea lista semplice delle categorie
  const categories = [
    { key: 'c1', name: 'CAFFÈ', color: '#888' },
    { key: 'c2', name: 'SPINA', color: '#ff8800' },
    { key: 'c3', name: 'FRIGO', color: '#0099ff' },
    { key: 'c4', name: 'SUPER', color: '#aaaa00' },
    { key: 'c5', name: 'SNACK', color: '#ff0000' },
    { key: 'manutenzione', name: 'MANUTENZIONE', color: '#8800aa' }
  ];
  
  // Container per centrare i bottoni
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.padding = '10px';
  
  categories.forEach(cat => {
    const div = document.createElement('div');
    console.log(`🔄 Creando bottone REFILL ${cat.name} con:`, {
      font: fontSettings.refill.font,
      size: fontSettings.refill.size,
      color: fontSettings.refill.color,
      padding: fontSettings.refill.padding
    });
    div.style.width = '50%';
    div.style.padding = fontSettings.refill.padding + 'px';
    div.style.margin = '5px 0';
    div.style.background = cat.color;
    div.style.borderRadius = '8px';
    div.style.cursor = 'pointer';
    div.style.textAlign = 'center';
    div.style.fontWeight = '700';
    div.style.fontSize = fontSettings.refill.size + 'px';
    div.style.setProperty('font-family', fontSettings.refill.font, 'important');
    div.style.color = fontSettings.refill.color;
    div.textContent = cat.name;
    
    div.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      if(cat.key === 'manutenzione'){
        openManutenzioneRefill();
      } else {
        openRefillCategory(cat.key, cat.name, cat.color);
      }
    };
    
    container.appendChild(div);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const resetAllBtn = document.createElement('button');
  resetAllBtn.textContent = 'Reset Tutto';
  resetAllBtn.style.background = '#aa0000';
  resetAllBtn.style.color = '#fff';
  resetAllBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm('Confermi il reset di TUTTE le categorie REFILL?', ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Reset completo di refillList
      Object.keys(refillList).forEach(key => {
        delete refillList[key];
      });
      saveData();
      // Riapri il popup per vedere i cambiamenti
      openRefillSimple();
    }, 'Reset Completo REFILL');
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); closePopup(); };
  
  actionsDiv.appendChild(resetAllBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function openManutenzioneRefill(){
  popupTitle.textContent = "REFILL - MANUTENZIONE";
  orderList.innerHTML = "";
  
  // Lista prodotti manutenzione
  const manutenzioneProducts = [
    'CARTA MANI',
    'CARTA IGIENICA', 
    'SAPONE LIQUIDO',
    'SACCHI GRANDI',
    'SACCHI PICCOLI',
    'DET PAVIMENTI',
    'DET BAGNI',
    'DET SUPERFICI',
    'DET ACCIAIO',
    'SPUGNE GRANDI',
    'SPUGNE PICCOLE',
    'SPUGNE PIATTE',
    'LAVABICCHIERI B',
    'LAVABICCHIERI D'
  ];
  
  // Container per centrare le liste prodotti
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.padding = '10px';
  
  manutenzioneProducts.forEach(productName => {
    const qty = refillList[productName] || 0;
    
    const div = document.createElement('div');
    div.style.width = '50%';
    div.style.padding = '10px';
    div.style.margin = '3px 0';
    div.style.background = '#8800aa'; // Colore viola manutenzione
    div.style.borderRadius = '5px';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.cursor = 'pointer';
    
    const nameSpan = document.createElement('span');
    nameSpan.textContent = productName;
    nameSpan.style.color = '#fff';
    nameSpan.style.fontWeight = '700';
    nameSpan.style.fontSize = '14px';
    
    const qtySpan = document.createElement('span');
    qtySpan.textContent = qty;
    qtySpan.style.color = '#fff';
    qtySpan.style.fontWeight = '700';
    
    // Gestione tap normale e prolungato
    let pressTimer;
    let isLongPress = false;
    
    // Desktop events
    div.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isLongPress = false;
      pressTimer = setTimeout(() => {
        isLongPress = true;
        vibrate(VIBRATION_PATTERNS.warning);
        if(!refillList[productName]) refillList[productName] = 0;
        if(refillList[productName] > 0) {
          refillList[productName]--;
          qtySpan.textContent = refillList[productName];
          saveData();
        }
      }, 500); // 500ms per tap prolungato
    });
    
    div.addEventListener('mouseup', (e) => {
      e.preventDefault();
      clearTimeout(pressTimer);
      if(!isLongPress) {
        // Tap normale: +1
        vibrate(VIBRATION_PATTERNS.tap);
        if(!refillList[productName]) refillList[productName] = 0;
        refillList[productName]++;
        qtySpan.textContent = refillList[productName];
        saveData();
      }
    });
    
    div.addEventListener('mouseleave', () => {
      clearTimeout(pressTimer);
    });
    
    // Mobile events
    div.addEventListener('touchstart', (e) => {
      e.preventDefault();
      isLongPress = false;
      pressTimer = setTimeout(() => {
        isLongPress = true;
        vibrate(VIBRATION_PATTERNS.warning);
        if(!refillList[productName]) refillList[productName] = 0;
        if(refillList[productName] > 0) {
          refillList[productName]--;
          qtySpan.textContent = refillList[productName];
          saveData();
        }
      }, 500);
    });
    
    div.addEventListener('touchend', (e) => {
      e.preventDefault();
      clearTimeout(pressTimer);
      if(!isLongPress) {
        // Tap normale: +1
        vibrate(VIBRATION_PATTERNS.tap);
        if(!refillList[productName]) refillList[productName] = 0;
        refillList[productName]++;
        qtySpan.textContent = refillList[productName];
        saveData();
      }
    });
    
    div.appendChild(nameSpan);
    div.appendChild(qtySpan);
    container.appendChild(div);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); openRefillSimple(); };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.style.background = '#aa0000';
  resetBtn.style.color = '#fff';
  resetBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm('Confermi il reset di MANUTENZIONE?', ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Reset solo prodotti manutenzione
      manutenzioneProducts.forEach(product => {
        delete refillList[product];
      });
      saveData();
      // Riapri la lista per vedere i cambiamenti
      openManutenzioneRefill();
    }, 'Reset MANUTENZIONE');
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); closePopup(); };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);
}

function openRefillCategory(categoryKey, categoryName, categoryColor){
  popupTitle.textContent = `REFILL - ${categoryName}`;
  orderList.innerHTML = "";
  
  const products = CATALOG[categoryKey] || [];
  
  if(products.length === 0){
    orderList.innerHTML = "<div style='padding:20px;text-align:center;color:#fff;'>Nessun prodotto in questa categoria</div>";
  } else {
    // Container per centrare le liste prodotti
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.alignItems = 'center';
    container.style.padding = '10px';
    
    // Array per raccogliere tutti i prodotti (inclusi quelli nelle sottocategorie)
    const allProducts = [];
    
    products.forEach(product => {
      // Se il prodotto ha una sottocategoria, espandi SOLO i suoi prodotti (non il base)
      if(subcategories[product.name]){
        subcategories[product.name].forEach(subProduct => {
          allProducts.push({ name: `${product.name} ${subProduct.name}`, price: subProduct.price });
        });
      } else {
        // Aggiungi il prodotto base solo se NON ha sottocategorie
        allProducts.push(product);
      }
    });
    
    allProducts.forEach(product => {
      const qty = refillList[product.name] || 0;
      
      const div = document.createElement('div');
      div.style.width = '50%';
      div.style.padding = '10px';
      div.style.margin = '3px 0';
      div.style.background = categoryColor;
      div.style.borderRadius = '5px';
      div.style.display = 'flex';
      div.style.justifyContent = 'space-between';
      div.style.alignItems = 'center';
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = product.name;
      nameSpan.style.color = '#fff';
      nameSpan.style.fontWeight = '700';
      nameSpan.style.fontSize = '14px'; // Leggermente più piccolo per le sottocategorie
      
      const qtySpan = document.createElement('span');
      qtySpan.textContent = qty;
      qtySpan.style.color = '#fff';
      qtySpan.style.fontWeight = '700';
      
      div.appendChild(nameSpan);
      div.appendChild(qtySpan);
      container.appendChild(div);
    });
    
    orderList.appendChild(container);
  }
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); openRefillSimple(); };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.style.background = '#aa0000';
  resetBtn.style.color = '#fff';
  resetBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm(`Confermi il reset di ${categoryName}?`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Reset solo prodotti di questa categoria
      const catalogProducts = CATALOG[categoryKey] || [];
      catalogProducts.forEach(product => {
        // Reset prodotto base
        delete refillList[product.name];
        // Reset sottocategorie se esistono
        if(subcategories[product.name]){
          subcategories[product.name].forEach(subProduct => {
            delete refillList[`${product.name} ${subProduct.name}`];
          });
        }
      });
      saveData();
      // Riapri la lista per vedere i cambiamenti
      openRefillCategory(categoryKey, categoryName, categoryColor);
    }, `Reset ${categoryName}`);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); closePopup(); };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);
}

/* Popup Refill - Versione Standard (DEPRECATA) */
function openRefillStandardPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "REFILL - Seleziona Categoria";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Renderizza le categorie REFILL
  renderRefillCategories();
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function renderRefillCategories(){
  const categories = [
    { key: 'c1', name: 'CAFFÈ', color: '#888', catalog: CATALOG.c1 },
    { key: 'c2', name: 'SPINA', color: '#ff8800', catalog: CATALOG.c2 },
    { key: 'c3', name: 'FRIGO', color: '#0099ff', catalog: CATALOG.c3 },
    { key: 'c4', name: 'SUPER', color: '#aaaa00', catalog: CATALOG.c4 },
    { key: 'c5', name: 'SNACK', color: '#ff0000', catalog: CATALOG.c5 }
  ];
  
  categories.forEach(cat => {
    const row = document.createElement('div');
    row.className = 'order-row';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr auto';
    row.style.alignItems = 'center';
    row.style.padding = '15px';
    row.style.background = cat.color;
    row.style.borderRadius = '8px';
    row.style.margin = '5px 0';
    row.style.cursor = 'pointer';
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = cat.name;
    nameDiv.style.setProperty('font-family', fontSettings.refill.font, 'important');
    nameDiv.style.fontSize = fontSettings.refill.size + 'px';
    nameDiv.style.fontWeight = '700';
    nameDiv.style.color = fontSettings.refill.color;
    
    const arrowDiv = document.createElement('div');
    arrowDiv.textContent = '→';
    arrowDiv.style.fontSize = '20px';
    arrowDiv.style.fontWeight = '700';
    arrowDiv.style.color = fontSettings.refill.color;
    
    row.appendChild(nameDiv);
    row.appendChild(arrowDiv);
    
    row.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      openRefillCategoryStandard(cat.key, cat.name, cat.color, cat.catalog);
    };
    
    orderList.appendChild(row);
  });
}

function openRefillCategoryStandard(categoryKey, categoryName, categoryColor, catalogProducts){
  // Titolo popup
  popupTitle.textContent = `REFILL - ${categoryName}`;
  
  // Svuota la lista ordini
  orderList.innerHTML = "";
  
  // Array per raccogliere tutti i prodotti (inclusi quelli nelle sottocategorie)
  const allProducts = [];
  
  catalogProducts.forEach(product => {
    // Se il prodotto ha una sottocategoria, espandi i suoi prodotti
    if(subcategories[product.name]){
      subcategories[product.name].forEach(subProduct => {
        allProducts.push({ name: `${product.name} ${subProduct.name}`, price: subProduct.price });
      });
    }
    // Aggiungi anche il prodotto base
    allProducts.push(product);
  });
  
  // Renderizza prodotti come righe ordine
  allProducts.forEach(product => {
    const qty = refillList[product.name] || 0;
    
    const row = document.createElement('div');
    row.className = 'order-row';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr auto';
    row.style.alignItems = 'center';
    row.style.padding = '10px';
    row.style.background = 'rgba(255,255,255,0.05)';
    row.style.borderRadius = '4px';
    row.style.margin = '2px 0';
    row.style.borderLeft = `4px solid ${categoryColor}`;
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = product.name;
    nameDiv.style.setProperty('font-family', fontSettings.refill.font, 'important');
    nameDiv.style.fontSize = fontSettings.refill.size + 'px';
    nameDiv.style.fontWeight = '700';
    nameDiv.style.color = fontSettings.refill.color;
    
    const qtyDiv = document.createElement('div');
    qtyDiv.textContent = `Qty: ${qty}`;
    qtyDiv.style.setProperty('font-family', fontSettings.refill.font, 'important');
    qtyDiv.style.fontSize = (fontSettings.refill.size - 2) + 'px';
    qtyDiv.style.fontWeight = '700';
    qtyDiv.style.color = categoryColor;
    
    row.appendChild(nameDiv);
    row.appendChild(qtyDiv);
    orderList.appendChild(row);
  });
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openRefillStandardPopup();
  };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm(`Confermi il reset di ${categoryName}?`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      catalogProducts.forEach(product => {
        delete refillList[product.name];
      });
      saveData();
      openRefillCategoryStandard(categoryKey, categoryName, categoryColor, catalogProducts);
    }, `Reset ${categoryName}`);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);
}

/* Popup Refill - Versione Overlay (DEPRECATA) */
function openRefillPopup(){
  currentTarget = {type:null, id:null};
  
  // Crea overlay 90% schermo con background come SPESA
  const refillOverlay = document.createElement('div');
  refillOverlay.id = 'refill-overlay';
  refillOverlay.style.position = 'fixed';
  refillOverlay.style.top = '0';
  refillOverlay.style.left = '0';
  refillOverlay.style.right = '0';
  refillOverlay.style.bottom = '0';
  refillOverlay.style.background = 'rgba(0,0,0,0.95)';
  refillOverlay.style.zIndex = '9999';
  refillOverlay.style.display = 'flex';
  refillOverlay.style.alignItems = 'center';
  refillOverlay.style.justifyContent = 'center';
  // Evita che i click del popup propaghino a listener globali (solo stopPropagation)
  refillOverlay.addEventListener('click', (e)=> e.stopPropagation());
  refillOverlay.addEventListener('mousedown', (e)=> e.stopPropagation());
  refillOverlay.addEventListener('touchstart', (e)=> e.stopPropagation(), { passive: true });
  
  // Container interno 90% con background personalizzato
  const refillContent = document.createElement('div');
  refillContent.style.background = `#000 url("${currentBackground}") no-repeat center center`;
  refillContent.style.backgroundSize = 'cover';
  refillContent.style.width = '90vw';
  refillContent.style.height = '90vh';
  refillContent.style.borderRadius = '12px';
  refillContent.style.border = '2px solid #444';
  refillContent.style.padding = '20px';
  refillContent.style.overflowY = 'auto';
  refillContent.style.display = 'flex';
  refillContent.style.flexDirection = 'column';
  refillContent.style.alignItems = 'center';
  refillContent.style.justifyContent = 'center';
  // Blocca propagazione eventi all'esterno del contenitore
  refillContent.addEventListener('click', (e)=> e.stopPropagation());
  refillContent.addEventListener('mousedown', (e)=> e.stopPropagation());
  refillContent.addEventListener('touchstart', (e)=> e.stopPropagation(), { passive: true });
  
  // Titolo
  const title = document.createElement('div');
  title.textContent = 'REFILL - Seleziona Categoria';
  title.style.fontSize = (fontSettings.refill.size + 6) + 'px';
  title.style.setProperty('font-family', fontSettings.refill.font, 'important');
  title.style.fontWeight = '700';
  title.style.textAlign = 'center';
  title.style.marginBottom = '30px';
  title.style.color = fontSettings.refill.color;
  refillContent.appendChild(title);
  
  // Container bottoni categorie (50% larghezza, centrati)
  const categoriesContainer = document.createElement('div');
  categoriesContainer.style.width = '50%';
  categoriesContainer.style.maxWidth = '400px';
  categoriesContainer.style.display = 'flex';
  categoriesContainer.style.flexDirection = 'column';
  categoriesContainer.style.gap = '15px';
  
  // Definizione categorie
  const categories = [
    { key: 'c1', name: 'CAFFÈ', color: '#888', catalog: CATALOG.c1 },
    { key: 'c2', name: 'SPINA', color: '#ff8800', catalog: CATALOG.c2 },
    { key: 'c3', name: 'FRIGO', color: '#0099ff', catalog: CATALOG.c3 },
    { key: 'c4', name: 'SUPER', color: '#aaaa00', catalog: CATALOG.c4 },
    { key: 'c5', name: 'SNACK', color: '#ff0000', catalog: CATALOG.c5 }
  ];
  
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat.name;
    btn.type = 'button';
    btn.style.padding = fontSettings.refill.padding + 'px';
    btn.style.fontSize = fontSettings.refill.size + 'px';
    btn.style.setProperty('font-family', fontSettings.refill.font, 'important');
    btn.style.fontWeight = '700';
    btn.style.background = cat.color;
    btn.style.color = fontSettings.refill.color;
    btn.style.border = 'none';
    btn.style.borderRadius = '10px';
    btn.style.cursor = 'pointer';
    btn.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
    btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    
    btn.onmouseenter = () => {
      btn.style.transform = 'translateY(-3px)';
      btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.4)';
    };
    btn.onmouseleave = () => {
      btn.style.transform = 'translateY(0)';
      btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    };
    
    btn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      vibrate(VIBRATION_PATTERNS.tap);
      openRefillCategoryList(cat.key, cat.name, cat.color, cat.catalog);
    };
    
    categoriesContainer.appendChild(btn);
  });
  
  refillContent.appendChild(categoriesContainer);
  
  // Bottone chiudi in basso
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Chiudi';
  closeBtn.className = 'utility-btn';
  closeBtn.style.marginTop = '10px';
  closeBtn.type = 'button';
  closeBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    vibrate(VIBRATION_PATTERNS.tap);
    disableRefillHistoryTrap();
    document.getElementById('refill-overlay').remove();
  };
  
  refillContent.appendChild(closeBtn);
  refillOverlay.appendChild(refillContent);
  document.body.appendChild(refillOverlay);
  
  // Attiva trap per tasto back
  enableRefillHistoryTrap();
}

function openRefillCategoryList(categoryKey, categoryName, categoryColor, catalogProducts){
  // Rimuovi overlay precedente
  const oldOverlay = document.getElementById('refill-overlay');
  if(oldOverlay) oldOverlay.remove();
  
  // Crea nuovo overlay 90% schermo con background come SPESA
  const refillOverlay = document.createElement('div');
  refillOverlay.id = 'refill-overlay';
  refillOverlay.style.position = 'fixed';
  refillOverlay.style.top = '0';
  refillOverlay.style.left = '0';
  refillOverlay.style.right = '0';
  refillOverlay.style.bottom = '0';
  refillOverlay.style.background = 'rgba(0,0,0,0.95)';
  refillOverlay.style.zIndex = '9999';
  refillOverlay.style.display = 'flex';
  refillOverlay.style.alignItems = 'center';
  refillOverlay.style.justifyContent = 'center';
  
  // Container interno 90% con background personalizzato
  const refillContent = document.createElement('div');
  refillContent.style.background = `#000 url("${currentBackground}") no-repeat center center`;
  refillContent.style.backgroundSize = 'cover';
  refillContent.style.width = '90vw';
  refillContent.style.height = '90vh';
  refillContent.style.borderRadius = '12px';
  refillContent.style.border = '2px solid #444';
  refillContent.style.padding = '20px';
  refillContent.style.overflowY = 'auto';
  refillContent.style.display = 'flex';
  refillContent.style.flexDirection = 'column';
  
  // Titolo
  const title = document.createElement('div');
  title.textContent = `REFILL - ${categoryName}`;
  title.style.fontSize = (fontSettings.refill.size + 6) + 'px';
  title.style.setProperty('font-family', fontSettings.refill.font, 'important');
  title.style.fontWeight = '700';
  title.style.textAlign = 'center';
  title.style.marginBottom = '20px';
  title.style.color = fontSettings.refill.color;
  refillContent.appendChild(title);
  
  // Bottoni azioni
  const actionsTop = document.createElement('div');
  actionsTop.style.display = 'flex';
  actionsTop.style.gap = '10px';
  actionsTop.style.marginBottom = '20px';
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.style.background = '#555';
  backBtn.style.flex = '1';
  backBtn.style.padding = '15px';
  backBtn.style.fontSize = '16px';
  backBtn.style.fontWeight = '700';
  backBtn.style.border = 'none';
  backBtn.style.borderRadius = '8px';
  backBtn.style.color = '#fff';
  backBtn.style.cursor = 'pointer';
  backBtn.type = 'button';
  backBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    vibrate(VIBRATION_PATTERNS.tap);
    disableRefillHistoryTrap();
    const overlay = document.getElementById('refill-overlay');
    if(overlay) overlay.remove();
    openRefillPopup();
  };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.style.background = '#aa0000';
  resetBtn.style.flex = '1';
  resetBtn.style.padding = '15px';
  resetBtn.style.fontSize = '16px';
  resetBtn.style.fontWeight = '700';
  resetBtn.style.border = 'none';
  resetBtn.style.borderRadius = '8px';
  resetBtn.style.color = '#fff';
  resetBtn.style.cursor = 'pointer';
  resetBtn.type = 'button';
  resetBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm(`Confermi il reset di ${categoryName}?`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Reset solo prodotti di questa categoria
      catalogProducts.forEach(product => {
        delete refillList[product.name];
      });
      saveData();
      // Riapri la lista
      openRefillCategoryList(categoryKey, categoryName, categoryColor, catalogProducts);
    }, `Reset ${categoryName}`);
  };
  closeBtn.className = 'utility-btn';
  closeBtn.type = 'button';
  closeBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    vibrate(VIBRATION_PATTERNS.tap);
    disableRefillHistoryTrap();
    document.getElementById('refill-overlay').remove();
  };
  
  actionsTop.appendChild(backBtn);
  actionsTop.appendChild(resetBtn);
  actionsTop.appendChild(closeBtn);
  refillContent.appendChild(actionsTop);
  
  // Container prodotti
  const gridContainer = document.createElement('div');
  gridContainer.style.display = 'grid';
  gridContainer.style.gridTemplateColumns = '1fr 1fr';
  gridContainer.style.gap = '15px';
  
  // Array per raccogliere tutti i prodotti (inclusi quelli nelle sottocategorie)
  const allProducts = [];
  
  catalogProducts.forEach(product => {
    // Se il prodotto ha una sottocategoria, espandi i suoi prodotti
    if(subcategories[product.name]){
      subcategories[product.name].forEach(subProduct => {
        allProducts.push(subProduct);
      });
    } else {
      // Altrimenti aggiungi il prodotto normale
      allProducts.push(product);
    }
  });
  
  allProducts.forEach(product => {
    const qty = refillList[product.name] || 0;
    
    const row = document.createElement('div');
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '2fr 1fr';
    row.style.gap = '10px';
    row.style.alignItems = 'center';
    row.style.padding = '15px';
    row.style.background = categoryColor;
    row.style.borderRadius = '8px';
    row.style.transition = 'transform 0.2s ease';
    row.style.cursor = 'pointer';
    
    row.onmouseenter = () => {
      row.style.transform = 'scale(1.02)';
    };
    row.onmouseleave = () => {
      row.style.transform = 'scale(1)';
    };
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = product.name;
    nameDiv.style.fontSize = fontSettings.refill.size + 'px';
    nameDiv.style.setProperty('font-family', fontSettings.refill.font, 'important');
    nameDiv.style.fontWeight = '700';
    nameDiv.style.color = fontSettings.refill.color;
    
    const qtyDiv = document.createElement('div');
    qtyDiv.textContent = qty;
    qtyDiv.style.fontSize = (fontSettings.refill.size + 4) + 'px';
    qtyDiv.style.setProperty('font-family', fontSettings.refill.font, 'important');
    qtyDiv.style.fontWeight = '700';
    qtyDiv.style.textAlign = 'center';
    qtyDiv.style.color = fontSettings.refill.color;
    
    row.appendChild(nameDiv);
    row.appendChild(qtyDiv);
    gridContainer.appendChild(row);
  });
  
  refillContent.appendChild(gridContainer);
  refillOverlay.appendChild(refillContent);
  document.body.appendChild(refillOverlay);
  
  // Attiva trap per tasto back
  enableRefillHistoryTrap();
}

// Utilities REFILL: considera tutte le categorie di refill (c1..c5)
function getRefillCategoryKeys(){
  return ['c1','c2','c3','c4','c5'];
}

function getAllRefillCatalogProducts(){
  const keys = getRefillCategoryKeys();
  const products = [];
  keys.forEach(k => {
    const list = CATALOG[k] || [];
    list.forEach(p => {
      // espandi sottocategorie se presenti
      if(subcategories[p.name]){
        subcategories[p.name].forEach(sp => {
          products.push({ name: `${p.name} ${sp.name}`, price: sp.price });
        });
      }
      // aggiungi anche il prodotto base
      products.push({ name: p.name, price: p.price });
    });
  });
  return products;
}

function isRefillProductName(name){
  // Rimuove eventuali modificatori finali (SR, M, K, S, GH)
  let clean = name;
  const mods = [' SR',' M',' K',' S',' GH'];
  mods.forEach(m => {
    if(clean.endsWith(m)) clean = clean.slice(0, -m.length);
  });
  const all = getAllRefillCatalogProducts();
  return all.some(p => p.name === clean);
}

function updateRefillFromItems(items){
  // Aumenta i prodotti REFILL (c1..c5) nella lista refill quando vengono pagati/consegnati
  if(!items || items.length === 0) return;
  
  items.forEach(item => {
    // Pulisci eventuali modificatori e verifica se è un prodotto REFILL
    let productName = item.name;
    modifiersList.forEach(mod => {
      productName = productName.replace(new RegExp('\\s+' + mod + '$'), '');
    });
    const isRefill = isRefillProductName(productName);
    console.log('Checking item:', item.name, '-> Clean name:', productName, 'Is REFILL?', isRefill, 'Qty:', item.qty);
    if(isRefill){
      if(!refillList[productName]) refillList[productName] = 0;
      refillList[productName] += (item.qty || 1);
      console.log('Updated refillList:', productName, '=', refillList[productName]);
    }
  });
  saveData();
}


/* Popup Spesa */
function openSpesaPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "SPESA";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };
  
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function printSpesaList(){
  // Crea una finestra di stampa con la lista spesa per TUTTE le categorie refill
  const allRefillProducts = getAllRefillCatalogProducts();
  const productsToShow = allRefillProducts.filter(product => {
    const qty = refillList[product.name] || 0;
    return qty > 0;
  });
  
  if(productsToShow.length === 0){
    alert('Nessun prodotto da stampare!');
    return;
  }
  
  let printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Lista Spesa - Break Billiard Club</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { text-align: center; color: #00aa00; }
        .date { text-align: center; color: #666; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #00aa00; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .qty { text-align: center; font-weight: bold; font-size: 18px; }
        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
        @media print {
          button { display: none; }
        }
      </style>
    </head>
    <body>
      <h1>🛒 Lista Spesa</h1>
      <div class="date">${new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
      <table>
        <thead>
          <tr>
            <th>Prodotto</th>
            <th style="width: 100px; text-align: center;">Quantità</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  productsToShow.forEach(product => {
    const qty = refillList[product.name];
    printContent += `
      <tr>
        <td>${product.name}</td>
        <td class="qty">${qty}</td>
      </tr>
    `;
  });
  
  printContent += `
        </tbody>
      </table>
      <div class="footer">
        Break Billiard Club - Lista generata automaticamente
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  
  // Attendi il caricamento e stampa
  printWindow.onload = () => {
    setTimeout(() => {
      printWindow.print();
    }, 250);
  };
}

function renderSpesaList(){
  orderList.innerHTML = "";
  
  // Mostra i prodotti REFILL (c1..c5) che hanno quantità > 0
  const allRefillProducts = getAllRefillCatalogProducts();
  
  // Filtra solo prodotti con quantità > 0
  const productsToShow = allRefillProducts.filter(product => {
    const qty = refillList[product.name] || 0;
    return qty > 0;
  });
  
  if(productsToShow.length === 0){
    const emptyMsg = document.createElement('div');
    emptyMsg.innerHTML = `
      <div style="text-align:center;padding:40px 20px;">
        <div style="font-size:48px;margin-bottom:20px;">🛒</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:10px;">Nessun prodotto da acquistare</div>
        <div style="font-size:14px;color:#aaa;">Aggiungi prodotti alle categorie Refill (Caffè, Spina, Frigo, Super, Snack) per popolare la lista</div>
      </div>
    `;
    orderList.appendChild(emptyMsg);
    return;
  }
  
  // Intestazione con totale prodotti
  const header = document.createElement('div');
  header.style.background = "rgba(0,170,0,0.2)";
  header.style.padding = "15px";
  header.style.borderRadius = "8px";
  header.style.marginBottom = "15px";
  header.style.textAlign = "center";
  header.innerHTML = `
    <div style="font-size:16px;font-weight:700;color:#00ff00;">
      📦 Totale prodotti: ${productsToShow.length}
    </div>
    <div style="font-size:14px;color:#aaa;margin-top:5px;">
      Quantità totale: ${Object.values(refillList).reduce((a,b)=>a+b,0)}
    </div>
  `;
  orderList.appendChild(header);
  
  // Container con griglia a 1 colonna per lista più leggibile
  const gridContainer = document.createElement('div');
  gridContainer.style.display = "flex";
  gridContainer.style.flexDirection = "column";
  gridContainer.style.gap = "10px";
  
  productsToShow.forEach(product => {
    const qty = refillList[product.name];
    
    const row = document.createElement('div');
    row.style.display = "grid";
    row.style.gridTemplateColumns = "1fr auto";
    row.style.gap = "15px";
    row.style.alignItems = "center";
    row.style.padding = "15px";
    row.style.background = "linear-gradient(135deg, #00aa00 0%, #008800 100%)";
    row.style.borderRadius = "10px";
    row.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
    row.style.transition = "transform 0.2s ease, box-shadow 0.2s ease";
    row.style.cursor = "pointer";
    
    row.onmouseenter = () => {
      row.style.transform = "translateY(-2px)";
      row.style.boxShadow = "0 4px 12px rgba(0,170,0,0.4)";
    };
    row.onmouseleave = () => {
      row.style.transform = "translateY(0)";
      row.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
    };
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = product.name;
    nameDiv.style.fontSize = "16px";
    nameDiv.style.fontWeight = "700";
    nameDiv.style.color = "#fff";
    
    // Controlli quantità
    const qtyControls = document.createElement('div');
    qtyControls.style.display = "flex";
    qtyControls.style.alignItems = "center";
    qtyControls.style.gap = "10px";
    
    const minusBtn = document.createElement('button');
    minusBtn.textContent = "−";
    minusBtn.style.width = "35px";
    minusBtn.style.height = "35px";
    minusBtn.style.borderRadius = "50%";
    minusBtn.style.border = "2px solid #fff";
    minusBtn.style.background = "rgba(0,0,0,0.3)";
    minusBtn.style.color = "#fff";
    minusBtn.style.fontSize = "20px";
    minusBtn.style.fontWeight = "700";
    minusBtn.style.cursor = "pointer";
    minusBtn.style.transition = "all 0.2s ease";
    minusBtn.onclick = (e) => {
      e.stopPropagation();
      vibrate(VIBRATION_PATTERNS.tap);
      if(refillList[product.name] > 0) {
        refillList[product.name]--;
        if(refillList[product.name] === 0) {
          delete refillList[product.name];
        }
        saveData();
        renderSpesaList();
      }
    };
    
    const qtyDisplay = document.createElement('div');
    qtyDisplay.textContent = qty;
    qtyDisplay.style.fontSize = "24px";
    qtyDisplay.style.fontWeight = "700";
    qtyDisplay.style.color = "#fff";
    qtyDisplay.style.minWidth = "40px";
    qtyDisplay.style.textAlign = "center";
    qtyDisplay.style.background = "rgba(0,0,0,0.3)";
    qtyDisplay.style.padding = "5px 10px";
    qtyDisplay.style.borderRadius = "8px";
    
    const plusBtn = document.createElement('button');
    plusBtn.textContent = "+";
    plusBtn.style.width = "35px";
    plusBtn.style.height = "35px";
    plusBtn.style.borderRadius = "50%";
    plusBtn.style.border = "2px solid #fff";
    plusBtn.style.background = "rgba(255,255,255,0.2)";
    plusBtn.style.color = "#fff";
    plusBtn.style.fontSize = "20px";
    plusBtn.style.fontWeight = "700";
    plusBtn.style.cursor = "pointer";
    plusBtn.style.transition = "all 0.2s ease";
    plusBtn.onclick = (e) => {
      e.stopPropagation();
      vibrate(VIBRATION_PATTERNS.tap);
      refillList[product.name]++;
      saveData();
      renderSpesaList();
    };
    
    qtyControls.appendChild(minusBtn);
    qtyControls.appendChild(qtyDisplay);
    qtyControls.appendChild(plusBtn);
    
    row.appendChild(nameDiv);
    row.appendChild(qtyControls);
    
    gridContainer.appendChild(row);
  });
  
  orderList.appendChild(gridContainer);
}

/* Popup tavoli personalizzati */
function openCustomTablesPopup(){
  currentTarget = {type:null, id:null};
  
  // Rimuovi overlay precedente se esiste
  const oldOverlay = document.getElementById('custom-tables-overlay');
  if(oldOverlay) oldOverlay.remove();
  
  // Nascondi gli elementi normali del popup
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  popupTitle.textContent = "Tavoli Personalizzati";
  actionsDiv.innerHTML = "";
  
  // Crea un overlay che copre tutto il popup-main
  const overlay = document.createElement('div');
  overlay.id = "custom-tables-overlay";
  overlay.style.position = "absolute";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.right = "0";
  overlay.style.bottom = "0";
  overlay.style.background = "#000";
  overlay.style.zIndex = "10";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.padding = "20px";
  overlay.style.overflowY = "auto";
  
  const popupMain = document.querySelector('.popup-main');
  popupMain.style.position = "relative";
  
  // Bottoni azioni
  const header = document.createElement('div');
  header.style.marginBottom = "20px";
  const buttonsDiv = document.createElement('div');
  buttonsDiv.style.display = "flex";
  buttonsDiv.style.gap = "10px";
  buttonsDiv.style.marginBottom = "15px";
  
  const addTableBtn = document.createElement('button');
  addTableBtn.textContent = "+ Aggiungi Tavolo";
  addTableBtn.style.background = "#00aa00";
  addTableBtn.style.flex = "1";
  addTableBtn.onclick = ()=> {
    const newName = prompt("Nome del nuovo tavolo:");
    if(newName && !tableNames.includes(newName)){
      tableNames.push(newName);
      renderTables();
      saveData();
      openCustomTablesPopup();
    }
  };
  
  const closeTableBtn = document.createElement('button');
  closeTableBtn.textContent = "Chiudi";
  closeTableBtn.style.flex = "1";
  closeTableBtn.onclick = closePopup;
  
  buttonsDiv.appendChild(addTableBtn);
  buttonsDiv.appendChild(closeTableBtn);
  header.appendChild(buttonsDiv);
  
  // Container per i tasti
  const container = document.createElement('div');
  container.style.flex = "1";
  container.style.overflowY = "auto";
  container.style.padding = "10px";
  
  const customTables = tableNames.filter(n => !n.startsWith("TAV-") && !["BANCO","SALA","SALAF"].includes(n));
  
  if(customTables.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun tavolo personalizzato creato";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    container.appendChild(empty);
  } else {
    // Ordina alfabeticamente
    customTables.sort((a, b) => a.localeCompare(b));
    
    // Crea layout a colonne verticali
    const grid = document.createElement('div');
    grid.style.columnCount = "3";
    grid.style.columnGap = "10px";
    
    customTables.forEach(tableName => {
      const btn = document.createElement('button');
      btn.className = "table-btn";
      btn.textContent = tableName;
      btn.style.width = "100%";
      btn.style.marginBottom = "10px";
      btn.style.breakInside = "avoid";
      btn.style.display = "block";
      
      let pressTimer;
      
      // Click normale = apri tavolo
      btn.onclick = ()=> {
        const idx = tableNames.indexOf(tableName);
        if(idx !== -1){
          closePopup();
          openForTable(idx);
        }
      };
      
      // Pressione lunga = mostra popup elimina
      btn.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => {
          showConfirm(`Vuoi eliminare il tavolo "${tableName}"?`, ()=> {
            const idx = tableNames.indexOf(tableName);
            if(idx !== -1){
              tableNames.splice(idx,1);
              saveData();
              renderTables();
              openCustomTablesPopup();
            }
          }, 'Elimina Tavolo');
        }, 800);
      });
      
      btn.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
      });
      
      btn.addEventListener('touchmove', () => {
        clearTimeout(pressTimer);
      });
      
      // Supporto mouse per desktop
      btn.addEventListener('mousedown', () => {
        pressTimer = setTimeout(() => {
          showConfirm(`Vuoi eliminare il tavolo "${tableName}"?`, ()=> {
            const idx = tableNames.indexOf(tableName);
            if(idx !== -1){
              tableNames.splice(idx,1);
              saveData();
              renderTables();
              openCustomTablesPopup();
            }
          }, 'Elimina Tavolo');
        }, 800);
      });
      
      btn.addEventListener('mouseup', () => {
        clearTimeout(pressTimer);
      });
      
      btn.addEventListener('mouseleave', () => {
        clearTimeout(pressTimer);
      });
      
      grid.appendChild(btn);
    });
    
    container.appendChild(grid);
  }
  
  // Aggiungi tutto all'overlay
  overlay.appendChild(header);
  overlay.appendChild(container);
  
  // Aggiungi l'overlay al popup-main
  popupMain.appendChild(overlay);
  
  // Mostra il popup
  showPopup();
}

/* aperture modale */
function openForTable(tableIndex){
  const tableName = tableNames[tableIndex];
  
  // Cerca se esiste già un ordine salvato con lo stesso nome
  let existingOrder = savedOrders.find(s => s.tableName === tableName);
  
  if(!existingOrder){
    // Crea un nuovo ordine salvato
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    existingOrder = { id, tableName, items: [] };
    savedOrders.push(existingOrder);
    renderSavedButtons();
    saveData();
  }
  
  // Apri l'ordine salvato invece del tavolo
  currentTarget = {type:'saved', id: existingOrder.id};
  popupTitle.textContent = tableName;
  // Layout verticale - elementi sempre visibili
  if(categoriesDiv) categoriesDiv.style.display = 'grid';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'grid';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'grid';
  renderOrderList();
  renderActionsForSaved();
  showPopup();
}
function openForSaved(savedId){
  const saved = savedOrders.find(x=>x.id===savedId);
  if(!saved) return;
  currentTarget = {type:'saved', id: savedId};
  popupTitle.textContent = saved.tableName;
  // Layout verticale - elementi sempre visibili
  if(categoriesDiv) categoriesDiv.style.display = 'grid';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'grid';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'grid';
  renderOrderList();
  renderActionsForSaved();
  showPopup();
}

/* azioni */
function renderActionsForTable(){
  actionsDiv.innerHTML = "";

  const payBtn = document.createElement('button');
  payBtn.textContent = "Pagato";
  payBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.click);
    const items = getEditingItems();
    const total = items.reduce((sum, it) => sum + ((it.price || 0) * (it.qty || 1)), 0);
    showConfirm(`Totale: €${total.toFixed(2)}`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Salva l'ordine negli evasi prima di pagare
      if(items && items.length > 0){
        evasiOrders.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
          tableName: tableNames[currentTarget.id],
          tableIndex: currentTarget.id,
          items: JSON.parse(JSON.stringify(items)),
          timestamp: new Date().toISOString(),
          dateLabel: new Date().toLocaleString()
        });
      }
      items.forEach(it=>{
        const cat = detectCategory(it.name);
        if(cat && totals[cat] !== undefined){
          totals[cat] += (it.price || 0) * (it.qty || 1);
        }
      });
      // Svuota il tavolo dopo il pagamento
      tableOrders[currentTarget.id] = [];
      renderOrderList();
      saveData();
      closePopup();
    });
  };

  const accontoBtn = document.createElement('button');
  accontoBtn.textContent = "Acconto";
  accontoBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.click);
    openAccontoPopup();
  };

  const consegnatoBtn = document.createElement('button');
  consegnatoBtn.textContent = "Done";
  consegnatoBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.success);
    // Marca come consegnato e chiudi popup
    const items = getEditingItems();
    if(!items || items.length === 0) {
      closePopup();
      return;
    }
    
    // Trova l'ordine salvato corrispondente e marcalo come consegnato
    const saved = savedOrders.find(s => s.tableName === tableNames[currentTarget.id]);
    if(saved) {
      saved.consegnato = true;
      saved.timestampDone = Date.now();
      saveData();
      renderTables();
      renderSavedButtons();
    }
    closePopup();
  };

  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };

  actionsDiv.appendChild(payBtn);
  actionsDiv.appendChild(accontoBtn);
  actionsDiv.appendChild(consegnatoBtn);
  actionsDiv.appendChild(closeBtn);
}

function renderActionsForSaved(){
  actionsDiv.innerHTML = "";
  const payBtn = document.createElement('button');
  payBtn.textContent = "Pagato";
  payBtn.onclick = ()=> {
    const items = getEditingItems();
    const total = items.reduce((sum, it) => sum + ((it.price || 0) * (it.qty || 1)), 0);
    showConfirm(`Totale: €${total.toFixed(2)}`, ()=>{
      paySavedOrder(currentTarget.id);
    });
  };
  
  const accontoBtn = document.createElement('button');
  accontoBtn.textContent = "Acconto";
  accontoBtn.onclick = ()=> { openAccontoPopup(); };
  
  const consegnatoBtn = document.createElement('button');
  consegnatoBtn.textContent = "Done";
  consegnatoBtn.onclick = ()=> {
    // Marca come consegnato e chiudi popup
    const items = getEditingItems();
    if(!items || items.length === 0) {
      closePopup();
      return;
    }
    
    const saved = savedOrders.find(s => s.id === currentTarget.id);
    if(saved) {
      saved.consegnato = true;
      saved.timestampDone = Date.now();
      saveData();
      renderTables();
      renderSavedButtons();
    }
    closePopup();
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  
  actionsDiv.appendChild(payBtn);
  actionsDiv.appendChild(accontoBtn);
  actionsDiv.appendChild(consegnatoBtn);
  actionsDiv.appendChild(closeBtn);
}

/* Popup Acconto */
function openAccontoPopup(){
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  
  const items = getEditingItems();
  const selectedItems = new Set();
  
  if(!items || items.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun prodotto nell'ordine";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    orderList.appendChild(empty);
  } else {
    const title = document.createElement('div');
    title.textContent = "Seleziona i prodotti da pagare:";
    title.style.fontWeight = "700";
    title.style.marginBottom = "10px";
    title.style.fontSize = "16px";
    orderList.appendChild(title);
    
    items.forEach((it, i)=>{
      const row = document.createElement('div');
      row.style.border = "2px solid #444";
      row.style.borderRadius = "6px";
      row.style.padding = "12px";
      row.style.marginBottom = "8px";
      row.style.cursor = "pointer";
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.transition = "all 0.2s";
      
      const cat = detectCategory(it.name);
      if(cat === 'caffe') row.style.background = '#888';
      else if(cat === 'spina') row.style.background = '#ff8800';
      else if(cat === 'frigo') row.style.background = '#0099ff';
      else if(cat === 'super') row.style.background = '#aaaa00';
      else if(cat === 'snack') row.style.background = '#ff0000';
      else if(cat === 'tempo') row.style.background = '#008800';
      else if(cat === 'quote') row.style.background = '#0000ff';
      else if(cat === 'cassa') row.style.background = '#000';
      
      const nameDiv = document.createElement('div');
      nameDiv.textContent = `${it.qty} × ${it.name}`;
      nameDiv.style.fontSize = "16px";
      
      const priceDiv = document.createElement('div');
      const lineTotal = (it.qty * (it.price||0));
      priceDiv.textContent = `€${lineTotal.toFixed(2)}`;
      priceDiv.style.fontSize = "16px";
      priceDiv.style.fontWeight = "700";
      
      row.appendChild(nameDiv);
      row.appendChild(priceDiv);
      
      row.onclick = ()=> {
        if(selectedItems.has(i)){
          selectedItems.delete(i);
          row.style.border = "2px solid #444";
          row.style.opacity = "1";
        } else {
          selectedItems.add(i);
          row.style.border = "2px solid #00ff00";
          row.style.opacity = "0.8";
        }
      };
      
      orderList.appendChild(row);
    });
  }
  
  actionsDiv.innerHTML = "";
  
  const payBtn = document.createElement('button');
  payBtn.textContent = "Pagato";
  payBtn.style.background = "#00aa00";
  payBtn.onclick = ()=> {
    if(selectedItems.size === 0){
      return;
    }
    
    const selectedIndexes = Array.from(selectedItems).sort((a,b)=>b-a);
    let totalAcconto = 0;
    
    selectedIndexes.forEach(idx => {
      const item = items[idx];
      totalAcconto += (item.price || 0) * (item.qty || 1);
    });
    
    showConfirm(`Totale: €${totalAcconto.toFixed(2)}`, ()=>{
      const paidItems = [];
      selectedIndexes.forEach(idx => {
        const item = items[idx];
        paidItems.push(JSON.parse(JSON.stringify(item)));
        const cat = detectCategory(item.name);
        if(cat && totals[cat] !== undefined){
          totals[cat] += (item.price || 0) * (item.qty || 1);
        }
        
        if(items && items.length > 0){
          evasiOrders.push({
            id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
            tableName: currentTarget.type === 'table' ? tableNames[currentTarget.id] : 'Riepilogo',
            tableIndex: currentTarget.type === 'table' ? currentTarget.id : null,
            items: [JSON.parse(JSON.stringify(item))],
            timestamp: new Date().toISOString(),
            dateLabel: new Date().toLocaleString()
          });
        }
        
        items.splice(idx, 1);
      });
      
      saveData();
      
      if(items.length === 0 && currentTarget.type === 'saved'){
        const idx = savedOrders.findIndex(s=>s.id === currentTarget.id);
        if(idx !== -1) savedOrders.splice(idx,1);
        closePopup();
      } else {
        // Torna al popup dell'ordine
        if(currentTarget.type === 'table'){
          openForTable(currentTarget.id);
        } else if(currentTarget.type === 'saved'){
          openForSaved(currentTarget.id);
        }
      }
    });
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Annulla";
  closeBtn.onclick = ()=> {
    if(currentTarget.type === 'table'){
      openForTable(currentTarget.id);
    } else if(currentTarget.type === 'saved'){
      openForSaved(currentTarget.id);
    }
  };
  
  actionsDiv.appendChild(payBtn);
  actionsDiv.appendChild(closeBtn);
  
  popupTitle.textContent = "Acconto";
  showPopup();
}

function closePopup(){
  hidePopup(() => {
    subcatsDiv.innerHTML = "";
    tempoPad.classList.add('hidden');
    cassaPad.classList.add('hidden');
    
    // Ripristina lo stile normale di orderList (per refill a schermo intero)
    orderList.style.position = "";
    orderList.style.top = "";
    orderList.style.left = "";
    orderList.style.right = "";
    orderList.style.bottom = "";
    orderList.style.background = "";
    orderList.style.zIndex = "";
    orderList.style.padding = "";
    orderList.style.overflowY = "";
    
    // Rimuovi classe fullscreen e spesa-popup dal popup e popup-content
    popup.classList.remove('fullscreen-popup');
    const popupContent = document.querySelector('.popup-content');
    if(popupContent) {
      popupContent.classList.remove('fullscreen');
      popupContent.classList.remove('spesa-popup');
    }
    
    // Rimuovi l'overlay dei tavoli personalizzati se esiste
    const overlay = document.getElementById('custom-tables-overlay');
    if(overlay) overlay.remove();
    
    // Ripristina il layout normale del popup
    const popupMain = document.querySelector('.popup-main');
    popupMain.style.position = "";
    
    renderTables();
    renderSavedButtons();
    saveData();
  });
}

/* sottocategorie */
function showSubcatsByKey(key){
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  tempoValue = "";
  cassaValue = "";
  if(tempoDisplay) tempoDisplay.value = "";
  if(cassaDisplay) cassaDisplay.value = "0";
  subcatsDiv.innerHTML = "";

  if(key === 'c6'){ // TEMPO
    openTempoPad();
    return;
  }
  
  if(key === 'c8'){ // CASSA
    openCassaPad();
    return;
  }

  const list = CATALOG[key] || [];
  list.forEach(item=>{
    const btn = document.createElement('button');
    btn.className = "subcat-btn";
    if(key==="c1") btn.classList.add('cat-caffe');
    if(key==="c2") btn.classList.add('cat-spina');
    if(key==="c3") btn.classList.add('cat-frigo');
    if(key==="c4") btn.classList.add('cat-super');
    if(key==="c5") btn.classList.add('cat-snack');
    if(key==="c7") btn.classList.add('cat-quote');
    if(key==="c8") btn.classList.add('cat-cassa');
    btn.textContent = item.name;
    btn.onclick = ()=> addCatalogProduct(item.name, item.price);
    subcatsDiv.appendChild(btn);
  });

  Array.from(subcatsDiv.children).forEach(ch=>{
    const prodName = ch.textContent;
    if(subcategories[prodName]){
      ch.onclick = ()=> showOptionsAndAdd(prodName, subcategories[prodName], key);
    }
  });
  // subcatsDiv è sempre visibile nel nuovo layout
}

function showOptionsAndAdd(base, options, parentKey){
  subcatsDiv.innerHTML = "";
  options.forEach(opt=>{
    const btn = document.createElement('button');
    btn.className = "subcat-btn";
    if(parentKey === 'c1') btn.classList.add('cat-caffe');
    if(parentKey === 'c2') btn.classList.add('cat-spina');
    if(parentKey === 'c3') btn.classList.add('cat-frigo');
    if(parentKey === 'c4') btn.classList.add('cat-super');
    if(parentKey === 'c5') btn.classList.add('cat-snack');
    btn.textContent = opt.name;
    btn.onclick = ()=> addCatalogProduct(`${base} ${opt.name}`, opt.price);
    subcatsDiv.appendChild(btn);
  });
  const back = document.createElement('button');
  back.textContent = '← Indietro';
  back.className = 'back-btn';
  back.onclick = ()=> showSubcatsByKey(parentKey);
  subcatsDiv.appendChild(back);
  // subcatsDiv è sempre visibile nel nuovo layout
}

/* editing target */
function getEditingItems(){
  if(currentTarget.type === 'table'){
    return tableOrders[currentTarget.id] || (tableOrders[currentTarget.id] = []);
  } else if(currentTarget.type === 'saved'){
    const s = savedOrders.find(x=>x.id===currentTarget.id);
    if(!s) return [];
    if(!s.items) s.items = [];
    return s.items;
  }
  return [];
}

/* aggiungi prodotto */
function addCatalogProduct(name, price){
  vibrate(VIBRATION_PATTERNS.click);
  const items = getEditingItems();
  const newItem = {name, qty:1, price: typeof price === 'number' ? price : 0, timestamp: Date.now()};
  items.push(newItem);
  
  // Se è un ordine salvato, marca come non consegnato quando aggiungi prodotti
  if(currentTarget.type === 'saved'){
    const saved = savedOrders.find(s => s.id === currentTarget.id);
    if(saved) {
      saved.consegnato = false;
    }
  }
  
  // Aggiorna refill list quando aggiungi un prodotto delle categorie Refill (c1..c5)
  if(isRefillProductName(name)){
    if(!refillList[name]) refillList[name] = 0;
    refillList[name] += 1;
  }
  
  renderOrderList();
  saveData();
  renderSavedButtons();
}

/* modificatori */
modifiersDiv.addEventListener('click', e=>{
  if(!e.target.matches('button')) return;
  vibrate(VIBRATION_PATTERNS.tap);
  const mod = e.target.dataset && e.target.dataset.mod || e.target.textContent;
  const items = getEditingItems();
  if(!items || items.length===0) return;
  items[items.length-1].name += ` ${mod}`;
  renderOrderList();
  saveData();
});

/* render ordine */
function renderOrderList(){
  orderList.innerHTML = "";
  const items = getEditingItems();
  let total = 0;
  // Trova il timestamp dell'ultimo Done
  let timestampDone = null;
  if(currentTarget.type === 'saved'){
    const saved = savedOrders.find(s => s.id === currentTarget.id);
    if(saved) timestampDone = saved.timestampDone;
  }
  
  // Calcola il totale prima
  (items || []).forEach((it)=>{
    const lineTotal = (it.qty * (it.price||0));
    total += lineTotal;
  });
  
  // Mostra il totale in alto
  if(items && items.length>0){
    const totDiv = document.createElement('div');
    totDiv.className = "order-row";
    totDiv.style.fontWeight = '700';
    totDiv.style.fontSize = '18px';
    totDiv.style.borderBottom = '3px solid #fff';
    const nameCell = document.createElement('div');
    nameCell.className = "order-name";
    nameCell.textContent = 'Totale Ordine';
    const priceCell = document.createElement('div');
    priceCell.className = "order-price";
    priceCell.textContent = `€${total.toFixed(2)}`;
    totDiv.appendChild(nameCell);
    totDiv.appendChild(priceCell);
    orderList.appendChild(totDiv);
  }
  
  // Mostra gli ordini in ordine inverso (dal più recente al più vecchio)
  const reversedItems = [...(items || [])].reverse();
  let separatorAdded = false;
  
  reversedItems.forEach((it, reversedIndex)=>{
    const i = items.length - 1 - reversedIndex; // Indice originale
    
    // Aggiungi separatore "CONSEGNATO" quando passiamo agli ordini vecchi
    if(timestampDone && it.timestamp && it.timestamp <= timestampDone && !separatorAdded){
      const separator = document.createElement('div');
      separator.style.textAlign = 'center';
      separator.style.padding = '15px 0';
      separator.style.fontWeight = '700';
      separator.style.fontSize = '16px';
      separator.style.color = '#00ff00';
      separator.style.borderTop = '2px solid #00ff00';
      separator.style.borderBottom = '2px solid #00ff00';
      separator.style.margin = '10px 0';
      separator.style.background = 'rgba(0,255,0,0.1)';
      separator.textContent = '✓ CONSEGNATO';
      orderList.appendChild(separator);
      separatorAdded = true;
    }
    
    const row = document.createElement('div');
    row.className = "order-row";
    
    // Colora la riga in base alla categoria
    const cat = detectCategory(it.name);
    if(cat === 'caffe') row.style.background = '#888';
    else if(cat === 'spina') row.style.background = '#ff8800';
    else if(cat === 'frigo') row.style.background = '#0099ff';
    else if(cat === 'super') row.style.background = '#aaaa00';
    else if(cat === 'snack') row.style.background = '#ff0000';
    else if(cat === 'tempo') row.style.background = '#008800';
    else if(cat === 'quote') row.style.background = '#0000ff';
    else if(cat === 'cassa') row.style.background = '#000';

    const nameCell = document.createElement('div');
    nameCell.className = "order-name";
    nameCell.textContent = `${it.qty} × ${it.name}`;

    const priceCell = document.createElement('div');
    priceCell.className = "order-price";
    const lineTotal = (it.qty * (it.price||0));
    priceCell.textContent = `€${lineTotal.toFixed(2)}`;

    row.appendChild(nameCell);
    row.appendChild(priceCell);

    // Long press per dividere TEMPO
    let pressTimer;
    if(it.name === "TEMPO"){
      row.ontouchstart = row.onmousedown = (e)=> {
        pressTimer = setTimeout(()=> {
          openDivideTempoPopup(i, it);
        }, 800);
      };
      row.ontouchend = row.onmouseup = row.ontouchcancel = ()=> {
        clearTimeout(pressTimer);
      };
    }
    
    row.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.warning);
      
      // Rimuovi dal refillList se è un prodotto REFILL
      const item = items[i];
      let productName = item.name;
      
      // Rimuovi modificatori dal nome del prodotto
      modifiersList.forEach(mod => {
        productName = productName.replace(new RegExp('\\s+' + mod + '$'), '');
      });
      
      const isRefill = isRefillProductName(productName);
      if(isRefill && refillList[productName]){
        refillList[productName] -= (item.qty || 1);
        if(refillList[productName] <= 0){
          delete refillList[productName];
        }
        console.log('Removed from refillList:', productName, '=', refillList[productName] || 0);
      }
      
      if(accontoMode){
        accontoMode = false;
        const cat = detectCategory(item.name);
        if(cat && totals[cat] !== undefined){
          totals[cat] += (item.price || 0) * (item.qty || 1);
        }
        items.splice(i,1);
        if(items.length === 0 && currentTarget.type === 'saved'){
          const idx = savedOrders.findIndex(s=>s.id === currentTarget.id);
          if(idx !== -1) savedOrders.splice(idx,1);
          closePopup();
        } else {
          renderOrderList();
        }
        saveData();
      } else {
        items.splice(i,1);
        renderOrderList();
        saveData();
      }
    };

    orderList.appendChild(row);
  });
}

/* Dividi TEMPO */
function openDivideTempoPopup(itemIndex, item){
  const items = getEditingItems();
  
  showConfirm(
    `Dividi €${item.price.toFixed(2)} in quante parti?`,
    null,
    'Dividi TEMPO',
    true,
    (parts) => {
      if(parts && parts > 1){
        const pricePerPart = item.price / parts;
        // Rimuovi il TEMPO originale
        items.splice(itemIndex, 1);
        // Aggiungi i nuovi TEMPO divisi
        for(let i = 0; i < parts; i++){
          items.push({
            name: "TEMPO",
            qty: 1,
            price: pricePerPart,
            timestamp: Date.now()
          });
        }
        renderOrderList();
        saveData();
      }
    }
  );
}

/* create saved */
function createSavedFromTable(){
  if(currentTarget.type !== 'table') return;
  const items = getEditingItems();
  if(!items || items.length===0){
    return;
  }
  
  const tableName = tableNames[currentTarget.id];
  
  // Cerca se esiste già un ordine salvato con lo stesso nome
  const existingOrder = savedOrders.find(s => s.tableName === tableName);
  
  if(existingOrder){
    // Aggiungi i prodotti all'ordine esistente
    existingOrder.items.push(...JSON.parse(JSON.stringify(items)));
  } else {
    // Crea un nuovo ordine salvato
    const id = Date.now().toString(36);
    savedOrders.push({ id, tableName, items: JSON.parse(JSON.stringify(items)) });
  }
  
  tableOrders[currentTarget.id] = [];
  renderOrderList();
  renderSavedButtons();
  closePopup();
  saveData();
}

/* tempo pad */
function openTempoPad(){
  tempoValue = "";
  if(tempoDisplay) tempoDisplay.value = "";
  subcatsDiv.innerHTML = "";
  tempoPad.classList.remove('hidden');
}
document.getElementById('tempo-numpad').addEventListener('click', e=>{
  if(!e.target.matches('button')) return;
  const k = e.target.dataset.key;
  if(!k) return;
  if(k === '.'){
    if(tempoValue.includes('.')) return;
    if(tempoValue === "") tempoValue = "0.";
    else tempoValue += '.';
  } else {
    if(tempoValue.length >= 9) return;
    tempoValue += k;
  }
  tempoDisplay.value = tempoValue || "0";
});
document.getElementById('tempo-ok').addEventListener('click', ()=>{
  const v = parseFloat(tempoValue);
  if(isNaN(v) || v <= 0){ return; }
  addCatalogProduct("TEMPO", v);
  tempoValue = "";
  tempoDisplay.value = "";
  tempoPad.classList.add('hidden');
});

/* cassa pad */
function openCassaPad(){
  cassaValue = "";
  if(cassaDisplay) cassaDisplay.value = "0";
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.remove('hidden');
}
document.getElementById('cassa-numpad').addEventListener('click', e=>{
  if(!e.target.matches('button')) return;
  const k = e.target.dataset.key;
  if(!k) return;
  if(k === 'C'){
    cassaValue = "";
    cassaDisplay.value = "0";
    return;
  }
  if(k === '.'){
    if(cassaValue.includes('.')) return;
    if(cassaValue === "") cassaValue = "0.";
    else cassaValue += '.';
  } else {
    if(cassaValue.length >= 9) return;
    cassaValue += k;
  }
  cassaDisplay.value = cassaValue || "0";
});
document.getElementById('cassa-entrata').addEventListener('click', ()=>{
  const v = parseFloat(cassaValue);
  if(isNaN(v) || v <= 0){ return; }
  addCatalogProduct("ENTRATA CASSA", v);
  cassaValue = "";
  cassaDisplay.value = "0";
  cassaPad.classList.add('hidden');
});
document.getElementById('cassa-uscita').addEventListener('click', ()=>{
  const v = parseFloat(cassaValue);
  if(isNaN(v) || v <= 0){ return; }
  addCatalogProduct("USCITA CASSA", -v);
  cassaValue = "";
  cassaDisplay.value = "0";
  cassaPad.classList.add('hidden');
});

/* pagamento riepilogo */
function paySavedOrder(savedId){
  const idx = savedOrders.findIndex(s=>s.id === savedId);
  if(idx === -1) return;
  const saved = savedOrders[idx];
  // Salva negli evasi
  if(saved.items && saved.items.length > 0){
    evasiOrders.push({
      id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
      tableName: saved.tableName,
      tableIndex: null,
      items: JSON.parse(JSON.stringify(saved.items)),
      timestamp: new Date().toISOString(),
      dateLabel: new Date().toLocaleString()
    });
  }
  saved.items.forEach(it=>{
    const cat = detectCategory(it.name);
    if(cat && totals[cat] !== undefined){
      totals[cat] += (it.price || 0) * (it.qty || 1);
    }
  });
  savedOrders.splice(idx,1);
  renderSavedButtons();
  closePopup();
  saveData();
}

/* Totali popup */
function openTotals(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'none';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  Object.keys(totals).forEach(k=>{
    const row = document.createElement('div');
    row.className = "order-row";
    const nameCell = document.createElement('div');
    nameCell.className = "order-name";
    nameCell.textContent = k.toUpperCase();
    const priceCell = document.createElement('div');
    priceCell.className = "order-price";
    priceCell.textContent = `€${totals[k].toFixed(2)}`;
    row.appendChild(nameCell);
    row.appendChild(priceCell);
    orderList.appendChild(row);
  });

  const total = Object.values(totals).reduce((a,b)=>a+b,0).toFixed(2);
  const totRow = document.createElement('div');
  totRow.className = "order-row";
  totRow.style.fontWeight = '700';
  const nameCell = document.createElement('div');
  nameCell.className = "order-name";
  nameCell.textContent = "TOTALE COMPLESSIVO";
  const priceCell = document.createElement('div');
  priceCell.className = "order-price";
  priceCell.textContent = `€${total}`;
  totRow.appendChild(nameCell);
  totRow.appendChild(priceCell);
  orderList.appendChild(totRow);

  actionsDiv.innerHTML = "";
  const reset = document.createElement('button');
  reset.textContent = "Reset Totali";
  reset.onclick = ()=> {
    showConfirm('Confermi il reset dei totali?', ()=>{
      exportTotalsToCSV();
      // salva nello storico con timestamp ISO e label leggibile
      storico.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        dateISO: new Date().toISOString(),
        dateLabel: new Date().toLocaleString(),
        totali: {...totals},
        totale: parseFloat(total)
      });
      Object.keys(totals).forEach(k=>totals[k]=0);
      saveData();
      openTotals();
    }, 'Reset Totali');
  };
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(reset);
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Totali";
  showPopup();
}

/* Evasi */
function openEvasi(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'none';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  if(!evasiOrders || evasiOrders.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun ordine evaso";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    orderList.appendChild(empty);
  } else {
    // mostra dal più recente
    evasiOrders.slice().reverse().forEach(entry=>{
      const box = document.createElement('div');
      box.style.border = "1px solid #444";
      box.style.borderRadius = "6px";
      box.style.padding = "12px";
      box.style.marginBottom = "8px";

      const titolo = document.createElement('div');
      titolo.style.fontWeight = "700";
      titolo.style.marginBottom = "8px";
      const totalOrder = entry.items.reduce((sum, it) => sum + ((it.price || 0) * (it.qty || 1)), 0);
      titolo.textContent = `${entry.tableName} — ${entry.dateLabel} — €${totalOrder.toFixed(2)}`;
      box.appendChild(titolo);

      const itemsList = document.createElement('div');
      itemsList.style.fontSize = "14px";
      itemsList.style.marginBottom = "8px";
      entry.items.forEach(it=>{
        const itemDiv = document.createElement('div');
        itemDiv.textContent = `${it.qty} × ${it.name} — €${((it.price||0) * (it.qty||1)).toFixed(2)}`;
        itemsList.appendChild(itemDiv);
      });
      box.appendChild(itemsList);

      const actionsBox = document.createElement('div');
      actionsBox.style.display = "flex";
      actionsBox.style.gap = "8px";
      actionsBox.style.marginTop = "8px";

      const restoreBtn = document.createElement('button');
      restoreBtn.textContent = "Ripristina";
      restoreBtn.style.background = "#00aa00";
      restoreBtn.onclick = ()=> {
        showConfirm('Confermi il ripristino di questo ordine?', ()=>{
          // Ripristina l'ordine
          if(entry.tableIndex !== null && entry.tableIndex !== undefined){
            // Ripristina su tavolo
            if(!tableOrders[entry.tableIndex]) tableOrders[entry.tableIndex] = [];
            tableOrders[entry.tableIndex].push(...JSON.parse(JSON.stringify(entry.items)));
          } else {
            // Ripristina come ordine salvato
            const newId = Date.now().toString(36);
            savedOrders.push({
              id: newId,
              tableName: entry.tableName,
              items: JSON.parse(JSON.stringify(entry.items))
            });
          }
          // Rimuovi dai totali
          entry.items.forEach(it=>{
            const cat = detectCategory(it.name);
            if(cat && totals[cat] !== undefined){
              totals[cat] -= (it.price || 0) * (it.qty || 1);
              if(totals[cat] < 0) totals[cat] = 0;
            }
          });
          // Rimuovi dagli evasi
          const idx = evasiOrders.findIndex(e=>e.id === entry.id);
          if(idx !== -1) evasiOrders.splice(idx,1);
          saveData();
          renderTables();
          renderSavedButtons();
          closePopup();
        }, 'Ripristina Ordine');
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = "Elimina";
      delBtn.style.background = "#aa0000";
      delBtn.onclick = ()=> {
        showConfirm('Confermi l\'eliminazione di questo ordine?', ()=>{
          const idx = evasiOrders.findIndex(e=>e.id === entry.id);
          if(idx !== -1) evasiOrders.splice(idx,1);
          saveData();
          openEvasi();
        }, 'Elimina Ordine');
      };

      actionsBox.appendChild(restoreBtn);
      actionsBox.appendChild(delBtn);
      box.appendChild(actionsBox);

      orderList.appendChild(box);
    });
  }

  actionsDiv.innerHTML = "";
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = "Reset Evasi";
  resetBtn.style.background = "#aa0000";
  resetBtn.onclick = ()=> {
    if(evasiOrders.length === 0){
      return;
    }
    showConfirm('Confermi il reset degli ordini evasi?', ()=>{
      exportEvasiToCSV();
      evasiOrders = [];
      saveData();
      openEvasi();
    }, 'Reset Evasi');
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Ordini Evasi";
  showPopup();
}

function exportEvasiToCSV(){
  try {
    let csv = "Data;Tavolo;Categoria;Prodotto;Quantità;Prezzo Unitario;Totale\n";
    
    evasiOrders.forEach(order => {
      const dateStr = order.dateLabel || order.timestamp || "";
      order.items.forEach(item => {
        const qty = item.qty || 1;
        const price = item.price || 0;
        const total = qty * price;
        const cat = (detectCategory(item.name) || "").toUpperCase();
        csv += `"${dateStr}";"${order.tableName}";"${cat}";"${item.name}";${qty};${price.toFixed(2).replace('.', ',')};${total.toFixed(2).replace('.', ',')}\n`;
      });
    });
    
    // Calcola totale complessivo
    const totalComplessivo = evasiOrders.reduce((sum, order) => {
      return sum + order.items.reduce((orderSum, item) => {
        return orderSum + ((item.price || 0) * (item.qty || 1));
      }, 0);
    }, 0);
    
    csv += `\n"TOTALE COMPLESSIVO";"";"";"";"";"";
${totalComplessivo.toFixed(2).replace('.', ',')}\n`;
    
    // Prova invio a Kodular / AppInventor
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      AppInventor.setWebViewString("SAVE_EVASI_CSV::" + csv);
      setTimeout(() => {
        AppInventor.setWebViewString("SAVE_EVASI_CSV_DONE");
      }, 100);
      return;
    }
    
    // Scarica il file CSV
    downloadCSV(csv, 'evasi');
    
  } catch(e) {
    console.error("Errore exportEvasiToCSV:", e);
  }
}

/* Apply Background */
function applyBackground(){
  document.body.style.background = `#000 url("${currentBackground}") no-repeat center center fixed`;
  document.body.style.backgroundSize = 'cover';
  const popupContents = document.querySelectorAll('.popup-content, .confirm-box');
  popupContents.forEach(el => {
    el.style.background = `#000 url("${currentBackground}") no-repeat center center`;
    el.style.backgroundSize = 'cover';
  });
}

/* Settings */
function openSettings(){
  console.log('🔧 openSettings() chiamata');
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  // Aggiungi classe fullscreen al popup e popup-content
  popup.classList.add('fullscreen-popup');
  const popupContent = document.querySelector('.popup-content');
  if(popupContent) popupContent.classList.add('fullscreen');

  const mainTitle = document.createElement('div');
  mainTitle.textContent = "Impostazioni";
  mainTitle.style.fontWeight = "700";
  mainTitle.style.fontSize = "24px";
  mainTitle.style.marginBottom = "20px";
  mainTitle.style.textAlign = "center";
  orderList.appendChild(mainTitle);

  // Menu opzioni
  const menuOptions = [
    {name: "🎨 Cambia Sfondo", action: openBackgroundSettings},
    {name: "⚙️ Personalizza Tasti", action: openCustomizeFontSettings},
    {name: "📁 Gestisci Categorie", action: openCategorySettings},
    {name: "📂 Gestisci Sottocategorie", action: openSubcategorySettings},
    {name: "🏷️ Gestisci Modificatori", action: openModifierSettings}
  ];

  menuOptions.forEach(option => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "20px";
    box.style.marginBottom = "15px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.transition = "all 0.2s";
    box.style.textAlign = "center";
    box.style.fontSize = "20px";
    box.style.fontWeight = "700";
    box.textContent = option.name;
    
    box.onclick = option.action;
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Settings";
  showPopup();
}

/* Background Settings */
function openBackgroundSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli lo sfondo:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const backgrounds = [
    {name: "1", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4"},
    {name: "2", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000178-38e6a38e6c/3.jpeg?ph=03d98711d4"},
    {name: "3", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000179-4670746709/2.jpeg?ph=03d98711d4"},
    {name: "4", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000182-5d7cd5d7cf/1.jpeg?ph=03d98711d4"},
    {name: "5", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000181-5763f57641/4.jpeg?ph=03d98711d4"},
    {name: "6", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000187-0e93e0e941/6.jpeg?ph=03d98711d4"},
    {name: "7", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000217-4a8a34a8a5/7.jpeg?ph=03d98711d4"},
    {name: "8", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000216-3922339225/8.jpeg?ph=03d98711d4"},
    {name: "9", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000218-5f7365f737/9.jpeg?ph=03d98711d4"},
    {name: "10", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000215-3c49c3c49d/10.jpeg?ph=03d98711d4"},
    {name: "11", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000224-a2003a2005/14?ph=03d98711d4"},
    {name: "12", url: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExOWp1dXFvc2dlb2d4cjc2N3NxdjN6emwwOHN1aXJ0MzA3Nmhmc3B6NiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/YTEQrKe1bBPcDdKKtA/giphy.gif"},
    {name: "13", url: "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWU0OWxtbXBwdXExYm1heDlta3pkdndiNW9wMm54amcxNHA3ajdiZiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/12qHWnTUBzLWXS/giphy.gif"},
    {name: "14", url: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWFtZGViOHp3aWNwdGE5cWc5ZzdmNjhvenY4ZXVyeXF2OXYzM3JtbSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/TnDoEoXfT7YoE/giphy.gif"},
    {name: "15", url: "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdmhxdHMxdW02NWZ0MG9hajRxNzVmMWI2c24wbG9manM3bzlrenBrbiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/XAe9aDBIv3arS/giphy.gif"},
    {name: "16", url: "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExZHNrYXA4ZmcwbjUzbTBoaXJrZGs0Nmo2MHVvamQ5ZWwxNnl4dHdseiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/q2DwjOrFktA3r3cd5D/giphy.gif"},
    {name: "17", url: "https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExdTdkY2l2Mjl0Ym1ndTlpZmtkZTNsaGtqc2pkNHp2dDF4OHgzcHlxeSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/nIufcLJ4tPe5Zosc6t/giphy.gif"},
    {name: "18", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExbmttb2VrZmNvdDVqN3EwNjlpb2oxdDAyMXpib3I2b3N2cHRkaGZ4bCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/jTAmP5GWEZpQ8ZZyF1/giphy.gif"},
    {name: "19", url: "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExaGpwdGVjbzc5eHYweDd4ZDBnODRlMTVtdDczajVmcjZzYmdheTN0YiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l5JbspfwZ0yjHjlJ0K/giphy.gif"},
    {name: "20", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExN25yZ3d4bXJ6NGV3bmozYnF0N3pkZWRtZ3E4enl2dGp3djM3bmhoMCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/jaOXKCxtBPLieRLI0c/giphy.gif"},
    {name: "21", url: "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExMnA3Z2UwNHBxMDJ1cTJ4eWw0YjBwYTEwNHJlaGR6YjA4ZHo5cDdrZiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/ui1VQlTo0FvHrdwJD7/giphy.gif"},
    {name: "22", url: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZmsza2lqNXB1b2t0dHJyN2RrZXpwNWVpNzdlbjdrajlxeWRjNHk0ciZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/uFmH8za4E6M5STIiTu/giphy.gif"},
    {name: "23", url: "https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExZWlvcTBkYndmbWUzMXIxOHU4YXJnZmlrcjV2cHBpOHlwanZmaHAyeiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/MqlVfYDenvazq5MgeK/giphy.gif"},
    {name: "24", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExN2tqeDZpNngwY3hhM29ncno0NHJ0Z3U4am5xM2dtNjhobm1zcWdqdCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/EyiufcIwTdF35pNIFS/giphy.gif"},
    {name: "25", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExeXJ5bno3ZHg1eWppcmE5c3kyZDZuNWRraG42enFkMGJwb3Z1cXd6NyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/qyUJmARdRq7HlQgT5Z/giphy.gif"},
    {name: "26", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExbnRmdGgydGN5cHFsZzVqNXN5MHR4bzA4Yjd2ZjR2eGU1M2pndTkxaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Svoz9fOVe8lOYfwTYG/giphy.gif"},
    {name: "27", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExaW1nbnB6eWcyNWc5Y2VncG5zdXB4NjN5b3Y0Mm11Nnczbzh0bGJreSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/XEgWz1vwDjzlLVCx04/giphy.gif"}
  ];

  backgrounds.forEach(bg => {
    const box = document.createElement('div');
    box.style.border = currentBackground === bg.url ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.transition = "all 0.2s";
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = bg.name;
    nameDiv.style.fontSize = "16px";
    nameDiv.style.fontWeight = "700";
    box.appendChild(nameDiv);
    
    box.onclick = ()=> {
      currentBackground = bg.url;
      applyBackground();
      saveData();
      openSettings();
    };
    
    box.onmouseenter = ()=> {
      if(currentBackground !== bg.url) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(currentBackground !== bg.url) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "← Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Sfondi";
  showPopup();
}

/* Font Settings */
function openFontSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli il font:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const fonts = [
    {name: "Arial", value: "Arial, Helvetica, sans-serif"},
    {name: "Times New Roman", value: "Times New Roman, Times, serif"},
    {name: "Courier New", value: "Courier New, Courier, monospace"},
    {name: "Georgia", value: "Georgia, serif"},
    {name: "Verdana", value: "Verdana, Geneva, sans-serif"},
    {name: "Comic Sans MS", value: "Comic Sans MS, cursive"},
    {name: "Impact", value: "Impact, Charcoal, sans-serif"},
    {name: "Trebuchet MS", value: "Trebuchet MS, sans-serif"},
    {name: "Palatino", value: "Palatino Linotype, Book Antiqua, Palatino, serif"},
    {name: "Lucida Console", value: "Lucida Console, Monaco, monospace"},
    {name: "Mountains of Christmas", value: "'Mountains of Christmas', cursive"},
    {name: "Dokdo", value: "'Dokdo', cursive"},
    {name: "Rubik Vinyl", value: "'Rubik Vinyl', cursive"},
    {name: "Irish Grover", value: "'Irish Grover', cursive"},
    {name: "Rampart One", value: "'Rampart One', cursive"},
    {name: "Cherry Cream Soda", value: "'Cherry Cream Soda', cursive"},
    {name: "Permanent Marker", value: "'Permanent Marker', cursive"},
    {name: "Swanky and Moo Moo", value: "'Swanky and Moo Moo', cursive"},
    {name: "Caveat Brush", value: "'Caveat Brush', cursive"},
    {name: "Bangers", value: "'Bangers', cursive"},
    {name: "Knewave", value: "'Knewave', cursive"},
    {name: "DynaPuff", value: "'DynaPuff', cursive"},
    {name: "Indie Flower", value: "'Indie Flower', cursive"}
  ];

  fonts.forEach(font => {
    const box = document.createElement('div');
    box.style.border = currentFont === font.value ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontFamily = font.value;
    box.style.fontSize = "18px";
    box.style.fontWeight = "700";
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = font.name;
    box.appendChild(nameDiv);
    
    box.onclick = ()=> {
      currentFont = font.value;
      applyFont();
      saveData();
      openFontSettings();
    };
    
    box.onmouseenter = ()=> {
      if(currentFont !== font.value) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(currentFont !== font.value) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Cambia Font";
  showPopup();
}

function applyFont(){
  document.body.style.fontFamily = currentFont;
  document.body.style.fontSize = currentFontSize + 'px';
  
  // Calcola il fattore di scala rispetto alla dimensione base (16px)
  const scaleFactor = currentFontSize / 16;
  
  // Applica la scala a tutti gli elementi
  const style = document.createElement('style');
  style.id = 'dynamic-font-size';
  
  // Rimuovi lo style precedente se esiste
  const oldStyle = document.getElementById('dynamic-font-size');
  if(oldStyle) oldStyle.remove();
  
  style.textContent = `
    /* Applica font globale */
    body, input, select, textarea, div {
      font-family: ${currentFont} !important;
    }
    
    /* Bottoni utility (TOTALI, STORICO, EVASI, SETTINGS, REFILL, SPESA) */
    button.utility-btn,
    .utility-btn {
      font-family: ${fontSettings.utility.font} !important;
      font-size: ${fontSettings.utility.size}px !important;
      padding: ${fontSettings.utility.padding}px !important;
    }
    
    /* Bottoni tavoli (TAV-1, TAV-2, BANCO, SALA, SALAF, +) */
    button.table-btn,
    .table-btn {
      font-family: ${fontSettings.tavoli.font} !important;
      font-size: ${fontSettings.tavoli.size}px !important;
      padding: ${fontSettings.tavoli.padding}px !important;
    }
    
    /* Bottoni ordini salvati */
    #saved-orders button {
      font-family: ${fontSettings.ordiniSalvati.font} !important;
      font-size: ${fontSettings.ordiniSalvati.size}px !important;
      padding: ${fontSettings.ordiniSalvati.padding}px !important;
    }
    
    /* Categorie */
    .cat-btn {
      font-family: ${fontSettings.categorie.font} !important;
      font-size: ${fontSettings.categorie.size}px !important;
      padding: ${fontSettings.categorie.padding}px !important;
    }
    
    /* Sottocategorie */
    .subcat-btn {
      font-family: ${fontSettings.sottocategorie.font} !important;
      font-size: ${fontSettings.sottocategorie.size}px !important;
      padding: ${fontSettings.sottocategorie.padding}px !important;
    }
    
    /* Modificatori */
    .modifiers button {
      font-family: ${fontSettings.modificatori.font} !important;
      font-size: ${fontSettings.modificatori.size}px !important;
      padding: ${fontSettings.modificatori.padding}px !important;
    }
    
    /* Bottoni azioni (Pagato, Acconto, ecc.) */
    .actions button {
      font-family: ${fontSettings.azioni.font} !important;
      font-size: ${fontSettings.azioni.size}px !important;
      padding: ${fontSettings.azioni.padding}px !important;
    }
    
    /* Ordini nella lista */
    .order-row, .order-name, .order-price {
      font-family: ${fontSettings.ordini.font} !important;
      font-size: ${fontSettings.ordini.size}px !important;
    }
    
    /* Popup conferma */
    .confirm-box, .confirm-box h3, .confirm-box p, .confirm-buttons button {
      font-family: ${fontSettings.conferma.font} !important;
    }
    .confirm-box h3 {
      font-size: ${fontSettings.conferma.size + 4}px !important;
    }
    .confirm-box p {
      font-size: ${fontSettings.conferma.size}px !important;
    }
    .confirm-buttons button {
      font-size: ${fontSettings.conferma.size}px !important;
    }
    
    
    /* Titoli popup */
    .popup-header h3 {
      font-size: ${20 * scaleFactor}px !important;
    }
    
    /* Numpad */
    .numpad button {
      font-size: ${18 * scaleFactor}px !important;
      padding: ${14 * scaleFactor}px !important;
    }
    
    /* Bottoni generici */
    button {
      font-size: ${16 * scaleFactor}px !important;
      padding: ${12 * scaleFactor}px !important;
    }
    
    /* Column titles */
    .column-title {
      font-size: ${18 * scaleFactor}px !important;
    }

    /* Colori per categoria (testo) */
    /* Bottoni utility (TOTALI, STORICO, EVASI, SETTINGS, REFILL, SPESA) */
    button.utility-btn,
    .utility-btn { 
      color: ${fontSettings.utility?.color || '#ffffff'} !important; 
    }
    /* Bottoni tavoli (TAV-1, TAV-2, ecc., BANCO, SALA, SALAF, +) */
    button.table-btn,
    .table-btn { 
      color: ${fontSettings.tavoli?.color || '#ffffff'} !important; 
    }
    /* Bottoni ordini salvati */
    #saved-orders button { 
      color: ${fontSettings.ordiniSalvati?.color || '#ffffff'} !important; 
    }
    /* Bottoni categorie nel popup */
    button.cat-btn,
    .cat-btn,
    .categories-grid button { 
      color: ${fontSettings.categorie?.color || '#ffffff'} !important; 
    }
    /* Bottoni sottocategorie */
    button.subcat-btn,
    .subcat-btn { 
      color: ${fontSettings.sottocategorie?.color || '#ffffff'} !important; 
    }
    /* Modificatori */
    #modifiers button,
    .modifiers button { 
      color: ${fontSettings.modificatori?.color || '#ffffff'} !important; 
    }
    /* Azioni dell'ordine */
    #actions button,
    .actions button { 
      color: ${fontSettings.azioni?.color || '#ffffff'} !important; 
    }
    /* Lista ordini */
    #order-list,
    #order-list .order-row,
    #order-list .order-name,
    #order-list .order-price { 
      color: ${fontSettings.ordini?.color || '#ffffff'} !important; 
    }
    /* Popup conferma */
    .confirm-box,
    .confirm-box h3,
    .confirm-box p,
    #confirm-popup .confirm-buttons button { 
      color: ${fontSettings.conferma?.color || '#ffffff'} !important; 
    }
  `;
  
  document.head.appendChild(style);
}

/* Font Size Settings */
function openFontSizeSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli la dimensione del testo:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const currentSizeDisplay = document.createElement('div');
  currentSizeDisplay.textContent = `Dimensione attuale: ${currentFontSize}px`;
  currentSizeDisplay.style.fontSize = "16px";
  currentSizeDisplay.style.marginBottom = "20px";
  currentSizeDisplay.style.textAlign = "center";
  currentSizeDisplay.style.padding = "10px";
  currentSizeDisplay.style.background = "#222";
  currentSizeDisplay.style.borderRadius = "8px";
  orderList.appendChild(currentSizeDisplay);

  const sizes = [
    {name: "Molto Piccolo", value: 12},
    {name: "Piccolo", value: 14},
    {name: "Normale", value: 16},
    {name: "Grande", value: 18},
    {name: "Molto Grande", value: 20},
    {name: "Extra Grande", value: 24}
  ];

  sizes.forEach(size => {
    const box = document.createElement('div');
    box.style.border = currentFontSize === size.value ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = size.value + "px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    
    box.textContent = `${size.name} (${size.value}px)`;
    
    box.onclick = ()=> {
      currentFontSize = size.value;
      applyFont();
      saveData();
      openFontSizeSettings();
    };
    
    box.onmouseenter = ()=> {
      if(currentFontSize !== size.value) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(currentFontSize !== size.value) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Dimensione Testo";
  showPopup();
}

/* Customize Font Settings */
function openCustomizeFontSettings(){
  console.log('🎨 openCustomizeFontSettings() chiamata');
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "🎨 Personalizza Tasti per Categoria";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "20px";
  title.style.textAlign = "center";
  orderList.appendChild(title);

  const categories = [
    {key: "utility", label: "🔧 Bottoni Utility", desc: "TOTALI, STORICO, EVASI, SETTINGS"},
    {key: "tavoli", label: "🎯 Bottoni Tavoli", desc: "TAV-1, TAV-2, BANCO, SALA, SALAF"},
    {key: "ordiniSalvati", label: "💾 Ordini Salvati", desc: "Bottoni in alto a sinistra"},
    {key: "categorie", label: "📋 Categorie", desc: "CAFFÈ, SPINA, FRIGO, SUPER, SNACK"},
    {key: "sottocategorie", label: "📝 Sottocategorie", desc: "GRAPPA, SAMBUCA, APEROL, ecc."},
    {key: "modificatori", label: "🏷️ Modificatori", desc: "SR, M, K, S, GH"},
    {key: "azioni", label: "⚡ Azioni", desc: "PAGATO, ACCONTO, DONE, CHIUDI"},
    {key: "ordini", label: "📄 Lista Ordini", desc: "Prodotti e prezzi nell'ordine"},
    {key: "conferma", label: "✅ Popup Conferma", desc: "Dialoghi di conferma"},
    {key: "refill", label: "🔄 REFILL", desc: "Bottoni nel popup REFILL"}
  ];

  categories.forEach(cat => {
    const section = document.createElement('div');
    section.className = `customize-section customize-${cat.key}`;
    section.style.marginBottom = "12px";
    section.style.padding = "12px";
    section.style.background = "#222";
    section.style.borderRadius = "8px";
    section.style.border = "2px solid #444";
    
    const header = document.createElement('div');
    header.className = `customize-header customize-header-${cat.key}`;
    header.textContent = cat.label;
    header.style.fontWeight = "700";
    header.style.fontSize = "16px";
    header.style.marginBottom = "5px";
    section.appendChild(header);
    
    const desc = document.createElement('div');
    desc.className = `customize-desc customize-desc-${cat.key}`;
    desc.textContent = cat.desc;
    desc.style.fontSize = "12px";
    desc.style.color = "#aaa";
    desc.style.marginBottom = "10px";
    section.appendChild(desc);
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = `customize-buttons customize-buttons-${cat.key}`;
    buttonsDiv.style.display = "grid";
    buttonsDiv.style.gridTemplateColumns = "repeat(4, 1fr)";
    buttonsDiv.style.gap = "6px";
    
    // Font
    const fontBtn = document.createElement('button');
    fontBtn.className = `customize-btn customize-font-btn customize-font-${cat.key}`;
    fontBtn.textContent = "Font";
    fontBtn.style.padding = "8px 4px";
    fontBtn.style.fontSize = "12px";
    fontBtn.onclick = ()=> openSelectFont(cat.key, cat.label);
    
    // Dimensione  
    const sizeBtn = document.createElement('button');
    sizeBtn.className = `customize-btn customize-size-btn customize-size-${cat.key}`;
    sizeBtn.textContent = "Size";
    sizeBtn.style.padding = "8px 4px";
    sizeBtn.style.fontSize = "12px";
    sizeBtn.onclick = ()=> openSelectSize(cat.key, cat.label);
    
    // Padding
    const paddingBtn = document.createElement('button');
    paddingBtn.className = `customize-btn customize-padding-btn customize-padding-${cat.key}`;
    paddingBtn.textContent = "Pad";
    paddingBtn.style.padding = "8px 4px";
    paddingBtn.style.fontSize = "12px";
    paddingBtn.onclick = ()=> openSelectPadding(cat.key, cat.label);
    
    // Colore
    const colorBtn = document.createElement('button');
    colorBtn.className = `customize-btn customize-color-btn customize-color-${cat.key}`;
    colorBtn.textContent = "Color";
    colorBtn.style.padding = "8px 4px";
    colorBtn.style.fontSize = "12px";
    colorBtn.onclick = ()=> openSelectColor(cat.key, cat.label);
    
    buttonsDiv.appendChild(fontBtn);
    buttonsDiv.appendChild(sizeBtn);
    buttonsDiv.appendChild(paddingBtn);
    buttonsDiv.appendChild(colorBtn);
    section.appendChild(buttonsDiv);
    
    orderList.appendChild(section);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.className = "customize-back-btn";
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Personalizza Tasti";
  showPopup();
}

function openSelectFont(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli il font per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const fonts = [
    {name: "Arial", value: "Arial, Helvetica, sans-serif"},
    {name: "Times New Roman", value: "Times New Roman, Times, serif"},
    {name: "Courier New", value: "Courier New, Courier, monospace"},
    {name: "Georgia", value: "Georgia, serif"},
    {name: "Verdana", value: "Verdana, Geneva, sans-serif"},
    {name: "Comic Sans MS", value: "Comic Sans MS, cursive"},
    {name: "Impact", value: "Impact, Charcoal, sans-serif"},
    {name: "Trebuchet MS", value: "Trebuchet MS, sans-serif"},
    {name: "Palatino", value: "Palatino Linotype, Book Antiqua, Palatino, serif"},
    {name: "Lucida Console", value: "Lucida Console, Monaco, monospace"},
    {name: "Mountains of Christmas", value: "'Mountains of Christmas', cursive"},
    {name: "Dokdo", value: "'Dokdo', cursive"},
    {name: "Rubik Vinyl", value: "'Rubik Vinyl', cursive"},
    {name: "Irish Grover", value: "'Irish Grover', cursive"},
    {name: "Rampart One", value: "'Rampart One', cursive"},
    {name: "Cherry Cream Soda", value: "'Cherry Cream Soda', cursive"},
    {name: "Permanent Marker", value: "'Permanent Marker', cursive"},
    {name: "Swanky and Moo Moo", value: "'Swanky and Moo Moo', cursive"},
    {name: "Caveat Brush", value: "'Caveat Brush', cursive"},
    {name: "Bangers", value: "'Bangers', cursive"},
    {name: "Knewave", value: "'Knewave', cursive"},
    {name: "DynaPuff", value: "'DynaPuff', cursive"},
    {name: "Indie Flower", value: "'Indie Flower', cursive"}
  ];

  fonts.forEach(font => {
    const box = document.createElement('div');
    box.style.border = fontSettings[category].font === font.value ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontFamily = font.value;
    box.style.fontSize = "18px";
    box.style.fontWeight = "700";
    box.textContent = font.name;
    
    box.onclick = ()=> {
      fontSettings[category].font = font.value;
      applyFont();
      saveData();
        openSelectFont(category, label);
    };
    
    box.onmouseenter = ()=> {
      if(fontSettings[category].font !== font.value) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(fontSettings[category].font !== font.value) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Seleziona Font";
  showPopup();
}

function openSelectSize(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli la dimensione per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const sizes = [10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 36, 40];

  sizes.forEach(size => {
    const box = document.createElement('div');
    box.style.border = fontSettings[category].size === size ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = size + "px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${size}px`;
    
    box.onclick = ()=> {
      fontSettings[category].size = size;
      applyFont();
      saveData();
        openSelectSize(category, label);
    };
    
    box.onmouseenter = ()=> {
      if(fontSettings[category].size !== size) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(fontSettings[category].size !== size) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Seleziona Dimensione";
  showPopup();
}

function openSelectPadding(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli il padding per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);
  
  const infoDiv = document.createElement('div');
  infoDiv.textContent = "Il padding è lo spazio interno tra il bordo del bottone e il testo";
  infoDiv.style.fontSize = "14px";
  infoDiv.style.marginBottom = "20px";
  infoDiv.style.textAlign = "center";
  infoDiv.style.padding = "10px";
  infoDiv.style.background = "#222";
  infoDiv.style.borderRadius = "8px";
  infoDiv.style.color = "#aaa";
  orderList.appendChild(infoDiv);

  const paddings = [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30];

  paddings.forEach(padding => {
    const box = document.createElement('div');
    box.style.border = fontSettings[category].padding === padding ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = padding + "px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = "16px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${padding}px`;
    
    box.onclick = ()=> {
      fontSettings[category].padding = padding;
      applyFont();
      saveData();
        openSelectPadding(category, label);
    };
    
    box.onmouseenter = ()=> {
      if(fontSettings[category].padding !== padding) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(fontSettings[category].padding !== padding) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Seleziona Padding";
  showPopup();
}

/* Funzioni per modificare TUTTE le categorie insieme */
function openSelectFontForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli il font per TUTTE le categorie:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const fonts = [
    {name: "Arial", value: "Arial, Helvetica, sans-serif"},
    {name: "Times New Roman", value: "Times New Roman, Times, serif"},
    {name: "Courier New", value: "Courier New, Courier, monospace"},
    {name: "Georgia", value: "Georgia, serif"},
    {name: "Verdana", value: "Verdana, Geneva, sans-serif"},
    {name: "Comic Sans MS", value: "Comic Sans MS, cursive"},
    {name: "Impact", value: "Impact, Charcoal, sans-serif"},
    {name: "Trebuchet MS", value: "Trebuchet MS, sans-serif"},
    {name: "Palatino", value: "Palatino Linotype, Book Antiqua, Palatino, serif"},
    {name: "Lucida Console", value: "Lucida Console, Monaco, monospace"},
    {name: "Mountains of Christmas", value: "'Mountains of Christmas', cursive"},
    {name: "Dokdo", value: "'Dokdo', cursive"},
    {name: "Rubik Vinyl", value: "'Rubik Vinyl', cursive"},
    {name: "Irish Grover", value: "'Irish Grover', cursive"},
    {name: "Rampart One", value: "'Rampart One', cursive"},
    {name: "Cherry Cream Soda", value: "'Cherry Cream Soda', cursive"},
    {name: "Permanent Marker", value: "'Permanent Marker', cursive"},
    {name: "Swanky and Moo Moo", value: "'Swanky and Moo Moo', cursive"},
    {name: "Caveat Brush", value: "'Caveat Brush', cursive"},
    {name: "Bangers", value: "'Bangers', cursive"},
    {name: "Knewave", value: "'Knewave', cursive"},
    {name: "DynaPuff", value: "'DynaPuff', cursive"},
    {name: "Indie Flower", value: "'Indie Flower', cursive"}
  ];

  fonts.forEach(font => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontFamily = font.value;
    box.style.fontSize = "18px";
    box.style.fontWeight = "700";
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = font.name;
    box.appendChild(nameDiv);
    
    box.onclick = ()=> {
      // Applica a tutte le categorie
      Object.keys(fontSettings).forEach(key => {
        fontSettings[key].font = font.value;
      });
      applyFont();
      saveData();
      openSelectFontForAll();
    };
    
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Font per Tutti";
  showPopup();
}

function openSelectSizeForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli la dimensione per TUTTE le categorie:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const sizes = [10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 36, 40];

  sizes.forEach(size => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = size + "px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${size}px`;
    
    box.onclick = ()=> {
      // Applica a tutte le categorie
      Object.keys(fontSettings).forEach(key => {
        fontSettings[key].size = size;
      });
      applyFont();
      saveData();
      openSelectSizeForAll();
    };
    
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Dimensione per Tutti";
  showPopup();
}

function openSelectPaddingForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli il padding per TUTTE le categorie:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);
  
  const infoDiv = document.createElement('div');
  infoDiv.textContent = "Il padding è lo spazio interno tra il bordo del bottone e il testo";
  infoDiv.style.fontSize = "14px";
  infoDiv.style.marginBottom = "20px";
  infoDiv.style.textAlign = "center";
  infoDiv.style.padding = "10px";
  infoDiv.style.background = "#222";
  infoDiv.style.borderRadius = "8px";
  infoDiv.style.color = "#aaa";
  orderList.appendChild(infoDiv);

  const paddings = [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30];

  paddings.forEach(padding => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = padding + "px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = "16px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${padding}px`;
    
    box.onclick = ()=> {
      // Applica a tutte le categorie
      Object.keys(fontSettings).forEach(key => {
        fontSettings[key].padding = padding;
      });
      applyFont();
      saveData();
      openSelectPaddingForAll();
    };
    
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Padding per Tutti";
  showPopup();
}

/* Category Settings */
function openCategorySettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Gestisci Categorie e Prodotti";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const catKeys = Object.keys(CATALOG);
  const catNames = {c1:"CAFFE", c2:"SPINA", c3:"FRIGO", c4:"SUPER", c5:"SNACK", c6:"TEMPO", c7:"QUOTE"};

  catKeys.forEach(key => {
    if(key === 'c6') return;
    
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "12px";
    box.style.marginBottom = "10px";
    box.style.background = "#222";
    
    const header = document.createElement('div');
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.marginBottom = "10px";
    
    const catName = document.createElement('div');
    catName.textContent = catNames[key] || key;
    catName.style.fontSize = "16px";
    catName.style.fontWeight = "700";
    
    const addBtn = document.createElement('button');
    addBtn.textContent = "+ Aggiungi";
    addBtn.style.padding = "8px 12px";
    addBtn.style.fontSize = "14px";
    addBtn.onclick = ()=> addProductToCategory(key);
    
    header.appendChild(catName);
    header.appendChild(addBtn);
    box.appendChild(header);
    
    const products = CATALOG[key] || [];
    products.forEach((prod, idx) => {
      const prodRow = document.createElement('div');
      prodRow.style.display = "flex";
      prodRow.style.justifyContent = "space-between";
      prodRow.style.alignItems = "center";
      prodRow.style.padding = "8px";
      prodRow.style.borderTop = "1px solid #444";
      
      const prodInfo = document.createElement('div');
      prodInfo.textContent = `${prod.name} - €${prod.price.toFixed(2)}`;
      prodInfo.style.fontSize = "14px";
      
      const actions = document.createElement('div');
      actions.style.display = "flex";
      actions.style.gap = "8px";
      
      const editBtn = document.createElement('button');
      editBtn.textContent = "Modifica";
      editBtn.style.padding = "6px 10px";
      editBtn.style.fontSize = "12px";
      editBtn.onclick = ()=> editProduct(key, idx);
      
      const delBtn = document.createElement('button');
      delBtn.textContent = "Elimina";
      delBtn.style.padding = "6px 10px";
      delBtn.style.fontSize = "12px";
      delBtn.style.background = "#aa0000";
      delBtn.onclick = ()=> deleteProduct(key, idx);
      
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      prodRow.appendChild(prodInfo);
      prodRow.appendChild(actions);
      box.appendChild(prodRow);
    });
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const backBtn2 = document.createElement('button');
  backBtn2.textContent = "← Indietro";
  backBtn2.onclick = openSettings;
  actionsDiv.appendChild(backBtn2);
  
  const closeBtn2 = document.createElement('button');
  closeBtn2.textContent = "Chiudi";
  closeBtn2.onclick = closePopup;
  actionsDiv.appendChild(closeBtn2);

  popupTitle.textContent = "Categorie";
  showPopup();
}

function addProductToCategory(catKey){
  const name = prompt("Nome prodotto:");
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 2.50):");
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  if(!CATALOG[catKey]) CATALOG[catKey] = [];
  CATALOG[catKey].push({name, price});
  saveData();
  openCategorySettings();
}

function editProduct(catKey, idx){
  const prod = CATALOG[catKey][idx];
  const name = prompt("Nome prodotto:", prod.name);
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 2.50):", prod.price);
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  CATALOG[catKey][idx] = {name, price};
  saveData();
  openCategorySettings();
}

function deleteProduct(catKey, idx){
  if(confirm(`Eliminare "${CATALOG[catKey][idx].name}"?`)){
    CATALOG[catKey].splice(idx, 1);
    saveData();
    openCategorySettings();
  }
}

/* Subcategory Settings */
function openSubcategorySettings(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Gestisci Sottocategorie";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const subtitle = document.createElement('div');
  subtitle.textContent = "Le sottocategorie sono prodotti che hanno opzioni aggiuntive";
  subtitle.style.fontSize = "14px";
  subtitle.style.marginBottom = "15px";
  subtitle.style.color = "#aaa";
  orderList.appendChild(subtitle);

  Object.keys(subcategories).forEach(subKey => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "12px";
    box.style.marginBottom = "10px";
    box.style.background = "#222";
    
    const header = document.createElement('div');
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.marginBottom = "10px";
    
    const subName = document.createElement('div');
    subName.textContent = subKey;
    subName.style.fontSize = "16px";
    subName.style.fontWeight = "700";
    
    const headerActions = document.createElement('div');
    headerActions.style.display = "flex";
    headerActions.style.gap = "8px";
    
    const addOptBtn = document.createElement('button');
    addOptBtn.textContent = "+ Opzione";
    addOptBtn.style.padding = "6px 10px";
    addOptBtn.style.fontSize = "12px";
    addOptBtn.style.background = "#00aa00";
    addOptBtn.onclick = ()=> addSubcategoryOption(subKey);
    
    const delSubBtn = document.createElement('button');
    delSubBtn.textContent = "Elimina";
    delSubBtn.style.padding = "6px 10px";
    delSubBtn.style.fontSize = "12px";
    delSubBtn.style.background = "#aa0000";
    delSubBtn.onclick = ()=> deleteSubcategory(subKey);
    
    headerActions.appendChild(addOptBtn);
    headerActions.appendChild(delSubBtn);
    header.appendChild(subName);
    header.appendChild(headerActions);
    box.appendChild(header);
    
    const options = subcategories[subKey] || [];
    options.forEach((opt, idx) => {
      const optRow = document.createElement('div');
      optRow.style.display = "flex";
      optRow.style.justifyContent = "space-between";
      optRow.style.alignItems = "center";
      optRow.style.padding = "8px";
      optRow.style.borderTop = "1px solid #444";
      
      const optInfo = document.createElement('div');
      optInfo.textContent = `${opt.name} - €${opt.price.toFixed(2)}`;
      optInfo.style.fontSize = "14px";
      
      const actions = document.createElement('div');
      actions.style.display = "flex";
      actions.style.gap = "8px";
      
      const editBtn = document.createElement('button');
      editBtn.textContent = "Modifica";
      editBtn.style.padding = "6px 10px";
      editBtn.style.fontSize = "12px";
      editBtn.onclick = ()=> editSubcategoryOption(subKey, idx);
      
      const delBtn = document.createElement('button');
      delBtn.textContent = "Elimina";
      delBtn.style.padding = "6px 10px";
      delBtn.style.fontSize = "12px";
      delBtn.style.background = "#aa0000";
      delBtn.onclick = ()=> deleteSubcategoryOption(subKey, idx);
      
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      optRow.appendChild(optInfo);
      optRow.appendChild(actions);
      box.appendChild(optRow);
    });
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const addSubBtn = document.createElement('button');
  addSubBtn.textContent = "+ Nuova Sottocategoria";
  addSubBtn.style.background = "#00aa00";
  addSubBtn.onclick = addNewSubcategory;
  actionsDiv.appendChild(addSubBtn);
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "← Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Sottocategorie";
  showPopup();
}

function addNewSubcategory(){
  const name = prompt("Nome della sottocategoria (es: CAFFÈ CORRETTO):");
  if(!name) return;
  if(subcategories[name]){
    alert("Questa sottocategoria esiste già!");
    return;
  }
  subcategories[name] = [];
  saveData();
  openSubcategorySettings();
}

function deleteSubcategory(subKey){
  if(confirm(`Eliminare la sottocategoria "${subKey}" e tutte le sue opzioni?`)){
    delete subcategories[subKey];
    saveData();
    openSubcategorySettings();
  }
}

function addSubcategoryOption(subKey){
  const name = prompt("Nome opzione:");
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 3.00):");
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  subcategories[subKey].push({name, price});
  saveData();
  openSubcategorySettings();
}

function editSubcategoryOption(subKey, idx){
  const opt = subcategories[subKey][idx];
  const name = prompt("Nome opzione:", opt.name);
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 3.00):", opt.price);
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  subcategories[subKey][idx] = {name, price};
  saveData();
  openSubcategorySettings();
}

function deleteSubcategoryOption(subKey, idx){
  if(confirm(`Eliminare l'opzione "${subcategories[subKey][idx].name}"?`)){
    subcategories[subKey].splice(idx, 1);
    saveData();
    openSubcategorySettings();
  }
}

/* Render Modifiers */
function renderModifiers(){
  modifiersDiv.innerHTML = "";
  modifiersList.forEach(mod => {
    const btn = document.createElement('button');
    btn.setAttribute('data-mod', mod);
    btn.textContent = mod;
    modifiersDiv.appendChild(btn);
  });
}

/* Modifier Settings */
function openModifierSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Gestisci Modificatori";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const subtitle = document.createElement('div');
  subtitle.textContent = "I modificatori vengono aggiunti al nome del prodotto";
  subtitle.style.fontSize = "14px";
  subtitle.style.marginBottom = "15px";
  subtitle.style.color = "#aaa";
  orderList.appendChild(subtitle);

  modifiersList.forEach((mod, idx) => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "12px";
    box.style.marginBottom = "10px";
    box.style.background = "#222";
    box.style.display = "flex";
    box.style.justifyContent = "space-between";
    box.style.alignItems = "center";
    
    const modName = document.createElement('div');
    modName.textContent = mod;
    modName.style.fontSize = "16px";
    modName.style.fontWeight = "700";
    
    const actions = document.createElement('div');
    actions.style.display = "flex";
    actions.style.gap = "8px";
    
    const editBtn = document.createElement('button');
    editBtn.textContent = "Modifica";
    editBtn.style.padding = "8px 12px";
    editBtn.style.fontSize = "14px";
    editBtn.onclick = ()=> editModifier(idx);
    
    const delBtn = document.createElement('button');
    delBtn.textContent = "Elimina";
    delBtn.style.padding = "8px 12px";
    delBtn.style.fontSize = "14px";
    delBtn.style.background = "#aa0000";
    delBtn.onclick = ()=> deleteModifier(idx);
    
    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    box.appendChild(modName);
    box.appendChild(actions);
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const addBtn = document.createElement('button');
  addBtn.textContent = "+ Aggiungi Modificatore";
  addBtn.style.background = "#00aa00";
  addBtn.onclick = addModifier;
  actionsDiv.appendChild(addBtn);
  
  const backBtn3 = document.createElement('button');
  backBtn3.textContent = "← Indietro";
  backBtn3.onclick = openSettings;
  actionsDiv.appendChild(backBtn3);
  
  const closeBtn3 = document.createElement('button');
  closeBtn3.textContent = "Chiudi";
  closeBtn3.onclick = closePopup;
  actionsDiv.appendChild(closeBtn3);

  popupTitle.textContent = "Modificatori";
  showPopup();
}

function addModifier(){
  const name = prompt("Nome modificatore (es: SR, M, K):");
  if(!name) return;
  modifiersList.push(name.toUpperCase());
  renderModifiers();
  saveData();
  openModifierSettings();
}

function editModifier(idx){
  const current = modifiersList[idx];
  const name = prompt("Nome modificatore:", current);
  if(!name) return;
  modifiersList[idx] = name.toUpperCase();
  renderModifiers();
  saveData();
  openModifierSettings();
}

function deleteModifier(idx){
  if(confirm(`Eliminare il modificatore "${modifiersList[idx]}"?`)){
    modifiersList.splice(idx, 1);
    renderModifiers();
    saveData();
    openModifierSettings();
  }
}

/* Storico */
function openStorico(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'none';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  if(!storico || storico.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessuno storico disponibile";
    orderList.appendChild(empty);
  } else {
    // mostra dal più recente
    storico.slice().reverse().forEach(entry=>{
      const box = document.createElement('div');
      box.style.border = "1px solid #444";
      box.style.borderRadius = "6px";
      box.style.padding = "6px";
      box.style.marginBottom = "8px";

      const titolo = document.createElement('div');
      titolo.style.fontWeight = "700";
      titolo.textContent = `Data: ${entry.dateLabel || entry.dateISO || entry.date} — Totale: €${(entry.totale||Object.values(entry.totali||{}).reduce((a,b)=>a+b,0)).toFixed(2)}`;
      box.appendChild(titolo);

      const inner = document.createElement('div');
      inner.style.marginTop = "6px";
      for(const k in (entry.totali||{})){
        const r = document.createElement('div');
        r.textContent = `${k.toUpperCase()}: €${entry.totali[k].toFixed(2)}`;
        inner.appendChild(r);
      }
      box.appendChild(inner);

      const actionsBox = document.createElement('div');
      actionsBox.style.display = "flex";
      actionsBox.style.gap = "8px";
      actionsBox.style.marginTop = "8px";

      const exp = document.createElement('button');
      exp.textContent = "Esporta";
      exp.onclick = ()=> {
        showConfirm('Confermi l\'esportazione di questo storico?', ()=>{
          exportSingleHistoric(entry);
        }, 'Esporta Storico');
      };

      const del = document.createElement('button');
      del.textContent = "Elimina";
      del.onclick = ()=> {
        showConfirm('Confermi l\'eliminazione di questo storico?', ()=>{
          const idx = storico.findIndex(s=>s.id === entry.id);
          if(idx !== -1) storico.splice(idx,1);
          saveData();
          openStorico();
        }, 'Elimina Storico');
      };

      actionsBox.appendChild(exp);
      actionsBox.appendChild(del);
      box.appendChild(actionsBox);

      orderList.appendChild(box);
    });
  }

  actionsDiv.innerHTML = "";
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Storico";
  showPopup();
}

function exportSingleHistoric(entry){
  const rows = [["Categoria","Totale (€)"]];
  for(const k in (entry.totali||{})){
    rows.push([k.toUpperCase(), (entry.totali[k]).toFixed(2).replace('.', ',')]);
  }
  rows.push(["TOTALE", ((entry.totale!==undefined)?entry.totale:Object.values(entry.totali||{}).reduce((a,b)=>a+b,0)).toFixed(2).replace('.', ',')]);
  const csv = rows.map(r=>r.join(";")).join("\n");
  const dateLabel = entry.dateLabel || entry.dateISO || new Date().toLocaleString();
  downloadCSV(csv, 'storico');
}

/* helper detect category */
function detectCategory(name){
  const s = (name||"").toLowerCase();
  if(s.includes("caff")) return "caffe";
  if(s.includes("pyraser")||s.includes("aria")||s.includes("guinness")||s.includes("spritz")) return "spina";
  // Controlla prima i cocktails con "lemon" (GIN LEMON, VODKA LEMON) prima di controllare LEMON SODA
  if(s.includes("gin lemon")||s.includes("vodka lemon")||s.includes("amaro")||s.includes("grappa")||s.includes("cocktail")||s.includes("baileys")||s.includes("jack")||s.includes("talisker")||s.includes("liquirizia")||s.includes("prugna cm")||s.includes("vodka tonic")||s.includes("jagerbomb")) return "super";
  if(s.includes("acqua")||s.includes("coca")||s.includes("tè")||s.includes("fanta")||s.includes("lemon")||s.includes("red bull")) return "frigo";
  if(s.includes("toast")||s.includes("pizzetta")||s.includes("hot dog")) return "snack";
  if(s.includes("tempo")) return "tempo";
  if(s.includes("quota")||s.includes("quote")) return "quote";
  if(s.includes("cassa")||s.includes("entrata")||s.includes("uscita")) return "cassa";
  return null;
}

/* delegazione click categorie */
categoriesDiv.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const key = btn.dataset.cat;
  if(!key) return;
  vibrate(VIBRATION_PATTERNS.tap);
  showSubcatsByKey(key);
});

/* click esterno per chiudere popup */
popup.addEventListener('click', e=>{ if(e.target === popup) closePopup(); });

/* init */
if(firebaseEnabled){
  setupFirebaseSync();
} else {
  loadData();
  renderTables();
  renderSavedButtons();
}

// helper: prova a inviare il CSV a App Inventor (WebViewer)
function sendCsvToAppInventor(csv) {
  try {
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      // prefisso unico per riconoscerlo nell'app
      AppInventor.setWebViewString("EXPORT_CSV::" + csv);
      return true;
    }
  } catch (e) {
    console.error("sendCsvToAppInventor error", e);
  }
  return false;
}

// genera ed esporta il CSV (fallback download + invio a AppInventor)
function exportTotalsToCSV() {
  try {
    // 1️⃣ Genera CSV con ordine categorie: caffe, spina, frigo, super, snack, tempo, quote, cassa
    let csv = "Categoria;Totale (€)\n";
    const categoriesOrder = ['caffe', 'spina', 'frigo', 'super', 'snack', 'tempo', 'quote', 'cassa'];
    categoriesOrder.forEach(k => {
      if(totals[k] !== undefined) {
        csv += `${k.toUpperCase()};${totals[k].toFixed(2).replace('.', ',')}\n`;
      }
    });
    const totaleCompl = Object.values(totals).reduce((a,b)=>a+b,0).toFixed(2).replace('.', ',');
    csv += `TOTALE COMPLESSIVO;${totaleCompl}\n`;

    // 2️⃣ Prova invio a Kodular / AppInventor
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      AppInventor.setWebViewString("SAVE_CSV::" + csv);
      setTimeout(() => {
        AppInventor.setWebViewString("SAVE_CSV_DONE");
      }, 100);
      return;
    }

    // 3️⃣ Scarica il file CSV
    downloadCSV(csv, 'totali');

  } catch(e) {
    console.error("Errore exportTotalsToCSV:", e);
  }
}

/* Funzione per scaricare CSV in locale */
function downloadCSV(csvContent, tipo) {
  try {
    const timestamp = new Date().toISOString().replace(/[:.]/g,'-');
    const filename = `${tipo}_${timestamp}.csv`;
    
    // Crea il blob CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // Scarica il file
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('✅ File CSV scaricato:', filename);
  } catch(e) {
    console.error('❌ Errore download CSV:', e);
    alert('Errore nel download del file.');
  }
}

/* Nascondi barra indirizzi e disabilita zoom */
window.addEventListener('load', () => {
  // Nascondi barra indirizzi con scroll
  setTimeout(() => {
    window.scrollTo(0, 1);
  }, 0);
  
  // Previeni zoom con gesture
  document.addEventListener('gesturestart', (e) => e.preventDefault());
  document.addEventListener('gesturechange', (e) => e.preventDefault());
  document.addEventListener('gestureend', (e) => e.preventDefault());
  
  // Previeni zoom con doppio tap
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
});

/* Register Service Worker */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => {
        console.log('✅ Service Worker registrato');
        
        // Controlla aggiornamenti ogni 60 secondi
        setInterval(() => {
          reg.update();
        }, 60000);
        
        // Notifica quando c'è un nuovo service worker in attesa
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('🔄 Nuovo aggiornamento disponibile!');
              // Opzionale: mostra notifica all'utente
              if(confirm('Nuova versione disponibile! Ricaricare?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(err => console.log('❌ Service Worker errore:', err));
  });
}

/* Gestione stato Online/Offline */
const offlineIndicator = document.getElementById('offline-indicator');

function updateOnlineStatus() {
  if (navigator.onLine) {
    offlineIndicator.style.display = 'none';
    console.log('🌐 Online');
    vibrate([20, 50, 20]); // Doppio tap per conferma online
  } else {
    offlineIndicator.style.display = 'block';
    console.log('📡 Offline - Modalità cache attiva');
    vibrate([100, 100, 100]); // Tripla vibrazione per avviso offline
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Controlla stato iniziale
updateOnlineStatus();

/* Previeni perdita dati non salvati */
window.addEventListener('beforeunload', (e) => {
  // Salva sempre prima di chiudere
  saveData();
});

/* Performance monitoring */
if ('performance' in window) {
  window.addEventListener('load', () => {
    setTimeout(() => {
      const perfData = performance.getEntriesByType('navigation')[0];
      if (perfData) {
        console.log('📊 Performance:', {
          'Caricamento DOM': Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart) + 'ms',
          'Caricamento completo': Math.round(perfData.loadEventEnd - perfData.loadEventStart) + 'ms',
          'Tempo totale': Math.round(perfData.loadEventEnd - perfData.fetchStart) + 'ms'
        });
      }
    }, 0);
  });
}
</script>
</body>
</html>
