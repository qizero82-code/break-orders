<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover" />
<meta name="theme-color" content="#000000" />
<meta name="description" content="Sistema di gestione ordini per Break Billiard Club" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="manifest.json" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Caveat+Brush&family=Cherry+Cream+Soda&family=Dokdo&family=DynaPuff:wght@400..700&family=Indie+Flower&family=Irish+Grover&family=Knewave&family=Mountains+of+Christmas:wght@400;700&family=Permanent+Marker&family=Rampart+One&family=Rubik+Vinyl&family=Swanky+and+Moo+Moo&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<title>Break Orders — Completo</title>
<style>
  /* v2.1 - Tasti grandi su tablet */
  :root{--tempo-color:#008800}
  *{scroll-behavior:smooth}
  html{height:100%;overflow:hidden}
  body{
    font-family:Arial,Helvetica,sans-serif;
    margin:20px;padding-bottom:140px;
    background:#000 url("https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4") no-repeat center center fixed;
    background-size:cover;color:#fff;box-sizing:border-box;
    touch-action:manipulation;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;
    position:fixed;width:100%;height:100%;overflow-y:auto;top:0;left:0
  }
  button{padding:12px;font-size:16px;cursor:pointer;border-radius:8px;border:1px solid #444;background:#000;color:#fff;touch-action:manipulation;transition:transform 0.2s ease,background 0.2s ease,box-shadow 0.2s ease}
  button:active{transform:scale(0.95);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
  
  /* Layout ordini salvati */
  #saved-orders{
    position:fixed;
    top:10px;
    left:10px;
    right:10px;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:0.5vw;
    z-index:999;
  }
  #saved-orders button{
    background:#000 !important;
    color:#fff !important;
    border-radius:8px !important;
    padding:1.5vh 0.5vw !important;
    font-size:clamp(10px, 2.5vw, 20px) !important;
    font-weight:700 !important;
    min-height:auto !important;
    box-sizing:border-box !important;
    line-height:1.2 !important;
    transition:transform 0.2s ease,background 0.2s ease,box-shadow 0.2s ease !important;
  }
  #saved-orders button:active{
    transform:scale(0.95) !important;
    box-shadow:0 4px 12px rgba(0,0,0,0.5) !important;
  }
  #saved-orders button.has-orders{
    background:#cc0000 !important;
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{box-shadow:0 0 0 0 rgba(204,0,0,0.7)}
    50%{box-shadow:0 0 0 8px rgba(204,0,0,0)}
  }
  
  /* Barra tavoli in basso */
  .tables-wrapper{position:fixed;bottom:0.5vh;left:0;right:0;padding:0.5vh 1vw;z-index:1000;background:rgba(0,0,0,0.06);box-sizing:border-box;max-height:65vh;overflow-y:auto}
  .tables-container{display:flex;flex-direction:column;gap:0.5vh}
  .utility-row{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5vw}
  .tables-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5vw}
  .tables-grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:0.5vw}
  button.table-btn{background:#000 !important;color:#fff !important;border-radius:8px !important;padding:1.5vh 0.5vw !important;font-size:clamp(10px, 2.5vw, 20px) !important;font-weight:700 !important;min-height:auto !important;box-sizing:border-box !important;line-height:1.2 !important;transition:transform 0.2s ease,background 0.2s ease,box-shadow 0.2s ease !important}
  button.table-btn:active{transform:scale(0.95) !important;box-shadow:0 4px 12px rgba(0,0,0,0.5) !important}
  button.table-btn.has-orders{background:#cc0000 !important}
  .utility-btn{padding:1.2vh 0.3vw;font-size:clamp(9px, 2vw, 14px);line-height:1.2;transition:transform 0.2s ease,background 0.2s ease}
  .utility-btn:active{transform:scale(0.95)}
  .popup{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;overflow:hidden;z-index:4000;opacity:0;transition:opacity 0.3s ease-in-out}
  .popup.show{display:flex;animation:fadeIn 0.3s ease-in-out forwards}
  .popup.hide{animation:fadeOut 0.3s ease-in-out forwards}
  .popup.fullscreen-popup{align-items:flex-start;justify-content:flex-start;background:#000}
  .popup-content{background:#000 url("https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4") no-repeat center center fixed;
background-size:cover;padding:18px;border-radius:8px;width:90vw;height:90vh;margin:0;box-sizing:border-box;color:#fff;border:2px solid #444;overflow:hidden;display:flex;flex-direction:column;transform:translateY(20px);opacity:0;transition:all 0.3s ease-in-out}
  .popup.show .popup-content{transform:translateY(0);opacity:1}
  .popup-content.fullscreen{width:100vw !important;height:100vh !important;padding:20px;border-radius:0;margin:0}
  .popup-content.fullscreen .popup-main{display:block !important;grid-template-columns:1fr !important;overflow-y:auto !important;height:100% !important}
  .popup-content.fullscreen .popup-column-left{display:none !important}
  .popup-content.fullscreen .popup-column{background:transparent !important;padding:0 !important;overflow-y:auto !important;height:100% !important}
  .popup-content.spesa-popup{width:90vw !important;height:90vh !important;padding:20px;border-radius:12px;display:flex;flex-direction:column}
  .popup-content.spesa-popup .popup-header{margin-bottom:15px}
  .popup-content.spesa-popup .popup-main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
  .hidden{display:none}
  .popup-header{display:flex;flex-direction:column;gap:10px;margin-bottom:15px}
  .popup-header h3{margin:0;text-align:center;font-size:20px}
  .popup-main{display:flex;flex-direction:column;gap:15px;flex:1;overflow:hidden}
  .popup-column{display:flex;flex-direction:column;overflow-y:auto;background:transparent;padding:0;border-radius:0;flex:1}
  .popup-column-left{display:flex;flex-direction:column;gap:10px;overflow:hidden}
  .categories-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .subcats-modifiers-wrapper{display:flex;flex-direction:column;gap:10px;overflow-y:auto;background:transparent;padding:0;border-radius:0;flex:1}
  .column-title{font-size:14px;font-weight:700;margin-bottom:10px;text-align:center;color:#fff}
  #categories{display:contents}
  #subcats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;overflow-y:auto;align-content:start}
  .cat-btn,.subcat-btn{color:#fff;border:none;border-radius:8px;padding:20px;font-size:16px;font-weight:700;width:100%;text-align:center;background:#000;transition:transform 0.2s ease,box-shadow 0.2s ease,filter 0.2s ease}
  .cat-btn:active,.subcat-btn:active{transform:scale(0.95);box-shadow:0 4px 12px rgba(0,0,0,0.4)}
  .cat-btn:hover,.subcat-btn:hover{filter:brightness(1.2)}
  .back-btn{background:#555;color:#fff;border:none;border-radius:6px;padding:10px;margin:4px 0;font-size:14px;grid-column:span 2;cursor:pointer}
  .cat-caffe{background:#888}.cat-spina{background:#ff8800}.cat-frigo{background:#0099ff}.cat-super{background:#aaaa00}.cat-snack{background:#ff0000}.cat-tempo{background:var(--tempo-color)}.cat-quote{background:#0000ff}.cat-cassa{background:#000;color:#fff}
  .modifiers{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:0}
  .modifiers button{background:#444;color:#fff;font-weight:700;padding:10px;border:none;border-radius:6px;cursor:pointer;width:100%}
  .list div{padding:6px;border-bottom:1px solid #666;cursor:pointer}
  #order-list{background:transparent;color:#fff;padding:0;border-radius:8px;flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
  .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:100%}
  .actions button{padding:20px;font-size:18px;text-transform:uppercase;font-weight:700}
  #tempo-pad,#cassa-pad{width:90%;margin:0 auto;align-self:center}
  .numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .numpad button{font-size:18px;padding:14px;border-radius:8px;background:var(--tempo-color);color:#fff;border:none;width:100%;box-sizing:border-box;font-weight:700}
  .tempo-display{width:100%;padding:10px;font-size:18px;text-align:right;margin-bottom:8px;background:#111;border:1px solid #333;color:#fff;border-radius:6px}
  .order-row{display:grid;grid-template-columns:3fr 1fr;align-items:center;padding:4px 0;border-bottom:1px solid #333;animation:slideUp 0.3s ease-out}
  .order-name{text-align:left}
  .order-price{text-align:right;font-weight:bold}
  .order-row:hover{background:rgba(255,255,255,0.05);cursor:pointer}
  /* Animazioni */
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes fadeOut{from{opacity:1}to{opacity:0}}
  @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes scaleIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
  
  /* Popup conferma personalizzato */
  #confirm-popup{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:10000;opacity:0;transition:opacity 0.3s ease-in-out}
  #confirm-popup.show{display:flex;animation:fadeIn 0.3s ease-in-out forwards}
  #confirm-popup.hide{animation:fadeOut 0.3s ease-in-out forwards}
  .confirm-box{background:#000 url("https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4") no-repeat center center;background-size:cover;padding:24px;border-radius:10px;border:2px solid #444;color:#fff;text-align:center;width:90vw;max-width:500px;transform:scale(0.9);opacity:0;transition:all 0.3s ease-in-out}
  #confirm-popup.show .confirm-box{animation:scaleIn 0.3s ease-in-out forwards}
  .confirm-box h3{margin:0 0 16px 0;font-size:20px}
  .confirm-box p{margin:0 0 20px 0;font-size:16px}
  .confirm-buttons{display:flex;gap:10px;justify-content:center}
  .confirm-buttons button{padding:12px 24px;font-size:16px;border-radius:8px;cursor:pointer;border:none;font-weight:700;transition:transform 0.2s ease,background 0.2s ease}
  .confirm-buttons button:active{transform:scale(0.95)}
  .btn-confirm{background:#00aa00;color:#fff}
  .btn-confirm:hover{background:#00cc00}
  .btn-cancel{background:#aa0000;color:#fff}
  .btn-cancel:hover{background:#cc0000}
  /* Smartphone - Layout a due colonne mantenuto */
  @media(max-width:768px){
    .popup-content{width:100vw;height:100vh}
    .popup-content.spesa-popup{width:100vw !important;height:100vh !important;padding:10px !important;border-radius:0 !important}
    #saved-orders{left:10px;right:10px;gap:0.5vw;grid-template-columns:repeat(4,1fr)}
    #saved-orders button{padding:1vh 0.5vw !important;font-size:clamp(10px, 2.5vw, 13px) !important}
    .popup-content{padding:10px}
    .popup-header{flex-direction:column;gap:8px;margin-bottom:10px}
    .popup-header h3{text-align:center;font-size:18px}
    .actions{justify-content:center;margin-bottom:8px}
    .actions button{font-size:11px;padding:6px 10px}
    .popup-main{flex-direction:column;gap:10px;overflow:hidden}
    .popup-column{padding:0;overflow-y:auto;flex:1}
    .popup-column-left{display:flex;flex-direction:column;overflow:hidden}
    .column-title{font-size:12px;margin-bottom:6px}
    .categories-grid{grid-template-columns:repeat(4,1fr);gap:5px}
    #subcats{display:grid;grid-template-columns:repeat(2,1fr);gap:5px}
    .cat-btn,.subcat-btn{padding:8px 4px;font-size:11px}
    .modifiers{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:0}
    .modifiers button{width:100%;padding:6px;font-size:11px}
    #order-list{font-size:13px}
    .order-row{padding:5px 0;font-size:13px}
    .numpad button{font-size:14px;padding:10px}
    .confirm-box{padding:20px}
    .refill-categories-grid{grid-template-columns:1fr !important;gap:10px !important;padding:10px !important}
    .refill-products-grid{grid-template-columns:1fr !important;gap:8px !important;padding:10px !important}
  }
  /* Telefoni piccoli */
  @media(max-width:480px){
    .actions button{font-size:10px;padding:5px 8px}
    .cat-btn,.subcat-btn{font-size:10px;padding:6px 2px}
    #saved-orders button{padding:1vh 1vw;font-size:clamp(10px, 2.5vw, 13px)}
  }
</style>
</head>
<body>
  <!-- Indicatore stato offline -->
  <div id="offline-indicator" style="display:none;position:fixed;top:5px;right:5px;background:#ff6600;color:#fff;padding:8px 12px;border-radius:6px;font-size:12px;font-weight:700;z-index:10000;box-shadow:0 2px 8px rgba(0,0,0,0.3)">
    📡 OFFLINE
  </div>
  
  <!-- Ordini salvati in alto a sinistra -->
  <div id="saved-orders"></div>
  
  <!-- Barra tavoli in basso -->
  <div class="tables-wrapper">
    <div class="tables-container" id="tables-container"></div>
  </div>

  <!-- Popup conferma personalizzato -->
  <div id="confirm-popup">
    <div class="confirm-box">
      <h3 id="confirm-title">Conferma</h3>
      <p id="confirm-message">Sei sicuro?</p>
      <div class="confirm-buttons">
        <button class="btn-confirm" id="confirm-ok">OK</button>
        <button class="btn-cancel" id="confirm-cancel">Annulla</button>
      </div>
    </div>
  </div>

  <div class="popup" id="popup" aria-modal="true" role="dialog">
    <div class="popup-content">
      <div class="popup-header">
        <h3 id="popup-title">Tavolo</h3>
        <div class="actions" id="actions"></div>
        <div class="categories-grid">
          <button class="cat-btn cat-caffe" data-cat="c1">CAFFE</button>
          <button class="cat-btn cat-spina" data-cat="c2">SPINA</button>
          <button class="cat-btn cat-frigo" data-cat="c3">FRIGO</button>
          <button class="cat-btn cat-super" data-cat="c4">SUPER</button>
          <button class="cat-btn cat-snack" data-cat="c5">SNACK</button>
          <button class="cat-btn cat-tempo" data-cat="c6">TEMPO</button>
          <button class="cat-btn cat-quote" data-cat="c7">QUOTE</button>
          <button class="cat-btn cat-cassa" data-cat="c8">CASSA</button>
        </div>
      </div>
      
      <div class="popup-main">
        <!-- Sottocategorie a tutto schermo -->
        <div id="subcats" aria-live="polite"></div>
        
        <!-- Tempo e Cassa pad -->
        <div id="tempo-pad" class="hidden" aria-hidden="true">
          <input id="tempo-display" class="tempo-display" readonly value="0" />
          <div class="numpad" id="tempo-numpad">
            <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button>
            <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button>
            <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button>
            <button data-key=".">.</button><button data-key="0">0</button><button id="tempo-ok">OK</button>
          </div>
        </div>
        <div id="cassa-pad" class="hidden" aria-hidden="true">
          <input id="cassa-display" class="tempo-display" readonly value="0" style="background:#000;color:#fff;border:1px solid #fff" />
          <div class="numpad" id="cassa-numpad" style="margin-bottom:10px">
            <button data-key="7" style="background:#000;color:#fff">7</button><button data-key="8" style="background:#000;color:#fff">8</button><button data-key="9" style="background:#000;color:#fff">9</button>
            <button data-key="4" style="background:#000;color:#fff">4</button><button data-key="5" style="background:#000;color:#fff">5</button><button data-key="6" style="background:#000;color:#fff">6</button>
            <button data-key="1" style="background:#000;color:#fff">1</button><button data-key="2" style="background:#000;color:#fff">2</button><button data-key="3" style="background:#000;color:#fff">3</button>
            <button data-key="." style="background:#000;color:#fff">.</button><button data-key="0" style="background:#000;color:#fff">0</button><button data-key="C" style="background:#aa0000;color:#fff">C</button>
          </div>
          <button id="cassa-entrata" style="background:#00aa00;color:#fff;width:100%;padding:14px;font-size:16px;font-weight:700;border:none;border-radius:8px;margin-bottom:8px;cursor:pointer">ENTRATA</button>
          <button id="cassa-uscita" style="background:#aa0000;color:#fff;width:100%;padding:14px;font-size:16px;font-weight:700;border:none;border-radius:8px;cursor:pointer">USCITA</button>
        </div>
        
        <!-- Modificatori in una riga da 5 -->
        <div class="modifiers" id="modifiers">
          <button data-mod="SR">SR</button><button data-mod="M">M</button><button data-mod="K">K</button>
          <button data-mod="S">S</button><button data-mod="GH">GH</button>
        </div>
        
        <!-- Ordini a tutto schermo -->
        <div class="popup-column">
          <div class="column-title">ORDINE</div>
          <div id="order-list" class="list" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== FIREBASE CONFIGURATION ========== */
// Configurazione Firebase per sincronizzazione in tempo reale
const firebaseConfig = {
  apiKey: "AIzaSyBZn0t52sJ4W7hsJEAPjaCpuOlR5al7hOU",
  authDomain: "breakcounter-6ecc0.firebaseapp.com",
  databaseURL: "https://breakcounter-6ecc0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "breakcounter-6ecc0",
  storageBucket: "breakcounter-6ecc0.firebasestorage.app",
  messagingSenderId: "1078008487853",
  appId: "1:1078008487853:web:7145962aa0bc1772ec8b24"
};

let firebaseApp = null;
let database = null;
let firebaseEnabled = false;
let isUpdatingFromFirebase = false; // Flag per evitare loop di aggiornamenti

// Inizializza Firebase
try {
  // Verifica se la configurazione è stata personalizzata
  if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    firebaseEnabled = true;
    console.log("✅ Firebase inizializzato correttamente");
  } else {
    console.warn("⚠️ Firebase non configurato. Usando solo localStorage locale.");
  }
} catch (e) {
  console.error("❌ Errore inizializzazione Firebase:", e);
  firebaseEnabled = false;
}

function openSelectColor(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli il colore testo per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const inputRow = document.createElement('div');
  inputRow.style.display = 'grid';
  inputRow.style.gridTemplateColumns = '1fr 1fr';
  inputRow.style.gap = '10px';
  inputRow.style.marginBottom = '15px';

  const colorInput = document.createElement('input');
  colorInput.type = 'color';
  const current = (fontSettings[category].color || '#ffffff');
  colorInput.value = current.startsWith('#') ? current : ('#' + current);
  colorInput.style.width = '100%';
  colorInput.style.height = '42px';
  colorInput.style.borderRadius = '8px';
  colorInput.style.border = '2px solid #444';
  colorInput.style.background = '#222';

  const hexInput = document.createElement('input');
  hexInput.type = 'text';
  hexInput.placeholder = 'es. 00ff00 o #00ff00';
  hexInput.value = current;
  hexInput.style.width = '100%';
  hexInput.style.padding = '10px';
  hexInput.style.fontSize = '16px';
  hexInput.style.border = '2px solid #444';
  hexInput.style.background = '#222';
  hexInput.style.color = '#fff';
  hexInput.style.borderRadius = '8px';

  colorInput.oninput = ()=> {
    hexInput.value = colorInput.value;
  };
  hexInput.oninput = ()=> {
    let v = hexInput.value.trim();
    if(!v) return;
    if(!v.startsWith('#')) v = '#' + v;
    if(/^#([0-9a-fA-F]{6})$/.test(v)){
      colorInput.value = v;
    }
  };

  inputRow.appendChild(colorInput);
  inputRow.appendChild(hexInput);
  orderList.appendChild(inputRow);

  const preview = document.createElement('div');
  preview.textContent = 'Anteprima Testo';
  preview.style.fontWeight = '700';
  preview.style.padding = '12px';
  preview.style.border = '2px solid #444';
  preview.style.borderRadius = '8px';
  preview.style.background = '#222';
  preview.style.color = current;
  orderList.appendChild(preview);

  const updatePreview = ()=> {
    const v = colorInput.value;
    preview.style.color = v;
  };
  colorInput.addEventListener('input', updatePreview);
  hexInput.addEventListener('input', updatePreview);

  actionsDiv.innerHTML = "";
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Salva Colore';
  saveBtn.onclick = ()=> {
    let v = hexInput.value.trim();
    if(!v.startsWith('#')) v = '#' + v;
    if(!/^#([0-9a-fA-F]{6})$/.test(v)){
      alert('Inserisci un colore esadecimale valido (es. 00ff00)');
      return;
    }
    fontSettings[category].color = v.toLowerCase();
    applyFont();
    saveData();
    openCustomizeFontSettings();
  };
  const backBtn = document.createElement('button');
  backBtn.textContent = 'Indietro';
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(saveBtn);
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = 'Seleziona Colore';
  showPopup();
}

function openSelectColorForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = 'Scegli il colore testo per TUTTE le categorie:';
  title.style.fontWeight = '700';
  title.style.fontSize = '18px';
  title.style.marginBottom = '15px';
  orderList.appendChild(title);

  const inputRow = document.createElement('div');
  inputRow.style.display = 'grid';
  inputRow.style.gridTemplateColumns = '1fr 1fr';
  inputRow.style.gap = '10px';
  inputRow.style.marginBottom = '15px';

  const colorInput = document.createElement('input');
  colorInput.type = 'color';
  colorInput.value = '#ffffff';
  colorInput.style.width = '100%';
  colorInput.style.height = '42px';
  colorInput.style.borderRadius = '8px';
  colorInput.style.border = '2px solid #444';
  colorInput.style.background = '#222';

  const hexInput = document.createElement('input');
  hexInput.type = 'text';
  hexInput.placeholder = 'es. 00ff00 o #00ff00';
  hexInput.value = '#ffffff';
  hexInput.style.width = '100%';
  hexInput.style.padding = '10px';
  hexInput.style.fontSize = '16px';
  hexInput.style.border = '2px solid #444';
  hexInput.style.background = '#222';
  hexInput.style.color = '#fff';
  hexInput.style.borderRadius = '8px';

  colorInput.oninput = ()=> {
    hexInput.value = colorInput.value;
  };
  hexInput.oninput = ()=> {
    let v = hexInput.value.trim();
    if(!v) return;
    if(!v.startsWith('#')) v = '#' + v;
    if(/^#([0-9a-fA-F]{6})$/.test(v)){
      colorInput.value = v;
    }
  };

  inputRow.appendChild(colorInput);
  inputRow.appendChild(hexInput);
  orderList.appendChild(inputRow);

  const preview = document.createElement('div');
  preview.textContent = 'Anteprima Testo';
  preview.style.fontWeight = '700';
  preview.style.padding = '12px';
  preview.style.border = '2px solid #444';
  preview.style.borderRadius = '8px';
  preview.style.background = '#222';
  preview.style.color = '#ffffff';
  orderList.appendChild(preview);

  const updatePreview = ()=> {
    const v = colorInput.value;
    preview.style.color = v;
  };
  colorInput.addEventListener('input', updatePreview);
  hexInput.addEventListener('input', updatePreview);

  actionsDiv.innerHTML = "";
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Salva Colore per Tutti';
  saveBtn.onclick = ()=> {
    let v = hexInput.value.trim();
    if(!v.startsWith('#')) v = '#' + v;
    if(!/^#([0-9a-fA-F]{6})$/.test(v)){
      alert('Inserisci un colore esadecimale valido (es. 00ff00)');
      return;
    }
    Object.keys(fontSettings).forEach(key => {
      fontSettings[key].color = v.toLowerCase();
    });
    applyFont();
    saveData();
    openCustomizeFontSettings();
  };
  const backBtn = document.createElement('button');
  backBtn.textContent = 'Indietro';
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(saveBtn);
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = 'Seleziona Colore (Tutti)';
  showPopup();
}
/* Popup conferma personalizzato */
function showConfirm(message, onConfirm, title = "Conferma", needsInput = false, inputCallback = null){
  const confirmPopup = document.getElementById('confirm-popup');
  const confirmTitle = document.getElementById('confirm-title');
  const confirmMessage = document.getElementById('confirm-message');
  const confirmOk = document.getElementById('confirm-ok');
  const confirmCancel = document.getElementById('confirm-cancel');
  
  confirmTitle.textContent = title;
  
  // Se serve input numerico, crea un campo input
  if(needsInput){
    confirmMessage.innerHTML = `
      <p style="margin-bottom:15px">${message}</p>
      <input type="number" id="confirm-input" min="2" max="10" value="" placeholder="2" 
        style="width:100%;padding:10px;font-size:18px;text-align:center;border:2px solid #444;background:#222;color:#fff;border-radius:8px">
    `;
    confirmCallback = ()=> {
      const input = document.getElementById('confirm-input');
      const value = parseInt(input.value);
      if(inputCallback && value >= 2) inputCallback(value);
    };
  } else {
    confirmMessage.textContent = message;
    confirmCallback = onConfirm;
  }
  
  confirmPopup.style.display = 'flex';
  // Force reflow per attivare l'animazione
  void confirmPopup.offsetWidth;
  confirmPopup.classList.add('show');
}

function hideConfirm(){
  const confirmPopup = document.getElementById('confirm-popup');
  confirmPopup.classList.remove('show');
  confirmPopup.classList.add('hide');
  setTimeout(() => {
    confirmPopup.style.display = 'none';
    confirmPopup.classList.remove('hide');
    confirmCallback = null;
  }, 300);
}

// Popup personalizzato per manutenzione refill con pulsanti +1/-1
function showMaintenancePopup(productName) {
  const confirmPopup = document.getElementById('confirm-popup');
  const confirmTitle = document.getElementById('confirm-title');
  const confirmMessage = document.getElementById('confirm-message');
  
  const currentCount = getMaintenanceCounter(productName);
  
  confirmTitle.textContent = "Manutenzione";
  confirmMessage.innerHTML = `
    <p style="margin-bottom:15px">${productName}</p>
    <p style="margin-bottom:20px; font-size:18px; font-weight:bold;">Quantità attuale: ${currentCount}</p>
    <div style="display:flex; gap:15px; justify-content:center; align-items:center;">
      <button id="maintenance-plus" style="
        background:#28a745; color:#fff; border:none; border-radius:8px; 
        padding:15px 20px; font-size:20px; font-weight:bold; cursor:pointer;
        min-width:60px; transition:all 0.2s ease;
      ">+1</button>
      <span style="font-size:24px; font-weight:bold; min-width:40px; text-align:center;">${currentCount}</span>
      <button id="maintenance-minus" style="
        background:#dc3545; color:#fff; border:none; border-radius:8px; 
        padding:15px 20px; font-size:20px; font-weight:bold; cursor:pointer;
        min-width:60px; transition:all 0.2s ease;
      ">-1</button>
    </div>
  `;
  
  // Gestione eventi pulsanti
  setTimeout(() => {
    const minusBtn = document.getElementById('maintenance-minus');
    const plusBtn = document.getElementById('maintenance-plus');
    const countSpan = confirmMessage.querySelector('span');
    
    let localCount = currentCount;
    
    const updateDisplay = () => {
      countSpan.textContent = localCount;
      minusBtn.style.opacity = localCount <= 0 ? '0.5' : '1';
      minusBtn.style.cursor = localCount <= 0 ? 'not-allowed' : 'pointer';
    };
    
    minusBtn.onclick = () => {
      if(localCount > 0) {
        localCount--;
        updateDisplay();
        vibrate(VIBRATION_PATTERNS.tap);
      }
    };
    
    plusBtn.onclick = () => {
      localCount++;
      updateDisplay();
      vibrate(VIBRATION_PATTERNS.tap);
    };
    
    // Hover effects
    [minusBtn, plusBtn].forEach(btn => {
      btn.onmouseenter = () => btn.style.transform = 'scale(1.05)';
      btn.onmouseleave = () => btn.style.transform = 'scale(1)';
    });
    
    updateDisplay();
    
    // Override confirm callback per salvare il valore finale
    confirmCallback = () => {
      // Aggiorna il contatore con il nuovo valore
      if(localCount <= 0) {
        delete maintenanceCounters[productName];
      } else {
        maintenanceCounters[productName] = localCount;
      }
      
      saveData();
      
      // Forza refresh multiplo per garantire sincronizzazione visiva
      setTimeout(() => {
        openRefillManutenzione();
      }, 100);
      setTimeout(() => {
        openRefillManutenzione();
      }, 500);
    };
  }, 100);
  
  confirmPopup.style.display = 'flex';
  void confirmPopup.offsetWidth;
  confirmPopup.classList.add('show');
}

document.getElementById('confirm-ok').addEventListener('click', ()=>{
  if(confirmCallback) confirmCallback();
  hideConfirm();
});

document.getElementById('confirm-cancel').addEventListener('click', ()=>{
  hideConfirm();
});

/* stato */
const tableNames = ["TAV-1","TAV-2","TAV-3","TAV-4","TAV-5","TAV-6","TAV-7","TAV-8","TAV-9","TAV-10","TAV-11","TAV-12","STE","SALA","SALAF"];
let tableOrders = {}; // {index: [{name,qty,price,cat}, ...], ...}
let savedOrders = []; // {id, tableName, items: [...], consegnato: false, timestampDone: null}
let totals = {caffe:0,spina:0,frigo:0,super:0,snack:0,tempo:0,quote:0,cassa:0};
let currentTarget = {type:null, id:null};
let accontoMode = false;
let storico = [];
let evasiOrders = []; // ordini pagati che possono essere ripristinati
let refillList = {}; // {productName: {quantity: number, value: number}} - lista prodotti refill con valori
let refillCounters = {}; // {productName: number} - contatori prodotti aggiunti agli ordini
let maintenanceCounters = {}; // {productName: number} - contatori manutenzione manuali
let consumoCounters = {}; // {productName: number} - contatori consumo da reset refill
let consumoList = {}; // {productName: {quantity: number, value: number}} - lista prodotti consumo (come refill ma persistente)
let editableValues = {}; // {productName: number} - valori editabili per il calcolo del prodotto
let storageValues = {}; // {productName: number} - valori per le righe storage

// Liste per i popup carrello (da celle Excel)
let amazonList = []; // Lista prodotti Amazon da cella I84, CB84
let poggianaList = []; // Lista prodotti Poggiana da cella I85, CB85
let prixList = []; // Lista prodotti Prix da cella I86, CB86
let battocchioList = []; // Lista prodotti Battocchio da cella I87, CB87

// Funzioni helper per gestire la nuova struttura refillList
function getRefillQuantity(productName) {
  return refillList[productName]?.quantity || 0;
}

function getRefillValue(productName) {
  return refillList[productName]?.value || 0;
}

function setRefillQuantity(productName, quantity) {
  if (!refillList[productName]) refillList[productName] = {quantity: 0, value: 0};
  refillList[productName].quantity = quantity;
  if (quantity <= 0) {
    delete refillList[productName];
  }
}

function setRefillValue(productName, value) {
  if (!refillList[productName]) refillList[productName] = {quantity: 0, value: 0};
  refillList[productName].value = value;
}

function addRefillQuantity(productName, amount = 1) {
  if (!refillList[productName]) refillList[productName] = {quantity: 0, value: 0};
  refillList[productName].quantity += amount;
}

// Funzioni helper per gestire i contatori REFILL
function getRefillCounter(productName) {
  return refillCounters[productName] || 0;
}

function incrementRefillCounter(productName) {
  refillCounters[productName] = (refillCounters[productName] || 0) + 1;
}

function decrementRefillCounter(productName) {
  if(refillCounters[productName] && refillCounters[productName] > 0) {
    refillCounters[productName] -= 1;
    if(refillCounters[productName] <= 0) {
      delete refillCounters[productName];
    }
  }
}

// Funzioni helper per gestire i contatori CONSUMO
function getConsumoCounter(productName) {
  return consumoCounters[productName] || 0;
}

function incrementConsumoCounter(productName, amount = 1) {
  consumoCounters[productName] = (consumoCounters[productName] || 0) + amount;
}

// Funzioni helper per gestire consumoList (identiche a refillList)
function getConsumoQuantity(productName) {
  return consumoList[productName]?.quantity || 0;
}

function getConsumoValue(productName) {
  return consumoList[productName]?.value || 0;
}

function setConsumoQuantity(productName, quantity) {
  if (!consumoList[productName]) consumoList[productName] = {quantity: 0, value: 0};
  consumoList[productName].quantity = quantity;
  if (quantity <= 0) {
    delete consumoList[productName];
  }
}

function setConsumoValue(productName, value) {
  if (!consumoList[productName]) consumoList[productName] = {quantity: 0, value: 0};
  consumoList[productName].value = value;
}

function editConsumoValue(productName, callback) {
  const currentQuantity = getConsumoQuantity(productName);
  const currentValue = getConsumoValue(productName);
  
  // Crea popup personalizzato per editing
  const editOverlay = document.createElement('div');
  editOverlay.style.position = 'fixed';
  editOverlay.style.top = '0';
  editOverlay.style.left = '0';
  editOverlay.style.width = '100%';
  editOverlay.style.height = '100%';
  editOverlay.style.background = 'rgba(0,0,0,0.8)';
  editOverlay.style.display = 'flex';
  editOverlay.style.alignItems = 'center';
  editOverlay.style.justifyContent = 'center';
  editOverlay.style.zIndex = '9999';
  
  const editBox = document.createElement('div');
  editBox.style.background = '#222';
  editBox.style.padding = '30px';
  editBox.style.borderRadius = '10px';
  editBox.style.border = '2px solid #444';
  editBox.style.minWidth = '300px';
  editBox.style.textAlign = 'center';
  
  const title = document.createElement('div');
  title.textContent = `Modifica: ${productName}`;
  title.style.fontSize = '18px';
  title.style.fontWeight = 'bold';
  title.style.marginBottom = '20px';
  title.style.color = '#fff';
  editBox.appendChild(title);
  
  // Campo quantità
  const qtyLabel = document.createElement('div');
  qtyLabel.textContent = 'Quantità:';
  qtyLabel.style.color = '#fff';
  qtyLabel.style.marginBottom = '5px';
  qtyLabel.style.textAlign = 'left';
  editBox.appendChild(qtyLabel);
  
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.value = currentQuantity;
  qtyInput.style.width = '100%';
  qtyInput.style.padding = '10px';
  qtyInput.style.marginBottom = '20px';
  qtyInput.style.fontSize = '16px';
  qtyInput.style.borderRadius = '5px';
  qtyInput.style.border = '1px solid #666';
  qtyInput.style.background = '#333';
  qtyInput.style.color = '#fff';
  editBox.appendChild(qtyInput);
  
  // Rimuovo il campo valore - manteniamo solo la quantità
  
  // Bottoni
  const buttonsDiv = document.createElement('div');
  buttonsDiv.style.display = 'flex';
  buttonsDiv.style.gap = '10px';
  buttonsDiv.style.justifyContent = 'center';
  
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Salva';
  saveBtn.style.padding = '10px 20px';
  saveBtn.style.fontSize = '16px';
  saveBtn.style.background = '#00aa00';
  saveBtn.style.color = '#fff';
  saveBtn.style.border = 'none';
  saveBtn.style.borderRadius = '5px';
  saveBtn.style.cursor = 'pointer';
  saveBtn.onclick = () => {
    const newQuantity = parseFloat(qtyInput.value) || 0;
    
    // Aggiorna solo la quantità, valore sempre 0
    setConsumoQuantity(productName, newQuantity);
    // Il valore è sempre 0 nelle liste consumo
    if(newQuantity > 0) {
      setConsumoValue(productName, 0);
    }
    
    // Aggiorna anche il contatore se necessario
    if(newQuantity > 0) {
      consumoCounters[productName] = newQuantity;
    } else {
      delete consumoCounters[productName];
    }
    
    // Salva i dati
    saveData();
    
    // Rimuovi overlay
    document.body.removeChild(editOverlay);
    
    // Callback per aggiornare interfaccia
    if(callback) callback();
    
    vibrate(VIBRATION_PATTERNS.success);
  };
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Annulla';
  cancelBtn.style.padding = '10px 20px';
  cancelBtn.style.fontSize = '16px';
  cancelBtn.style.background = '#666';
  cancelBtn.style.color = '#fff';
  cancelBtn.style.border = 'none';
  cancelBtn.style.borderRadius = '5px';
  cancelBtn.style.cursor = 'pointer';
  cancelBtn.onclick = () => {
    document.body.removeChild(editOverlay);
  };
  
  buttonsDiv.appendChild(saveBtn);
  buttonsDiv.appendChild(cancelBtn);
  editBox.appendChild(buttonsDiv);
  
  editOverlay.appendChild(editBox);
  document.body.appendChild(editOverlay);
  
  // Focus sul primo input
  qtyInput.focus();
  qtyInput.select();
}


// Lista dei 70 prodotti nell'ordine del database Excel
const DATABASE_PRODUCTS = [
  "CAFFÈ LISCIO", "CAFFÈ DECA", "CAFFÈ CORRETTO GRAPPA", "CAFFÈ CORRETTO SAMBUCA", "CAFFÈ CORRETTO BAILEYS",
  "CAFFÈ CORRETTO PRUGNA", "PYRASER 0,3", "PYRASER 0,5", "ARIA 0,3", "ARIA 0,5",
  "GUINNESS 0,25", "GUINNESS 0,5", "SPRITZ LISCIO", "SPRITZ APEROL", "SPRITZ CAMPARI",
  "SPRITZ CYNAR", "ACQUA NATURALE", "ACQUA FRIZZANTE", "COCA COLA", "COCA ZERO",
  "TÈ LIMONE", "TÈ PESCA", "FANTA", "LEMON SODA", "RED BULL",
  "AMARO MONTENEGRO", "AMARO JAGERMEISTER", "AMARO CAPO", "AMARO BRAULIO", "AMARO BRANCAMENTA",
  "AMARO PETRUS", "GRAPPA BIANCA", "GRAPPA 24k", "GRAPPA MIELE", "GRAPPA CAMOMILLA",
  "GRAPPA PRUGNA", "GRAPPA MIRTILLO", "COCKTAILS GIN TONIC", "COCKTAILS GIN TONIC H", "COCKTAILS GIN LEMON",
  "COCKTAILS GIN LEMON H", "COCKTAILS JACK COLA", "COCKTAILS RUM COLA", "COCKTAILS VODKA TONIC", "COCKTAILS JAGERBOMB",
  "COCKTAILS VODKA LEMON", "COCKTAILS AMERICANO", "BAILEYS", "JACK DANIELS", "TALISKER",
  "LIQUIRIZIA", "PRUGNA CM", "SAMBUCA", "TOAST", "PIZZETTA",
  "HOT DOG", "CARTA MANI", "CARTA IGIENICA", "SAPONE LIQUIDO", "SACCHI GRANDI",
  "SACCHI PICCOLI", "DET PAVIMENTI", "DET BAGNI", "DET SUPERFICI", "DET ACCIAIO",
  "SPUGNE GRANDI", "SPUGNE PICCOLE", "SPUGNE PIATTE", "LAVABICCHIERI B", "LAVABICCHIERI D"
];

// Variabile per memorizzare il file Excel caricato
let loadedExcelFile = null;
let pwaBuilderFolderHandle = null; // Handle cartella PWAbuilder per File System Access API

// Funzioni per gestire i file Excel
async function loadExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        loadedExcelFile = workbook;
        console.log('📊 File Excel caricato con successo');
        resolve(workbook);
      } catch (error) {
        console.error('❌ Errore caricamento Excel:', error);
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

function updateExcelWithConsumoData(consumoData) {
  if (!loadedExcelFile) {
    console.error('❌ Nessun file Excel caricato');
    return null;
  }
  
  try {
    // Clona il workbook per non modificare l'originale
    const workbook = XLSX.utils.book_new();
    
    // Copia tutti i fogli dall'originale
    loadedExcelFile.SheetNames.forEach(sheetName => {
      const originalSheet = loadedExcelFile.Sheets[sheetName];
      
      // Clona il foglio mantenendo tutte le proprietà originali
      const newSheet = {};
      Object.keys(originalSheet).forEach(key => {
        newSheet[key] = originalSheet[key];
      });
      
      // Se è il primo foglio (Sheet1), aggiorna SOLO le celle B2:B71
      if (sheetName === loadedExcelFile.SheetNames[0]) {
        console.log('📝 Aggiornamento celle B2:B71 (preservando formule)...');
        
        // Debug: mostra tutte le celle B2:B71 del file originale
        console.log('🔍 DEBUG: Contenuto celle B2:B71 nel file originale:');
        for (let i = 2; i <= 71; i++) {
          const cellAddr = `B${i}`;
          if (originalSheet[cellAddr]) {
            console.log(`${cellAddr}:`, originalSheet[cellAddr]);
          }
        }
        
        // Aggiorna solo le celle specifiche B2:B71
        DATABASE_PRODUCTS.forEach((productName, index) => {
          const rowNumber = index + 2; // B2, B3, B4, etc.
          const cellAddress = `B${rowNumber}`;
          const refillQuantity = consumoData[productName] || 0;
          
          // Leggi il valore esistente nella cella B
          let currentValue = 0;
          if (originalSheet[cellAddress]) {
            // Prova prima il valore calcolato (w), poi il valore grezzo (v)
            if (originalSheet[cellAddress].w !== undefined) {
              currentValue = parseFloat(originalSheet[cellAddress].w) || 0;
            } else if (originalSheet[cellAddress].v !== undefined) {
              currentValue = parseFloat(originalSheet[cellAddress].v) || 0;
            }
          }
          
          console.log(`🔍 ${productName} (${cellAddress}): cella =`, originalSheet[cellAddress], `→ valore = ${currentValue}, refill = ${refillQuantity}`);
          
          // Calcola il nuovo valore: esistente + quantità refill
          const newValue = currentValue + refillQuantity;
          
          // Aggiorna SEMPRE la cella (anche se refill = 0, per debug)
          newSheet[cellAddress] = {
            t: 'n', // tipo numero
            v: newValue, // valore aggiornato
            w: newValue.toString() // valore formattato
          };
          
          if (refillQuantity > 0) {
            console.log(`📊 ${productName} (${cellAddress}): ${currentValue} + ${refillQuantity} = ${newValue} ✅`);
          } else {
            console.log(`📊 ${productName} (${cellAddress}): ${currentValue} + 0 = ${newValue} ⚪`);
          }
        });
      }
      
      // Aggiungi il foglio al nuovo workbook
      XLSX.utils.book_append_sheet(workbook, newSheet, sheetName);
    });
    
    console.log('✅ File Excel aggiornato in memoria (formule preservate)');
    return workbook;
    
  } catch (error) {
    console.error('❌ Errore aggiornamento Excel:', error);
    return null;
  }
}

// File System Access API - Selezione cartella PWAbuilder
async function selectPWABuilderFolder() {
  if (!('showDirectoryPicker' in window)) {
    console.warn('⚠️ File System Access API non supportata. Fallback a download.');
    return null;
  }
  
  try {
    const directoryHandle = await window.showDirectoryPicker({
      id: 'pwabuilder-folder',
      mode: 'readwrite'
    });
    
    pwaBuilderFolderHandle = directoryHandle;
    console.log('✅ Cartella PWAbuilder selezionata:', directoryHandle.name);
    return directoryHandle;
    
  } catch (err) {
    console.warn('❌ Selezione cartella annullata:', err);
    return null;
  }
}

// File System Access API - Salvataggio diretto
async function saveDatabaseDirectly(workbook) {
  // Verifica se l'handle della cartella esiste e è ancora valido
  if (!pwaBuilderFolderHandle) {
    console.log('📁 Seleziona prima la cartella PWAbuilder...');
    pwaBuilderFolderHandle = await selectPWABuilderFolder();
  } else {
    // Testa se l'handle è ancora valido
    try {
      await pwaBuilderFolderHandle.queryPermission({ mode: 'readwrite' });
      console.log('✅ Handle cartella PWAbuilder ancora valido');
    } catch (error) {
      console.log('⚠️ Handle cartella PWAbuilder non più valido, richiedo selezione...');
      pwaBuilderFolderHandle = await selectPWABuilderFolder();
    }
  }
  
  if (!pwaBuilderFolderHandle) {
    console.log('📥 Fallback a download tradizionale...');
    return downloadUpdatedExcel(workbook);
  }
  
  try {
    // Ottiene/crea database.xlsx nella cartella
    const fileHandle = await pwaBuilderFolderHandle.getFileHandle('database.xlsx', {
      create: true
    });
    
    // Crea stream di scrittura
    const writable = await fileHandle.createWritable();
    
    // Converte workbook in blob
    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // Scrive e sovrascrive
    await writable.write(blob);
    await writable.close();
    
    console.log('✅ database.xlsx sovrascritto direttamente nella cartella PWAbuilder!');
    alert('✅ Database Excel aggiornato con successo!\n\n📁 Salvato direttamente in PWAbuilder/database.xlsx');
    return true;
    
  } catch (error) {
    console.error('❌ Errore salvataggio diretto:', error);
    console.log('📥 Fallback a download tradizionale...');
    return downloadUpdatedExcel(workbook);
  }
}

// Fallback download tradizionale
function downloadUpdatedExcel(workbook, filename = 'database.xlsx') {
  try {
    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    
    // Genera timestamp per nome univoco che evita duplicati
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const uniqueFilename = `database_${timestamp}.xlsx`;
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = uniqueFilename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log(`📥 File ${uniqueFilename} scaricato con successo`);
    console.log(`⚠️  IMPORTANTE: Sposta manualmente il file da Download a PWAbuilder e rinominalo in 'database.xlsx'`);
    
    // Mostra istruzioni all'utente
    setTimeout(() => {
      alert(`✅ File Excel aggiornato!\n\n📁 Salvato come: ${uniqueFilename}\n\n⚠️ Per completare:\n1. Vai in Download\n2. Sposta il file in PWAbuilder\n3. Rinominalo in 'database.xlsx'`);
    }, 500);
    
  } catch (error) {
    console.error('❌ Errore download Excel:', error);
  }
}

// Funzioni helper per gestire i valori editabili
function getEditableValue(productName) {
  const value = editableValues[productName] || 0;
  console.log(`GET editableValue per ${productName}: ${value}`); // Debug
  return value;
}

function setEditableValue(productName, value) {
  const numValue = parseFloat(value) || 0;
  editableValues[productName] = numValue;
  console.log(`SET editableValue per ${productName}: ${numValue}`, editableValues); // Debug
  // NON cancellare i valori 0 - sono validi!
  // Cancella solo se il valore è effettivamente vuoto/undefined
  if (value === '' || value === null || value === undefined) {
    delete editableValues[productName];
  }
}

// Funzioni helper per gestire i valori storage
function getStorageValue(productName) {
  return storageValues[productName] || 0;
}

function setStorageValue(productName, value) {
  const numValue = parseFloat(value) || 0;
  storageValues[productName] = numValue;
  console.log(`SET storageValue per ${productName}: ${numValue}`, storageValues); // Debug
  if (value === '' || value === null || value === undefined) {
    delete storageValues[productName];
  }
}


function getProductResult(productName) {
  const consumo = getConsumoCounter(productName);
  const editable = getEditableValue(productName);
  return consumo * editable;
}

// Funzioni helper per gestire i contatori manutenzione
function getMaintenanceCounter(productName) {
  return maintenanceCounters[productName] || 0;
}

function incrementMaintenanceCounter(productName) {
  maintenanceCounters[productName] = (maintenanceCounters[productName] || 0) + 1;
}

function decrementMaintenanceCounter(productName) {
  const currentValue = maintenanceCounters[productName] || 0;
  console.log(`MANUTENZIONE: Decrementing ${productName} from ${currentValue}`);
  
  if(currentValue > 0) {
    maintenanceCounters[productName] = currentValue - 1;
    console.log(`MANUTENZIONE: ${productName} decremented to ${maintenanceCounters[productName]}`);
    
    if(maintenanceCounters[productName] <= 0) {
      delete maintenanceCounters[productName];
      console.log(`MANUTENZIONE: ${productName} deleted from counters`);
    }
  } else {
    console.log(`MANUTENZIONE: ${productName} already at 0, cannot decrement further`);
  }
}

function executeRefillReset() {
  console.log('RESET REFILL: Inizio esecuzione reset...');
  
  // Disabilita Firebase completamente
  const wasFirebaseEnabled = firebaseEnabled;
  firebaseEnabled = false;
  console.log('RESET REFILL: Firebase disabilitato');
  
  // Debug: mostra cosa c'è in refillList prima del reset
  console.log('RESET REFILL: refillList prima del reset:', refillList);
  console.log('RESET REFILL: refillCounters prima del reset:', refillCounters);
  
  // Prima di azzerare, trasferisci i dati refill alle liste spesa/magazzino/consumo
  console.log('RESET REFILL: Inizio trasferimento dati...');
  const refillKeys = Object.keys(refillList);
  console.log('RESET REFILL: Prodotti da trasferire:', refillKeys);
  
  try {
    refillKeys.forEach(productName => {
      try {
        console.log(`RESET REFILL: Processando ${productName}...`);
        
        // Fix per dati corrotti: se refillList[productName] è una stringa, usa refillCounters
        let quantity, value;
        if(typeof refillList[productName] === 'object' && refillList[productName] !== null) {
          quantity = getRefillQuantity(productName);
          value = getRefillValue(productName);
        } else {
          // Fallback: usa refillCounters per quantità e valore di default da editableValues
          quantity = refillCounters[productName] || 0;
          value = getEditableValue(productName) || 0;
          console.log(`RESET REFILL: Dati corrotti per ${productName}, usando fallback qty=${quantity}, val=${value}`);
        }
        
        if(quantity > 0) {
          // 1. CONSUMO: Aggiungi alla lista consumo (somma se già esiste)
          if(!consumoList[productName]) consumoList[productName] = {quantity: 0, value: 0};
          consumoList[productName].quantity += quantity;
          consumoList[productName].value = 0; // Sempre 0 nelle liste consumo
          incrementConsumoCounter(productName, quantity);

          // 2. Trasferisci il valore ai valori editabili
          const currentEditable = getEditableValue(productName) || 0;
          const newEditableValue = currentEditable + (parseFloat(value) || 0);
          setEditableValue(productName, newEditableValue);
          console.log(`RESET REFILL: ${productName} editable ${currentEditable} + ${value} = ${newEditableValue}`);
          
          // 3. Aggiorna anche direttamente storageValues
          const currentStorage = getStorageValue(productName) || 0;
          const storageIncrement = (parseFloat(quantity) || 0) * (parseFloat(value) || 0);
          const newStorageValue = currentStorage + storageIncrement;
          setStorageValue(productName, newStorageValue);
          console.log(`RESET REFILL: ${productName} storage ${currentStorage} + (${quantity}*${value}) = ${newStorageValue}`);
        }
      } catch(err) {
        console.error(`RESET REFILL: Errore processando ${productName}:`, err);
      }
    });
  } catch(err) {
    console.error('RESET REFILL: Errore generale nel trasferimento:', err);
  }
  
  // Azzera tutto completamente
  console.log('RESET REFILL: Azzerando refillList e refillCounters...');
  refillList = {};
  refillCounters = {};
  maintenanceCounters = {};
  
  console.log('RESET REFILL: Dopo azzeramento - refillList:', refillList);
  console.log('RESET REFILL: Dopo azzeramento - refillCounters:', refillCounters);
  
  // Salva in localStorage
  localStorage.setItem('breakOrdersState', JSON.stringify({
    tableOrders, savedOrders, totals, tableNames, storico, evasiOrders, 
    refillList: {}, refillCounters: {}, maintenanceCounters: {}, 
    consumoCounters, consumoList, editableValues, storageValues,
    amazonList, poggianaList, prixList, battocchioList,
    currentBackground, currentFont, currentFontSize, fontSettings, 
    modifiersList, subcategories
  }));
  
  // Riabilita Firebase e forza il salvataggio
  firebaseEnabled = wasFirebaseEnabled;
  if (firebaseEnabled && database) {
    console.log('RESET REFILL: Salvando dati azzerati su Firebase...');
    database.ref('breakOrders').update({
      refillList: {},
      refillCounters: {},
      maintenanceCounters: {},
      _meta: { lastUpdated: firebase.database.ServerValue.TIMESTAMP }
    }).then(() => {
      console.log('RESET REFILL: Dati azzerati salvati su Firebase con successo');
    }).catch(err => {
      console.error('RESET REFILL: Errore salvataggio Firebase:', err);
    });
  }
  
  // Leggi i dati dalle celle Excel per le liste carrello
  if (loadedExcelFile) {
    try {
      console.log('RESET REFILL: Leggendo dati Excel per liste carrello...');
      
      // Azzera le liste carrello prima di riempirle
      amazonList = [];
      poggianaList = [];
      prixList = [];
      battocchioList = [];
      console.log('RESET REFILL: Liste carrello azzerate');
      
      const firstSheet = loadedExcelFile.Sheets[loadedExcelFile.SheetNames[0]];
      
      // Debug: mostra info generali sul foglio
      console.log('RESET REFILL: Nome foglio:', loadedExcelFile.SheetNames[0]);
      console.log('RESET REFILL: Numero di celle nel foglio:', Object.keys(firstSheet).length);
      
      // Debug: controlla se esistono le righe 85-88
      const testCells = ['I85', 'J85', 'K85', 'I86', 'I87', 'I88'];
      testCells.forEach(cellRef => {
        const cell = firstSheet[cellRef];
        if (cell) {
          console.log(`RESET REFILL: Test cella ${cellRef}:`, {
            v: cell.v,
            w: cell.w,
            f: cell.f,
            t: cell.t
          });
        } else {
          console.log(`RESET REFILL: Cella ${cellRef} non trovata o vuota`);
        }
      });
      
      // Debug: scansiona tutte le celle nelle righe 84-87 per vedere cosa c'è
      console.log('RESET REFILL: Scansionando tutte le celle nelle righe 84-87...');
      const allCells = Object.keys(firstSheet);
      const relevantCells = allCells.filter(cellRef => {
        const match = cellRef.match(/^([A-Z]+)(\d+)$/);
        if (match) {
          const row = parseInt(match[2]);
          return row >= 84 && row <= 87;
        }
        return false;
      });
      
      console.log(`RESET REFILL: Trovate ${relevantCells.length} celle nelle righe 84-87:`, relevantCells);
      
      relevantCells.forEach(cellRef => {
        const cell = firstSheet[cellRef];
        if (cell && (cell.v || cell.w)) {
          console.log(`RESET REFILL: Cella ${cellRef} contiene:`, {
            v: cell.v,
            w: cell.w,
            f: cell.f,
            t: cell.t
          });
        }
      });
      
      // Debug: prova anche a forzare il ricalcolo delle formule
      console.log('RESET REFILL: Tentativo di forzare ricalcolo formule...');
      try {
        // Prova a utilizzare XLSX.utils per ricalcolare
        if (typeof XLSX !== 'undefined' && XLSX.utils && XLSX.utils.sheet_to_json) {
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false});
          if (jsonData[83]) { // riga 84 (0-indexed)
            console.log('RESET REFILL: Riga 84 da JSON:', jsonData[83]);
          }
          if (jsonData[84]) { // riga 85
            console.log('RESET REFILL: Riga 85 da JSON:', jsonData[84]);
          }
          if (jsonData[85]) { // riga 86
            console.log('RESET REFILL: Riga 86 da JSON:', jsonData[85]);
          }
          if (jsonData[86]) { // riga 87
            console.log('RESET REFILL: Riga 87 da JSON:', jsonData[86]);
          }
        }
      } catch (err) {
        console.log('RESET REFILL: Errore nel ricalcolo formule:', err);
      }
      
      // Funzione helper per convertire numero colonna in lettera (I=9, CB=80)
      const getColumnLetter = (colNum) => {
        let result = '';
        while (colNum > 0) {
          colNum--;
          result = String.fromCharCode(65 + (colNum % 26)) + result;
          colNum = Math.floor(colNum / 26);
        }
        return result;
      };
      
      // Leggi range I85:CB85 (colonne 9-80, riga 85) per Amazon
      const amazonNames = [];
      console.log('RESET REFILL: Leggendo riga 85 per Amazon...');
      for (let col = 9; col <= 80; col++) { // I=9, CB=80
        const cellRef = getColumnLetter(col) + '85';
        const cell = firstSheet[cellRef];
        
        // Debug: mostra cosa c'è nella cella
        if (cell) {
          console.log(`RESET REFILL: Cella ${cellRef}:`, {
            v: cell.v,
            w: cell.w,
            f: cell.f,
            t: cell.t
          });
        }
        
        // Prova diversi modi per ottenere il valore
        let cellValue = null;
        if (cell) {
          // Prova prima il valore calcolato (w), poi il valore grezzo (v)
          cellValue = cell.w || cell.v;
          if (cellValue && cellValue.toString().trim() !== '') {
            const trimmedValue = cellValue.toString().trim();
            amazonNames.push(trimmedValue);
            console.log(`RESET REFILL: Aggiunto ad Amazon da ${cellRef}: "${trimmedValue}"`);
          }
        }
      }
      
      // Leggi range I86:CB86 per Poggiana
      const poggianaNames = [];
      console.log('RESET REFILL: Leggendo riga 86 per Poggiana...');
      for (let col = 9; col <= 80; col++) {
        const cellRef = getColumnLetter(col) + '86';
        const cell = firstSheet[cellRef];
        
        let cellValue = null;
        if (cell) {
          cellValue = cell.w || cell.v;
          if (cellValue && cellValue.toString().trim() !== '') {
            const trimmedValue = cellValue.toString().trim();
            poggianaNames.push(trimmedValue);
            console.log(`RESET REFILL: Aggiunto a Poggiana da ${cellRef}: "${trimmedValue}"`);
          }
        }
      }
      
      // Leggi range I87:CB87 per Prix
      const prixNames = [];
      console.log('RESET REFILL: Leggendo riga 87 per Prix...');
      for (let col = 9; col <= 80; col++) {
        const cellRef = getColumnLetter(col) + '87';
        const cell = firstSheet[cellRef];
        
        let cellValue = null;
        if (cell) {
          cellValue = cell.w || cell.v;
          if (cellValue && cellValue.toString().trim() !== '') {
            const trimmedValue = cellValue.toString().trim();
            prixNames.push(trimmedValue);
            console.log(`RESET REFILL: Aggiunto a Prix da ${cellRef}: "${trimmedValue}"`);
          }
        }
      }
      
      // Leggi range I88:CB88 per Battocchio
      const battocchioNames = [];
      console.log('RESET REFILL: Leggendo riga 88 per Battocchio...');
      for (let col = 9; col <= 80; col++) {
        const cellRef = getColumnLetter(col) + '88';
        const cell = firstSheet[cellRef];
        
        let cellValue = null;
        if (cell) {
          cellValue = cell.w || cell.v;
          if (cellValue && cellValue.toString().trim() !== '') {
            const trimmedValue = cellValue.toString().trim();
            battocchioNames.push(trimmedValue);
            console.log(`RESET REFILL: Aggiunto a Battocchio da ${cellRef}: "${trimmedValue}"`);
          }
        }
      }
      
      // Mostra risultati del metodo diretto
      console.log('RESET REFILL: Risultati metodo diretto:', {
        amazon: amazonNames.length,
        poggiana: poggianaNames.length, 
        prix: prixNames.length,
        battocchio: battocchioNames.length
      });
      
      // Se non abbiamo trovato nomi con il metodo diretto, prova con JSON
      if (amazonNames.length === 0 && poggianaNames.length === 0 && prixNames.length === 0 && battocchioNames.length === 0) {
        console.log('RESET REFILL: Metodo diretto fallito, provo con JSON...');
        try {
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false});
          
          // Riga 84 (indice 83) per Amazon
          if (jsonData[83]) {
            jsonData[83].forEach((cell, index) => {
              if (cell && cell.toString().trim() !== '' && index >= 8) { // colonna I = indice 8
                amazonNames.push(cell.toString().trim());
                console.log(`RESET REFILL: Amazon da JSON colonna ${index + 1}: "${cell}"`);
              }
            });
          }
          
          // Riga 85 (indice 84) per Poggiana
          if (jsonData[84]) {
            jsonData[84].forEach((cell, index) => {
              if (cell && cell.toString().trim() !== '' && index >= 8) {
                poggianaNames.push(cell.toString().trim());
                console.log(`RESET REFILL: Poggiana da JSON colonna ${index + 1}: "${cell}"`);
              }
            });
          }
          
          // Riga 86 (indice 85) per Prix
          if (jsonData[85]) {
            jsonData[85].forEach((cell, index) => {
              if (cell && cell.toString().trim() !== '' && index >= 8) {
                prixNames.push(cell.toString().trim());
                console.log(`RESET REFILL: Prix da JSON colonna ${index + 1}: "${cell}"`);
              }
            });
          }
          
          // Riga 87 (indice 86) per Battocchio
          if (jsonData[86]) {
            jsonData[86].forEach((cell, index) => {
              if (cell && cell.toString().trim() !== '' && index >= 8) {
                battocchioNames.push(cell.toString().trim());
                console.log(`RESET REFILL: Battocchio da JSON colonna ${index + 1}: "${cell}"`);
              }
            });
          }
          
        } catch (err) {
          console.error('RESET REFILL: Errore lettura JSON:', err);
        }
      }
      
      // Aggiungi i nomi alle rispettive liste
      const timestamp = new Date().toISOString();
      
      amazonNames.forEach(name => {
        amazonList.push({
          name: name,
          timestamp: timestamp
        });
      });
      
      poggianaNames.forEach(name => {
        poggianaList.push({
          name: name,
          timestamp: timestamp
        });
      });
      
      prixNames.forEach(name => {
        prixList.push({
          name: name,
          timestamp: timestamp
        });
      });
      
      battocchioNames.forEach(name => {
        battocchioList.push({
          name: name,
          timestamp: timestamp
        });
      });
      
      console.log('RESET REFILL: Liste carrello aggiornate:', {
        amazon: `${amazonNames.length} nomi aggiunti (totale: ${amazonList.length})`,
        poggiana: `${poggianaNames.length} nomi aggiunti (totale: ${poggianaList.length})`,
        prix: `${prixNames.length} nomi aggiunti (totale: ${prixList.length})`,
        battocchio: `${battocchioNames.length} nomi aggiunti (totale: ${battocchioList.length})`
      });
      
      // Mostra sempre lo stato finale delle liste
      console.log('RESET REFILL: Stato finale liste carrello:', {
        amazonList: amazonList.map(item => item.name),
        poggianaList: poggianaList.map(item => item.name),
        prixList: prixList.map(item => item.name),
        battocchioList: battocchioList.map(item => item.name)
      });
      
    } catch (err) {
      console.error('RESET REFILL: Errore lettura celle Excel:', err);
    }
  } else {
    console.warn('RESET REFILL: Nessun file Excel caricato, liste carrello non aggiornate');
  }
  
  console.log('RESET REFILL: Reset completato');
  
  // Forza sincronizzazione liste carrello per mobile
  setTimeout(() => {
    forceSyncShoppingLists();
  }, 1000);
  
  // Riapri il popup per aggiornare i contatori visualizzati
  openRefillSimple();
}

function resetRefillQuantitiesOnly(productNames) {
  // Prima di azzerare, aggiungi le quantità a consumoList
  productNames.forEach(productName => {
    if (refillList[productName]) {
      const quantity = getRefillQuantity(productName);
      const value = getRefillValue(productName);
      if(quantity > 0) {
        // Aggiungi alla lista consumo (somma se già esiste)
        if(!consumoList[productName]) consumoList[productName] = {quantity: 0, value: 0};
        consumoList[productName].quantity += quantity;
        consumoList[productName].value = 0; // Sempre 0 nelle liste consumo
      }
      refillList[productName].quantity = 0;
      // Se la quantità diventa 0, rimuovi completamente il prodotto
      if (refillList[productName].quantity <= 0) {
        delete refillList[productName];
      }
    }
  });
}
let currentBackground = "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4";
let currentFont = "Arial, Helvetica, sans-serif";
let currentFontSize = 16; // dimensione base in px
let fontSettings = {
  utility: {font: "Arial, Helvetica, sans-serif", size: 20, padding: 20, color: "#ffffff"},
  tavoli: {font: "Arial, Helvetica, sans-serif", size: 24, padding: 21, color: "#ffffff"},
  ordiniSalvati: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 12, color: "#ffffff"},
  categorie: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 20, color: "#ffffff"},
  sottocategorie: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 20, color: "#ffffff"},
  modificatori: {font: "Arial, Helvetica, sans-serif", size: 14, padding: 10, color: "#ffffff"},
  azioni: {font: "Arial, Helvetica, sans-serif", size: 18, padding: 20, color: "#ffffff"},
  ordini: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 6, color: "#ffffff"},
  conferma: {font: "Arial, Helvetica, sans-serif", size: 16, padding: 12, color: "#ffffff"}
};
let modifiersList = ["SR", "M", "K", "S", "GH"];
let subcategories = {
  "CAFFÈ CORRETTO": [{name:"GRAPPA",price:1.50},{name:"SAMBUCA",price:1.50},{name:"BAILEYS",price:1.50},{name:"PRUGNA",price:1.50}],
  "SPRITZ": [{name:"LISCIO",price:2.50},{name:"APEROL",price:3.00},{name:"CAMPARI",price:3.00},{name:"CYNAR",price:3.00}],
  "AMARO": [{name:"MONTENEGRO",price:3.00},{name:"JAGERMEISTER",price:3.00},{name:"CAPO",price:3.00},{name:"BRAULIO",price:3.00},{name:"BRANCAMENTA",price:3.00},{name:"PETRUS",price:3.00}],
  "GRAPPA": [{name:"BIANCA",price:3.00},{name:"24k",price:3.00},{name:"MIELE",price:3.00},{name:"CAMOMILLA",price:3.00},{name:"PRUGNA",price:3.00},{name:"MIRTILLO",price:3.00}],
  "COCKTAILS": [{name:"GIN TONIC",price:6.00},{name:"GIN TONIC H",price:8.00},{name:"GIN LEMON",price:6.00},{name:"GIN LEMON H",price:8.00},{name:"JACK COLA",price:8.00},{name:"RUM COLA",price:6.00},{name:"VODKA TONIC",price:6.00},{name:"JAGERBOMB",price:6.00},{name:"VODKA LEMON",price:6.00},{name:"AMERICANO",price:4.00}]
};

const tablesContainer = document.getElementById('tables-container');
const savedOrdersDiv = document.getElementById('saved-orders');
const popup = document.getElementById('popup');
const popupTitle = document.getElementById('popup-title');
const categoriesDiv = document.querySelector('.categories-grid');
const subcatsDiv = document.getElementById('subcats');
const tempoPad = document.getElementById('tempo-pad');
const tempoDisplay = document.getElementById('tempo-display');
const cassaPad = document.getElementById('cassa-pad');
const cassaDisplay = document.getElementById('cassa-display');
const modifiersDiv = document.getElementById('modifiers');
const actionsDiv = document.getElementById('actions');
const orderList = document.getElementById('order-list');

let tempoValue = "";
let cassaValue = "";
let confirmCallback = null;
let refillHistoryHandler = null; // intercetta il tasto back mentre il REFILL è aperto

function enableRefillHistoryTrap(){
  try{
    if(refillHistoryHandler) return;
    refillHistoryHandler = (e)=>{
      const overlay = document.getElementById('refill-overlay');
      if(overlay){
        if(e && e.preventDefault) e.preventDefault();
        // ripristina lo stato per evitare di uscire
        try { history.pushState({refill:true}, ''); } catch(_){ }
        overlay.remove();
      }
    };
    window.addEventListener('popstate', refillHistoryHandler);
    try { history.pushState({refill:true}, ''); } catch(_){ }
  }catch(err){ console.warn('enableRefillHistoryTrap error', err); }
}

function disableRefillHistoryTrap(){
  try{
    if(!refillHistoryHandler) return;
    window.removeEventListener('popstate', refillHistoryHandler);
    refillHistoryHandler = null;
  }catch(err){ console.warn('disableRefillHistoryTrap error', err); }
}

/* Funzioni helper per animazioni popup */
function showPopup(){
  popup.classList.remove('hide');
  popup.style.display = 'flex';
  // Force reflow per attivare l'animazione
  void popup.offsetWidth;
  popup.classList.add('show');
}

function hidePopup(callback){
  popup.classList.remove('show');
  popup.classList.add('hide');
  setTimeout(() => {
    popup.style.display = 'none';
    popup.classList.remove('hide');
    if(callback) callback();
  }, 300); // Durata dell'animazione
}

/* Funzione helper per vibrazione tattile */
function vibrate(pattern = [10]){
  if ('vibrate' in navigator) {
    try {
      navigator.vibrate(pattern);
    } catch(e) {
      console.log('Vibration not supported:', e);
    }
  }
}

// Pattern di vibrazione predefiniti
const VIBRATION_PATTERNS = {
  tap: [10],           // Tap leggero
  click: [20],         // Click normale
  success: [30, 50, 30], // Successo (doppio tap)
  error: [100],        // Errore (vibrazione lunga)
  warning: [50, 30, 50], // Avviso
  longPress: [50]      // Pressione lunga
};

function saveData(){
  try{
    // Dati da sincronizzare su Firebase (ordini + nomi tavoli)
    // Evita di inviare oggetti/array vuoti per non sovrascrivere dati esistenti sul server
    const firebaseData = {};
    const addIfHasData = (key, value) => {
      if (value == null) return;
      if (Array.isArray(value)) { if (value.length > 0) firebaseData[key] = value; return; }
      if (typeof value === 'object') { if (Object.keys(value).length > 0) firebaseData[key] = value; return; }
      firebaseData[key] = value;
    };
    addIfHasData('tableOrders', tableOrders);
    addIfHasData('savedOrders', savedOrders);
    addIfHasData('totals', totals);
    // Forza sempre il salvataggio dello storico, anche se vuoto
    firebaseData['storico'] = storico || [];
    console.log('SaveData - Salvando storico con', (storico || []).length, 'elementi');
    // Forza sempre il salvataggio degli evasi, anche se vuoto
    firebaseData['evasiOrders'] = evasiOrders || [];
    console.log('SaveData - Salvando evasi con', (evasiOrders || []).length, 'elementi');
    addIfHasData('refillList', refillList);
    addIfHasData('refillCounters', refillCounters);
    // Forza sempre il salvataggio di maintenanceCounters, anche se vuoto
    firebaseData['maintenanceCounters'] = maintenanceCounters;
    addIfHasData('consumoCounters', consumoCounters);
    addIfHasData('consumoList', consumoList);
    addIfHasData('editableValues', editableValues);
    addIfHasData('storageValues', storageValues);
    // Forza sempre il salvataggio delle liste carrello, anche se vuote
    firebaseData['amazonList'] = amazonList || [];
    firebaseData['poggianaList'] = poggianaList || [];
    firebaseData['prixList'] = prixList || [];
    firebaseData['battocchioList'] = battocchioList || [];
    console.log('SaveData - Salvando liste carrello:', {
      amazon: (amazonList || []).length,
      poggiana: (poggianaList || []).length,
      prix: (prixList || []).length,
      battocchio: (battocchioList || []).length
    });
    addIfHasData('tableNames', tableNames);
    // Metadati server per ordinamento/risoluzione conflitti lato client
    firebaseData._meta = { lastUpdated: firebase.database.ServerValue.TIMESTAMP };
    
    // Dati completi da salvare in localStorage (ordini + impostazioni)
    const localData = {
      tableOrders, savedOrders, totals, tableNames, storico, evasiOrders, refillList, refillCounters, maintenanceCounters, consumoCounters, consumoList, editableValues, storageValues,
      amazonList, poggianaList, prixList, battocchioList,
      currentBackground, currentFont, currentFontSize, fontSettings, 
      modifiersList, subcategories
    };
    
    // Salva sempre in localStorage come backup
    localStorage.setItem('breakOrdersState', JSON.stringify(localData));
    
    // Se Firebase è abilitato, sincronizza SOLO gli ordini
    if (firebaseEnabled && database && !isUpdatingFromFirebase) {
      // update() evita di sovrascrivere le chiavi non incluse nel payload
      database.ref('breakOrders').update(firebaseData).catch(err => {
        console.error("Errore salvataggio Firebase:", err);
      });
    }
  }catch(e){ 
    console.error("Errore saveData:", e);
  }
}
function loadData(){
  try{
    const raw = localStorage.getItem('breakOrdersState');
    if(!raw) return;
    const parsed = JSON.parse(raw);
    applyParsedData(parsed);
  }catch(e){ 
    console.error("Errore loadData:", e);
  }
}

// Funzione helper per applicare i dati parsati
function applyParsedData(parsed, fromFirebase = false){
  if(!parsed) return;
  
  tableOrders = parsed.tableOrders || {};
  // normalize savedOrders to {id,tableName,items,consegnato}
  if(Array.isArray(parsed.savedOrders)){
    savedOrders = parsed.savedOrders.map(s=>{
      if(!s) return null;
      const id = s.id || s.name || (Date.now().toString(36)+Math.random().toString(36).slice(2,6));
      const tableName = s.tableName || s.name || s.table || "Riepilogo";
      const items = s.items || s.itemsList || [];
      const consegnato = s.consegnato || false;
      const timestampDone = s.timestampDone || null;
      return { id, tableName, items, consegnato, timestampDone };
    }).filter(Boolean);
  } else savedOrders = [];
  totals = parsed.totals || totals;
  // Assicura che tutte le categorie esistano
  if(!totals.cassa) totals.cassa = 0;
  storico = parsed.storico || parsed.storicoList || [];
  console.log('LoadData - Caricato storico con', storico.length, 'elementi');
  evasiOrders = parsed.evasiOrders || [];
  console.log('LoadData - Caricato evasi con', evasiOrders.length, 'elementi');
  
  // RefillList e RefillCounters: Firebase ha priorità
  if(parsed.refillList){
    if(fromFirebase) {
      refillList = { ...parsed.refillList };
    } else if(Object.keys(refillList).length === 0) {
      refillList = { ...parsed.refillList };
    }
  }
  if(parsed.refillCounters){
    if(fromFirebase) {
      refillCounters = { ...parsed.refillCounters };
    } else if(Object.keys(refillCounters).length === 0) {
      refillCounters = { ...parsed.refillCounters };
    }
  }
  console.log('REFILL: Caricati dati refill:', {refillList, refillCounters, fromFirebase});
  
  // MaintenanceCounters: Firebase ha priorità, localStorage solo se Firebase vuoto
  if(parsed.maintenanceCounters){
    console.log(`🔧 MAINTENANCE: ${fromFirebase ? 'Firebase' : 'localStorage'} - prima:`, {...maintenanceCounters});
    console.log(`🔧 MAINTENANCE: ${fromFirebase ? 'Firebase' : 'localStorage'} - ricevuti:`, parsed.maintenanceCounters);
    
    if(fromFirebase) {
      // Firebase ha priorità assoluta - sostituisce tutto
      maintenanceCounters = { ...parsed.maintenanceCounters };
      console.log(`🔧 MAINTENANCE: Firebase - SOSTITUITO completamente:`, {...maintenanceCounters});
    } else {
      // localStorage solo se maintenanceCounters è vuoto
      if(Object.keys(maintenanceCounters).length === 0) {
        maintenanceCounters = { ...parsed.maintenanceCounters };
        console.log(`🔧 MAINTENANCE: localStorage - caricato (era vuoto):`, {...maintenanceCounters});
      } else {
        console.log(`🔧 MAINTENANCE: localStorage - IGNORATO (Firebase già caricato)`);
      }
    }
  }
  
  // ConsumoCounters: sincronizza con Firebase
  if(parsed.consumoCounters){
    consumoCounters = { ...(consumoCounters || {}), ...parsed.consumoCounters };
  }
  
  // ConsumoList: sincronizza con Firebase
  if(parsed.consumoList){
    consumoList = { ...(consumoList || {}), ...parsed.consumoList };
  }
  
  // EditableValues: priorità a localStorage, effettua merge per non perdere chiavi
  if(!fromFirebase){
    const incoming = parsed.editableValues || {};
    editableValues = { ...(editableValues || {}), ...incoming };
    console.log('editableValues da localStorage (merge):', editableValues); // Debug
  } else if(parsed.editableValues && Object.keys(editableValues).length === 0){
    // Caricamento da Firebase solo se localStorage era vuoto
    editableValues = parsed.editableValues;
    console.log('CARICATI editableValues da Firebase (localStorage vuoto):', editableValues); // Debug
  } else {
    console.log('editableValues mantenuti (Firebase ignorato):', editableValues); // Debug
  }
  
  // StorageValues: merge
  if(!fromFirebase){
    const incoming = parsed.storageValues || {};
    storageValues = { ...(storageValues || {}), ...incoming };
    console.log('storageValues da localStorage (merge):', storageValues); // Debug
  } else if(parsed.storageValues && Object.keys(storageValues).length === 0){
    storageValues = parsed.storageValues;
    console.log('CARICATI storageValues da Firebase (localStorage vuoto):', storageValues); // Debug
  } else {
    console.log('storageValues mantenuti (Firebase ignorato):', storageValues); // Debug
  }
  
  // Carica le liste carrello - Firebase ha priorità SEMPRE
  if(fromFirebase) {
    // Firebase ha priorità assoluta - sostituisce SEMPRE tutto
    amazonList = [...(parsed.amazonList || [])];
    poggianaList = [...(parsed.poggianaList || [])];
    prixList = [...(parsed.prixList || [])];
    battocchioList = [...(parsed.battocchioList || [])];
    console.log('🔄 SYNC: Liste carrello AGGIORNATE da Firebase:', {
      amazon: amazonList.length,
      poggiana: poggianaList.length,
      prix: prixList.length,
      battocchio: battocchioList.length
    });
  } else {
    // localStorage solo se le liste sono vuote (primo caricamento)
    if(parsed.amazonList && amazonList.length === 0) amazonList = [...(parsed.amazonList || [])];
    if(parsed.poggianaList && poggianaList.length === 0) poggianaList = [...(parsed.poggianaList || [])];
    if(parsed.prixList && prixList.length === 0) prixList = [...(parsed.prixList || [])];
    if(parsed.battocchioList && battocchioList.length === 0) battocchioList = [...(parsed.battocchioList || [])];
    console.log('📂 SYNC: Liste carrello da localStorage (backup):', {
      amazon: amazonList.length,
      poggiana: poggianaList.length,
      prix: prixList.length,
      battocchio: battocchioList.length
    });
  }
  
  // Sincronizza tableNames da Firebase
  if(parsed.tableNames) tableNames.splice(0, tableNames.length, ...parsed.tableNames);
  
  // Carica impostazioni SOLO da localStorage, NON da Firebase
  if(!fromFirebase){
    currentBackground = parsed.currentBackground || currentBackground;
    currentFont = parsed.currentFont || currentFont;
    currentFontSize = parsed.currentFontSize || currentFontSize;
    
    // Carica fontSettings e assicura che tutte le nuove categorie esistano
    if(parsed.fontSettings){
      fontSettings = parsed.fontSettings;
      // Aggiungi le nuove categorie se mancano
      if(!fontSettings.utility){
        fontSettings.utility = {font: "Arial, Helvetica, sans-serif", size: 20, padding: 20, color: "#ffffff"};
      }
      if(!fontSettings.ordiniSalvati){
        fontSettings.ordiniSalvati = {font: "Arial, Helvetica, sans-serif", size: 16, padding: 12, color: "#ffffff"};
      }
    }
    
    modifiersList = parsed.modifiersList || modifiersList;
    subcategories = parsed.subcategories || subcategories;
    if(parsed.tableNames) tableNames.splice(0, tableNames.length, ...parsed.tableNames);
    applyBackground();
    applyFont();
    renderModifiers();
  }
}

// Setup Firebase Real-time Sync
function setupFirebaseSync(){
  if(!firebaseEnabled || !database) return;
  
  console.log("🔄 Attivazione sincronizzazione Firebase...");
  
  // Listener per aggiornamenti in tempo reale
  database.ref('breakOrders').on('value', (snapshot) => {
    const data = snapshot.val();
    if(data){
      console.log("📥 Ricevuti dati da Firebase");
      console.log("📥 LISTE DEBUG: Dati ricevuti da Firebase:", {
        amazonList: (data.amazonList || []).length,
        poggianaList: (data.poggianaList || []).length,
        prixList: (data.prixList || []).length,
        battocchioList: (data.battocchioList || []).length
      });
      isUpdatingFromFirebase = true;
      applyParsedData(data, true); // true = da Firebase, non caricare impostazioni
      renderTables();
      renderSavedButtons();
      isUpdatingFromFirebase = false;
    }
  }, (error) => {
    console.error("❌ Errore listener Firebase:", error);
  });
  
  
  // Carica i dati iniziali da Firebase
  database.ref('breakOrders').once('value').then((snapshot) => {
    const data = snapshot.val();
    if(data){
      console.log("📥 Caricamento iniziale da Firebase completato");
      isUpdatingFromFirebase = true;
      
      // Carica impostazioni locali PRIMA di applicare dati Firebase
      const localSettings = localStorage.getItem('breakOrdersState');
      if(localSettings){
        const parsed = JSON.parse(localSettings);
        console.log("🔄 INIT: Caricando impostazioni locali, maintenanceCounters:", parsed.maintenanceCounters);
        applyParsedData(parsed, false); // Carica impostazioni locali
      }
      
      // Poi applica solo gli ordini da Firebase
      console.log("🔄 INIT: Caricando dati Firebase, maintenanceCounters:", data.maintenanceCounters);
      applyParsedData(data, true); // true = da Firebase, non caricare impostazioni
      renderTables();
      renderSavedButtons();
      isUpdatingFromFirebase = false;
    } else {
      console.log("📤 Nessun dato su Firebase, carico da localStorage");
      loadData();
      // Se c'è qualcosa in localStorage, sincronizza su Firebase
      const localData = localStorage.getItem('breakOrdersState');
      if(localData){
        saveData();
      }
    }
  }).catch((error) => {
    console.error("❌ Errore caricamento Firebase:", error);
    console.log("📂 Fallback a localStorage");
    loadData();
  });
}

// Funzione per forzare la sincronizzazione delle liste carrello su mobile
function forceSyncShoppingLists() {
  if (!firebaseEnabled || !database) return;
  
  console.log("🔄 FORCE SYNC: Forzando sincronizzazione liste carrello...");
  
  // Aggiorna solo le liste carrello nel percorso principale
  const listsUpdate = {
    amazonList: amazonList || [],
    poggianaList: poggianaList || [],
    prixList: prixList || [],
    battocchioList: battocchioList || [],
    '_meta/lastUpdated': firebase.database.ServerValue.TIMESTAMP,
    '_meta/forceSync': Date.now()
  };
  
  // Usa update() per aggiornare solo le liste nel percorso principale
  database.ref('breakOrders').update(listsUpdate).then(() => {
    console.log("✅ FORCE SYNC: Liste carrello sincronizzate con successo");
    console.log("✅ FORCE SYNC: Dati sincronizzati:", {
      amazon: (amazonList || []).length,
      poggiana: (poggianaList || []).length,
      prix: (prixList || []).length,
      battocchio: (battocchioList || []).length
    });
  }).catch(err => {
    console.error("❌ FORCE SYNC: Errore sincronizzazione liste:", err);
  });
}

/* catalogo */
const CATALOG = {
  c1: [ {name:"CAFFÈ LISCIO", price:1.00}, {name:"CAFFÈ DECA", price:1.00}, {name:"CAFFÈ CORRETTO", price:1.50} ],
  c2: [ {name:"PYRASER 0,3", price:3.50}, {name:"PYRASER 0,5", price:5.50}, {name:"ARIA 0,3", price:3.50}, {name:"ARIA 0,5", price:5.50}, {name:"GUINNESS 0,25", price:3.50}, {name:"GUINNESS 0,5", price:5.50}, {name:"SPRITZ", price:2.50} ],
  c3: [ {name:"ACQUA NATURALE", price:1.00}, {name:"ACQUA FRIZZANTE", price:1.00}, {name:"COCA COLA", price:2.50}, {name:"COCA ZERO", price:2.50}, {name:"TÈ LIMONE", price:2.50}, {name:"TÈ PESCA", price:2.50}, {name:"FANTA", price:2.50}, {name:"LEMON SODA", price:2.50}, {name:"RED BULL", price:2.50} ],
  c4: [ {name:"AMARO", price:3.00}, {name:"GRAPPA", price:3.00}, {name:"COCKTAILS", price:6.00}, {name:"BAILEYS", price:3.00}, {name:"JACK DANIELS", price:5.00}, {name:"TALISKER", price:5.00}, {name:"LIQUIRIZIA", price:3.00}, {name:"PRUGNA CM", price:3.00} ],
  c5: [ {name:"TOAST", price:6.50}, {name:"PIZZETTA", price:3.00}, {name:"HOT DOG", price:4.00} ],
  c6: null,
  c7: [ {name:"QUOTA SINGOLA", price:5.00} ],
  c8: null
};

/* render tavoli e saved */
function renderTables(){
  const container = document.getElementById('tables-container');
  container.innerHTML = "";
  
  // Riga 1: Totali, Storico, Evasi, Settings
  const utilityRow = document.createElement('div');
  utilityRow.className = "utility-row";
  
  const totBtn = document.createElement('button');
  totBtn.className = "utility-btn";
  totBtn.textContent = "TOTALI";
  totBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openTotals();
  };
  utilityRow.appendChild(totBtn);

  const storBtn = document.createElement('button');
  storBtn.className = "utility-btn";
  storBtn.textContent = "STORICO";
  storBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openStorico();
  };
  utilityRow.appendChild(storBtn);
  
  const evasiBtn = document.createElement('button');
  evasiBtn.className = "utility-btn";
  evasiBtn.textContent = "EVASI";
  evasiBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openEvasi();
  };
  utilityRow.appendChild(evasiBtn);
  
  const settingsBtn = document.createElement('button');
  settingsBtn.className = "utility-btn";
  settingsBtn.innerHTML = "&#9881;";
  settingsBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openSettings();
  };
  utilityRow.appendChild(settingsBtn);
  
  container.appendChild(utilityRow);
  
  // Riga 2: TAV-1, TAV-2, TAV-3, TAV-4
  const row1 = document.createElement('div');
  row1.className = "tables-grid";
  for(let i=1; i<=4; i++){
    const idx = tableNames.indexOf(`TAV-${i}`);
    if(idx !== -1){
      const b = document.createElement('button');
      b.className = "table-btn";
      // Aggiungi classe has-orders se il tavolo ha ordini o ordini salvati
      const tableName = `TAV-${i}`;
      // Rimuovo il comportamento rosso dai tavoli
      b.textContent = tableName;
      b.onclick = ()=> {
        vibrate(VIBRATION_PATTERNS.tap);
        openForTable(idx);
      };
      row1.appendChild(b);
    }
  }
  container.appendChild(row1);
  
  // Riga 3: TAV-5, TAV-6, TAV-7, TAV-8
  const row2 = document.createElement('div');
  row2.className = "tables-grid";
  for(let i=5; i<=8; i++){
    const idx = tableNames.indexOf(`TAV-${i}`);
    if(idx !== -1){
      const b = document.createElement('button');
      b.className = "table-btn";
      const tableName = `TAV-${i}`;
      // Rimuovo il comportamento rosso dai tavoli
      b.textContent = tableName;
      b.onclick = ()=> {
        vibrate(VIBRATION_PATTERNS.tap);
        openForTable(idx);
      };
      row2.appendChild(b);
    }
  }
  container.appendChild(row2);
  
  // Riga 4: TAV-9, TAV-10, TAV-11, TAV-12
  const row3 = document.createElement('div');
  row3.className = "tables-grid";
  for(let i=9; i<=12; i++){
    const idx = tableNames.indexOf(`TAV-${i}`);
    if(idx !== -1){
      const b = document.createElement('button');
      b.className = "table-btn";
      const tableName = `TAV-${i}`;
      // Rimuovo il comportamento rosso dai tavoli
      b.textContent = tableName;
      b.onclick = ()=> {
        vibrate(VIBRATION_PATTERNS.tap);
        openForTable(idx);
      };
      row3.appendChild(b);
    }
  }
  container.appendChild(row3);
  
  // Riga 5: STE, SALA, SALAF, +, REFILL, SPESA
  const row4 = document.createElement('div');
  row4.className = "tables-grid";
  
  const steIdx = tableNames.indexOf("STE");
  if(steIdx !== -1){
    const b = document.createElement('button');
    b.className = "table-btn";
    // Rimuovo il comportamento rosso dai tavoli
    b.textContent = "STE";
    b.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.tap);
      openForTable(steIdx);
    };
    row4.appendChild(b);
  }
  
  
  const plusBtn = document.createElement('button');
  plusBtn.className = "table-btn";
  // Rimuovo il comportamento rosso dal tasto +
  plusBtn.textContent = "+";
  plusBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomTablesPopup();
  };
  row4.appendChild(plusBtn);
  
  const refillBtn = document.createElement('button');
  refillBtn.className = "utility-btn";
  refillBtn.textContent = "REFILL";
  refillBtn.style.background = "#0099ff !important"; // Colore blu come categoria FRIGO
  refillBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openRefillSimple();
  };
  row4.appendChild(refillBtn);
  
  const spesaBtn = document.createElement('button');
  spesaBtn.className = "utility-btn";
  spesaBtn.textContent = "SPESA";
  spesaBtn.style.background = "#00aa00 !important"; // Colore verde
  spesaBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openSpesaPopup();
  };
  row4.appendChild(spesaBtn);
  
  
  container.appendChild(row4);
}

function renderSavedButtons(){
  // Ordini salvati in griglia 4x4
  savedOrdersDiv.innerHTML = "";
  savedOrders.forEach(s=>{
    const b = document.createElement('button');
    // Diventa rosso se ha prodotti e non è stato consegnato
    if(s.items && s.items.length > 0 && !s.consegnato) {
      b.classList.add('has-orders');
    }
    b.textContent = s.tableName;
    
    let pressTimer;
    
    // Click normale = apri ordine
    b.onclick = ()=> {
      vibrate(VIBRATION_PATTERNS.tap);
      openForSaved(s.id);
    };
    
    // Pressione lunga = rinomina ordine
    b.addEventListener('touchstart', (e) => {
      pressTimer = setTimeout(() => {
        const newName = prompt("Nuovo nome per l'ordine:", s.tableName);
        if(newName && newName.trim()){
          s.tableName = newName.trim();
          saveData();
          renderSavedButtons();
        }
      }, 800);
    });
    
    b.addEventListener('touchend', () => {
      clearTimeout(pressTimer);
    });
    
    b.addEventListener('touchmove', () => {
      clearTimeout(pressTimer);
    });
    
    // Supporto mouse per desktop
    b.addEventListener('mousedown', () => {
      pressTimer = setTimeout(() => {
        const newName = prompt("Nuovo nome per l'ordine:", s.tableName);
        if(newName && newName.trim()){
          s.tableName = newName.trim();
          saveData();
          renderSavedButtons();
        }
      }, 800);
    });
    
    b.addEventListener('mouseup', () => {
      clearTimeout(pressTimer);
    });
    
    b.addEventListener('mouseleave', () => {
      clearTimeout(pressTimer);
    });
    
    savedOrdersDiv.appendChild(b);
  });
}
/* Popup Standard per REFILL */
function openRefillSimple(){
  currentTarget = {type:null, id:null};
  
  // Setup popup standard come SPESA
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi solo la scritta "ORDINE" mantenendo i tasti azione
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  popupTitle.textContent = "REFILL";
  orderList.innerHTML = "";
  
  // Container per centrare i tasti
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'center';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  
  // Definizione tasti REFILL con colori delle categorie
  const refillButtons = [
    { name: 'REFILL CAFFÈ', color: '#888' },
    { name: 'REFILL SPINA', color: '#ff8800' },
    { name: 'REFILL FRIGO', color: '#0099ff' },
    { name: 'REFILL SUPER', color: '#aaaa00' },
    { name: 'REFILL SNACK', color: '#ff0000' },
    { name: 'MANUTENZIONE', color: '#8800aa' }
  ];
  
  refillButtons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.name;
    button.style.width = '75%';
    button.style.padding = '20px';
    button.style.fontSize = '18px';
    button.style.fontWeight = '700';
    button.style.background = btn.color;
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '8px';
    button.style.cursor = 'pointer';
    button.style.transition = 'all 0.2s ease';
    button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    
    // Effetti hover
    button.onmouseenter = () => {
      button.style.transform = 'translateY(-2px)';
      button.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
    };
    button.onmouseleave = () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    };
    
    // Click per aprire sottocategorie
    button.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      if(btn.name === 'MANUTENZIONE') {
        openRefillManutenzione();
      } else {
        const categoryKey = btn.name.replace('REFILL ', '').toLowerCase();
        openRefillCategory(categoryKey, btn.name, btn.color);
      }
    };
    
    container.appendChild(button);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  

  const resetBtn = document.createElement('button');
  resetBtn.textContent = "Reset Refill";
  resetBtn.style.background = '#ff4444';
  resetBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    showConfirm('Vuoi azzerare tutti i contatori REFILL e aggiornare il database Excel?', async ()=> {
      vibrate(VIBRATION_PATTERNS.success);
      
      console.log('RESET REFILL: INIZIO RESET CON EXCEL');
      
      // BLOCCA Firebase completamente
      const originalFirebaseEnabled = firebaseEnabled;
      firebaseEnabled = false;
      console.log('RESET REFILL: Firebase DISABILITATO');
      
      // Copia refillCounters prima di azzerare
      const refillCountersCopy = {...refillCounters};
      console.log('RESET REFILL: refillCounters copiati:', refillCountersCopy);
      
      // Prepara i dati per l'Excel
      const consumoDataForExcel = {};
      
      // Trasferisci ogni prodotto a consumo
      Object.keys(refillCountersCopy).forEach(productName => {
        const quantity = refillCountersCopy[productName];
        if(quantity > 0) {
          console.log(`RESET REFILL: Trasferendo ${productName}: qty=${quantity}`);
          
          // Aggiungi a consumoCounters
          consumoCounters[productName] = (consumoCounters[productName] || 0) + quantity;
          
          // Aggiungi a consumoList
          if(!consumoList[productName]) consumoList[productName] = {quantity: 0, value: 0};
          consumoList[productName].quantity += quantity;
          consumoList[productName].value = 0; // Sempre 0 nelle liste consumo
          
          // Prepara per Excel: accumula le quantità per prodotti nel database
          if(DATABASE_PRODUCTS.includes(productName)) {
            consumoDataForExcel[productName] = (consumoDataForExcel[productName] || 0) + quantity;
          }
          
          console.log(`RESET REFILL: ${productName} trasferito - consumoCounters: ${consumoCounters[productName]}, consumoList: ${JSON.stringify(consumoList[productName])}`);
        }
      });
      
      // Debug: mostra i dati preparati per Excel
      console.log('📊 Dati preparati per Excel:', consumoDataForExcel);
      console.log('📊 Prodotti nel database:', DATABASE_PRODUCTS);
      
      // Aggiorna database.xlsx se ci sono dati da aggiornare
      console.log('📊 Controllo dati per aggiornamento Excel:', {
        numeroChiavi: Object.keys(consumoDataForExcel).length,
        dati: consumoDataForExcel
      });
      
      if(Object.keys(consumoDataForExcel).length > 0) {
        try {
          console.log('📊 Aggiornamento database.xlsx...');
          
          // SEMPRE ricarica il database.xlsx dal disco per preservare modifiche manuali
          console.log('🔄 Ricaricamento database.xlsx dal disco per preservare modifiche manuali...');
          
          // Assicurati che la cartella PWAbuilder sia selezionata e valida
          if (!pwaBuilderFolderHandle) {
            console.log('📁 Seleziona prima la cartella PWAbuilder...');
            pwaBuilderFolderHandle = await selectPWABuilderFolder();
          } else {
            // Testa se l'handle è ancora valido
            try {
              await pwaBuilderFolderHandle.queryPermission({ mode: 'readwrite' });
              console.log('✅ Handle cartella PWAbuilder ancora valido per ricaricamento');
            } catch (error) {
              console.log('⚠️ Handle cartella PWAbuilder non più valido, richiedo selezione per ricaricamento...');
              pwaBuilderFolderHandle = await selectPWABuilderFolder();
            }
          }
          
          if (!pwaBuilderFolderHandle) {
            throw new Error('Cartella PWAbuilder non selezionata');
          }
          
          // Ricarica SEMPRE il database.xlsx dal disco
          const fileHandle = await pwaBuilderFolderHandle.getFileHandle('database.xlsx');
          const file = await fileHandle.getFile();
          const arrayBuffer = await file.arrayBuffer();
          loadedExcelFile = XLSX.read(arrayBuffer, { type: 'array' });
          console.log('✅ Database ricaricato dal disco - modifiche manuali preservate');
          
          // Verifica che loadedExcelFile sia ora disponibile
          if (!loadedExcelFile) {
            throw new Error('Impossibile caricare database.xlsx dal disco');
          }
          
          console.log('✅ loadedExcelFile disponibile, aggiornamento in corso...');
          
          // Verifica che la funzione updateExcelWithConsumoData esista
          if (typeof updateExcelWithConsumoData !== 'function') {
            console.error('❌ Funzione updateExcelWithConsumoData non trovata');
            throw new Error('Funzione updateExcelWithConsumoData non definita');
          }
          
          console.log('✅ Funzione updateExcelWithConsumoData trovata, esecuzione...');
          
          // Aggiorna il workbook con i dati di consumo (usa loadedExcelFile già caricato)
          const updatedWorkbook = updateExcelWithConsumoData(consumoDataForExcel);
          
          if (!updatedWorkbook) {
            console.error('❌ updateExcelWithConsumoData ha restituito null/undefined');
            throw new Error('Errore aggiornamento workbook');
          }
          
          console.log('✅ Workbook aggiornato con successo');
          
          if(updatedWorkbook) {
            // Verifica che la funzione saveDatabaseDirectly esista
            if (typeof saveDatabaseDirectly !== 'function') {
              console.error('❌ Funzione saveDatabaseDirectly non trovata');
              throw new Error('Funzione saveDatabaseDirectly non definita');
            }
            
            console.log('✅ Funzione saveDatabaseDirectly trovata, salvataggio...');
            
            // Prova prima File System Access API, poi fallback a download
            await saveDatabaseDirectly(updatedWorkbook);
            console.log('✅ File Excel aggiornato');
            
            // Leggi i dati dalle celle Excel per le liste carrello
            try {
              console.log('RESET REFILL: Leggendo dati Excel per liste carrello...');
              console.log('RESET REFILL: loadedExcelFile disponibile:', !!loadedExcelFile);
              console.log('RESET REFILL: updatedWorkbook disponibile:', !!updatedWorkbook);
              
              // Azzera le liste carrello prima di riempirle
              amazonList = [];
              poggianaList = [];
              prixList = [];
              battocchioList = [];
              console.log('RESET REFILL: Liste carrello azzerate');
              
              // Usa il workbook ricaricato dal disco per leggere le celle (contiene modifiche manuali)
              const firstSheet = loadedExcelFile.Sheets[loadedExcelFile.SheetNames[0]];
              
              // Debug: mostra info generali sul foglio
              console.log('RESET REFILL: Nome foglio:', loadedExcelFile.SheetNames[0]);
              console.log('RESET REFILL: Numero di celle nel foglio:', Object.keys(firstSheet).length);
              
              // Debug: controlla se esistono le righe 85-88
              const testCells = ['I85', 'J85', 'K85', 'I86', 'I87', 'I88'];
              testCells.forEach(cellRef => {
                const cell = firstSheet[cellRef];
                if (cell) {
                  console.log(`RESET REFILL: Test cella ${cellRef}:`, {
                    v: cell.v,
                    w: cell.w,
                    f: cell.f,
                    t: cell.t
                  });
                } else {
                  console.log(`RESET REFILL: Cella ${cellRef} non trovata o vuota`);
                }
              });
              
              // Prova con il metodo JSON
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false});
              
              // Debug: mostra tutte le righe da 83 a 89 per capire dove sono i dati
              console.log('RESET REFILL: Debug righe 83-89:');
              for (let i = 83; i <= 89; i++) {
                if (jsonData[i]) {
                  console.log(`Riga ${i + 1} (indice ${i}):`, jsonData[i]);
                } else {
                  console.log(`Riga ${i + 1} (indice ${i}): vuota o inesistente`);
                }
              }
              
              // Riga 85 (indice 84) per Amazon con valori dalla riga 81 (indice 80)
              const amazonNames = [];
              if (jsonData[84]) {
                console.log('RESET REFILL: Riga 85 da JSON:', jsonData[84]);
                jsonData[84].forEach((cell, index) => {
                  if (cell && cell.toString().trim() !== '' && index >= 8) { // colonna I = indice 8
                    const name = cell.toString().trim();
                    const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                    const nameWithValue = `${name} (${value})`;
                    amazonNames.push(nameWithValue);
                    console.log(`RESET REFILL: Amazon da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                  }
                });
              } else {
                console.log('RESET REFILL: Riga 85 (indice 84) non trovata o vuota');
              }
              console.log('RESET REFILL: Amazon nomi trovati:', amazonNames.length);
              
              // Riga 86 (indice 85) per Poggiana con valori dalla riga 81 (indice 80)
              const poggianaNames = [];
              if (jsonData[85]) {
                console.log('RESET REFILL: Riga 86 da JSON:', jsonData[85]);
                jsonData[85].forEach((cell, index) => {
                  if (cell && cell.toString().trim() !== '' && index >= 8) {
                    const name = cell.toString().trim();
                    const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                    const nameWithValue = `${name} (${value})`;
                    poggianaNames.push(nameWithValue);
                    console.log(`RESET REFILL: Poggiana da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                  }
                });
              } else {
                console.log('RESET REFILL: Riga 86 (indice 85) non trovata o vuota');
              }
              console.log('RESET REFILL: Poggiana nomi trovati:', poggianaNames.length);
              
              // Riga 87 (indice 86) per Prix con valori dalla riga 81 (indice 80)
              const prixNames = [];
              if (jsonData[86]) {
                console.log('RESET REFILL: Riga 87 da JSON:', jsonData[86]);
                jsonData[86].forEach((cell, index) => {
                  if (cell && cell.toString().trim() !== '' && index >= 8) {
                    const name = cell.toString().trim();
                    const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                    const nameWithValue = `${name} (${value})`;
                    prixNames.push(nameWithValue);
                    console.log(`RESET REFILL: Prix da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                  }
                });
              } else {
                console.log('RESET REFILL: Riga 87 (indice 86) non trovata o vuota');
              }
              console.log('RESET REFILL: Prix nomi trovati:', prixNames.length);
              
              // Riga 88 (indice 87) per Battocchio con valori dalla riga 81 (indice 80)
              const battocchioNames = [];
              
              // Metodo alternativo: leggi direttamente dalle celle per gestire le formule
              console.log('RESET REFILL: Leggendo Battocchio direttamente dalle celle (percorso principale)...');
              for (let col = 8; col < 100; col++) { // da colonna I (8) in poi
                const colLetter = String.fromCharCode(65 + col); // A=65, B=66, etc.
                const cellRef88 = `${colLetter}88`;
                const cellRef81 = `${colLetter}81`;
                
                const cell88 = firstSheet[cellRef88];
                const cell81 = firstSheet[cellRef81];
                
                if (cell88 && cell88.v && cell88.v.toString().trim() !== '') {
                  const name = cell88.v.toString().trim();
                  const value = cell81 && cell81.v ? cell81.v.toString() : '0';
                  const nameWithValue = `${name} (${value})`;
                  battocchioNames.push(nameWithValue);
                  console.log(`RESET REFILL: Battocchio da cella ${cellRef88}: "${name}" valore da ${cellRef81}: "${value}"`);
                }
              }
              
              // Fallback: usa il metodo JSON se il metodo diretto non trova nulla
              if (battocchioNames.length === 0 && jsonData[87]) {
                console.log('RESET REFILL: Fallback - Riga 88 da JSON:', jsonData[87]);
                jsonData[87].forEach((cell, index) => {
                  if (cell && cell.toString().trim() !== '' && index >= 8) {
                    const name = cell.toString().trim();
                    const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                    const nameWithValue = `${name} (${value})`;
                    battocchioNames.push(nameWithValue);
                    console.log(`RESET REFILL: Battocchio da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                  }
                });
              }
              
              console.log('RESET REFILL: Battocchio nomi trovati:', battocchioNames.length);
              
              // Aggiungi i nomi alle rispettive liste
              const timestamp = new Date().toISOString();
              
              amazonNames.forEach(name => {
                amazonList.push({
                  name: name,
                  timestamp: timestamp
                });
              });
              
              poggianaNames.forEach(name => {
                poggianaList.push({
                  name: name,
                  timestamp: timestamp
                });
              });
              
              prixNames.forEach(name => {
                prixList.push({
                  name: name,
                  timestamp: timestamp
                });
              });
              
              battocchioNames.forEach(name => {
                battocchioList.push({
                  name: name,
                  timestamp: timestamp
                });
              });
              
              console.log('RESET REFILL: Liste carrello aggiornate:', {
                amazon: `${amazonNames.length} nomi aggiunti (totale: ${amazonList.length})`,
                poggiana: `${poggianaNames.length} nomi aggiunti (totale: ${poggianaList.length})`,
                prix: `${prixNames.length} nomi aggiunti (totale: ${prixList.length})`,
                battocchio: `${battocchioNames.length} nomi aggiunti (totale: ${battocchioList.length})`
              });
              
              // Debug: mostra il contenuto delle liste
              console.log('RESET REFILL: Contenuto liste dopo aggiornamento:', {
                amazonList: amazonList.map(item => item.name),
                poggianaList: poggianaList.map(item => item.name),
                prixList: prixList.map(item => item.name),
                battocchioList: battocchioList.map(item => item.name)
              });
              
            } catch (err) {
              console.error('RESET REFILL: Errore lettura celle Excel:', err);
            }
          }
          
        } catch (error) {
          console.error('❌ Errore gestione database.xlsx:', error);
          console.error('❌ Stack trace:', error.stack);
          console.error('❌ Dettagli errore:', {
            message: error.message,
            name: error.name,
            loadedExcelFile: !!loadedExcelFile,
            consumoDataForExcel: consumoDataForExcel
          });
          alert(`Errore nella gestione del file database.xlsx: ${error.message}`);
        }
      } else {
        console.log('📊 Nessun dato da aggiornare in Excel');
        
        // Anche se non aggiorniamo Excel, azzeriamo le liste carrello e leggiamo quelle nuove
        amazonList = [];
        poggianaList = [];
        prixList = [];
        battocchioList = [];
        console.log('RESET REFILL: Liste carrello azzerate (nessun aggiornamento Excel)');
        
        // Carica il database per leggere le liste carrello anche se non aggiorniamo
        if (!loadedExcelFile) {
          try {
            console.log('⚠️ Caricamento database.xlsx per leggere liste carrello...');
            
            if (!pwaBuilderFolderHandle) {
              console.log('📁 Seleziona prima la cartella PWAbuilder...');
              pwaBuilderFolderHandle = await selectPWABuilderFolder();
            } else {
              // Testa se l'handle è ancora valido
              try {
                await pwaBuilderFolderHandle.queryPermission({ mode: 'readwrite' });
                console.log('✅ Handle cartella PWAbuilder ancora valido per lettura liste');
              } catch (error) {
                console.log('⚠️ Handle cartella PWAbuilder non più valido, richiedo selezione per lettura liste...');
                pwaBuilderFolderHandle = await selectPWABuilderFolder();
              }
            }
            
            if (pwaBuilderFolderHandle) {
              const fileHandle = await pwaBuilderFolderHandle.getFileHandle('database.xlsx');
              const file = await fileHandle.getFile();
              const arrayBuffer = await file.arrayBuffer();
              loadedExcelFile = XLSX.read(arrayBuffer, { type: 'array' });
              console.log('✅ Database caricato per lettura liste carrello');
            }
          } catch (err) {
            console.error('❌ Errore caricamento database per liste carrello:', err);
          }
        }
        
        // Leggi le liste carrello dal database caricato (anche se non ci sono aggiornamenti)
        if (loadedExcelFile) {
          try {
            console.log('RESET REFILL: Leggendo liste carrello dal database caricato...');
            
            const firstSheet = loadedExcelFile.Sheets[loadedExcelFile.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false});
            
            // Debug: controlla direttamente la cella I88 per vedere se è una formula
            const cellI88 = firstSheet['I88'];
            if (cellI88) {
              console.log('RESET REFILL: Cella I88 diretta:', {
                v: cellI88.v, // valore calcolato
                w: cellI88.w, // valore formattato
                f: cellI88.f, // formula
                t: cellI88.t  // tipo
              });
            } else {
              console.log('RESET REFILL: Cella I88 non trovata direttamente');
            }
            
            // Debug: mostra tutte le righe da 83 a 89 per capire dove sono i dati
            console.log('RESET REFILL: Debug righe 83-89:');
            for (let i = 83; i <= 89; i++) {
              if (jsonData[i]) {
                console.log(`Riga ${i + 1} (indice ${i}):`, jsonData[i]);
              } else {
                console.log(`Riga ${i + 1} (indice ${i}): vuota o inesistente`);
              }
            }
            
            // Leggi Amazon (riga 85, indice 84) con valori dalla riga 81 (indice 80)
            const amazonNames = [];
            if (jsonData[84]) {
              console.log('RESET REFILL: Riga 85 da JSON:', jsonData[84]);
              jsonData[84].forEach((cell, index) => {
                if (cell && cell.toString().trim() !== '' && index >= 8) {
                  const name = cell.toString().trim();
                  const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                  const nameWithValue = `${name} (${value})`;
                  amazonNames.push(nameWithValue);
                  console.log(`RESET REFILL: Amazon da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                }
              });
            } else {
              console.log('RESET REFILL: Riga 85 (indice 84) non trovata o vuota');
            }
            console.log('RESET REFILL: Amazon nomi trovati:', amazonNames.length);
            
            // Leggi Poggiana (riga 86, indice 85) con valori dalla riga 81 (indice 80)
            const poggianaNames = [];
            if (jsonData[85]) {
              console.log('RESET REFILL: Riga 86 da JSON:', jsonData[85]);
              jsonData[85].forEach((cell, index) => {
                if (cell && cell.toString().trim() !== '' && index >= 8) {
                  const name = cell.toString().trim();
                  const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                  const nameWithValue = `${name} (${value})`;
                  poggianaNames.push(nameWithValue);
                  console.log(`RESET REFILL: Poggiana da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                }
              });
            } else {
              console.log('RESET REFILL: Riga 86 (indice 85) non trovata o vuota');
            }
            console.log('RESET REFILL: Poggiana nomi trovati:', poggianaNames.length);
            
            // Leggi Prix (riga 87, indice 86) con valori dalla riga 81 (indice 80)
            const prixNames = [];
            if (jsonData[86]) {
              console.log('RESET REFILL: Riga 87 da JSON:', jsonData[86]);
              jsonData[86].forEach((cell, index) => {
                if (cell && cell.toString().trim() !== '' && index >= 8) {
                  const name = cell.toString().trim();
                  const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                  const nameWithValue = `${name} (${value})`;
                  prixNames.push(nameWithValue);
                  console.log(`RESET REFILL: Prix da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                }
              });
            } else {
              console.log('RESET REFILL: Riga 87 (indice 86) non trovata o vuota');
            }
            console.log('RESET REFILL: Prix nomi trovati:', prixNames.length);
            
            // Leggi Battocchio (riga 88, indice 87) con valori dalla riga 81 (indice 80)
            const battocchioNames = [];
            
            // Metodo alternativo: leggi direttamente dalle celle per gestire le formule
            console.log('RESET REFILL: Leggendo Battocchio direttamente dalle celle...');
            for (let col = 8; col < 100; col++) { // da colonna I (8) in poi
              const colLetter = String.fromCharCode(65 + col); // A=65, B=66, etc.
              const cellRef88 = `${colLetter}88`;
              const cellRef81 = `${colLetter}81`;
              
              const cell88 = firstSheet[cellRef88];
              const cell81 = firstSheet[cellRef81];
              
              if (cell88 && cell88.v && cell88.v.toString().trim() !== '') {
                const name = cell88.v.toString().trim();
                const value = cell81 && cell81.v ? cell81.v.toString() : '0';
                const nameWithValue = `${name} (${value})`;
                battocchioNames.push(nameWithValue);
                console.log(`RESET REFILL: Battocchio da cella ${cellRef88}: "${name}" valore da ${cellRef81}: "${value}"`);
              }
            }
            
            // Fallback: usa il metodo JSON se il metodo diretto non trova nulla
            if (battocchioNames.length === 0 && jsonData[87]) {
              console.log('RESET REFILL: Fallback - Riga 88 da JSON:', jsonData[87]);
              jsonData[87].forEach((cell, index) => {
                if (cell && cell.toString().trim() !== '' && index >= 8) {
                  const name = cell.toString().trim();
                  const value = jsonData[80] && jsonData[80][index] ? jsonData[80][index].toString() : '0';
                  const nameWithValue = `${name} (${value})`;
                  battocchioNames.push(nameWithValue);
                  console.log(`RESET REFILL: Battocchio da JSON colonna ${index + 1}: "${name}" valore: "${value}"`);
                }
              });
            }
            
            console.log('RESET REFILL: Battocchio nomi trovati:', battocchioNames.length);
            
            // Aggiungi alle liste con timestamp
            const timestamp = new Date().toISOString();
            
            amazonNames.forEach(name => {
              amazonList.push({ name: name, timestamp: timestamp });
            });
            
            poggianaNames.forEach(name => {
              poggianaList.push({ name: name, timestamp: timestamp });
            });
            
            prixNames.forEach(name => {
              prixList.push({ name: name, timestamp: timestamp });
            });
            
            battocchioNames.forEach(name => {
              battocchioList.push({ name: name, timestamp: timestamp });
            });
            
            console.log('RESET REFILL: Liste carrello aggiornate (nessun aggiornamento Excel):', {
              amazon: `${amazonNames.length} nomi caricati`,
              poggiana: `${poggianaNames.length} nomi caricati`,
              prix: `${prixNames.length} nomi caricati`,
              battocchio: `${battocchioNames.length} nomi caricati`
            });
            
            // Debug: mostra il contenuto delle liste
            console.log('RESET REFILL: Contenuto liste dopo aggiornamento (nessun aggiornamento Excel):', {
              amazonList: amazonList.map(item => item.name),
              poggianaList: poggianaList.map(item => item.name),
              prixList: prixList.map(item => item.name),
              battocchioList: battocchioList.map(item => item.name)
            });
            
          } catch (err) {
            console.error('RESET REFILL: Errore lettura liste carrello:', err);
          }
        }
        
        // Mostra sempre lo stato finale delle liste
        console.log('RESET REFILL: Stato finale liste carrello:', {
          amazonList: amazonList.map(item => item.name),
          poggianaList: poggianaList.map(item => item.name),
          prixList: prixList.map(item => item.name),
          battocchioList: battocchioList.map(item => item.name)
        });
      }
      
      // Azzera refill localmente
      refillList = {};
      refillCounters = {};
      console.log('RESET REFILL: Liste azzerate localmente');
      
      // Salva TUTTO in localStorage con Firebase disabilitato
      const completeState = {
        tableOrders, savedOrders, totals, tableNames, storico, evasiOrders, 
        refillList: {}, refillCounters: {}, maintenanceCounters, 
        consumoCounters, consumoList, editableValues, storageValues,
        amazonList, poggianaList, prixList, battocchioList,
        currentBackground, currentFont, currentFontSize, fontSettings, 
        modifiersList, subcategories
      };
      localStorage.setItem('breakOrdersState', JSON.stringify(completeState));
      console.log('RESET REFILL: Salvato in localStorage con consumoCounters:', consumoCounters);
      
      // Ora salva su Firebase e riabilita
      setTimeout(() => {
        firebaseEnabled = originalFirebaseEnabled;
        if (firebaseEnabled && database) {
          console.log('RESET REFILL: Salvando TUTTO su Firebase...');
          database.ref('breakOrders').set({
            ...completeState,
            _meta: { lastUpdated: firebase.database.ServerValue.TIMESTAMP }
          }).then(() => {
            console.log('RESET REFILL: Salvato su Firebase con successo');
            
            // Forza sincronizzazione liste carrello per mobile
            setTimeout(() => {
              forceSyncShoppingLists();
            }, 1000);
          });
        }
        
        // Riapri popup
        openRefillSimple();
      }, 500);
    }, 'Reset Refill + Excel');
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); closePopup(); };
  
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

// Funzione per aprire categoria REFILL con sottocategorie
function openRefillCategory(categoryKey, categoryName, categoryColor) {
  popupTitle.textContent = categoryName;
  orderList.innerHTML = "";
  
  // Mappa le chiavi alle categorie del CATALOG
  const categoryMap = {
    'caffè': 'c1',
    'spina': 'c2', 
    'frigo': 'c3',
    'super': 'c4',
    'snack': 'c5'
  };
  
  const catalogKey = categoryMap[categoryKey];
  const products = CATALOG[catalogKey] || [];
  
  // Container per centrare la lista
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.padding = '20px';
  container.style.gap = '10px';
  
  if(products.length === 0) {
    const emptyMsg = document.createElement('div');
    emptyMsg.textContent = 'Nessun prodotto in questa categoria';
    emptyMsg.style.color = '#fff';
    emptyMsg.style.fontSize = '18px';
    emptyMsg.style.textAlign = 'center';
    emptyMsg.style.padding = '40px';
    container.appendChild(emptyMsg);
  } else {
    // Lista prodotti - mostra solo sottocategorie o prodotti senza sottocategorie
    products.forEach(product => {
      // Se ha sottocategorie, mostra solo quelle
      if(subcategories[product.name]) {
        subcategories[product.name].forEach(subProduct => {
          const subDiv = document.createElement('div');
          subDiv.style.width = '75%';
          subDiv.style.padding = '15px';
          subDiv.style.background = categoryColor;
          subDiv.style.borderRadius = '8px';
          subDiv.style.color = '#fff';
          subDiv.style.fontSize = '16px';
          subDiv.style.fontWeight = '700';
          subDiv.style.textAlign = 'left';
          subDiv.style.cursor = 'pointer';
          subDiv.style.transition = 'all 0.2s ease';
          subDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
          subDiv.style.display = 'flex';
          subDiv.style.justifyContent = 'space-between';
          subDiv.style.alignItems = 'center';
          
          const productName = `${product.name} ${subProduct.name}`;
          const counter = getRefillCounter(productName);
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = productName;
          
          const counterSpan = document.createElement('span');
          counterSpan.textContent = counter;
          counterSpan.style.fontSize = '14px';
          counterSpan.style.fontWeight = '600';
          counterSpan.style.background = 'rgba(255,255,255,0.2)';
          counterSpan.style.padding = '4px 8px';
          counterSpan.style.borderRadius = '12px';
          counterSpan.style.minWidth = '24px';
          counterSpan.style.textAlign = 'center';
          
          subDiv.appendChild(nameSpan);
          subDiv.appendChild(counterSpan);
          
          // Effetti hover
          subDiv.onmouseenter = () => {
            subDiv.style.transform = 'translateY(-1px)';
            subDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
          };
          subDiv.onmouseleave = () => {
            subDiv.style.transform = 'translateY(0)';
            subDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
          };
          
          // Click per ora inerte
          subDiv.onclick = () => {
            vibrate(VIBRATION_PATTERNS.tap);
          };
          
          container.appendChild(subDiv);
        });
      } else {
        // Se non ha sottocategorie, mostra il prodotto normale
        const productDiv = document.createElement('div');
        productDiv.style.width = '75%';
        productDiv.style.padding = '15px';
        productDiv.style.background = categoryColor;
        productDiv.style.borderRadius = '8px';
        productDiv.style.color = '#fff';
        productDiv.style.fontSize = '16px';
        productDiv.style.fontWeight = '700';
        productDiv.style.textAlign = 'left';
        productDiv.style.cursor = 'pointer';
        productDiv.style.transition = 'all 0.2s ease';
        productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        productDiv.style.display = 'flex';
        productDiv.style.justifyContent = 'space-between';
        productDiv.style.alignItems = 'center';
        
        const counter = getRefillCounter(product.name);
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = product.name;
        
        const counterSpan = document.createElement('span');
        counterSpan.textContent = counter;
        counterSpan.style.fontSize = '14px';
        counterSpan.style.fontWeight = '600';
        counterSpan.style.background = 'rgba(255,255,255,0.2)';
        counterSpan.style.padding = '4px 8px';
        counterSpan.style.borderRadius = '12px';
        counterSpan.style.minWidth = '24px';
        counterSpan.style.textAlign = 'center';
        
        productDiv.appendChild(nameSpan);
        productDiv.appendChild(counterSpan);
        
        // Effetti hover
        productDiv.onmouseenter = () => {
          productDiv.style.transform = 'translateY(-1px)';
          productDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
        };
        productDiv.onmouseleave = () => {
          productDiv.style.transform = 'translateY(0)';
          productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        };
        
        // Click per ora inerte
        productDiv.onclick = () => {
          vibrate(VIBRATION_PATTERNS.tap);
        };
        
        container.appendChild(productDiv);
      }
    });
  }
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openRefillSimple(); 
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
}

// Funzione per MANUTENZIONE
function openRefillManutenzione() {
  popupTitle.textContent = "MANUTENZIONE";
  orderList.innerHTML = "";
  
  // Lista prodotti manutenzione
  const manutenzioneProducts = [
    'MAIONESE BIDONE', 'MAIONESE', 'KETCHUP', 'SENAPE',
    'TOVAGLIOLI', 'CARTA ROTOLO', 'CARTA MANI', 'CARTA IGIENICA',
    'SAPONE LIQUIDO', 'SACCHI GRANDI', 'SACCHI PICCOLI',
    'DET PAVIMENTI', 'DET BAGNI', 'DET SUPERFICI', 'DET ACCIAIO',
    'SPUGNE GRANDI', 'SPUGNE PICCOLE', 'SPUGNE PIATTE',
    'LAVABICCHIERI B', 'LAVABICCHIERI D', 'LAMPADINE', 'FARETTI'
  ];
  
  // Container per centrare la lista
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.padding = '20px';
  container.style.gap = '10px';
  
  manutenzioneProducts.forEach(productName => {
    const productDiv = document.createElement('div');
    productDiv.style.width = '75%';
    productDiv.style.padding = '15px';
    productDiv.style.background = '#8800aa';
    productDiv.style.borderRadius = '8px';
    productDiv.style.color = '#fff';
    productDiv.style.fontSize = '16px';
    productDiv.style.fontWeight = '700';
    productDiv.style.textAlign = 'left';
    productDiv.style.cursor = 'pointer';
    productDiv.style.transition = 'all 0.2s ease';
    productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
    productDiv.style.display = 'flex';
    productDiv.style.justifyContent = 'space-between';
    productDiv.style.alignItems = 'center';
    
    // Forza refresh del contatore
    const counter = maintenanceCounters[productName] || 0;
    
    const nameSpan = document.createElement('span');
    nameSpan.textContent = productName;
    
    const counterSpan = document.createElement('span');
    counterSpan.textContent = counter;
    counterSpan.style.fontSize = '14px';
    counterSpan.style.fontWeight = '600';
    counterSpan.style.background = 'rgba(255,255,255,0.2)';
    counterSpan.style.padding = '4px 8px';
    counterSpan.style.borderRadius = '12px';
    counterSpan.style.minWidth = '24px';
    counterSpan.style.textAlign = 'center';
    
    productDiv.appendChild(nameSpan);
    productDiv.appendChild(counterSpan);
    
    // Gestione tap lungo per aprire popup manutenzione
    let pressTimer;
    let isPressed = false;
    let isLongTap = false;
    
    const startPress = (e) => {
      if(isPressed) return;
      isPressed = true;
      isLongTap = false;
      // Effetto visivo di pressione
      productDiv.style.transform = 'translateY(-1px)';
      productDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
      
      pressTimer = setTimeout(() => {
        if(isPressed) {
          isLongTap = true;
          vibrate(VIBRATION_PATTERNS.longPress);
          // Long tap: apri popup manutenzione
          showMaintenancePopup(productName);
        }
      }, 600); // 600ms per long tap
    };
    
    const endPress = (e) => {
      clearTimeout(pressTimer);
      if(isPressed && !isLongTap) {
        // Tap normale: apri popup manutenzione
        vibrate(VIBRATION_PATTERNS.tap);
        showMaintenancePopup(productName);
      }
      isPressed = false;
      isLongTap = false;
      // Reset effetto visivo
      productDiv.style.transform = 'translateY(0)';
      productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
    };
    
    // Effetti hover normali (solo quando non premuto)
    productDiv.onmouseenter = () => {
      if(!isPressed) {
        productDiv.style.transform = 'translateY(-1px)';
        productDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
      }
    };
    
    productDiv.onmouseleave = () => {
      if(!isPressed) {
        productDiv.style.transform = 'translateY(0)';
        productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
      }
    };
    
    productDiv.ontouchstart = startPress;
    productDiv.onmousedown = startPress;
    productDiv.ontouchend = endPress;
    productDiv.onmouseup = endPress;
    productDiv.ontouchcancel = endPress;
    
    container.appendChild(productDiv);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openRefillSimple(); 
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
}


/* Popup Spesa */
function openSpesaPopup(){
  popupTitle.textContent = `REFILL - ${categoryName}`;
  orderList.innerHTML = "";
  
  const products = CATALOG[categoryKey] || [];
  
  if(products.length === 0){
    orderList.innerHTML = "<div style='padding:20px;text-align:center;color:#fff;'>Nessun prodotto in questa categoria</div>";
  } else {
    // Array per raccogliere tutti i prodotti (inclusi quelli nelle sottocategorie)
    const allProducts = [];

    products.forEach(product => {
      // Se il prodotto ha una sottocategoria, espandi SOLO i suoi prodotti (non il base)
      if(subcategories[product.name]){
        subcategories[product.name].forEach(subProduct => {
          allProducts.push({ name: `${product.name} ${subProduct.name}`, price: subProduct.price });
        });
      } else {
        // Aggiungi il prodotto base solo se NON ha sottocategorie
        allProducts.push(product);
      }
    });

    // Renderizza prodotti come lista semplice (formato originale)
    allProducts.forEach(product => {
      const qty = getRefillQuantity(product.name);
      
      const row = document.createElement('div');
      row.className = 'order-row';
      row.style.display = 'flex';
      row.style.flexDirection = 'column';
      row.style.gap = '8px';
      row.style.padding = '10px';
      row.style.background = 'rgba(255,255,255,0.05)';
      row.style.borderRadius = '4px';
      row.style.margin = '2px 0';
      row.style.borderLeft = `4px solid ${categoryColor}`;
      
      // Prima riga: nome e controlli quantità
      const topRow = document.createElement('div');
      topRow.style.display = 'grid';
      topRow.style.gridTemplateColumns = '2fr 1fr';
      topRow.style.alignItems = 'center';
      topRow.style.gap = '10px';
      
      const nameDiv = document.createElement('div');
      nameDiv.textContent = product.name;
      nameDiv.style.fontFamily = fontSettings.refill.font;
      nameDiv.style.fontSize = fontSettings.refill.size + 'px';
      nameDiv.style.fontWeight = '700';
      nameDiv.style.color = fontSettings.refill.color;
      
      // Container controlli quantità
      const qtyControls = document.createElement('div');
      qtyControls.style.display = 'flex';
      qtyControls.style.alignItems = 'center';
      qtyControls.style.gap = '8px';
      qtyControls.style.justifyContent = 'center';

      // Bottone -
      const minusBtn = document.createElement('button');
      minusBtn.textContent = '−';
      minusBtn.style.width = '30px';
      minusBtn.style.height = '30px';
      minusBtn.style.borderRadius = '50%';
      minusBtn.style.border = '2px solid #fff';
      minusBtn.style.background = 'rgba(255, 255, 255, 0.2)';
      minusBtn.style.color = '#fff';
      minusBtn.style.fontSize = '16px';
      minusBtn.style.fontWeight = '700';
      minusBtn.style.cursor = 'pointer';
      minusBtn.style.transition = 'all 0.2s ease';
      minusBtn.onclick = (e) => {
        e.stopPropagation();
        vibrate(VIBRATION_PATTERNS.tap);
        if(getRefillQuantity(product.name) > 0) {
          setRefillQuantity(product.name, getRefillQuantity(product.name) - 1);
          const updatedQty = getRefillQuantity(product.name);
          qtyDisplay.textContent = updatedQty;
          saveData();
        }
      };

      // Display quantità
      const qtyDisplay = document.createElement('div');
      qtyDisplay.textContent = qty;
      qtyDisplay.style.fontSize = '18px';
      qtyDisplay.style.fontWeight = '700';
      qtyDisplay.style.color = '#fff';
      qtyDisplay.style.minWidth = '30px';
      qtyDisplay.style.textAlign = 'center';

      // Bottone +
      const plusBtn = document.createElement('button');
      plusBtn.textContent = '+';
      plusBtn.style.width = '30px';
      plusBtn.style.height = '30px';
      plusBtn.style.borderRadius = '50%';
      plusBtn.style.border = '2px solid #fff';
      plusBtn.style.background = 'rgba(255, 255, 255, 0.2)';
      plusBtn.style.color = '#fff';
      plusBtn.style.fontSize = '16px';
      plusBtn.style.fontWeight = '700';
      plusBtn.style.cursor = 'pointer';
      plusBtn.style.transition = 'all 0.2s ease';
      plusBtn.onclick = (e) => {
        e.stopPropagation();
        vibrate(VIBRATION_PATTERNS.tap);
        addRefillQuantity(product.name, 1);
        const updatedQty = getRefillQuantity(product.name);
        qtyDisplay.textContent = updatedQty;
        saveData();
      };

      qtyControls.appendChild(minusBtn);
      qtyControls.appendChild(qtyDisplay);
      qtyControls.appendChild(plusBtn);
      
      topRow.appendChild(nameDiv);
      topRow.appendChild(qtyControls);
      
      // Seconda riga: campo valore
      const valueRow = document.createElement('div');
      valueRow.style.display = 'flex';
      valueRow.style.alignItems = 'center';
      valueRow.style.gap = '5px';
      
      const valueLabel = document.createElement('span');
      valueLabel.textContent = 'Valore unitario:';
      valueLabel.style.color = '#fff';
      valueLabel.style.fontSize = '12px';
      
      const valueInput = document.createElement('input');
      valueInput.type = 'number';
      valueInput.step = '0.001';
      valueInput.min = '0';
      valueInput.value = (getRefillValue(product.name) || 0).toString();
      valueInput.placeholder = '0';
      valueInput.style.width = '60px';
      valueInput.style.padding = '2px 4px';
      valueInput.style.fontSize = '12px';
      valueInput.style.border = '1px solid #ccc';
      valueInput.style.borderRadius = '3px';
      valueInput.style.background = '#fff';
      
      valueInput.onchange = () => {
        const newValue = parseFloat(valueInput.value) || 0;
        setRefillValue(product.name, newValue);
        saveData();
      };
      
      valueRow.appendChild(valueLabel);
      valueRow.appendChild(valueInput);
      
      row.appendChild(topRow);
      row.appendChild(valueRow);
      orderList.appendChild(row);
    });
  }
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); openRefillSimple(); };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.style.background = '#aa0000';
  resetBtn.style.color = '#fff';
  resetBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm(`Confermi il reset di ${categoryName}? (Solo quantità, valori mantenuti)`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Reset solo quantità prodotti di questa categoria, mantenendo i valori unitari
      const categoryProductNames = [];
      const catalogProducts = CATALOG[categoryKey] || [];
      catalogProducts.forEach(product => {
        // Aggiungi prodotto base
        categoryProductNames.push(product.name);
        // Aggiungi sottocategorie se esistono
        if(subcategories[product.name]){
          subcategories[product.name].forEach(subProduct => {
            categoryProductNames.push(`${product.name} ${subProduct.name}`);
          });
        }
      });
      resetRefillQuantitiesOnly(categoryProductNames);
      saveData();
      // Riapri la lista per vedere i cambiamenti
      openRefillCategory(categoryKey, categoryName, categoryColor);
    }, `Reset ${categoryName}`);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); closePopup(); };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);
}

/* Popup Refill - Versione Standard (DEPRECATA) */
function openRefillStandardPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "REFILL - Seleziona Categoria";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Renderizza le categorie REFILL
  renderRefillCategories();
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function renderRefillCategories(){
  const categories = [
    { key: 'c1', name: 'REFILL CAFFÈ', color: '#888', catalog: CATALOG.c1 },
    { key: 'c2', name: 'REFILL SPINA', color: '#ff8800', catalog: CATALOG.c2 },
    { key: 'c3', name: 'REFILL FRIGO', color: '#0099ff', catalog: CATALOG.c3 },
    { key: 'c4', name: 'REFILL SUPER', color: '#aaaa00', catalog: CATALOG.c4 },
    { key: 'c5', name: 'REFILL SNACK', color: '#ff0000', catalog: CATALOG.c5 }
  ];
  
  categories.forEach(cat => {
    const row = document.createElement('div');
    row.className = 'order-row';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr auto';
    row.style.alignItems = 'center';
    row.style.padding = '15px';
    row.style.background = cat.color;
    row.style.borderRadius = '8px';
    row.style.margin = '5px 0';
    row.style.cursor = 'pointer';
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = cat.name;
    nameDiv.style.fontFamily = fontSettings.refill.font;
    nameDiv.style.fontSize = fontSettings.refill.size + 'px';
    nameDiv.style.fontWeight = '700';
    nameDiv.style.color = fontSettings.refill.color;
    
    const arrowDiv = document.createElement('div');
    arrowDiv.textContent = '→';
    arrowDiv.style.fontSize = '20px';
    arrowDiv.style.fontWeight = '700';
    arrowDiv.style.color = fontSettings.refill.color;
    
    row.appendChild(nameDiv);
    row.appendChild(arrowDiv);
    
    row.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      openRefillCategoryStandard(cat.key, cat.name, cat.color, cat.catalog);
    };
    
    orderList.appendChild(row);
  });
}

function openRefillCategoryStandard(categoryKey, categoryName, categoryColor, catalogProducts){
  // Titolo popup
  popupTitle.textContent = `REFILL - ${categoryName}`;
  
  // Svuota la lista ordini
  orderList.innerHTML = "";
  
  // Array per raccogliere tutti i prodotti (inclusi quelli nelle sottocategorie)
  const allProducts = [];
  
  catalogProducts.forEach(product => {
    // Se il prodotto ha una sottocategoria, espandi i suoi prodotti
    if(subcategories[product.name]){
      subcategories[product.name].forEach(subProduct => {
        allProducts.push({ name: `${product.name} ${subProduct.name}`, price: subProduct.price });
      });
    }
    // Aggiungi anche il prodotto base
    allProducts.push(product);
  });
  
  // Renderizza prodotti come righe ordine
  allProducts.forEach(product => {
    const qty = getRefillQuantity(product.name);
    
    const row = document.createElement('div');
    row.className = 'order-row';
    row.style.display = 'flex';
    row.style.flexDirection = 'column';
    row.style.gap = '8px';
    row.style.padding = '10px';
    row.style.background = 'rgba(255,255,255,0.05)';
    row.style.borderRadius = '4px';
    row.style.margin = '2px 0';
    row.style.borderLeft = `4px solid ${categoryColor}`;
    
    // Prima riga: nome e quantità
    const topRow = document.createElement('div');
    topRow.style.display = 'grid';
    topRow.style.gridTemplateColumns = '1fr auto';
    topRow.style.alignItems = 'center';
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = product.name;
    nameDiv.style.fontFamily = fontSettings.refill.font;
    nameDiv.style.fontSize = fontSettings.refill.size + 'px';
    nameDiv.style.fontWeight = '700';
    nameDiv.style.color = fontSettings.refill.color;
    
    const qtyDiv = document.createElement('div');
    qtyDiv.textContent = `Qty: ${qty}`;
    qtyDiv.style.fontFamily = fontSettings.refill.font;
    qtyDiv.style.fontSize = (fontSettings.refill.size - 2) + 'px';
    qtyDiv.style.fontWeight = '700';
    qtyDiv.style.color = categoryColor;
    
    topRow.appendChild(nameDiv);
    topRow.appendChild(qtyDiv);
    
    // Seconda riga: campo valore
    const valueRow = document.createElement('div');
    valueRow.style.display = 'flex';
    valueRow.style.alignItems = 'center';
    valueRow.style.gap = '5px';
    
    const valueLabel = document.createElement('span');
    valueLabel.textContent = 'Valore unitario:';
    valueLabel.style.color = '#fff';
    valueLabel.style.fontSize = '12px';
    
    const valueInput = document.createElement('input');
    valueInput.type = 'number';
    valueInput.step = '0.1';
    valueInput.min = '0';
    valueInput.value = (getRefillValue(product.name) || 0).toString();
    valueInput.placeholder = '0';
    valueInput.style.width = '60px';
    valueInput.style.padding = '2px 4px';
    valueInput.style.fontSize = '12px';
    valueInput.style.border = '1px solid #ccc';
    valueInput.style.borderRadius = '3px';
    valueInput.style.background = '#fff';
    
    valueInput.onchange = () => {
      const newValue = parseFloat(valueInput.value) || 0;
      setRefillValue(product.name, newValue);
      saveData();
    };
    
    valueRow.appendChild(valueLabel);
    valueRow.appendChild(valueInput);
    
    row.appendChild(topRow);
    row.appendChild(valueRow);
    orderList.appendChild(row);
  });
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openRefillStandardPopup();
  };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm(`Confermi il reset di ${categoryName}? (Solo quantità, valori mantenuti)`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Reset solo quantità prodotti di questa categoria, mantenendo i valori unitari
      resetRefillQuantitiesOnly(catalogProducts.map(p => p.name));
      saveData();
      openRefillCategoryStandard(categoryKey, categoryName, categoryColor, catalogProducts);
    }, `Reset ${categoryName}`);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);
}

/* Popup Refill - Versione Overlay (DEPRECATA) */
function openRefillPopup(){
  currentTarget = {type:null, id:null};
  
  // Crea overlay 90% schermo con background come SPESA
  const refillOverlay = document.createElement('div');
  refillOverlay.id = 'refill-overlay';
  refillOverlay.style.position = 'fixed';
  refillOverlay.style.top = '0';
  refillOverlay.style.left = '0';
  refillOverlay.style.right = '0';
  refillOverlay.style.bottom = '0';
  refillOverlay.style.background = 'rgba(0,0,0,0.95)';
  refillOverlay.style.zIndex = '9999';
  refillOverlay.style.display = 'flex';
  refillOverlay.style.alignItems = 'center';
  refillOverlay.style.justifyContent = 'center';
  // Evita che i click del popup propaghino a listener globali (solo stopPropagation)
  refillOverlay.addEventListener('click', (e)=> e.stopPropagation());
  refillOverlay.addEventListener('mousedown', (e)=> e.stopPropagation());
  refillOverlay.addEventListener('touchstart', (e)=> e.stopPropagation(), { passive: true });
  
  // Container interno 90% con background personalizzato
  const refillContent = document.createElement('div');
  refillContent.style.background = `#000 url("${currentBackground}") no-repeat center center`;
  refillContent.style.backgroundSize = 'cover';
  refillContent.style.width = '90vw';
  refillContent.style.height = '90vh';
  refillContent.style.borderRadius = '12px';
  refillContent.style.border = '2px solid #444';
  refillContent.style.padding = '20px';
  refillContent.style.overflowY = 'auto';
  refillContent.style.display = 'flex';
  refillContent.style.flexDirection = 'column';
  refillContent.style.alignItems = 'center';
  refillContent.style.justifyContent = 'center';
  // Blocca propagazione eventi all'esterno del contenitore
  refillContent.addEventListener('click', (e)=> e.stopPropagation());
  refillContent.addEventListener('mousedown', (e)=> e.stopPropagation());
  refillContent.addEventListener('touchstart', (e)=> e.stopPropagation(), { passive: true });
  
  // Titolo
  const title = document.createElement('div');
  title.textContent = 'REFILL - Seleziona Categoria';
  title.style.fontSize = '24px';
  title.style.fontWeight = '700';
  title.style.textAlign = 'center';
  title.style.marginBottom = '30px';
  title.style.color = '#fff';
  refillContent.appendChild(title);
  
  // Container bottoni categorie (50% larghezza, centrati)
  const categoriesContainer = document.createElement('div');
  categoriesContainer.style.width = '50%';
  categoriesContainer.style.maxWidth = '400px';
  categoriesContainer.style.display = 'flex';
  categoriesContainer.style.flexDirection = 'column';
  categoriesContainer.style.gap = '15px';
  
  // Definizione categorie
  const categories = [
    { key: 'c1', name: 'REFILL CAFFÈ', color: '#888', catalog: CATALOG.c1 },
    { key: 'c2', name: 'REFILL SPINA', color: '#ff8800', catalog: CATALOG.c2 },
    { key: 'c3', name: 'REFILL FRIGO', color: '#0099ff', catalog: CATALOG.c3 },
    { key: 'c4', name: 'REFILL SUPER', color: '#aaaa00', catalog: CATALOG.c4 },
    { key: 'c5', name: 'REFILL SNACK', color: '#ff0000', catalog: CATALOG.c5 }
  ];
  
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat.name;
    btn.type = 'button';
    btn.style.padding = '20px';
    btn.style.fontSize = '20px';
    btn.style.fontWeight = '700';
    btn.style.background = cat.color;
    btn.style.color = '#fff';
    btn.style.border = 'none';
    btn.style.borderRadius = '10px';
    btn.style.cursor = 'pointer';
    btn.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
    btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    
    btn.onmouseenter = () => {
      btn.style.transform = 'translateY(-3px)';
      btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.4)';
    };
    btn.onmouseleave = () => {
      btn.style.transform = 'translateY(0)';
      btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    };
    
    btn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      vibrate(VIBRATION_PATTERNS.tap);
      openRefillCategoryList(cat.key, cat.name, cat.color, cat.catalog);
    };
    
    categoriesContainer.appendChild(btn);
  });
  
  refillContent.appendChild(categoriesContainer);
  
  // Bottone chiudi in basso
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Chiudi';
  closeBtn.className = 'utility-btn';
  closeBtn.style.marginTop = '10px';
  closeBtn.type = 'button';
  closeBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    vibrate(VIBRATION_PATTERNS.tap);
    disableRefillHistoryTrap();
    document.getElementById('refill-overlay').remove();
  };
  
  refillContent.appendChild(closeBtn);
  refillOverlay.appendChild(refillContent);
  document.body.appendChild(refillOverlay);
  
  // Attiva trap per tasto back
  enableRefillHistoryTrap();
}

function openRefillCategoryList(categoryKey, categoryName, categoryColor, catalogProducts){
  // Rimuovi overlay precedente
  const oldOverlay = document.getElementById('refill-overlay');
  if(oldOverlay) oldOverlay.remove();
  
  // Crea nuovo overlay 90% schermo con background come SPESA
  const refillOverlay = document.createElement('div');
  refillOverlay.id = 'refill-overlay';
  refillOverlay.style.position = 'fixed';
  refillOverlay.style.top = '0';
  refillOverlay.style.left = '0';
  refillOverlay.style.right = '0';
  refillOverlay.style.bottom = '0';
  refillOverlay.style.background = 'rgba(0,0,0,0.95)';
  refillOverlay.style.zIndex = '9999';
  refillOverlay.style.display = 'flex';
  refillOverlay.style.alignItems = 'center';
  refillOverlay.style.justifyContent = 'center';
  
  // Container interno 90% con background personalizzato
  const refillContent = document.createElement('div');
  refillContent.style.background = `#000 url("${currentBackground}") no-repeat center center`;
  refillContent.style.backgroundSize = 'cover';
  refillContent.style.width = '90vw';
  refillContent.style.height = '90vh';
  refillContent.style.borderRadius = '12px';
  refillContent.style.border = '2px solid #444';
  refillContent.style.padding = '20px';
  refillContent.style.overflowY = 'auto';
  refillContent.style.display = 'flex';
  refillContent.style.flexDirection = 'column';
  
  // Titolo
  const title = document.createElement('div');
  title.textContent = `REFILL - ${categoryName}`;
  title.style.fontSize = '24px';
  title.style.fontWeight = '700';
  title.style.textAlign = 'center';
  title.style.marginBottom = '20px';
  title.style.color = '#fff';
  refillContent.appendChild(title);
  
  // Bottoni azioni
  const actionsTop = document.createElement('div');
  actionsTop.style.display = 'flex';
  actionsTop.style.gap = '10px';
  actionsTop.style.marginBottom = '20px';
  
  const backBtn = document.createElement('button');
  backBtn.textContent = '← Indietro';
  backBtn.style.background = '#555';
  backBtn.style.flex = '1';
  backBtn.style.padding = '15px';
  backBtn.style.fontSize = '16px';
  backBtn.style.fontWeight = '700';
  backBtn.style.border = 'none';
  backBtn.style.borderRadius = '8px';
  backBtn.style.color = '#fff';
  backBtn.style.cursor = 'pointer';
  backBtn.type = 'button';
  backBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    vibrate(VIBRATION_PATTERNS.tap);
    disableRefillHistoryTrap();
    const overlay = document.getElementById('refill-overlay');
    if(overlay) overlay.remove();
    openRefillPopup();
  };
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = 'Reset';
  resetBtn.style.background = '#aa0000';
  resetBtn.style.flex = '1';
  resetBtn.style.padding = '15px';
  resetBtn.style.fontSize = '16px';
  resetBtn.style.fontWeight = '700';
  resetBtn.style.border = 'none';
  resetBtn.style.borderRadius = '8px';
  resetBtn.style.color = '#fff';
  resetBtn.style.cursor = 'pointer';
  resetBtn.type = 'button';
  resetBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    vibrate(VIBRATION_PATTERNS.warning);
    showConfirm(`Confermi il reset di ${categoryName}?`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Prima di azzerare, aggiungi le quantità ai contatori consumo
      catalogProducts.forEach(product => {
        const quantity = getRefillQuantity(product.name);
        if(quantity > 0) {
          incrementConsumoCounter(product.name, quantity);
        }
        delete refillList[product.name];
      });
      saveData();
      // Riapri la lista
      openRefillCategoryList(categoryKey, categoryName, categoryColor, catalogProducts);
    }, `Reset ${categoryName}`);
  };
  closeBtn.className = 'utility-btn';
  closeBtn.type = 'button';
  closeBtn.onclick = (e)=> {
    e.preventDefault();
    e.stopPropagation();
    vibrate(VIBRATION_PATTERNS.tap);
    disableRefillHistoryTrap();
    document.getElementById('refill-overlay').remove();
  };
  
  actionsTop.appendChild(backBtn);
  actionsTop.appendChild(resetBtn);
  actionsTop.appendChild(closeBtn);
  refillContent.appendChild(actionsTop);
  
  // Container prodotti
  const gridContainer = document.createElement('div');
  gridContainer.style.display = 'grid';
  gridContainer.style.gridTemplateColumns = '1fr 1fr';
  gridContainer.style.gap = '15px';
  
  // Array per raccogliere tutti i prodotti (inclusi quelli nelle sottocategorie)
  const allProducts = [];
  
  catalogProducts.forEach(product => {
    // Se il prodotto ha una sottocategoria, espandi i suoi prodotti
    if(subcategories[product.name]){
      subcategories[product.name].forEach(subProduct => {
        allProducts.push(subProduct);
      });
    } else {
      // Altrimenti aggiungi il prodotto normale
      allProducts.push(product);
    }
  });
  
  allProducts.forEach(product => {
    const qty = getRefillQuantity(product.name);
    
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.flexDirection = 'column';
    row.style.gap = '10px';
    row.style.padding = '15px';
    row.style.background = categoryColor;
    row.style.borderRadius = '8px';
    row.style.transition = 'transform 0.2s ease';
    
    row.onmouseenter = () => {
      row.style.transform = 'scale(1.02)';
    };
    row.onmouseleave = () => {
      row.style.transform = 'scale(1)';
    };
    
    // Prima riga: nome e quantità
    const topRow = document.createElement('div');
    topRow.style.display = 'grid';
    topRow.style.gridTemplateColumns = '2fr 1fr';
    topRow.style.gap = '10px';
    topRow.style.alignItems = 'center';
    topRow.style.cursor = 'pointer';
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = product.name;
    nameDiv.style.fontSize = '16px';
    nameDiv.style.fontWeight = '700';
    nameDiv.style.color = '#fff';
    
    const qtyDiv = document.createElement('div');
    qtyDiv.textContent = qty;
    qtyDiv.style.fontSize = '20px';
    qtyDiv.style.fontWeight = '700';
    qtyDiv.style.textAlign = 'center';
    qtyDiv.style.color = '#fff';
    
    topRow.appendChild(nameDiv);
    topRow.appendChild(qtyDiv);
    
    // Seconda riga: campo valore
    const valueRow = document.createElement('div');
    valueRow.style.display = 'flex';
    valueRow.style.alignItems = 'center';
    valueRow.style.gap = '5px';
    
    const valueLabel = document.createElement('span');
    valueLabel.textContent = 'Valore unitario:';
    valueLabel.style.color = '#fff';
    valueLabel.style.fontSize = '12px';
    
    const valueInput = document.createElement('input');
    valueInput.type = 'number';
    valueInput.step = '0.1';
    valueInput.min = '0';
    valueInput.value = (getRefillValue(product.name) || 0).toString();
    valueInput.placeholder = '0';
    valueInput.style.width = '60px';
    valueInput.style.padding = '2px 4px';
    valueInput.style.fontSize = '12px';
    valueInput.style.border = '1px solid #ccc';
    valueInput.style.borderRadius = '3px';
    valueInput.style.background = '#fff';
    
    valueInput.onchange = () => {
      const newValue = parseFloat(valueInput.value) || 0;
      setRefillValue(product.name, newValue);
      saveData();
    };
    
    valueRow.appendChild(valueLabel);
    valueRow.appendChild(valueInput);
    
    row.appendChild(topRow);
    row.appendChild(valueRow);
    gridContainer.appendChild(row);
  });
  
  refillContent.appendChild(gridContainer);
  refillOverlay.appendChild(refillContent);
  document.body.appendChild(refillOverlay);
  
  // Attiva trap per tasto back
  enableRefillHistoryTrap();
}

// Utilities REFILL: considera tutte le categorie di refill (c1..c5)
function getRefillCategoryKeys(){
  return ['c1','c2','c3','c4','c5'];
}

function getAllRefillCatalogProducts(){
  const keys = getRefillCategoryKeys();
  const products = [];
  keys.forEach(k => {
    const list = CATALOG[k] || [];
    list.forEach(p => {
      // espandi sottocategorie se presenti
      if(subcategories[p.name]){
        subcategories[p.name].forEach(sp => {
          products.push({ name: `${p.name} ${sp.name}`, price: sp.price });
        });
      }
      // aggiungi anche il prodotto base
      products.push({ name: p.name, price: p.price });
    });
  });
  return products;
}

function isRefillProductName(name){
  // Rimuove eventuali modificatori finali (SR, M, K, S, GH)
  let clean = name;
  const mods = [' SR',' M',' K',' S',' GH'];
  mods.forEach(m => {
    if(clean.endsWith(m)) clean = clean.slice(0, -m.length);
  });
  const all = getAllRefillCatalogProducts();
  return all.some(p => p.name === clean);
}

function updateRefillFromItems(items){
  // Aumenta i prodotti REFILL (c1..c5) nella lista refill quando vengono pagati/consegnati
  if(!items || items.length === 0) return;
  
  items.forEach(item => {
    // Pulisci eventuali modificatori e verifica se è un prodotto REFILL
    let productName = item.name;
    modifiersList.forEach(mod => {
      productName = productName.replace(new RegExp('\\s+' + mod + '$'), '');
    });
    const isRefill = isRefillProductName(productName);
    console.log('Checking item:', item.name, '-> Clean name:', productName, 'Is REFILL?', isRefill, 'Qty:', item.qty);
    if(isRefill){
      if(!refillList[productName]) refillList[productName] = {quantity: 0, value: 0};
      refillList[productName].quantity += (item.qty || 1);
      console.log('Updated refillList:', productName, '=', refillList[productName].quantity);
    }
  });
  saveData();
}


/* Popup Spesa */
function openSpesaPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi solo la scritta "ORDINE" mantenendo i tasti azione
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "SPESA";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Container per centrare i tasti (stile refill)
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'center';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  
  // Bottoni principali con stile refill
  const spesaButtons = [
    { name: 'CARRELLO', color: '#000000' }
  ];
  
  spesaButtons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.name;
    button.style.width = '75%';
    button.style.padding = '20px';
    button.style.fontSize = '18px';
    button.style.fontWeight = '700';
    button.style.background = btn.color;
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '8px';
    button.style.cursor = 'pointer';
    button.style.transition = 'all 0.2s ease';
    button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    
    // Effetti hover
    button.onmouseenter = () => {
      button.style.transform = 'translateY(-2px)';
      button.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
    };
    button.onmouseleave = () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    };
    
    // Click handlers
    button.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      if(btn.name === 'CARRELLO') {
        openCarrelloPopup();
      }
    };
    
    container.appendChild(button);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni (stile refill)
  actionsDiv.innerHTML = "";
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

/* Popup Carrello */
function openCarrelloPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi solo la scritta "ORDINE" mantenendo i tasti azione
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "CARRELLO";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Container per centrare i tasti (stile refill)
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'center';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  
  // Bottoni principali con stile refill
  const carrelloButtons = [
    { name: 'AMAZON', color: '#000000' },
    { name: 'POGGIANA', color: '#000000' },
    { name: 'PRIX', color: '#000000' },
    { name: 'BATTOCCHIO', color: '#000000' }
  ];
  
  carrelloButtons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.name;
    button.style.width = '75%';
    button.style.padding = '20px';
    button.style.fontSize = '18px';
    button.style.fontWeight = '700';
    button.style.background = btn.color;
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '8px';
    button.style.cursor = 'pointer';
    button.style.transition = 'all 0.2s ease';
    button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    
    // Effetti hover
    button.onmouseenter = () => {
      button.style.transform = 'translateY(-2px)';
      button.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
    };
    button.onmouseleave = () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    };
    
    // Click handlers
    button.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      if(btn.name === 'AMAZON') {
        openAmazonPopup();
      } else if(btn.name === 'POGGIANA') {
        openPoggianaPopup();
      } else if(btn.name === 'PRIX') {
        openPrixPopup();
      } else if(btn.name === 'BATTOCCHIO') {
        openBattocchioPopup();
      }
    };
    
    container.appendChild(button);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni (stile refill con Indietro + Chiudi)
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openSpesaPopup(); // Torna al popup spesa
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

/* Popup Amazon */
function openAmazonPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "AMAZON";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Mostra la lista Amazon
  if (amazonList.length === 0) {
    const emptyContainer = document.createElement('div');
    emptyContainer.style.display = 'flex';
    emptyContainer.style.alignItems = 'center';
    emptyContainer.style.justifyContent = 'center';
    emptyContainer.style.height = '100%';
    emptyContainer.style.fontSize = '18px';
    emptyContainer.style.color = '#888';
    emptyContainer.textContent = 'Nessun elemento nella lista Amazon';
    orderList.appendChild(emptyContainer);
  } else {
    amazonList.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.style.background = '#333';
      itemDiv.style.padding = '15px';
      itemDiv.style.margin = '8px auto';
      itemDiv.style.borderRadius = '8px';
      itemDiv.style.border = '1px solid #555';
      itemDiv.style.width = '75%';
      
      // Container per nome e valore
      const contentDiv = document.createElement('div');
      contentDiv.style.display = 'flex';
      contentDiv.style.justifyContent = 'space-between';
      contentDiv.style.alignItems = 'center';
      contentDiv.style.padding = '5px 0';
      
      // Estrai nome e valore dal formato "nome (valore)"
      const nameText = item.name.includes('(') ? item.name.split(' (')[0] : item.name;
      const valueText = item.name.includes('(') ? item.name.split(' (')[1].replace(')', '') : '';
      
      const nameDiv = document.createElement('div');
      nameDiv.style.fontSize = '16px';
      nameDiv.style.fontWeight = 'bold';
      nameDiv.style.color = '#fff';
      nameDiv.textContent = nameText;
      
      const valueDiv = document.createElement('div');
      valueDiv.style.fontSize = '16px';
      valueDiv.style.fontWeight = 'bold';
      valueDiv.style.color = '#4CAF50';
      valueDiv.textContent = valueText;
      
      contentDiv.appendChild(nameDiv);
      contentDiv.appendChild(valueDiv);
      itemDiv.appendChild(contentDiv);
      orderList.appendChild(itemDiv);
    });
  }
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openCarrelloPopup();
  };
  
  const aggiungiBtn = document.createElement('button');
  aggiungiBtn.textContent = "Aggiungi";
  aggiungiBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openAggiungiPopup(amazonList, "AMAZON", openAmazonPopup);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(aggiungiBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

/* Popup Poggiana */
function openPoggianaPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "POGGIANA";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Mostra la lista Poggiana
  if (poggianaList.length === 0) {
    const emptyContainer = document.createElement('div');
    emptyContainer.style.display = 'flex';
    emptyContainer.style.alignItems = 'center';
    emptyContainer.style.justifyContent = 'center';
    emptyContainer.style.height = '100%';
    emptyContainer.style.fontSize = '18px';
    emptyContainer.style.color = '#888';
    emptyContainer.textContent = 'Nessun elemento nella lista Poggiana';
    orderList.appendChild(emptyContainer);
  } else {
    poggianaList.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.style.background = '#333';
      itemDiv.style.padding = '15px';
      itemDiv.style.margin = '8px auto';
      itemDiv.style.borderRadius = '8px';
      itemDiv.style.border = '1px solid #555';
      itemDiv.style.width = '75%';
      
      // Container per nome e valore
      const contentDiv = document.createElement('div');
      contentDiv.style.display = 'flex';
      contentDiv.style.justifyContent = 'space-between';
      contentDiv.style.alignItems = 'center';
      contentDiv.style.padding = '5px 0';
      
      // Estrai nome e valore dal formato "nome (valore)"
      const nameText = item.name.includes('(') ? item.name.split(' (')[0] : item.name;
      const valueText = item.name.includes('(') ? item.name.split(' (')[1].replace(')', '') : '';
      
      const nameDiv = document.createElement('div');
      nameDiv.style.fontSize = '16px';
      nameDiv.style.fontWeight = 'bold';
      nameDiv.style.color = '#fff';
      nameDiv.textContent = nameText;
      
      const valueDiv = document.createElement('div');
      valueDiv.style.fontSize = '16px';
      valueDiv.style.fontWeight = 'bold';
      valueDiv.style.color = '#4CAF50';
      valueDiv.textContent = valueText;
      
      contentDiv.appendChild(nameDiv);
      contentDiv.appendChild(valueDiv);
      itemDiv.appendChild(contentDiv);
      orderList.appendChild(itemDiv);
    });
  }
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openCarrelloPopup();
  };
  
  const aggiungiBtn = document.createElement('button');
  aggiungiBtn.textContent = "Aggiungi";
  aggiungiBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openAggiungiPopup(poggianaList, "POGGIANA", openPoggianaPopup);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(aggiungiBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

/* Popup Prix */
function openPrixPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "PRIX";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Mostra la lista Prix
  if (prixList.length === 0) {
    const emptyContainer = document.createElement('div');
    emptyContainer.style.display = 'flex';
    emptyContainer.style.alignItems = 'center';
    emptyContainer.style.justifyContent = 'center';
    emptyContainer.style.height = '100%';
    emptyContainer.style.fontSize = '18px';
    emptyContainer.style.color = '#888';
    emptyContainer.textContent = 'Nessun elemento nella lista Prix';
    orderList.appendChild(emptyContainer);
  } else {
    prixList.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.style.background = '#333';
      itemDiv.style.padding = '15px';
      itemDiv.style.margin = '8px auto';
      itemDiv.style.borderRadius = '8px';
      itemDiv.style.border = '1px solid #555';
      itemDiv.style.width = '75%';
      
      // Container per nome e valore
      const contentDiv = document.createElement('div');
      contentDiv.style.display = 'flex';
      contentDiv.style.justifyContent = 'space-between';
      contentDiv.style.alignItems = 'center';
      contentDiv.style.padding = '5px 0';
      
      // Estrai nome e valore dal formato "nome (valore)"
      const nameText = item.name.includes('(') ? item.name.split(' (')[0] : item.name;
      const valueText = item.name.includes('(') ? item.name.split(' (')[1].replace(')', '') : '';
      
      const nameDiv = document.createElement('div');
      nameDiv.style.fontSize = '16px';
      nameDiv.style.fontWeight = 'bold';
      nameDiv.style.color = '#fff';
      nameDiv.textContent = nameText;
      
      const valueDiv = document.createElement('div');
      valueDiv.style.fontSize = '16px';
      valueDiv.style.fontWeight = 'bold';
      valueDiv.style.color = '#4CAF50';
      valueDiv.textContent = valueText;
      
      contentDiv.appendChild(nameDiv);
      contentDiv.appendChild(valueDiv);
      itemDiv.appendChild(contentDiv);
      orderList.appendChild(itemDiv);
    });
  }
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openCarrelloPopup();
  };
  
  const aggiungiBtn = document.createElement('button');
  aggiungiBtn.textContent = "Aggiungi";
  aggiungiBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openAggiungiPopup(prixList, "PRIX", openPrixPopup);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(aggiungiBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

/* Popup Battocchio */
function openBattocchioPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "BATTOCCHIO";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Mostra la lista Battocchio
  if (battocchioList.length === 0) {
    const emptyContainer = document.createElement('div');
    emptyContainer.style.display = 'flex';
    emptyContainer.style.alignItems = 'center';
    emptyContainer.style.justifyContent = 'center';
    emptyContainer.style.height = '100%';
    emptyContainer.style.fontSize = '18px';
    emptyContainer.style.color = '#888';
    emptyContainer.textContent = 'Nessun elemento nella lista Battocchio';
    orderList.appendChild(emptyContainer);
  } else {
    battocchioList.forEach((item, index) => {
      const itemDiv = document.createElement('div');
      itemDiv.style.background = '#333';
      itemDiv.style.padding = '15px';
      itemDiv.style.margin = '8px auto';
      itemDiv.style.borderRadius = '8px';
      itemDiv.style.border = '1px solid #555';
      itemDiv.style.width = '75%';
      
      // Container per nome e valore
      const contentDiv = document.createElement('div');
      contentDiv.style.display = 'flex';
      contentDiv.style.justifyContent = 'space-between';
      contentDiv.style.alignItems = 'center';
      contentDiv.style.padding = '5px 0';
      
      // Estrai nome e valore dal formato "nome (valore)"
      const nameText = item.name.includes('(') ? item.name.split(' (')[0] : item.name;
      const valueText = item.name.includes('(') ? item.name.split(' (')[1].replace(')', '') : '';
      
      const nameDiv = document.createElement('div');
      nameDiv.style.fontSize = '16px';
      nameDiv.style.fontWeight = 'bold';
      nameDiv.style.color = '#fff';
      nameDiv.textContent = nameText;
      
      const valueDiv = document.createElement('div');
      valueDiv.style.fontSize = '16px';
      valueDiv.style.fontWeight = 'bold';
      valueDiv.style.color = '#4CAF50';
      valueDiv.textContent = valueText;
      
      contentDiv.appendChild(nameDiv);
      contentDiv.appendChild(valueDiv);
      itemDiv.appendChild(contentDiv);
      orderList.appendChild(itemDiv);
    });
  }
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openCarrelloPopup();
  };
  
  const aggiungiBtn = document.createElement('button');
  aggiungiBtn.textContent = "Aggiungi";
  aggiungiBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openAggiungiPopup(battocchioList, "BATTOCCHIO", openBattocchioPopup);
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(aggiungiBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

// Funzione per ottenere tutte le sottocategorie storage
function getAllStorageCategories() {
  const storageCategories = [];
  
  // STORAGE CAFFÈ
  storageCategories.push('STORAGE CAFFÈ', 'STORAGE CAFFÈ DECA');
  
  // STORAGE SPINA
  storageCategories.push('STORAGE PYRASER', 'STORAGE ARIA', 'STORAGE GUINNESS', 'STORAGE GLERA', 'STORAGE APEROL', 'STORAGE CAMPARI', 'STORAGE CYNAR');
  
  // STORAGE FRIGO (da catalogo c3)
  const frigoProducts = CATALOG['c3'] || [];
  frigoProducts.forEach(product => {
    if(subcategories[product.name]) {
      subcategories[product.name].forEach(subProduct => {
        storageCategories.push(`STORAGE ${product.name} ${subProduct.name}`);
      });
    } else {
      storageCategories.push(`STORAGE ${product.name}`);
    }
  });
  
  // STORAGE SUPER (da catalogo c4 con modifiche)
  const superProducts = CATALOG['c4'] || [];
  superProducts.forEach(product => {
    if(subcategories[product.name]) {
      subcategories[product.name].forEach(subProduct => {
        const originalName = `${product.name} ${subProduct.name}`;
        let finalName = `STORAGE ${originalName}`;
        
        // Sostituzioni specifiche
        if(originalName === 'COCKTAILS GIN TONIC') {
          finalName = 'STORAGE GIN TANQUERAY';
        } else if(originalName === 'COCKTAILS GIN TONIC H') {
          finalName = 'STORAGE GIN HENDRICKS';
        } else if(originalName === 'COCKTAILS RUM COLA') {
          finalName = 'STORAGE BACARDI';
        } else if(originalName === 'COCKTAILS VODKA TONIC') {
          finalName = 'STORAGE SKYYE';
        } else if(originalName === 'COCKTAILS AMERICANO') {
          finalName = 'STORAGE MARTINI ROSSO';
        }
        
        storageCategories.push(finalName);
      });
    } else {
      storageCategories.push(`STORAGE ${product.name}`);
    }
  });
  
  // STORAGE SNACK
  storageCategories.push('STORAGE PROSCIUTTO', 'STORAGE FORMAGGIO', 'STORAGE PANE TOAST', 'STORAGE PANE HOT DOG');
  
  // STORAGE MANUTENZIONE
  const manutenzioneProducts = ['CARTA MANI', 'CARTA IGIENICA', 'SAPONE LIQUIDO', 'SACCHI GRANDI', 'SACCHI PICCOLI', 'DET PAVIMENTI', 'DET BAGNI', 'DET SUPERFICI', 'DET ACCIAIO', 'SPUGNE GRANDI', 'SPUGNE PICCOLE', 'SPUGNE PIATTE', 'LAVABICCHIERI B', 'LAVABICCHIERI D'];
  manutenzioneProducts.forEach(product => {
    storageCategories.push(`STORAGE ${product}`);
  });
  
  return storageCategories.sort();
}

// Funzione helper per creare una riga prodotto nella sezione STORAGE
function createStorageProductRow(container, productName, categoryColor) {
  const productDiv = document.createElement('div');
  productDiv.style.width = '75%';
  productDiv.style.padding = '15px';
  productDiv.style.background = categoryColor;
  productDiv.style.borderRadius = '8px';
  productDiv.style.color = '#fff';
  productDiv.style.fontSize = '16px';
  productDiv.style.fontWeight = '700';
  productDiv.style.textAlign = 'left';
  productDiv.style.cursor = 'pointer';
  productDiv.style.transition = 'all 0.2s ease';
  productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
  productDiv.style.display = 'flex';
  productDiv.style.justifyContent = 'space-between';
  productDiv.style.alignItems = 'center';
  
  const nameSpan = document.createElement('span');
  nameSpan.textContent = productName;
  nameSpan.style.flex = '1';
  nameSpan.style.marginRight = '10px';
  
  // Valore storage (verde)
  const storageValue = getStorageValue(productName);
  const valueSpan = document.createElement('span');
  valueSpan.textContent = storageValue.toFixed(2);
  valueSpan.style.fontSize = '14px';
  valueSpan.style.fontWeight = '700';
  valueSpan.style.background = 'rgba(100,255,100,0.4)';
  valueSpan.style.padding = '6px 12px';
  valueSpan.style.borderRadius = '8px';
  valueSpan.style.minWidth = '60px';
  valueSpan.style.textAlign = 'center';
  valueSpan.style.border = '1px solid rgba(100,255,100,0.6)';
  valueSpan.title = `Valore storage: ${storageValue.toFixed(2)}`;
  
  productDiv.appendChild(nameSpan);
  productDiv.appendChild(valueSpan);
  
  // Effetti hover
  productDiv.onmouseenter = () => {
    productDiv.style.transform = 'translateY(-1px)';
    productDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
  };
  productDiv.onmouseleave = () => {
    productDiv.style.transform = 'translateY(0)';
    productDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
  };
  
  productDiv.onclick = () => {
    vibrate(VIBRATION_PATTERNS.tap);
    // Qui si può aggiungere logica per modificare il valore manualmente
  };
  
  container.appendChild(productDiv);
}



/* Popup Consumo */
function openConsumoPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi solo la scritta "ORDINE" mantenendo i tasti azione
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "CONSUMO";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Container per centrare i tasti (stile refill)
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'center';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  
  // Bottoni principali con stile refill
  const consumoButtons = [
    { name: 'CONSUMO CAFFÈ', color: '#888888' },
    { name: 'CONSUMO SPINA', color: '#ff8800' },
    { name: 'CONSUMO FRIGO', color: '#0099ff' },
    { name: 'CONSUMO SUPER', color: '#aaaa00' },
    { name: 'CONSUMO SNACK', color: '#ff0000' },
    { name: 'CONSUMO MANUTENZIONE', color: '#8800aa' }
  ];
  
  consumoButtons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.name;
    button.style.width = '75%';
    button.style.padding = '20px';
    button.style.fontSize = '18px';
    button.style.fontWeight = '700';
    button.style.background = btn.color;
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '8px';
    button.style.cursor = 'pointer';
    button.style.transition = 'all 0.2s ease';
    button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    
    // Effetti hover
    button.onmouseenter = () => {
      button.style.transform = 'translateY(-2px)';
      button.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
    };
    button.onmouseleave = () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    };
    
    // Click handlers
    button.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      if(btn.name === 'CONSUMO CAFFÈ') {
        openConsumoCaffePopup();
      } else if(btn.name === 'CONSUMO SPINA') {
        openConsumoSpinaPopup();
      } else if(btn.name === 'CONSUMO FRIGO') {
        openConsumoFrigoPopup();
      } else if(btn.name === 'CONSUMO SUPER') {
        openConsumoSuperPopup();
      } else if(btn.name === 'CONSUMO SNACK') {
        openConsumoSnackPopup();
      } else if(btn.name === 'CONSUMO MANUTENZIONE') {
        openConsumoManutenzionePopup();
      }
    };
    
    container.appendChild(button);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni (stile refill con Indietro + Chiudi)
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openMagazzinoPopup(); // Torna al popup magazzino
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

/* Popup Storage */
function openStoragePopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi solo la scritta "ORDINE" mantenendo i tasti azione
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = "STORAGE";
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Container per centrare i tasti (stile refill)
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'center';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  
  // Bottoni principali con stile refill
  const storageButtons = [
    { name: 'STORAGE CAFFÈ', color: '#888888' },
    { name: 'STORAGE SPINA', color: '#ff8800' },
    { name: 'STORAGE FRIGO', color: '#0099ff' },
    { name: 'STORAGE SUPER', color: '#aaaa00' },
    { name: 'STORAGE SNACK', color: '#ff0000' },
    { name: 'STORAGE MANUTENZIONE', color: '#8800aa' }
  ];
  
  storageButtons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.name;
    button.style.width = '75%';
    button.style.padding = '20px';
    button.style.fontSize = '18px';
    button.style.fontWeight = '700';
    button.style.background = btn.color;
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '8px';
    button.style.cursor = 'pointer';
    button.style.transition = 'all 0.2s ease';
    button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    
    // Effetti hover
    button.onmouseenter = () => {
      button.style.transform = 'translateY(-2px)';
      button.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
    };
    button.onmouseleave = () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    };
    
    // Click handlers
    button.onclick = () => {
      vibrate(VIBRATION_PATTERNS.tap);
      if(btn.name === 'STORAGE CAFFÈ') {
        openStorageCaffePopup();
      } else if(btn.name === 'STORAGE SPINA') {
        openStorageSpinaPopup();
      } else if(btn.name === 'STORAGE FRIGO') {
        openStorageFrigoPopup();
      } else if(btn.name === 'STORAGE SUPER') {
        openStorageSuperPopup();
      } else if(btn.name === 'STORAGE SNACK') {
        openStorageSnackPopup();
      } else if(btn.name === 'STORAGE MANUTENZIONE') {
        openStorageManutenzionePopup();
      }
    };
    
    container.appendChild(button);
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni (stile refill con Indietro + Chiudi)
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openMagazzinoPopup(); // Torna al popup magazzino
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}


/* Popup Consumo Categorie */
function openConsumoCaffePopup(){
  openCategoryPopup('c1', 'CONSUMO CAFFÈ', '#888888', 'CONSUMO', openConsumoPopup);
}

function openConsumoSpinaPopup(){
  openCategoryPopup('c2', 'CONSUMO SPINA', '#ff8800', 'CONSUMO', openConsumoPopup);
}

function openConsumoFrigoPopup(){
  openCategoryPopup('c3', 'CONSUMO FRIGO', '#0099ff', 'CONSUMO', openConsumoPopup);
}

function openConsumoSuperPopup(){
  openCategoryPopup('c4', 'CONSUMO SUPER', '#aaaa00', 'CONSUMO', openConsumoPopup);
}

function openConsumoSnackPopup(){
  openCategoryPopup('c5', 'CONSUMO SNACK', '#ff0000', 'CONSUMO', openConsumoPopup);
}

function openConsumoManutenzionePopup(){
  openCategoryPopup('manutenzione', 'CONSUMO MANUTENZIONE', '#8800aa', 'CONSUMO', openConsumoPopup);
}

/* Popup Storage Categorie */
function openStorageCaffePopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = 'STORAGE CAFFÈ';
  
  // Svuota la lista ordini
  orderList.innerHTML = "";
  
  // Container per i tasti
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'flex-start';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  container.style.overflowY = 'auto';
  
  // Prodotti specifici per STORAGE CAFFÈ
  const caffeProducts = [
    'STORAGE CAFFÈ',
    'STORAGE CAFFÈ DECA'
  ];
  
  caffeProducts.forEach(productName => {
    createStorageProductRow(container, productName, '#888888');
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openStoragePopup();
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function openStorageSpinaPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = 'STORAGE SPINA';
  
  // Svuota la lista ordini
  orderList.innerHTML = "";
  
  // Container per i tasti
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'flex-start';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  container.style.overflowY = 'auto';
  
  // Prodotti specifici per STORAGE SPINA
  const spinaProducts = [
    'STORAGE PYRASER',
    'STORAGE ARIA',
    'STORAGE GUINNESS',
    'STORAGE GLERA',
    'STORAGE APEROL',
    'STORAGE CAMPARI',
    'STORAGE CYNAR'
  ];
  
  spinaProducts.forEach(productName => {
    createStorageProductRow(container, productName, '#ff8800');
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openStoragePopup();
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function openStorageFrigoPopup(){
  openCategoryPopup('c3', 'STORAGE FRIGO', '#0099ff', 'STORAGE', openStoragePopup);
}

function openStorageSuperPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = 'STORAGE SUPER';
  
  // Svuota la lista ordini
  orderList.innerHTML = "";
  
  // Container per i tasti
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'flex-start';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  container.style.overflowY = 'auto';
  
  // Ottieni i prodotti originali dal catalogo c4 e modifica quelli richiesti
  const originalProducts = CATALOG['c4'] || [];
  const superProducts = [];
  
  originalProducts.forEach(product => {
    if(subcategories[product.name]) {
      // Se ha sottocategorie, processa quelle
      subcategories[product.name].forEach(subProduct => {
        const originalName = `${product.name} ${subProduct.name}`;
        let finalName = `STORAGE ${originalName}`;
        
        // Sostituzioni richieste
        if(originalName === 'COCKTAILS GIN TONIC') {
          finalName = 'STORAGE GIN TANQUERAY';
        } else if(originalName === 'COCKTAILS GIN TONIC H') {
          finalName = 'STORAGE GIN HENDRICKS';
        } else if(originalName === 'COCKTAILS RUM COLA') {
          finalName = 'STORAGE BACARDI';
        } else if(originalName === 'COCKTAILS VODKA TONIC') {
          finalName = 'STORAGE SKYYE';
        } else if(originalName === 'COCKTAILS AMERICANO') {
          finalName = 'STORAGE MARTINI ROSSO';
        } else if(originalName === 'COCKTAILS GIN LEMON' || originalName === 'COCKTAILS GIN LEMON H' || 
                  originalName === 'COCKTAILS JACK COLA' || originalName === 'COCKTAILS JAGERBOMB' || 
                  originalName === 'COCKTAILS VODKA LEMON') {
          // Salta questi prodotti (non li aggiungiamo)
          return;
        }
        
        superProducts.push(finalName);
      });
    } else {
      // Prodotto senza sottocategorie
      let finalName = `STORAGE ${product.name}`;
      
      // Sostituzioni richieste
      if(product.name === 'GIN TONIC') {
        finalName = 'STORAGE GIN TANQUERAY';
      } else if(product.name === 'GIN TONIC H') {
        finalName = 'STORAGE GIN HENDRICKS';
      } else if(product.name === 'GIN LEMON' || product.name === 'GIN LEMON H') {
        // Salta questi prodotti
        return;
      }
      
      superProducts.push(finalName);
    }
  });
  
  superProducts.forEach(productName => {
    createStorageProductRow(container, productName, '#aaaa00');
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openStoragePopup();
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function openStorageSnackPopup(){
  currentTarget = {type:null, id:null};
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi elementi non necessari
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = 'STORAGE SNACK';
  
  // Svuota la lista ordini
  orderList.innerHTML = "";
  
  // Container per i tasti
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'flex-start';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  container.style.overflowY = 'auto';
  
  // Prodotti specifici per STORAGE SNACK
  const snackProducts = [
    'STORAGE PROSCIUTTO',
    'STORAGE FORMAGGIO',
    'STORAGE PANE TOAST',
    'STORAGE PIZZETTA',
    'STORAGE WURSTEL',
    'STORAGE PANE HOT DOG'
  ];
  
  snackProducts.forEach(productName => {
    createStorageProductRow(container, productName, '#ff0000');
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    openStoragePopup();
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = () => { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function openStorageManutenzionePopup(){
  openCategoryPopup('manutenzione', 'STORAGE MANUTENZIONE', '#8800aa', 'STORAGE', openStoragePopup);
}



/* Funzione generica per popup categorie */
function openCategoryPopup(categoryKey, categoryName, categoryColor, prefix, backFunction){
  currentTarget = {type:null, id:null};
  
  
  // Applica classe spesa-popup per layout 90%
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  
  // Nascondi solo la scritta "ORDINE" mantenendo i tasti azione
  const columnTitle = document.querySelector('.column-title');
  if(columnTitle) columnTitle.style.display = 'none';
  
  // Nascondi elementi non necessari
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  // Titolo popup
  popupTitle.textContent = categoryName;
  
  // Svuota la lista ordini (area principale)
  orderList.innerHTML = "";
  
  // Container per i tasti con scroll
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.alignItems = 'center';
  container.style.justifyContent = 'flex-start';
  container.style.height = '100%';
  container.style.gap = '15px';
  container.style.padding = '20px';
  container.style.overflowY = 'auto';
  container.style.boxSizing = 'border-box';
  
  // Ottieni i prodotti della categoria con sottocategorie espanse
  let products = [];
  if(categoryKey === 'manutenzione') {
    // Per manutenzione, usa la stessa lista di refill manutenzione
    const manutenzioneProducts = [
      'CARTA MANI', 'CARTA IGIENICA', 'SAPONE LIQUIDO',
      'SACCHI GRANDI', 'SACCHI PICCOLI', 'DET PAVIMENTI',
      'DET BAGNI', 'DET SUPERFICI', 'DET ACCIAIO',
      'SPUGNE GRANDI', 'SPUGNE PICCOLE', 'SPUGNE PIATTE',
      'LAVABICCHIERI B', 'LAVABICCHIERI D'
    ];
    products = manutenzioneProducts.map(name => ({name, price: 0}));
  } else {
    const catalogProducts = CATALOG[categoryKey] || [];
    catalogProducts.forEach(product => {
      // Se il prodotto ha sottocategorie, espandi i suoi prodotti
      if(subcategories[product.name]){
        subcategories[product.name].forEach(subProduct => {
          products.push({ name: `${product.name} ${subProduct.name}`, price: subProduct.price });
        });
      } else {
        // Aggiungi il prodotto base se non ha sottocategorie
        products.push(product);
      }
    });
  }
  
  // Crea righe per ogni sottocategoria/prodotto
  products.forEach(product => {
    const productName = `${prefix} ${product.name}`;
    
    if(prefix === 'STORAGE') {
      // Usa la funzione specifica per storage
      createStorageProductRow(container, productName, categoryColor);
    } else {
      // Usa il vecchio sistema per CONSUMO e altri
      const button = document.createElement('button');
      
      // Se è CONSUMO, mostra il contatore
      let buttonText = productName;
      if(prefix === 'CONSUMO') {
        const counter = getConsumoCounter(product.name);
        buttonText = productName;
      }
      
      button.textContent = buttonText;
      button.style.width = '75%';
      button.style.padding = '20px';
      button.style.fontSize = '18px';
      button.style.fontWeight = '700';
      button.style.background = categoryColor;
      button.style.color = '#fff';
      button.style.border = 'none';
      button.style.borderRadius = '8px';
      button.style.cursor = 'pointer';
      button.style.transition = 'all 0.2s ease';
      button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
      button.style.textAlign = 'left';
      button.style.display = 'flex';
      button.style.justifyContent = 'space-between';
      button.style.alignItems = 'center';
      
      // Se è CONSUMO, aggiungi la quantità a destra
      if(prefix === 'CONSUMO') {
        const quantity = getConsumoQuantity(product.name);
        const quantitySpan = document.createElement('span');
        quantitySpan.textContent = quantity;
        quantitySpan.style.fontSize = '16px';
        quantitySpan.style.fontWeight = '600';
        quantitySpan.style.background = 'rgba(255,255,255,0.2)';
        quantitySpan.style.padding = '4px 8px';
        quantitySpan.style.borderRadius = '12px';
        quantitySpan.style.minWidth = '24px';
        quantitySpan.style.textAlign = 'center';
        
        // Svuota il button e aggiungi testo e quantità separatamente
        button.textContent = '';
        const textSpan = document.createElement('span');
        textSpan.textContent = `${prefix} ${product.name}`;
        button.appendChild(textSpan);
        button.appendChild(quantitySpan);
      }
      
      // Effetti hover
      button.onmouseenter = () => {
        button.style.transform = 'translateY(-2px)';
        button.style.boxShadow = '0 6px 12px rgba(0,0,0,0.4)';
      };
      button.onmouseleave = () => {
        button.style.transform = 'translateY(0)';
        button.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
      };
      
      // Click handler
      button.onclick = () => {
        vibrate(VIBRATION_PATTERNS.tap);
        if(prefix === 'CONSUMO') {
          // Per CONSUMO, mostra dettagli o permetti modifica rapida
          alert(`${prefix} per: ${product.name}\nQuantità: ${getConsumoQuantity(product.name)}\nValore: ${getConsumoValue(product.name)}`);
        } else {
          alert(`${prefix} per: ${product.name}`);
        }
      };
      
      // Tap prolungato per CONSUMO - permette modifica valore
      if(prefix === 'CONSUMO') {
        let longPressTimer;
        
        button.onmousedown = button.ontouchstart = (e) => {
          e.preventDefault();
          longPressTimer = setTimeout(() => {
            vibrate(VIBRATION_PATTERNS.warning);
            editConsumoValue(product.name, () => {
              // Callback per aggiornare l'interfaccia dopo la modifica
              openCategoryPopup(categoryKey, categoryName, categoryColor, prefix, backFunction);
            });
          }, 800); // 800ms per tap prolungato
        };
        
        button.onmouseup = button.onmouseleave = button.ontouchend = button.ontouchcancel = () => {
          if(longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        };
      }
      
      container.appendChild(button);
    }
  });
  
  orderList.appendChild(container);
  
  // Bottoni azioni (stile refill con Indietro + Chiudi)
  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    backFunction(); // Torna al popup precedente
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { 
    vibrate(VIBRATION_PATTERNS.tap); 
    closePopup(); 
  };
  
  actionsDiv.appendChild(backBtn);
  actionsDiv.appendChild(closeBtn);
  
  showPopup();
}

function printSpesaList(){
  // Crea una finestra di stampa con la lista spesa per TUTTE le categorie refill
  const allRefillProducts = getAllRefillCatalogProducts();
  const productsToShow = allRefillProducts.filter(product => {
    const qty = refillList[product.name] || 0;
    return qty > 0;
  });
  
  if(productsToShow.length === 0){
    alert('Nessun prodotto da stampare!');
    return;
  }
  
  let printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Lista Spesa - Break Billiard Club</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { text-align: center; color: #00aa00; }
        .date { text-align: center; color: #666; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #00aa00; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .qty { text-align: center; font-weight: bold; font-size: 18px; }
        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
        @media print {
          button { display: none; }
        }
      </style>
    </head>
    <body>
      <h1>🛒 Lista Spesa</h1>
      <div class="date">${new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
      <table>
        <thead>
          <tr>
            <th>Prodotto</th>
            <th style="width: 100px; text-align: center;">Quantità</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  productsToShow.forEach(product => {
    const qty = refillList[product.name];
    printContent += `
      <tr>
        <td>${product.name}</td>
        <td class="qty">${qty}</td>
      </tr>
    `;
  });
  
  printContent += `
        </tbody>
      </table>
      <div class="footer">
        Break Billiard Club - Lista generata automaticamente
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  
  // Attendi il caricamento e stampa
  printWindow.onload = () => {
    setTimeout(() => {
      printWindow.print();
    }, 250);
  };
}

function renderSpesaList(){
  orderList.innerHTML = "";
  
  // Mostra i prodotti REFILL (c1..c5) che hanno quantità > 0
  const allRefillProducts = getAllRefillCatalogProducts();
  
  // Filtra solo prodotti con quantità > 0
  const productsToShow = allRefillProducts.filter(product => {
    const qty = refillList[product.name] || 0;
    return qty > 0;
  });
  
  if(productsToShow.length === 0){
    const emptyMsg = document.createElement('div');
    emptyMsg.innerHTML = `
      <div style="text-align:center;padding:40px 20px;">
        <div style="font-size:48px;margin-bottom:20px;">🛒</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:10px;">Nessun prodotto da acquistare</div>
        <div style="font-size:14px;color:#aaa;">Aggiungi prodotti alle categorie Refill (Caffè, Spina, Frigo, Super, Snack) per popolare la lista</div>
      </div>
    `;
    orderList.appendChild(emptyMsg);
    return;
  }
  
  // Intestazione con totale prodotti
  const header = document.createElement('div');
  header.style.background = "rgba(0,170,0,0.2)";
  header.style.padding = "15px";
  header.style.borderRadius = "8px";
  header.style.marginBottom = "15px";
  header.style.textAlign = "center";
  header.innerHTML = `
    <div style="font-size:16px;font-weight:700;color:#00ff00;">
      📦 Totale prodotti: ${productsToShow.length}
    </div>
    <div style="font-size:14px;color:#aaa;margin-top:5px;">
      Quantità totale: ${Object.values(refillList).reduce((a,b)=>a+b,0)}
    </div>
  `;
  orderList.appendChild(header);
  
  // Container con griglia a 1 colonna per lista più leggibile
  const gridContainer = document.createElement('div');
  gridContainer.style.display = "flex";
  gridContainer.style.flexDirection = "column";
  gridContainer.style.gap = "10px";
  
  productsToShow.forEach(product => {
    const qty = refillList[product.name];
    
    const row = document.createElement('div');
    row.style.display = "grid";
    row.style.gridTemplateColumns = "1fr auto";
    row.style.gap = "15px";
    row.style.alignItems = "center";
    row.style.padding = "15px";
    row.style.background = "linear-gradient(135deg, #00aa00 0%, #008800 100%)";
    row.style.borderRadius = "10px";
    row.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
    row.style.transition = "transform 0.2s ease, box-shadow 0.2s ease";
    row.style.cursor = "pointer";
    
    row.onmouseenter = () => {
      row.style.transform = "translateY(-2px)";
      row.style.boxShadow = "0 4px 12px rgba(0,170,0,0.4)";
    };
    row.onmouseleave = () => {
      row.style.transform = "translateY(0)";
      row.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
    };
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = product.name;
    nameDiv.style.fontSize = "16px";
    nameDiv.style.fontWeight = "700";
    nameDiv.style.color = "#fff";
    
    // Controlli quantità
    const qtyControls = document.createElement('div');
    qtyControls.style.display = "flex";
    qtyControls.style.alignItems = "center";
    qtyControls.style.gap = "10px";
    
    const minusBtn = document.createElement('button');
    minusBtn.textContent = "−";
    minusBtn.style.width = "35px";
    minusBtn.style.height = "35px";
    minusBtn.style.borderRadius = "50%";
    minusBtn.style.border = "2px solid #fff";
    minusBtn.style.background = "rgba(0,0,0,0.3)";
    minusBtn.style.color = "#fff";
    minusBtn.style.fontSize = "20px";
    minusBtn.style.fontWeight = "700";
    minusBtn.style.cursor = "pointer";
    minusBtn.style.transition = "all 0.2s ease";
    minusBtn.onclick = (e) => {
      e.stopPropagation();
      vibrate(VIBRATION_PATTERNS.tap);
      if(getRefillQuantity(product.name) > 0) {
        refillList[product.name].quantity--;
        if(refillList[product.name].quantity <= 0) {
          delete refillList[product.name];
        }
        saveData();
        renderSpesaList();
      }
    };
    
    const qtyDisplay = document.createElement('div');
    qtyDisplay.textContent = qty;
    qtyDisplay.style.fontSize = "24px";
    qtyDisplay.style.fontWeight = "700";
    qtyDisplay.style.color = "#fff";
    qtyDisplay.style.minWidth = "40px";
    qtyDisplay.style.textAlign = "center";
    qtyDisplay.style.background = "rgba(0,0,0,0.3)";
    qtyDisplay.style.padding = "5px 10px";
    qtyDisplay.style.borderRadius = "8px";
    
    const plusBtn = document.createElement('button');
    plusBtn.textContent = "+";
    plusBtn.style.width = "35px";
    plusBtn.style.height = "35px";
    plusBtn.style.borderRadius = "50%";
    plusBtn.style.border = "2px solid #fff";
    plusBtn.style.background = "rgba(255,255,255,0.2)";
    plusBtn.style.color = "#fff";
    plusBtn.style.fontSize = "20px";
    plusBtn.style.fontWeight = "700";
    plusBtn.style.cursor = "pointer";
    plusBtn.style.transition = "all 0.2s ease";
    plusBtn.onclick = (e) => {
      e.stopPropagation();
      vibrate(VIBRATION_PATTERNS.tap);
      refillList[product.name]++;
      saveData();
      renderSpesaList();
    };
    
    qtyControls.appendChild(minusBtn);
    qtyControls.appendChild(qtyDisplay);
    qtyControls.appendChild(plusBtn);
    
    row.appendChild(nameDiv);
    row.appendChild(qtyControls);
    
    gridContainer.appendChild(row);
  });
  
  orderList.appendChild(gridContainer);
}

/* Popup tavoli personalizzati */
function openCustomTablesPopup(){
  currentTarget = {type:null, id:null};
  
  // Rimuovi overlay precedente se esiste
  const oldOverlay = document.getElementById('custom-tables-overlay');
  if(oldOverlay) oldOverlay.remove();
  
  // Nascondi gli elementi normali del popup
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  popupTitle.textContent = "Tavoli Personalizzati";
  actionsDiv.innerHTML = "";
  
  // Crea un overlay che copre tutto il popup-main
  const overlay = document.createElement('div');
  overlay.id = "custom-tables-overlay";
  overlay.style.position = "absolute";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.right = "0";
  overlay.style.bottom = "0";
  overlay.style.background = "#000";
  overlay.style.zIndex = "10";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.padding = "20px";
  overlay.style.overflowY = "auto";
  
  const popupMain = document.querySelector('.popup-main');
  popupMain.style.position = "relative";
  
  // Bottoni azioni
  const header = document.createElement('div');
  header.style.marginBottom = "20px";
  const buttonsDiv = document.createElement('div');
  buttonsDiv.style.display = "flex";
  buttonsDiv.style.gap = "10px";
  buttonsDiv.style.marginBottom = "15px";
  
  const addTableBtn = document.createElement('button');
  addTableBtn.textContent = "+ Aggiungi Tavolo";
  addTableBtn.style.background = "#00aa00";
  addTableBtn.style.flex = "1";
  addTableBtn.onclick = ()=> {
    const newName = prompt("Nome del nuovo tavolo:");
    if(newName && !tableNames.includes(newName)){
      tableNames.push(newName);
      renderTables();
      saveData();
      openCustomTablesPopup();
    }
  };
  
  const closeTableBtn = document.createElement('button');
  closeTableBtn.textContent = "Chiudi";
  closeTableBtn.style.flex = "1";
  closeTableBtn.onclick = closePopup;
  
  buttonsDiv.appendChild(addTableBtn);
  buttonsDiv.appendChild(closeTableBtn);
  header.appendChild(buttonsDiv);
  
  // Container per i tasti
  const container = document.createElement('div');
  container.style.flex = "1";
  container.style.overflowY = "auto";
  container.style.padding = "10px";
  
  const customTables = tableNames.filter(n => !n.startsWith("TAV-") && !["STE","SALA","SALAF"].includes(n));
  
  if(customTables.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun tavolo personalizzato creato";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    container.appendChild(empty);
  } else {
    // Ordina alfabeticamente
    customTables.sort((a, b) => a.localeCompare(b));
    
    // Crea layout a colonne verticali
    const grid = document.createElement('div');
    grid.style.columnCount = "3";
    grid.style.columnGap = "10px";
    
    customTables.forEach(tableName => {
      const btn = document.createElement('button');
      btn.className = "table-btn";
      btn.textContent = tableName;
      btn.style.width = "100%";
      btn.style.marginBottom = "10px";
      btn.style.breakInside = "avoid";
      btn.style.display = "block";
      
      let pressTimer;
      
      // Click normale = apri tavolo
      btn.onclick = ()=> {
        const idx = tableNames.indexOf(tableName);
        if(idx !== -1){
          closePopup();
          openForTable(idx);
        }
      };
      
      // Pressione lunga = mostra popup elimina
      btn.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => {
          showConfirm(`Vuoi eliminare il tavolo "${tableName}"?`, ()=> {
            const idx = tableNames.indexOf(tableName);
            if(idx !== -1){
              tableNames.splice(idx,1);
              saveData();
              renderTables();
              openCustomTablesPopup();
            }
          }, 'Elimina Tavolo');
        }, 800);
      });
      
      btn.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
      });
      
      btn.addEventListener('touchmove', () => {
        clearTimeout(pressTimer);
      });
      
      // Supporto mouse per desktop
      btn.addEventListener('mousedown', () => {
        pressTimer = setTimeout(() => {
          showConfirm(`Vuoi eliminare il tavolo "${tableName}"?`, ()=> {
            const idx = tableNames.indexOf(tableName);
            if(idx !== -1){
              tableNames.splice(idx,1);
              saveData();
              renderTables();
              openCustomTablesPopup();
            }
          }, 'Elimina Tavolo');
        }, 800);
      });
      
      btn.addEventListener('mouseup', () => {
        clearTimeout(pressTimer);
      });
      
      btn.addEventListener('mouseleave', () => {
        clearTimeout(pressTimer);
      });
      
      grid.appendChild(btn);
    });
    
    container.appendChild(grid);
  }
  
  // Aggiungi tutto all'overlay
  overlay.appendChild(header);
  overlay.appendChild(container);
  
  // Aggiungi l'overlay al popup-main
  popupMain.appendChild(overlay);
  
  // Mostra il popup
  showPopup();
}

/* aperture modale */
function openForTable(tableIndex){
  const tableName = tableNames[tableIndex];
  
  // Cerca se esiste già un ordine salvato con lo stesso nome
  let existingOrder = savedOrders.find(s => s.tableName === tableName);
  
  if(!existingOrder){
    // Crea un nuovo ordine salvato
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    existingOrder = { id, tableName, items: [] };
    savedOrders.push(existingOrder);
    renderSavedButtons();
    saveData();
  }
  
  // Apri l'ordine salvato invece del tavolo
  currentTarget = {type:'saved', id: existingOrder.id};
  popupTitle.textContent = tableName;
  // Layout verticale - elementi sempre visibili
  if(categoriesDiv) categoriesDiv.style.display = 'grid';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'grid';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'grid';
  renderOrderList();
  renderActionsForSaved();
  showPopup();
}
function openForSaved(savedId){
  const saved = savedOrders.find(x=>x.id===savedId);
  if(!saved) return;
  currentTarget = {type:'saved', id: savedId};
  popupTitle.textContent = saved.tableName;
  // Layout verticale - elementi sempre visibili
  if(categoriesDiv) categoriesDiv.style.display = 'grid';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'grid';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'grid';
  renderOrderList();
  renderActionsForSaved();
  showPopup();
}

/* azioni */
function renderActionsForTable(){
  actionsDiv.innerHTML = "";

  const payBtn = document.createElement('button');
  payBtn.textContent = "Pagato";
  payBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.click);
    const items = getEditingItems();
    const total = items.reduce((sum, it) => sum + ((it.price || 0) * (it.qty || 1)), 0);
    showConfirm(`Totale: €${total.toFixed(2)}`, ()=>{
      vibrate(VIBRATION_PATTERNS.success);
      // Salva l'ordine negli evasi prima di pagare
      if(items && items.length > 0){
        evasiOrders.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
          tableName: tableNames[currentTarget.id],
          tableIndex: currentTarget.id,
          items: JSON.parse(JSON.stringify(items)),
          timestamp: new Date().toISOString(),
          dateLabel: new Date().toLocaleString()
        });
      }
      // Non aggiungere ai totali se il tavolo è STE
      const isSTETable = tableNames[currentTarget.id] === 'STE';
      if(!isSTETable){
        items.forEach(it=>{
          const cat = detectCategory(it.name);
          if(cat && totals[cat] !== undefined){
            totals[cat] += (it.price || 0) * (it.qty || 1);
          }
        });
      }
      // Svuota il tavolo dopo il pagamento
      tableOrders[currentTarget.id] = [];
      renderOrderList();
      saveData();
      closePopup();
    });
  };

  const accontoBtn = document.createElement('button');
  accontoBtn.textContent = "Acconto";
  accontoBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.click);
    openAccontoPopup();
  };

  const consegnatoBtn = document.createElement('button');
  consegnatoBtn.textContent = "Done";
  consegnatoBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.success);
    // Marca come consegnato e chiudi popup
    const items = getEditingItems();
    if(!items || items.length === 0) {
      closePopup();
      return;
    }
    
    // Trova l'ordine salvato corrispondente e marcalo come consegnato
    const saved = savedOrders.find(s => s.tableName === tableNames[currentTarget.id]);
    if(saved) {
      saved.consegnato = true;
      saved.timestampDone = Date.now();
      saveData();
      renderTables();
      renderSavedButtons();
    }
    closePopup();
  };

  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    closePopup();
  };

  actionsDiv.appendChild(payBtn);
  actionsDiv.appendChild(accontoBtn);
  actionsDiv.appendChild(consegnatoBtn);
  actionsDiv.appendChild(closeBtn);
}

function renderActionsForSaved(){
  actionsDiv.innerHTML = "";
  const payBtn = document.createElement('button');
  payBtn.textContent = "Pagato";
  payBtn.onclick = ()=> {
    const items = getEditingItems();
    const total = items.reduce((sum, it) => sum + ((it.price || 0) * (it.qty || 1)), 0);
    showConfirm(`Totale: €${total.toFixed(2)}`, ()=>{
      paySavedOrder(currentTarget.id);
    });
  };
  
  const accontoBtn = document.createElement('button');
  accontoBtn.textContent = "Acconto";
  accontoBtn.onclick = ()=> { openAccontoPopup(); };
  
  const consegnatoBtn = document.createElement('button');
  consegnatoBtn.textContent = "Done";
  consegnatoBtn.onclick = ()=> {
    // Marca come consegnato e chiudi popup
    const items = getEditingItems();
    if(!items || items.length === 0) {
      closePopup();
      return;
    }
    
    const saved = savedOrders.find(s => s.id === currentTarget.id);
    if(saved) {
      saved.consegnato = true;
      saved.timestampDone = Date.now();
      saveData();
      renderTables();
      renderSavedButtons();
    }
    closePopup();
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  
  actionsDiv.appendChild(payBtn);
  actionsDiv.appendChild(accontoBtn);
  actionsDiv.appendChild(consegnatoBtn);
  actionsDiv.appendChild(closeBtn);
}

/* Popup Acconto */
function openAccontoPopup(){
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  
  const items = getEditingItems();
  const selectedItems = new Set();
  
  if(!items || items.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun prodotto nell'ordine";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    orderList.appendChild(empty);
  } else {
    const title = document.createElement('div');
    title.textContent = "Seleziona i prodotti da pagare:";
    title.style.fontWeight = "700";
    title.style.marginBottom = "10px";
    title.style.fontSize = "16px";
    orderList.appendChild(title);
    
    items.forEach((it, i)=>{
      const row = document.createElement('div');
      row.style.border = "2px solid #444";
      row.style.borderRadius = "6px";
      row.style.padding = "12px";
      row.style.marginBottom = "8px";
      row.style.cursor = "pointer";
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.transition = "all 0.2s";
      
      const cat = detectCategory(it.name);
      if(cat === 'caffe') row.style.background = '#888';
      else if(cat === 'spina') row.style.background = '#ff8800';
      else if(cat === 'frigo') row.style.background = '#0099ff';
      else if(cat === 'super') row.style.background = '#aaaa00';
      else if(cat === 'snack') row.style.background = '#ff0000';
      else if(cat === 'tempo') row.style.background = '#008800';
      else if(cat === 'quote') row.style.background = '#0000ff';
      else if(cat === 'cassa') row.style.background = '#000';
      
      const nameDiv = document.createElement('div');
      nameDiv.textContent = `${it.qty} × ${it.name}`;
      nameDiv.style.fontSize = "16px";
      
      const priceDiv = document.createElement('div');
      const lineTotal = (it.qty * (it.price||0));
      priceDiv.textContent = `€${lineTotal.toFixed(2)}`;
      priceDiv.style.fontSize = "16px";
      priceDiv.style.fontWeight = "700";
      
      row.appendChild(nameDiv);
      row.appendChild(priceDiv);
      
      row.onclick = ()=> {
        if(selectedItems.has(i)){
          selectedItems.delete(i);
          row.style.border = "2px solid #444";
          row.style.opacity = "1";
        } else {
          selectedItems.add(i);
          row.style.border = "2px solid #00ff00";
          row.style.opacity = "0.8";
        }
      };
      
      orderList.appendChild(row);
    });
  }
  
  actionsDiv.innerHTML = "";
  
  const payBtn = document.createElement('button');
  payBtn.textContent = "Pagato";
  payBtn.style.background = "#00aa00";
  payBtn.onclick = ()=> {
    if(selectedItems.size === 0){
      return;
    }
    
    const selectedIndexes = Array.from(selectedItems).sort((a,b)=>b-a);
    let totalAcconto = 0;
    
    selectedIndexes.forEach(idx => {
      const item = items[idx];
      totalAcconto += (item.price || 0) * (item.qty || 1);
    });
    
    showConfirm(`Totale: €${totalAcconto.toFixed(2)}`, ()=>{
      const paidItems = [];
      selectedIndexes.forEach(idx => {
        const item = items[idx];
        paidItems.push(JSON.parse(JSON.stringify(item)));
        // Non aggiungere ai totali se il tavolo è STE
        let isSTETable = false;
        if(currentTarget.type === 'table' && tableNames[currentTarget.id] === 'STE'){
          isSTETable = true;
        }
        if(currentTarget.type === 'saved'){
          const saved = savedOrders.find(s => s.id === currentTarget.id);
          if(saved && saved.tableName === 'STE'){
            isSTETable = true;
          }
        }
        if(!isSTETable){
          const cat = detectCategory(item.name);
          if(cat && totals[cat] !== undefined){
            totals[cat] += (item.price || 0) * (item.qty || 1);
          }
        }
        
        if(items && items.length > 0){
          evasiOrders.push({
            id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
            tableName: currentTarget.type === 'table' ? tableNames[currentTarget.id] : 'Riepilogo',
            tableIndex: currentTarget.type === 'table' ? currentTarget.id : null,
            items: [JSON.parse(JSON.stringify(item))],
            timestamp: new Date().toISOString(),
            dateLabel: new Date().toLocaleString()
          });
        }
        
        items.splice(idx, 1);
      });
      
      saveData();
      
      if(items.length === 0 && currentTarget.type === 'saved'){
        const idx = savedOrders.findIndex(s=>s.id === currentTarget.id);
        if(idx !== -1) savedOrders.splice(idx,1);
        closePopup();
      } else {
        // Torna al popup dell'ordine
        if(currentTarget.type === 'table'){
          openForTable(currentTarget.id);
        } else if(currentTarget.type === 'saved'){
          openForSaved(currentTarget.id);
        }
      }
    });
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Annulla";
  closeBtn.onclick = ()=> {
    if(currentTarget.type === 'table'){
      openForTable(currentTarget.id);
    } else if(currentTarget.type === 'saved'){
      openForSaved(currentTarget.id);
    }
  };
  
  actionsDiv.appendChild(payBtn);
  actionsDiv.appendChild(closeBtn);
  
  popupTitle.textContent = "Acconto";
  showPopup();
}

/* Popup Aggiungi - per aggiungere prodotti alle liste carrello */
function openAggiungiPopup(targetList, listName, returnFunction){
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  
  // Salva il contesto corrente prima che venga modificato
  const savedTarget = JSON.parse(JSON.stringify(currentTarget));
  const items = getEditingItems();
  const selectedItems = new Set();
  
  if(!items || items.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun prodotto nell'ordine";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    orderList.appendChild(empty);
  } else {
    const title = document.createElement('div');
    title.textContent = `Seleziona i prodotti da aggiungere alla lista ${listName}:`;
    title.style.fontWeight = "700";
    title.style.marginBottom = "10px";
    title.style.fontSize = "16px";
    orderList.appendChild(title);
    
    items.forEach((it, i)=>{
      const row = document.createElement('div');
      row.style.border = "2px solid #444";
      row.style.borderRadius = "6px";
      row.style.padding = "12px";
      row.style.marginBottom = "8px";
      row.style.cursor = "pointer";
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.transition = "all 0.2s";
      
      const cat = detectCategory(it.name);
      if(cat === 'caffe') row.style.background = '#888';
      else if(cat === 'spina') row.style.background = '#ff8800';
      else if(cat === 'frigo') row.style.background = '#0099ff';
      else if(cat === 'super') row.style.background = '#aaaa00';
      else if(cat === 'snack') row.style.background = '#ff0000';
      else if(cat === 'tempo') row.style.background = '#008800';
      else if(cat === 'quote') row.style.background = '#0000ff';
      else if(cat === 'cassa') row.style.background = '#000';
      
      const nameDiv = document.createElement('div');
      nameDiv.textContent = `${it.qty} × ${it.name}`;
      nameDiv.style.fontSize = "16px";
      
      const priceDiv = document.createElement('div');
      const lineTotal = (it.qty * (it.price||0));
      priceDiv.textContent = `€${lineTotal.toFixed(2)}`;
      priceDiv.style.fontSize = "16px";
      priceDiv.style.fontWeight = "700";
      
      row.appendChild(nameDiv);
      row.appendChild(priceDiv);
      
      row.onclick = ()=> {
        if(selectedItems.has(i)){
          selectedItems.delete(i);
          row.style.border = "2px solid #444";
          row.style.opacity = "1";
        } else {
          selectedItems.add(i);
          row.style.border = "2px solid #00ff00";
          row.style.opacity = "0.8";
        }
      };
      
      orderList.appendChild(row);
    });
  }
  
  actionsDiv.innerHTML = "";
  
  const aggiungiBtn = document.createElement('button');
  aggiungiBtn.textContent = "Conferma Aggiunta";
  aggiungiBtn.style.background = "#00aa00";
  aggiungiBtn.onclick = ()=> {
    if(selectedItems.size === 0){
      return;
    }
    
    const selectedIndexes = Array.from(selectedItems).sort((a,b)=>b-a);
    let totalAggiungi = 0;
    
    selectedIndexes.forEach(idx => {
      const item = items[idx];
      totalAggiungi += (item.price || 0) * (item.qty || 1);
    });
    
    showConfirm(`Aggiungere ${selectedItems.size} prodotti alla lista ${listName}?\nTotale: €${totalAggiungi.toFixed(2)}`, ()=>{
      selectedIndexes.forEach(idx => {
        const item = items[idx];
        
        // Crea il formato per la lista carrello: "nome (prezzo)"
        const itemName = `${item.name} (€${(item.price || 0).toFixed(2)})`;
        
        // Aggiungi alla lista appropriata
        targetList.push({
          name: itemName,
          originalItem: JSON.parse(JSON.stringify(item))
        });
        
        // Rimuovi dall'ordine corrente
        items.splice(idx, 1);
      });
      
      saveData();
      
      // Ripristina il target originale
      currentTarget = savedTarget;
      
      if(items.length === 0 && savedTarget.type === 'saved'){
        const idx = savedOrders.findIndex(s=>s.id === savedTarget.id);
        if(idx !== -1) savedOrders.splice(idx,1);
        closePopup();
      } else {
        // Torna al popup dell'ordine o alla lista carrello
        if(returnFunction){
          returnFunction();
        } else if(savedTarget.type === 'table'){
          openForTable(savedTarget.id);
        } else if(savedTarget.type === 'saved'){
          openForSaved(savedTarget.id);
        }
      }
    });
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Annulla";
  closeBtn.onclick = ()=> {
    // Ripristina il target originale e torna alla lista carrello
    currentTarget = savedTarget;
    if(returnFunction){
      returnFunction();
    } else if(savedTarget.type === 'table'){
      openForTable(savedTarget.id);
    } else if(savedTarget.type === 'saved'){
      openForSaved(savedTarget.id);
    }
  };
  
  actionsDiv.appendChild(aggiungiBtn);
  actionsDiv.appendChild(closeBtn);
  
  popupTitle.textContent = `Aggiungi a ${listName}`;
  showPopup();
}

function closePopup(){
  hidePopup(() => {
    subcatsDiv.innerHTML = "";
    tempoPad.classList.add('hidden');
    cassaPad.classList.add('hidden');
    
    // Ripristina lo stile normale di orderList (per refill a schermo intero)
    orderList.style.position = "";
    orderList.style.top = "";
    orderList.style.left = "";
    orderList.style.right = "";
    orderList.style.bottom = "";
    orderList.style.background = "";
    orderList.style.zIndex = "";
    orderList.style.padding = "";
    orderList.style.overflowY = "";
    
    // Rimuovi classe fullscreen e spesa-popup dal popup e popup-content
    popup.classList.remove('fullscreen-popup');
    const popupContent = document.querySelector('.popup-content');
    if(popupContent) {
      popupContent.classList.remove('fullscreen');
      popupContent.classList.remove('spesa-popup');
    }
    
    // Rimuovi l'overlay dei tavoli personalizzati se esiste
    const overlay = document.getElementById('custom-tables-overlay');
    if(overlay) overlay.remove();
    
    // Ripristina il layout normale del popup
    const popupMain = document.querySelector('.popup-main');
    popupMain.style.position = "";
    
    renderTables();
    renderSavedButtons();
    saveData();
  });
}

/* sottocategorie */
function showSubcatsByKey(key){
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  tempoValue = "";
  cassaValue = "";
  if(tempoDisplay) tempoDisplay.value = "";
  if(cassaDisplay) cassaDisplay.value = "0";
  subcatsDiv.innerHTML = "";

  if(key === 'c6'){ // TEMPO
    openTempoPad();
    return;
  }
  
  if(key === 'c8'){ // CASSA
    openCassaPad();
    return;
  }

  const list = CATALOG[key] || [];
  list.forEach(item=>{
    const btn = document.createElement('button');
    btn.className = "subcat-btn";
    if(key==="c1") btn.classList.add('cat-caffe');
    if(key==="c2") btn.classList.add('cat-spina');
    if(key==="c3") btn.classList.add('cat-frigo');
    if(key==="c4") btn.classList.add('cat-super');
    if(key==="c5") btn.classList.add('cat-snack');
    if(key==="c7") btn.classList.add('cat-quote');
    if(key==="c8") btn.classList.add('cat-cassa');
    btn.textContent = item.name;
    btn.onclick = ()=> addCatalogProduct(item.name, item.price);
    subcatsDiv.appendChild(btn);
  });

  Array.from(subcatsDiv.children).forEach(ch=>{
    const prodName = ch.textContent;
    if(subcategories[prodName]){
      ch.onclick = ()=> showOptionsAndAdd(prodName, subcategories[prodName], key);
    }
  });
  // subcatsDiv è sempre visibile nel nuovo layout
}

function showOptionsAndAdd(base, options, parentKey){
  subcatsDiv.innerHTML = "";
  options.forEach(opt=>{
    const btn = document.createElement('button');
    btn.className = "subcat-btn";
    if(parentKey === 'c1') btn.classList.add('cat-caffe');
    if(parentKey === 'c2') btn.classList.add('cat-spina');
    if(parentKey === 'c3') btn.classList.add('cat-frigo');
    if(parentKey === 'c4') btn.classList.add('cat-super');
    if(parentKey === 'c5') btn.classList.add('cat-snack');
    btn.textContent = opt.name;
    btn.onclick = ()=> addCatalogProduct(`${base} ${opt.name}`, opt.price);
    subcatsDiv.appendChild(btn);
  });
  const back = document.createElement('button');
  back.textContent = '← Indietro';
  back.className = 'back-btn';
  back.onclick = ()=> showSubcatsByKey(parentKey);
  subcatsDiv.appendChild(back);
  // subcatsDiv è sempre visibile nel nuovo layout
}

/* editing target */
function getEditingItems(){
  if(currentTarget.type === 'table'){
    return tableOrders[currentTarget.id] || (tableOrders[currentTarget.id] = []);
  } else if(currentTarget.type === 'saved'){
    const s = savedOrders.find(x=>x.id===currentTarget.id);
    if(!s) return [];
    if(!s.items) s.items = [];
    return s.items;
  }
  return [];
}

/* aggiungi prodotto */
function addCatalogProduct(name, price){
  vibrate(VIBRATION_PATTERNS.click);
  const items = getEditingItems();
  const newItem = {name, qty:1, price: typeof price === 'number' ? price : 0, timestamp: Date.now()};
  items.push(newItem);
  
  // Se è un ordine salvato, marca come non consegnato quando aggiungi prodotti
  if(currentTarget.type === 'saved'){
    const saved = savedOrders.find(s => s.id === currentTarget.id);
    if(saved) {
      saved.consegnato = false;
    }
  }
  
  // Aggiorna refill list quando aggiungi un prodotto delle categorie Refill (c1..c5)
  if(isRefillProductName(name)){
    if(!refillList[name]) refillList[name] = {quantity: 0, value: 0};
    refillList[name].quantity += 1;
  }
  
  // Incrementa contatore REFILL per tutti i prodotti aggiunti
  incrementRefillCounter(name);
  
  renderOrderList();
  saveData();
  renderSavedButtons();
}

/* modificatori */
modifiersDiv.addEventListener('click', e=>{
  if(!e.target.matches('button')) return;
  vibrate(VIBRATION_PATTERNS.tap);
  const mod = e.target.dataset && e.target.dataset.mod || e.target.textContent;
  const items = getEditingItems();
  if(!items || items.length===0) return;
  items[items.length-1].name += ` ${mod}`;
  renderOrderList();
  saveData();
});

/* delete order item */
function deleteOrderItem(item) {
  vibrate(VIBRATION_PATTERNS.warning);
  
  // Ottieni gli elementi correnti
  const items = getEditingItems();
  if(!items) return;
  
  // Trova l'indice dell'elemento da cancellare
  const itemIndex = items.findIndex(it => 
    it.name === item.name && 
    it.qty === item.qty && 
    it.price === item.price && 
    it.timestamp === item.timestamp
  );
  
  if(itemIndex === -1) return; // Elemento non trovato
  
  // Gestione refill
  let productName = item.name;
  modifiersList.forEach(mod => {
    productName = productName.replace(new RegExp('\\s+' + mod + '$'), '');
  });
  
  // Decrementa contatori refill
  for(let q = 0; q < (item.qty || 1); q++) {
    decrementRefillCounter(item.name);
  }
  
  // Rimozione elemento
  if(accontoMode){
    accontoMode = false;
    let isSTETable = false;
    if(currentTarget.type === 'table' && tableNames[currentTarget.id] === 'STE'){
      isSTETable = true;
    }
    if(currentTarget.type === 'saved'){
      const saved = savedOrders.find(s => s.id === currentTarget.id);
      if(saved && saved.tableName === 'STE'){
        isSTETable = true;
      }
    }
    if(!isSTETable){
      const cat = detectCategory(item.name);
      if(cat && totals[cat] !== undefined){
        totals[cat] += (item.price || 0) * (item.qty || 1);
      }
    }
    items.splice(itemIndex,1);
    if(items.length === 0 && currentTarget.type === 'saved'){
      const idx = savedOrders.findIndex(s=>s.id === currentTarget.id);
      if(idx !== -1) savedOrders.splice(idx,1);
      closePopup();
    } else {
      renderOrderList();
    }
    saveData();
  } else {
    items.splice(itemIndex,1);
    renderOrderList();
    saveData();
  }
}

/* render ordine */
function renderOrderList(){
  orderList.innerHTML = "";
  const items = getEditingItems();
  let total = 0;
  // Trova il timestamp dell'ultimo Done
  let timestampDone = null;
  if(currentTarget.type === 'saved'){
    const saved = savedOrders.find(s => s.id === currentTarget.id);
    if(saved) timestampDone = saved.timestampDone;
  }
  
  // Calcola il totale prima
  (items || []).forEach((it)=>{
    const lineTotal = (it.qty * (it.price||0));
    total += lineTotal;
  });
  
  // Mostra il totale in alto
  if(items && items.length>0){
    const totDiv = document.createElement('div');
    totDiv.className = "order-row";
    totDiv.style.fontWeight = '700';
    totDiv.style.fontSize = '18px';
    totDiv.style.borderBottom = '3px solid #fff';
    const nameCell = document.createElement('div');
    nameCell.className = "order-name";
    nameCell.textContent = 'Totale Ordine';
    const priceCell = document.createElement('div');
    priceCell.className = "order-price";
    // Se il tavolo è STE, il totale mostrato è sempre 0
    let displayTotal = total;
    if(currentTarget.type === 'table' && tableNames[currentTarget.id] === 'STE'){
      displayTotal = 0;
    }
    if(currentTarget.type === 'saved'){
      const saved = savedOrders.find(s => s.id === currentTarget.id);
      if(saved && saved.tableName === 'STE'){
        displayTotal = 0;
      }
    }
    priceCell.textContent = `€${displayTotal.toFixed(2)}`;
    totDiv.appendChild(nameCell);
    totDiv.appendChild(priceCell);
    orderList.appendChild(totDiv);
  }
  
  // Mostra gli ordini in ordine inverso (dal più recente al più vecchio)
  const reversedItems = [...(items || [])].reverse();
  let separatorAdded = false;
  
  reversedItems.forEach((it, reversedIndex)=>{
    const i = items.length - 1 - reversedIndex; // Indice originale
    
    // Aggiungi separatore "CONSEGNATO" quando passiamo agli ordini vecchi
    if(timestampDone && it.timestamp && it.timestamp <= timestampDone && !separatorAdded){
      const separator = document.createElement('div');
      separator.style.textAlign = 'center';
      separator.style.padding = '15px 0';
      separator.style.fontWeight = '700';
      separator.style.fontSize = '16px';
      separator.style.color = '#00ff00';
      separator.style.borderTop = '2px solid #00ff00';
      separator.style.borderBottom = '2px solid #00ff00';
      separator.style.margin = '10px 0';
      separator.style.background = 'rgba(0,255,0,0.1)';
      separator.textContent = '✓ CONSEGNATO';
      orderList.appendChild(separator);
      separatorAdded = true;
    }
    
    const row = document.createElement('div');
    row.className = "order-row";
    
    // Colora la riga in base alla categoria
    const cat = detectCategory(it.name);
    if(cat === 'caffe') row.style.background = '#888';
    else if(cat === 'spina') row.style.background = '#ff8800';
    else if(cat === 'frigo') row.style.background = '#0099ff';
    else if(cat === 'super') row.style.background = '#aaaa00';
    else if(cat === 'snack') row.style.background = '#ff0000';
    else if(cat === 'tempo') row.style.background = '#008800';
    else if(cat === 'quote') row.style.background = '#0000ff';
    else if(cat === 'cassa') row.style.background = '#000';

    const nameCell = document.createElement('div');
    nameCell.className = "order-name";
    nameCell.textContent = `${it.qty} × ${it.name}`;

    const priceCell = document.createElement('div');
    priceCell.className = "order-price";
    const lineTotal = (it.qty * (it.price||0));
    priceCell.textContent = `€${lineTotal.toFixed(2)}`;

    row.appendChild(nameCell);
    row.appendChild(priceCell);

    // Gestione eventi per tutti gli elementi
    let pressTimer;
    let longPressTriggered = false;
    let touchHandled = false;
    let lastTapTime = 0;
    let tapCount = 0;
    
    // Touch events per tutti gli elementi
    row.ontouchstart = (e)=> {
      touchHandled = false;
      longPressTriggered = false;
      
      if(it.name === "TEMPO"){
        pressTimer = setTimeout(()=> {
          longPressTriggered = true;
          touchHandled = true;
          openDivideTempoPopup(i, it);
        }, 800);
      }
    };
    
    row.ontouchend = (e)=> {
      if(it.name === "TEMPO"){
        clearTimeout(pressTimer);
      }
      
      // Se non è stato un long press, gestisci il doppio tap
      if(!longPressTriggered && !touchHandled){
        const currentTime = Date.now();
        const timeDiff = currentTime - lastTapTime;
        
        if(timeDiff < 300 && tapCount === 1) {
          // Doppio tap rilevato - cancella l'elemento
          touchHandled = true;
          e.preventDefault();
          tapCount = 0;
          setTimeout(() => {
            deleteOrderItem(it);
          }, 10);
        } else {
          // Primo tap
          tapCount = 1;
          lastTapTime = currentTime;
          // Reset dopo 300ms se non arriva il secondo tap
          setTimeout(() => {
            tapCount = 0;
          }, 300);
        }
      }
    };
    
    row.ontouchcancel = (e)=> {
      if(it.name === "TEMPO"){
        clearTimeout(pressTimer);
      }
      touchHandled = false;
      longPressTriggered = false;
      tapCount = 0;
    };
    
    row.ontouchmove = (e)=> {
      if(it.name === "TEMPO"){
        clearTimeout(pressTimer);
      }
    };
    
    // Click event come fallback per mouse (doppio click)
    row.ondblclick = (e)=> {
      // Se il touch è già stato gestito, ignora il click
      if(touchHandled){
        touchHandled = false;
        return;
      }
      deleteOrderItem(it);
    };
    
    // Rimuovi il click singolo
    row.onclick = (e)=> {
      // Previeni il comportamento di default del click singolo
      e.preventDefault();
    };

    orderList.appendChild(row);
  });
}

/* Dividi TEMPO */
function openDivideTempoPopup(itemIndex, item){
  const items = getEditingItems();
  
  showConfirm(
    `Dividi €${item.price.toFixed(2)} in quante parti?`,
    null,
    'Dividi TEMPO',
    true,
    (parts) => {
      if(parts && parts > 1){
        const totalCents = Math.round((item.price || 0) * 100);
        const baseCents = Math.floor(totalCents / parts);
        const remainder = totalCents - baseCents * parts;

        items.splice(itemIndex, 1);
        for(let i = 0; i < parts; i++){
          const cents = baseCents + (i < remainder ? 1 : 0);
          items.push({
            name: "TEMPO",
            qty: 1,
            price: cents / 100,
            timestamp: Date.now()
          });
        }
        renderOrderList();
        saveData();
      }
    }
  );
}

/* create saved */
function createSavedFromTable(){
  if(currentTarget.type !== 'table') return;
  const items = getEditingItems();
  if(!items || items.length===0){
    return;
  }
  
  const tableName = tableNames[currentTarget.id];
  
  // Cerca se esiste già un ordine salvato con lo stesso nome
  const existingOrder = savedOrders.find(s => s.tableName === tableName);
  
  if(existingOrder){
    // Aggiungi i prodotti all'ordine esistente
    existingOrder.items.push(...JSON.parse(JSON.stringify(items)));
  } else {
    // Crea un nuovo ordine salvato
    const id = Date.now().toString(36);
    savedOrders.push({ id, tableName, items: JSON.parse(JSON.stringify(items)) });
  }
  
  tableOrders[currentTarget.id] = [];
  renderOrderList();
  renderSavedButtons();
  closePopup();
  saveData();
}

/* tempo pad */
function openTempoPad(){
  tempoValue = "";
  if(tempoDisplay) tempoDisplay.value = "";
  subcatsDiv.innerHTML = "";
  tempoPad.classList.remove('hidden');
}
document.getElementById('tempo-numpad').addEventListener('click', e=>{
  if(!e.target.matches('button')) return;
  const k = e.target.dataset.key;
  if(!k) return;
  if(k === '.'){
    if(tempoValue.includes('.')) return;
    if(tempoValue === "") tempoValue = "0.";
    else tempoValue += '.';
  } else {
    if(tempoValue.length >= 9) return;
    tempoValue += k;
  }
  tempoDisplay.value = tempoValue || "0";
});
document.getElementById('tempo-ok').addEventListener('click', ()=>{
  const v = parseFloat(tempoValue);
  if(isNaN(v) || v <= 0){ return; }
  addCatalogProduct("TEMPO", v);
  tempoValue = "";
  tempoDisplay.value = "";
  tempoPad.classList.add('hidden');
});

/* cassa pad */
function openCassaPad(){
  cassaValue = "";
  if(cassaDisplay) cassaDisplay.value = "0";
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.remove('hidden');
}
document.getElementById('cassa-numpad').addEventListener('click', e=>{
  if(!e.target.matches('button')) return;
  const k = e.target.dataset.key;
  if(!k) return;
  if(k === 'C'){
    cassaValue = "";
    cassaDisplay.value = "0";
    return;
  }
  if(k === '.'){
    if(cassaValue.includes('.')) return;
    if(cassaValue === "") cassaValue = "0.";
    else cassaValue += '.';
  } else {
    if(cassaValue.length >= 9) return;
    cassaValue += k;
  }
  cassaDisplay.value = cassaValue || "0";
});
document.getElementById('cassa-entrata').addEventListener('click', ()=>{
  const v = parseFloat(cassaValue);
  if(isNaN(v) || v <= 0){ return; }
  addCatalogProduct("ENTRATA CASSA", v);
  cassaValue = "";
  cassaDisplay.value = "0";
  cassaPad.classList.add('hidden');
});
document.getElementById('cassa-uscita').addEventListener('click', ()=>{
  const v = parseFloat(cassaValue);
  if(isNaN(v) || v <= 0){ return; }
  addCatalogProduct("USCITA CASSA", -v);
  cassaValue = "";
  cassaDisplay.value = "0";
  cassaPad.classList.add('hidden');
});

/* pagamento riepilogo */
function paySavedOrder(savedId){
  const idx = savedOrders.findIndex(s=>s.id === savedId);
  if(idx === -1) return;
  const saved = savedOrders[idx];
  // Salva negli evasi
  if(saved.items && saved.items.length > 0){
    evasiOrders.push({
      id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
      tableName: saved.tableName,
      tableIndex: null,
      items: JSON.parse(JSON.stringify(saved.items)),
      timestamp: new Date().toISOString(),
      dateLabel: new Date().toLocaleString()
    });
  }
  // Non aggiungere ai totali se l'ordine salvato è per STE
  const isSTEOrder = saved.tableName === 'STE';
  if(!isSTEOrder){
    saved.items.forEach(it=>{
      const cat = detectCategory(it.name);
      if(cat && totals[cat] !== undefined){
        totals[cat] += (it.price || 0) * (it.qty || 1);
      }
    });
  }
  savedOrders.splice(idx,1);
  renderSavedButtons();
  closePopup();
  saveData();
}

/* Totali popup */
function openTotals(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'none';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  Object.keys(totals).forEach(k=>{
    const row = document.createElement('div');
    row.className = "order-row";
    const nameCell = document.createElement('div');
    nameCell.className = "order-name";
    nameCell.textContent = k.toUpperCase();
    const priceCell = document.createElement('div');
    priceCell.className = "order-price";
    priceCell.textContent = `€${totals[k].toFixed(2)}`;
    row.appendChild(nameCell);
    row.appendChild(priceCell);
    orderList.appendChild(row);
  });

  const total = Object.values(totals).reduce((a,b)=>a+b,0).toFixed(2);
  const totRow = document.createElement('div');
  totRow.className = "order-row";
  totRow.style.fontWeight = '700';
  const nameCell = document.createElement('div');
  nameCell.className = "order-name";
  nameCell.textContent = "TOTALE COMPLESSIVO";
  const priceCell = document.createElement('div');
  priceCell.className = "order-price";
  priceCell.textContent = `€${total}`;
  totRow.appendChild(nameCell);
  totRow.appendChild(priceCell);
  orderList.appendChild(totRow);

  actionsDiv.innerHTML = "";
  const reset = document.createElement('button');
  reset.textContent = "Reset Totali";
  reset.onclick = ()=> {
    showConfirm('Confermi il reset dei totali?', ()=>{
      exportTotalsToCSV();
      // salva nello storico con timestamp ISO e label leggibile
      storico.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        dateISO: new Date().toISOString(),
        dateLabel: new Date().toLocaleString(),
        totali: {...totals},
        totale: parseFloat(total)
      });
      Object.keys(totals).forEach(k=>totals[k]=0);
      saveData();
      openTotals();
    }, 'Reset Totali');
  };
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(reset);
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Totali";
  showPopup();
}

/* Evasi */
function openEvasi(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'none';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  if(!evasiOrders || evasiOrders.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessun ordine evaso";
    empty.style.textAlign = "center";
    empty.style.padding = "20px";
    orderList.appendChild(empty);
  } else {
    // mostra dal più recente
    evasiOrders.slice().reverse().forEach(entry=>{
      const box = document.createElement('div');
      box.style.border = "1px solid #444";
      box.style.borderRadius = "6px";
      box.style.padding = "12px";
      box.style.marginBottom = "8px";

      const titolo = document.createElement('div');
      titolo.style.fontWeight = "700";
      titolo.style.marginBottom = "8px";
      const totalOrder = entry.items.reduce((sum, it) => sum + ((it.price || 0) * (it.qty || 1)), 0);
      titolo.textContent = `${entry.tableName} — ${entry.dateLabel} — €${totalOrder.toFixed(2)}`;
      box.appendChild(titolo);

      const itemsList = document.createElement('div');
      itemsList.style.fontSize = "14px";
      itemsList.style.marginBottom = "8px";
      entry.items.forEach(it=>{
        const itemDiv = document.createElement('div');
        itemDiv.textContent = `${it.qty} × ${it.name} — €${((it.price||0) * (it.qty||1)).toFixed(2)}`;
        itemsList.appendChild(itemDiv);
      });
      box.appendChild(itemsList);

      const actionsBox = document.createElement('div');
      actionsBox.style.display = "flex";
      actionsBox.style.gap = "8px";
      actionsBox.style.marginTop = "8px";

      const restoreBtn = document.createElement('button');
      restoreBtn.textContent = "Ripristina";
      restoreBtn.style.background = "#00aa00";
      restoreBtn.onclick = ()=> {
        showConfirm('Confermi il ripristino di questo ordine?', ()=>{
          // Ripristina l'ordine
          if(entry.tableIndex !== null && entry.tableIndex !== undefined){
            // Ripristina su tavolo
            if(!tableOrders[entry.tableIndex]) tableOrders[entry.tableIndex] = [];
            tableOrders[entry.tableIndex].push(...JSON.parse(JSON.stringify(entry.items)));
          } else {
            // Ripristina come ordine salvato
            const newId = Date.now().toString(36);
            savedOrders.push({
              id: newId,
              tableName: entry.tableName,
              items: JSON.parse(JSON.stringify(entry.items))
            });
          }
          // Rimuovi dai totali
          entry.items.forEach(it=>{
            const cat = detectCategory(it.name);
            if(cat && totals[cat] !== undefined){
              totals[cat] -= (it.price || 0) * (it.qty || 1);
              if(totals[cat] < 0) totals[cat] = 0;
            }
          });
          // Rimuovi dagli evasi
          const idx = evasiOrders.findIndex(e=>e.id === entry.id);
          if(idx !== -1) evasiOrders.splice(idx,1);
          saveData();
          renderTables();
          renderSavedButtons();
          closePopup();
        }, 'Ripristina Ordine');
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = "Elimina";
      delBtn.style.background = "#aa0000";
      delBtn.onclick = ()=> {
        showConfirm('Confermi l\'eliminazione di questo ordine?', ()=>{
          const idx = evasiOrders.findIndex(e=>e.id === entry.id);
          if(idx !== -1) evasiOrders.splice(idx,1);
          saveData();
          openEvasi();
        }, 'Elimina Ordine');
      };

      actionsBox.appendChild(restoreBtn);
      actionsBox.appendChild(delBtn);
      box.appendChild(actionsBox);

      orderList.appendChild(box);
    });
  }

  actionsDiv.innerHTML = "";
  
  const resetBtn = document.createElement('button');
  resetBtn.textContent = "Reset Evasi";
  resetBtn.style.background = "#aa0000";
  resetBtn.onclick = ()=> {
    if(evasiOrders.length === 0){
      return;
    }
    showConfirm('Confermi il reset degli ordini evasi?', ()=>{
      console.log('Reset Evasi - Prima del reset:', evasiOrders.length, 'elementi');
      exportEvasiToCSV();
      evasiOrders = [];
      console.log('Reset Evasi - Dopo il reset:', evasiOrders.length, 'elementi');
      saveData();
      openEvasi();
    }, 'Reset Evasi');
  };
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  
  actionsDiv.appendChild(resetBtn);
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Ordini Evasi";
  showPopup();
}

function exportEvasiToCSV(){
  try {
    let csv = "Data;Tavolo;Categoria;Prodotto;Quantità;Prezzo Unitario;Totale\n";
    
    evasiOrders.forEach(order => {
      const dateStr = order.dateLabel || order.timestamp || "";
      order.items.forEach(item => {
        const qty = item.qty || 1;
        const price = item.price || 0;
        const total = qty * price;
        const cat = (detectCategory(item.name) || "").toUpperCase();
        csv += `"${dateStr}";"${order.tableName}";"${cat}";"${item.name}";${qty};${price.toFixed(2).replace('.', ',')};${total.toFixed(2).replace('.', ',')}\n`;
      });
    });
    
    // Calcola totale complessivo
    const totalComplessivo = evasiOrders.reduce((sum, order) => {
      return sum + order.items.reduce((orderSum, item) => {
        return orderSum + ((item.price || 0) * (item.qty || 1));
      }, 0);
    }, 0);
    
    csv += `\n"TOTALE COMPLESSIVO";"";"";"";"";"";
${totalComplessivo.toFixed(2).replace('.', ',')}\n`;
    
    // Prova invio a Kodular / AppInventor
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      AppInventor.setWebViewString("SAVE_EVASI_CSV::" + csv);
      setTimeout(() => {
        AppInventor.setWebViewString("SAVE_EVASI_CSV_DONE");
      }, 100);
      return;
    }
    
    // Scarica il file CSV
    downloadCSV(csv, 'evasi');
    
  } catch(e) {
    console.error("Errore exportEvasiToCSV:", e);
  }
}

/* Apply Background */
function applyBackground(){
  document.body.style.background = `#000 url("${currentBackground}") no-repeat center center fixed`;
  document.body.style.backgroundSize = 'cover';
  const popupContents = document.querySelectorAll('.popup-content, .confirm-box');
  popupContents.forEach(el => {
    el.style.background = `#000 url("${currentBackground}") no-repeat center center`;
    el.style.backgroundSize = 'cover';
  });
}

/* Settings */
function openSettings(){
  currentTarget = {type:null, id:null};
  
  // Setup popup standard come SPESA e REFILL
  const popupContent = document.querySelector('.popup-content');
  popupContent.classList.add('spesa-popup');
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  
  popupTitle.textContent = "IMPOSTAZIONI";
  orderList.innerHTML = "";

  // Menu opzioni
  const menuOptions = [
    {name: "🎨 Cambia Sfondo", action: openBackgroundSettings},
    {name: "⚙️ Personalizza Tasti", action: openCustomizeFontSettings},
    {name: "📁 Gestisci Categorie", action: openCategorySettings},
    {name: "📂 Gestisci Sottocategorie", action: openSubcategorySettings},
    {name: "🏷️ Gestisci Modificatori", action: openModifierSettings},
    {name: "🔄 Forza Sync Liste (Debug)", action: () => {
      vibrate(VIBRATION_PATTERNS.tap);
      forceSyncShoppingLists();
      showAlert('Sincronizzazione liste forzata!');
    }},
    {name: "🔍 Debug Liste Correnti", action: () => {
      vibrate(VIBRATION_PATTERNS.tap);
      const debugInfo = `
LISTE CORRENTI:
Amazon: ${amazonList.length} elementi
Poggiana: ${poggianaList.length} elementi  
Prix: ${prixList.length} elementi
Battocchio: ${battocchioList.length} elementi

Firebase: ${firebaseEnabled ? 'Abilitato' : 'Disabilitato'}
      `.trim();
      showAlert(debugInfo);
      console.log('🔍 DEBUG LISTE:', {amazonList, poggianaList, prixList, battocchioList});
    }}
  ];

  menuOptions.forEach(option => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "20px";
    box.style.marginBottom = "15px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.transition = "all 0.2s";
    box.style.textAlign = "center";
    box.style.fontSize = "20px";
    box.style.fontWeight = "700";
    box.textContent = option.name;
    
    box.onclick = option.action;
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  // Bottoni azioni
  actionsDiv.innerHTML = "";
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = ()=> { vibrate(VIBRATION_PATTERNS.tap); closePopup(); };
  actionsDiv.appendChild(closeBtn);

  showPopup();
}

/* Background Settings */
function openBackgroundSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli lo sfondo:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const backgrounds = [
    {name: "1", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000148-9eb959eb97/HD-wallpaper-black-abstract-android-background-geometric.webp?ph=03d98711d4"},
    {name: "2", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000178-38e6a38e6c/3.jpeg?ph=03d98711d4"},
    {name: "3", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000179-4670746709/2.jpeg?ph=03d98711d4"},
    {name: "4", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000182-5d7cd5d7cf/1.jpeg?ph=03d98711d4"},
    {name: "5", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000181-5763f57641/4.jpeg?ph=03d98711d4"},
    {name: "6", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000187-0e93e0e941/6.jpeg?ph=03d98711d4"},
    {name: "7", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000217-4a8a34a8a5/7.jpeg?ph=03d98711d4"},
    {name: "8", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000216-3922339225/8.jpeg?ph=03d98711d4"},
    {name: "9", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000218-5f7365f737/9.jpeg?ph=03d98711d4"},
    {name: "10", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000215-3c49c3c49d/10.jpeg?ph=03d98711d4"},
    {name: "11", url: "https://03d98711d4.clvaw-cdnwnd.com/778f66d17c7b835c7de2aa9e94f2492e/200000224-a2003a2005/14?ph=03d98711d4"},
    {name: "12", url: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExOWp1dXFvc2dlb2d4cjc2N3NxdjN6emwwOHN1aXJ0MzA3Nmhmc3B6NiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/YTEQrKe1bBPcDdKKtA/giphy.gif"},
    {name: "13", url: "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWU0OWxtbXBwdXExYm1heDlta3pkdndiNW9wMm54amcxNHA3ajdiZiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/12qHWnTUBzLWXS/giphy.gif"},
    {name: "14", url: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWFtZGViOHp3aWNwdGE5cWc5ZzdmNjhvenY4ZXVyeXF2OXYzM3JtbSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/TnDoEoXfT7YoE/giphy.gif"},
    {name: "15", url: "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdmhxdHMxdW02NWZ0MG9hajRxNzVmMWI2c24wbG9manM3bzlrenBrbiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/XAe9aDBIv3arS/giphy.gif"},
    {name: "16", url: "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExZHNrYXA4ZmcwbjUzbTBoaXJrZGs0Nmo2MHVvamQ5ZWwxNnl4dHdseiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/q2DwjOrFktA3r3cd5D/giphy.gif"},
    {name: "17", url: "https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExdTdkY2l2Mjl0Ym1ndTlpZmtkZTNsaGtqc2pkNHp2dDF4OHgzcHlxeSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/nIufcLJ4tPe5Zosc6t/giphy.gif"},
    {name: "18", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExbmttb2VrZmNvdDVqN3EwNjlpb2oxdDAyMXpib3I2b3N2cHRkaGZ4bCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/jTAmP5GWEZpQ8ZZyF1/giphy.gif"},
    {name: "19", url: "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExaGpwdGVjbzc5eHYweDd4ZDBnODRlMTVtdDczajVmcjZzYmdheTN0YiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l5JbspfwZ0yjHjlJ0K/giphy.gif"},
    {name: "20", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExN25yZ3d4bXJ6NGV3bmozYnF0N3pkZWRtZ3E4enl2dGp3djM3bmhoMCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/jaOXKCxtBPLieRLI0c/giphy.gif"},
    {name: "21", url: "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExMnA3Z2UwNHBxMDJ1cTJ4eWw0YjBwYTEwNHJlaGR6YjA4ZHo5cDdrZiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/ui1VQlTo0FvHrdwJD7/giphy.gif"},
    {name: "22", url: "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZmsza2lqNXB1b2t0dHJyN2RrZXpwNWVpNzdlbjdrajlxeWRjNHk0ciZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/uFmH8za4E6M5STIiTu/giphy.gif"},
    {name: "23", url: "https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExZWlvcTBkYndmbWUzMXIxOHU4YXJnZmlrcjV2cHBpOHlwanZmaHAyeiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/MqlVfYDenvazq5MgeK/giphy.gif"},
    {name: "24", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExN2tqeDZpNngwY3hhM29ncno0NHJ0Z3U4am5xM2dtNjhobm1zcWdqdCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/EyiufcIwTdF35pNIFS/giphy.gif"},
    {name: "25", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExeXJ5bno3ZHg1eWppcmE5c3kyZDZuNWRraG42enFkMGJwb3Z1cXd6NyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/qyUJmARdRq7HlQgT5Z/giphy.gif"},
    {name: "26", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExbnRmdGgydGN5cHFsZzVqNXN5MHR4bzA4Yjd2ZjR2eGU1M2pndTkxaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Svoz9fOVe8lOYfwTYG/giphy.gif"},
    {name: "27", url: "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExaW1nbnB6eWcyNWc5Y2VncG5zdXB4NjN5b3Y0Mm11Nnczbzh0bGJreSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/XEgWz1vwDjzlLVCx04/giphy.gif"}
  ];

  backgrounds.forEach(bg => {
    const box = document.createElement('div');
    box.style.border = currentBackground === bg.url ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.transition = "all 0.2s";
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = bg.name;
    nameDiv.style.fontSize = "16px";
    nameDiv.style.fontWeight = "700";
    box.appendChild(nameDiv);
    
    box.onclick = ()=> {
      currentBackground = bg.url;
      applyBackground();
      saveData();
      openSettings();
    };
    
    box.onmouseenter = ()=> {
      if(currentBackground !== bg.url) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(currentBackground !== bg.url) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "← Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Sfondi";
  showPopup();
}

/* Font Settings */
function openFontSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli il font:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const fonts = [
    {name: "Arial", value: "Arial, Helvetica, sans-serif"},
    {name: "Times New Roman", value: "Times New Roman, Times, serif"},
    {name: "Courier New", value: "Courier New, Courier, monospace"},
    {name: "Georgia", value: "Georgia, serif"},
    {name: "Verdana", value: "Verdana, Geneva, sans-serif"},
    {name: "Comic Sans MS", value: "Comic Sans MS, cursive"},
    {name: "Impact", value: "Impact, Charcoal, sans-serif"},
    {name: "Trebuchet MS", value: "Trebuchet MS, sans-serif"},
    {name: "Palatino", value: "Palatino Linotype, Book Antiqua, Palatino, serif"},
    {name: "Lucida Console", value: "Lucida Console, Monaco, monospace"},
    {name: "Mountains of Christmas", value: "'Mountains of Christmas', cursive"},
    {name: "Dokdo", value: "'Dokdo', cursive"},
    {name: "Rubik Vinyl", value: "'Rubik Vinyl', cursive"},
    {name: "Irish Grover", value: "'Irish Grover', cursive"},
    {name: "Rampart One", value: "'Rampart One', cursive"},
    {name: "Cherry Cream Soda", value: "'Cherry Cream Soda', cursive"},
    {name: "Permanent Marker", value: "'Permanent Marker', cursive"},
    {name: "Swanky and Moo Moo", value: "'Swanky and Moo Moo', cursive"},
    {name: "Caveat Brush", value: "'Caveat Brush', cursive"},
    {name: "Bangers", value: "'Bangers', cursive"},
    {name: "Knewave", value: "'Knewave', cursive"},
    {name: "DynaPuff", value: "'DynaPuff', cursive"},
    {name: "Indie Flower", value: "'Indie Flower', cursive"}
  ];

  fonts.forEach(font => {
    const box = document.createElement('div');
    box.style.border = currentFont === font.value ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontFamily = font.value;
    box.style.fontSize = "18px";
    box.style.fontWeight = "700";
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = font.name;
    box.appendChild(nameDiv);
    
    box.onclick = ()=> {
      currentFont = font.value;
      applyFont();
      saveData();
      openFontSettings();
    };
    
    box.onmouseenter = ()=> {
      if(currentFont !== font.value) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(currentFont !== font.value) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Cambia Font";
  showPopup();
}

function applyFont(){
  document.body.style.fontFamily = currentFont;
  document.body.style.fontSize = currentFontSize + 'px';
  
  // Calcola il fattore di scala rispetto alla dimensione base (16px)
  const scaleFactor = currentFontSize / 16;
  
  // Applica la scala a tutti gli elementi
  const style = document.createElement('style');
  style.id = 'dynamic-font-size';
  
  // Rimuovi lo style precedente se esiste
  const oldStyle = document.getElementById('dynamic-font-size');
  if(oldStyle) oldStyle.remove();
  
  style.textContent = `
    /* Applica font globale */
    body, input, select, textarea, div {
      font-family: ${currentFont} !important;
    }
    
    /* Bottoni utility (TOTALI, STORICO, EVASI, SETTINGS, REFILL, SPESA) */
    button.utility-btn,
    .utility-btn {
      font-family: ${fontSettings.utility.font} !important;
      font-size: ${fontSettings.utility.size}px !important;
      padding: ${fontSettings.utility.padding}px !important;
    }
    
    /* Bottoni tavoli (TAV-1, TAV-2, STE, SALA, SALAF, +) */
    button.table-btn,
    .table-btn {
      font-family: ${fontSettings.tavoli.font} !important;
      font-size: ${fontSettings.tavoli.size}px !important;
      padding: ${fontSettings.tavoli.padding}px !important;
    }
    
    /* Bottoni ordini salvati */
    #saved-orders button {
      font-family: ${fontSettings.ordiniSalvati.font} !important;
      font-size: ${fontSettings.ordiniSalvati.size}px !important;
      padding: ${fontSettings.ordiniSalvati.padding}px !important;
    }
    
    /* Categorie */
    .cat-btn {
      font-family: ${fontSettings.categorie.font} !important;
      font-size: ${fontSettings.categorie.size}px !important;
      padding: ${fontSettings.categorie.padding}px !important;
    }
    
    /* Sottocategorie */
    .subcat-btn {
      font-family: ${fontSettings.sottocategorie.font} !important;
      font-size: ${fontSettings.sottocategorie.size}px !important;
      padding: ${fontSettings.sottocategorie.padding}px !important;
    }
    
    /* Modificatori */
    .modifiers button {
      font-family: ${fontSettings.modificatori.font} !important;
      font-size: ${fontSettings.modificatori.size}px !important;
      padding: ${fontSettings.modificatori.padding}px !important;
    }
    
    /* Bottoni azioni (Pagato, Acconto, ecc.) */
    .actions button {
      font-family: ${fontSettings.azioni.font} !important;
      font-size: ${fontSettings.azioni.size}px !important;
      padding: ${fontSettings.azioni.padding}px !important;
    }
    
    /* Ordini nella lista */
    .order-row, .order-name, .order-price {
      font-family: ${fontSettings.ordini.font} !important;
      font-size: ${fontSettings.ordini.size}px !important;
    }
    
    /* Popup conferma */
    .confirm-box, .confirm-box h3, .confirm-box p, .confirm-buttons button {
      font-family: ${fontSettings.conferma.font} !important;
    }
    .confirm-box h3 {
      font-size: ${fontSettings.conferma.size + 4}px !important;
    }
    .confirm-box p {
      font-size: ${fontSettings.conferma.size}px !important;
    }
    .confirm-buttons button {
      font-size: ${fontSettings.conferma.size}px !important;
    }
    
    /* Titoli popup */
    .popup-header h3 {
      font-size: ${20 * scaleFactor}px !important;
    }
    
    /* Numpad */
    .numpad button {
      font-size: ${18 * scaleFactor}px !important;
      padding: ${14 * scaleFactor}px !important;
    }
    
    /* Bottoni generici */
    button {
      font-size: ${16 * scaleFactor}px !important;
      padding: ${12 * scaleFactor}px !important;
    }
    
    /* Column titles */
    .column-title {
      font-size: ${18 * scaleFactor}px !important;
    }

    /* Colori per categoria (testo) */
    /* Bottoni utility (TOTALI, STORICO, EVASI, SETTINGS, REFILL, SPESA) */
    button.utility-btn,
    .utility-btn { 
      color: ${fontSettings.utility?.color || '#ffffff'} !important; 
    }
    /* Bottoni tavoli (TAV-1, TAV-2, ecc., STE, SALA, SALAF, +) */
    button.table-btn,
    .table-btn { 
      color: ${fontSettings.tavoli?.color || '#ffffff'} !important; 
    }
    /* Bottoni ordini salvati */
    #saved-orders button { 
      color: ${fontSettings.ordiniSalvati?.color || '#ffffff'} !important; 
    }
    /* Bottoni categorie nel popup */
    button.cat-btn,
    .cat-btn,
    .categories-grid button { 
      color: ${fontSettings.categorie?.color || '#ffffff'} !important; 
    }
    /* Bottoni sottocategorie */
    button.subcat-btn,
    .subcat-btn { 
      color: ${fontSettings.sottocategorie?.color || '#ffffff'} !important; 
    }
    /* Modificatori */
    #modifiers button,
    .modifiers button { 
      color: ${fontSettings.modificatori?.color || '#ffffff'} !important; 
    }
    /* Azioni dell'ordine */
    #actions button,
    .actions button { 
      color: ${fontSettings.azioni?.color || '#ffffff'} !important; 
    }
    /* Lista ordini */
    #order-list,
    #order-list .order-row,
    #order-list .order-name,
    #order-list .order-price { 
      color: ${fontSettings.ordini?.color || '#ffffff'} !important; 
    }
    /* Popup conferma */
    .confirm-box,
    .confirm-box h3,
    .confirm-box p,
    #confirm-popup .confirm-buttons button { 
      color: ${fontSettings.conferma?.color || '#ffffff'} !important; 
    }
  `;
  
  document.head.appendChild(style);
}

/* Font Size Settings */
function openFontSizeSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli la dimensione del testo:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const currentSizeDisplay = document.createElement('div');
  currentSizeDisplay.textContent = `Dimensione attuale: ${currentFontSize}px`;
  currentSizeDisplay.style.fontSize = "16px";
  currentSizeDisplay.style.marginBottom = "20px";
  currentSizeDisplay.style.textAlign = "center";
  currentSizeDisplay.style.padding = "10px";
  currentSizeDisplay.style.background = "#222";
  currentSizeDisplay.style.borderRadius = "8px";
  orderList.appendChild(currentSizeDisplay);

  const sizes = [
    {name: "Molto Piccolo", value: 12},
    {name: "Piccolo", value: 14},
    {name: "Normale", value: 16},
    {name: "Grande", value: 18},
    {name: "Molto Grande", value: 20},
    {name: "Extra Grande", value: 24}
  ];

  sizes.forEach(size => {
    const box = document.createElement('div');
    box.style.border = currentFontSize === size.value ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = size.value + "px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    
    box.textContent = `${size.name} (${size.value}px)`;
    
    box.onclick = ()=> {
      currentFontSize = size.value;
      applyFont();
      saveData();
      openFontSizeSettings();
    };
    
    box.onmouseenter = ()=> {
      if(currentFontSize !== size.value) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(currentFontSize !== size.value) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Dimensione Testo";
  showPopup();
}

/* Customize Font Settings */
function openCustomizeFontSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "🎨 Personalizza Tasti per Categoria";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "20px";
  title.style.textAlign = "center";
  orderList.appendChild(title);

  // Sezione controlli globali
  const globalSection = document.createElement('div');
  globalSection.className = 'customize-section customize-global';
  globalSection.style.marginBottom = "20px";
  globalSection.style.padding = "15px";
  globalSection.style.background = "#1a1a1a";
  globalSection.style.borderRadius = "10px";
  globalSection.style.border = "3px solid #ff6600";
  
  const globalHeader = document.createElement('div');
  globalHeader.className = 'customize-header customize-header-global';
  globalHeader.textContent = "🌟 APPLICA A TUTTI I TIPI DI TASTI";
  globalHeader.style.fontWeight = "700";
  globalHeader.style.fontSize = "18px";
  globalHeader.style.marginBottom = "8px";
  globalHeader.style.color = "#ff6600";
  globalHeader.style.textAlign = "center";
  globalSection.appendChild(globalHeader);
  
  const globalDesc = document.createElement('div');
  globalDesc.className = 'customize-desc customize-desc-global';
  globalDesc.textContent = "Cambia font, dimensione, padding e colore per tutte le categorie contemporaneamente";
  globalDesc.style.fontSize = "13px";
  globalDesc.style.color = "#ccc";
  globalDesc.style.marginBottom = "12px";
  globalDesc.style.textAlign = "center";
  globalSection.appendChild(globalDesc);
  
  const globalButtonsDiv = document.createElement('div');
  globalButtonsDiv.className = 'customize-buttons customize-buttons-global';
  globalButtonsDiv.style.display = "grid";
  globalButtonsDiv.style.gridTemplateColumns = "repeat(4, 1fr)";
  globalButtonsDiv.style.gap = "8px";
  
  // Font globale
  const globalFontBtn = document.createElement('button');
  globalFontBtn.className = 'customize-btn customize-font-btn customize-font-global';
  globalFontBtn.textContent = "Font Tutti";
  globalFontBtn.style.padding = "12px 6px";
  globalFontBtn.style.fontSize = "14px";
  globalFontBtn.style.background = "#ff6600";
  globalFontBtn.style.color = "#fff";
  globalFontBtn.style.fontWeight = "700";
  globalFontBtn.onclick = ()=> openSelectFontForAll();
  
  // Dimensione globale
  const globalSizeBtn = document.createElement('button');
  globalSizeBtn.className = 'customize-btn customize-size-btn customize-size-global';
  globalSizeBtn.textContent = "Size Tutti";
  globalSizeBtn.style.padding = "12px 6px";
  globalSizeBtn.style.fontSize = "14px";
  globalSizeBtn.style.background = "#ff6600";
  globalSizeBtn.style.color = "#fff";
  globalSizeBtn.style.fontWeight = "700";
  globalSizeBtn.onclick = ()=> openSelectSizeForAll();
  
  // Padding globale
  const globalPaddingBtn = document.createElement('button');
  globalPaddingBtn.className = 'customize-btn customize-padding-btn customize-padding-global';
  globalPaddingBtn.textContent = "Pad Tutti";
  globalPaddingBtn.style.padding = "12px 6px";
  globalPaddingBtn.style.fontSize = "14px";
  globalPaddingBtn.style.background = "#ff6600";
  globalPaddingBtn.style.color = "#fff";
  globalPaddingBtn.style.fontWeight = "700";
  globalPaddingBtn.onclick = ()=> openSelectPaddingForAll();
  
  // Colore globale
  const globalColorBtn = document.createElement('button');
  globalColorBtn.className = 'customize-btn customize-color-btn customize-color-global';
  globalColorBtn.textContent = "Color Tutti";
  globalColorBtn.style.padding = "12px 6px";
  globalColorBtn.style.fontSize = "14px";
  globalColorBtn.style.background = "#ff6600";
  globalColorBtn.style.color = "#fff";
  globalColorBtn.style.fontWeight = "700";
  globalColorBtn.onclick = ()=> openSelectColorForAll();
  
  globalButtonsDiv.appendChild(globalFontBtn);
  globalButtonsDiv.appendChild(globalSizeBtn);
  globalButtonsDiv.appendChild(globalPaddingBtn);
  globalButtonsDiv.appendChild(globalColorBtn);
  globalSection.appendChild(globalButtonsDiv);
  
  orderList.appendChild(globalSection);

  // Separatore
  const separator = document.createElement('div');
  separator.style.height = "2px";
  separator.style.background = "linear-gradient(90deg, transparent, #444, transparent)";
  separator.style.margin = "15px 0";
  orderList.appendChild(separator);

  const categories = [
    {key: "utility", label: "🔧 Bottoni Utility", desc: "TOTALI, STORICO, EVASI, SETTINGS"},
    {key: "tavoli", label: "🎯 Bottoni Tavoli", desc: "TAV-1, TAV-2, STE, SALA, SALAF"},
    {key: "ordiniSalvati", label: "💾 Ordini Salvati", desc: "Bottoni in alto a sinistra"},
    {key: "categorie", label: "📋 Categorie", desc: "CAFFÈ, SPINA, FRIGO, SUPER, SNACK"},
    {key: "sottocategorie", label: "📝 Sottocategorie", desc: "GRAPPA, SAMBUCA, APEROL, ecc."},
    {key: "modificatori", label: "🏷️ Modificatori", desc: "SR, M, K, S, GH"},
    {key: "azioni", label: "⚡ Azioni", desc: "PAGATO, ACCONTO, DONE, CHIUDI"},
    {key: "ordini", label: "📄 Lista Ordini", desc: "Prodotti e prezzi nell'ordine"},
    {key: "conferma", label: "✅ Popup Conferma", desc: "Dialoghi di conferma"}
  ];

  categories.forEach(cat => {
    const section = document.createElement('div');
    section.className = `customize-section customize-${cat.key}`;
    section.style.marginBottom = "12px";
    section.style.padding = "12px";
    section.style.background = "#222";
    section.style.borderRadius = "8px";
    section.style.border = "2px solid #444";
    
    const header = document.createElement('div');
    header.className = `customize-header customize-header-${cat.key}`;
    header.textContent = cat.label;
    header.style.fontWeight = "700";
    header.style.fontSize = "16px";
    header.style.marginBottom = "5px";
    section.appendChild(header);
    
    const desc = document.createElement('div');
    desc.className = `customize-desc customize-desc-${cat.key}`;
    desc.textContent = cat.desc;
    desc.style.fontSize = "12px";
    desc.style.color = "#aaa";
    desc.style.marginBottom = "10px";
    section.appendChild(desc);
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = `customize-buttons customize-buttons-${cat.key}`;
    buttonsDiv.style.display = "grid";
    buttonsDiv.style.gridTemplateColumns = "repeat(4, 1fr)";
    buttonsDiv.style.gap = "6px";
    
    // Font
    const fontBtn = document.createElement('button');
    fontBtn.className = `customize-btn customize-font-btn customize-font-${cat.key}`;
    fontBtn.textContent = "Font";
    fontBtn.style.padding = "8px 4px";
    fontBtn.style.fontSize = "12px";
    fontBtn.onclick = ()=> openSelectFont(cat.key, cat.label);
    
    // Dimensione  
    const sizeBtn = document.createElement('button');
    sizeBtn.className = `customize-btn customize-size-btn customize-size-${cat.key}`;
    sizeBtn.textContent = "Size";
    sizeBtn.style.padding = "8px 4px";
    sizeBtn.style.fontSize = "12px";
    sizeBtn.onclick = ()=> openSelectSize(cat.key, cat.label);
    
    // Padding
    const paddingBtn = document.createElement('button');
    paddingBtn.className = `customize-btn customize-padding-btn customize-padding-${cat.key}`;
    paddingBtn.textContent = "Pad";
    paddingBtn.style.padding = "8px 4px";
    paddingBtn.style.fontSize = "12px";
    paddingBtn.onclick = ()=> openSelectPadding(cat.key, cat.label);
    
    // Colore
    const colorBtn = document.createElement('button');
    colorBtn.className = `customize-btn customize-color-btn customize-color-${cat.key}`;
    colorBtn.textContent = "Color";
    colorBtn.style.padding = "8px 4px";
    colorBtn.style.fontSize = "12px";
    colorBtn.onclick = ()=> openSelectColor(cat.key, cat.label);
    
    buttonsDiv.appendChild(fontBtn);
    buttonsDiv.appendChild(sizeBtn);
    buttonsDiv.appendChild(paddingBtn);
    buttonsDiv.appendChild(colorBtn);
    section.appendChild(buttonsDiv);
    
    orderList.appendChild(section);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.className = "customize-back-btn";
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Personalizza Tasti";
  showPopup();
}

function openSelectFont(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli il font per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const fonts = [
    {name: "Arial", value: "Arial, Helvetica, sans-serif"},
    {name: "Times New Roman", value: "Times New Roman, Times, serif"},
    {name: "Courier New", value: "Courier New, Courier, monospace"},
    {name: "Georgia", value: "Georgia, serif"},
    {name: "Verdana", value: "Verdana, Geneva, sans-serif"},
    {name: "Comic Sans MS", value: "Comic Sans MS, cursive"},
    {name: "Impact", value: "Impact, Charcoal, sans-serif"},
    {name: "Trebuchet MS", value: "Trebuchet MS, sans-serif"},
    {name: "Palatino", value: "Palatino Linotype, Book Antiqua, Palatino, serif"},
    {name: "Lucida Console", value: "Lucida Console, Monaco, monospace"},
    {name: "Mountains of Christmas", value: "'Mountains of Christmas', cursive"},
    {name: "Dokdo", value: "'Dokdo', cursive"},
    {name: "Rubik Vinyl", value: "'Rubik Vinyl', cursive"},
    {name: "Irish Grover", value: "'Irish Grover', cursive"},
    {name: "Rampart One", value: "'Rampart One', cursive"},
    {name: "Cherry Cream Soda", value: "'Cherry Cream Soda', cursive"},
    {name: "Permanent Marker", value: "'Permanent Marker', cursive"},
    {name: "Swanky and Moo Moo", value: "'Swanky and Moo Moo', cursive"},
    {name: "Caveat Brush", value: "'Caveat Brush', cursive"},
    {name: "Bangers", value: "'Bangers', cursive"},
    {name: "Knewave", value: "'Knewave', cursive"},
    {name: "DynaPuff", value: "'DynaPuff', cursive"},
    {name: "Indie Flower", value: "'Indie Flower', cursive"}
  ];

  fonts.forEach(font => {
    const box = document.createElement('div');
    box.style.border = fontSettings[category].font === font.value ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontFamily = font.value;
    box.style.fontSize = "18px";
    box.style.fontWeight = "700";
    box.textContent = font.name;
    
    box.onclick = ()=> {
      fontSettings[category].font = font.value;
      applyFont();
      saveData();
      openSelectFont(category, label);
    };
    
    box.onmouseenter = ()=> {
      if(fontSettings[category].font !== font.value) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(fontSettings[category].font !== font.value) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Seleziona Font";
  showPopup();
}

function openSelectSize(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli la dimensione per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const sizes = [10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 36, 40];

  sizes.forEach(size => {
    const box = document.createElement('div');
    box.style.border = fontSettings[category].size === size ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = size + "px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${size}px`;
    
    box.onclick = ()=> {
      fontSettings[category].size = size;
      applyFont();
      saveData();
      openSelectSize(category, label);
    };
    
    box.onmouseenter = ()=> {
      if(fontSettings[category].size !== size) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(fontSettings[category].size !== size) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Seleziona Dimensione";
  showPopup();
}

function openSelectPadding(category, label){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = `Scegli il padding per: ${label}`;
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);
  
  const infoDiv = document.createElement('div');
  infoDiv.textContent = "Il padding è lo spazio interno tra il bordo del bottone e il testo";
  infoDiv.style.fontSize = "14px";
  infoDiv.style.marginBottom = "20px";
  infoDiv.style.textAlign = "center";
  infoDiv.style.padding = "10px";
  infoDiv.style.background = "#222";
  infoDiv.style.borderRadius = "8px";
  infoDiv.style.color = "#aaa";
  orderList.appendChild(infoDiv);

  const paddings = [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30];

  paddings.forEach(padding => {
    const box = document.createElement('div');
    box.style.border = fontSettings[category].padding === padding ? "3px solid #00ff00" : "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = padding + "px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = "16px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${padding}px`;
    
    box.onclick = ()=> {
      fontSettings[category].padding = padding;
      applyFont();
      saveData();
      openSelectPadding(category, label);
    };
    
    box.onmouseenter = ()=> {
      if(fontSettings[category].padding !== padding) box.style.border = "2px solid #888";
    };
    box.onmouseleave = ()=> {
      if(fontSettings[category].padding !== padding) box.style.border = "2px solid #444";
    };
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Seleziona Padding";
  showPopup();
}

/* Funzioni per modificare TUTTE le categorie insieme */
function openSelectFontForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli il font per TUTTE le categorie:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const fonts = [
    {name: "Arial", value: "Arial, Helvetica, sans-serif"},
    {name: "Times New Roman", value: "Times New Roman, Times, serif"},
    {name: "Courier New", value: "Courier New, Courier, monospace"},
    {name: "Georgia", value: "Georgia, serif"},
    {name: "Verdana", value: "Verdana, Geneva, sans-serif"},
    {name: "Comic Sans MS", value: "Comic Sans MS, cursive"},
    {name: "Impact", value: "Impact, Charcoal, sans-serif"},
    {name: "Trebuchet MS", value: "Trebuchet MS, sans-serif"},
    {name: "Palatino", value: "Palatino Linotype, Book Antiqua, Palatino, serif"},
    {name: "Lucida Console", value: "Lucida Console, Monaco, monospace"},
    {name: "Mountains of Christmas", value: "'Mountains of Christmas', cursive"},
    {name: "Dokdo", value: "'Dokdo', cursive"},
    {name: "Rubik Vinyl", value: "'Rubik Vinyl', cursive"},
    {name: "Irish Grover", value: "'Irish Grover', cursive"},
    {name: "Rampart One", value: "'Rampart One', cursive"},
    {name: "Cherry Cream Soda", value: "'Cherry Cream Soda', cursive"},
    {name: "Permanent Marker", value: "'Permanent Marker', cursive"},
    {name: "Swanky and Moo Moo", value: "'Swanky and Moo Moo', cursive"},
    {name: "Caveat Brush", value: "'Caveat Brush', cursive"},
    {name: "Bangers", value: "'Bangers', cursive"},
    {name: "Knewave", value: "'Knewave', cursive"},
    {name: "DynaPuff", value: "'DynaPuff', cursive"},
    {name: "Indie Flower", value: "'Indie Flower', cursive"}
  ];

  fonts.forEach(font => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontFamily = font.value;
    box.style.fontSize = "18px";
    box.style.fontWeight = "700";
    
    const nameDiv = document.createElement('div');
    nameDiv.textContent = font.name;
    box.appendChild(nameDiv);
    
    box.onclick = ()=> {
      // Applica a tutte le categorie
      Object.keys(fontSettings).forEach(key => {
        fontSettings[key].font = font.value;
      });
      applyFont();
      saveData();
      openSelectFontForAll();
    };
    
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Font per Tutti";
  showPopup();
}

function openSelectSizeForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli la dimensione per TUTTE le categorie:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const sizes = [10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 36, 40];

  sizes.forEach(size => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "15px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = size + "px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${size}px`;
    
    box.onclick = ()=> {
      // Applica a tutte le categorie
      Object.keys(fontSettings).forEach(key => {
        fontSettings[key].size = size;
      });
      applyFont();
      saveData();
      openSelectSizeForAll();
    };
    
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Dimensione per Tutti";
  showPopup();
}

function openSelectPaddingForAll(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Scegli il padding per TUTTE le categorie:";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);
  
  const infoDiv = document.createElement('div');
  infoDiv.textContent = "Il padding è lo spazio interno tra il bordo del bottone e il testo";
  infoDiv.style.fontSize = "14px";
  infoDiv.style.marginBottom = "20px";
  infoDiv.style.textAlign = "center";
  infoDiv.style.padding = "10px";
  infoDiv.style.background = "#222";
  infoDiv.style.borderRadius = "8px";
  infoDiv.style.color = "#aaa";
  orderList.appendChild(infoDiv);

  const paddings = [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30];

  paddings.forEach(padding => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = padding + "px";
    box.style.marginBottom = "10px";
    box.style.cursor = "pointer";
    box.style.background = "#222";
    box.style.fontSize = "16px";
    box.style.fontWeight = "700";
    box.style.textAlign = "center";
    box.textContent = `${padding}px`;
    
    box.onclick = ()=> {
      // Applica a tutte le categorie
      Object.keys(fontSettings).forEach(key => {
        fontSettings[key].padding = padding;
      });
      applyFont();
      saveData();
      openSelectPaddingForAll();
    };
    
    box.onmouseenter = ()=> box.style.border = "2px solid #888";
    box.onmouseleave = ()=> box.style.border = "2px solid #444";
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  const backBtn = document.createElement('button');
  backBtn.textContent = "Indietro";
  backBtn.onclick = ()=> {
    vibrate(VIBRATION_PATTERNS.tap);
    openCustomizeFontSettings();
  };
  actionsDiv.appendChild(backBtn);

  popupTitle.textContent = "Padding per Tutti";
  showPopup();
}

/* Category Settings */
function openCategorySettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Gestisci Categorie e Prodotti";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const catKeys = Object.keys(CATALOG);
  const catNames = {c1:"CAFFE", c2:"SPINA", c3:"FRIGO", c4:"SUPER", c5:"SNACK", c6:"TEMPO", c7:"QUOTE"};

  catKeys.forEach(key => {
    if(key === 'c6') return;
    
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "12px";
    box.style.marginBottom = "10px";
    box.style.background = "#222";
    
    const header = document.createElement('div');
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.marginBottom = "10px";
    
    const catName = document.createElement('div');
    catName.textContent = catNames[key] || key;
    catName.style.fontSize = "16px";
    catName.style.fontWeight = "700";
    
    const addBtn = document.createElement('button');
    addBtn.textContent = "+ Aggiungi";
    addBtn.style.padding = "8px 12px";
    addBtn.style.fontSize = "14px";
    addBtn.onclick = ()=> addProductToCategory(key);
    
    header.appendChild(catName);
    header.appendChild(addBtn);
    box.appendChild(header);
    
    const products = CATALOG[key] || [];
    products.forEach((prod, idx) => {
      const prodRow = document.createElement('div');
      prodRow.style.display = "flex";
      prodRow.style.justifyContent = "space-between";
      prodRow.style.alignItems = "center";
      prodRow.style.padding = "8px";
      prodRow.style.borderTop = "1px solid #444";
      
      const prodInfo = document.createElement('div');
      prodInfo.textContent = `${prod.name} - €${prod.price.toFixed(2)}`;
      prodInfo.style.fontSize = "14px";
      
      const actions = document.createElement('div');
      actions.style.display = "flex";
      actions.style.gap = "8px";
      
      const editBtn = document.createElement('button');
      editBtn.textContent = "Modifica";
      editBtn.style.padding = "6px 10px";
      editBtn.style.fontSize = "12px";
      editBtn.onclick = ()=> editProduct(key, idx);
      
      const delBtn = document.createElement('button');
      delBtn.textContent = "Elimina";
      delBtn.style.padding = "6px 10px";
      delBtn.style.fontSize = "12px";
      delBtn.style.background = "#aa0000";
      delBtn.onclick = ()=> deleteProduct(key, idx);
      
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      prodRow.appendChild(prodInfo);
      prodRow.appendChild(actions);
      box.appendChild(prodRow);
    });
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const backBtn2 = document.createElement('button');
  backBtn2.textContent = "← Indietro";
  backBtn2.onclick = openSettings;
  actionsDiv.appendChild(backBtn2);
  
  const closeBtn2 = document.createElement('button');
  closeBtn2.textContent = "Chiudi";
  closeBtn2.onclick = closePopup;
  actionsDiv.appendChild(closeBtn2);

  popupTitle.textContent = "Categorie";
  showPopup();
}

function addProductToCategory(catKey){
  const name = prompt("Nome prodotto:");
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 2.50):");
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  if(!CATALOG[catKey]) CATALOG[catKey] = [];
  CATALOG[catKey].push({name, price});
  saveData();
  openCategorySettings();
}

function editProduct(catKey, idx){
  const prod = CATALOG[catKey][idx];
  const name = prompt("Nome prodotto:", prod.name);
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 2.50):", prod.price);
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  CATALOG[catKey][idx] = {name, price};
  saveData();
  openCategorySettings();
}

function deleteProduct(catKey, idx){
  if(confirm(`Eliminare "${CATALOG[catKey][idx].name}"?`)){
    CATALOG[catKey].splice(idx, 1);
    saveData();
    openCategorySettings();
  }
}

/* Subcategory Settings */
function openSubcategorySettings(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  subcatsDiv.innerHTML = "";
  tempoPad.classList.add('hidden');
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Gestisci Sottocategorie";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const subtitle = document.createElement('div');
  subtitle.textContent = "Le sottocategorie sono prodotti che hanno opzioni aggiuntive";
  subtitle.style.fontSize = "14px";
  subtitle.style.marginBottom = "15px";
  subtitle.style.color = "#aaa";
  orderList.appendChild(subtitle);

  Object.keys(subcategories).forEach(subKey => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "12px";
    box.style.marginBottom = "10px";
    box.style.background = "#222";
    
    const header = document.createElement('div');
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.marginBottom = "10px";
    
    const subName = document.createElement('div');
    subName.textContent = subKey;
    subName.style.fontSize = "16px";
    subName.style.fontWeight = "700";
    
    const headerActions = document.createElement('div');
    headerActions.style.display = "flex";
    headerActions.style.gap = "8px";
    
    const addOptBtn = document.createElement('button');
    addOptBtn.textContent = "+ Opzione";
    addOptBtn.style.padding = "6px 10px";
    addOptBtn.style.fontSize = "12px";
    addOptBtn.style.background = "#00aa00";
    addOptBtn.onclick = ()=> addSubcategoryOption(subKey);
    
    const delSubBtn = document.createElement('button');
    delSubBtn.textContent = "Elimina";
    delSubBtn.style.padding = "6px 10px";
    delSubBtn.style.fontSize = "12px";
    delSubBtn.style.background = "#aa0000";
    delSubBtn.onclick = ()=> deleteSubcategory(subKey);
    
    headerActions.appendChild(addOptBtn);
    headerActions.appendChild(delSubBtn);
    header.appendChild(subName);
    header.appendChild(headerActions);
    box.appendChild(header);
    
    const options = subcategories[subKey] || [];
    options.forEach((opt, idx) => {
      const optRow = document.createElement('div');
      optRow.style.display = "flex";
      optRow.style.justifyContent = "space-between";
      optRow.style.alignItems = "center";
      optRow.style.padding = "8px";
      optRow.style.borderTop = "1px solid #444";
      
      const optInfo = document.createElement('div');
      optInfo.textContent = `${opt.name} - €${opt.price.toFixed(2)}`;
      optInfo.style.fontSize = "14px";
      
      const actions = document.createElement('div');
      actions.style.display = "flex";
      actions.style.gap = "8px";
      
      const editBtn = document.createElement('button');
      editBtn.textContent = "Modifica";
      editBtn.style.padding = "6px 10px";
      editBtn.style.fontSize = "12px";
      editBtn.onclick = ()=> editSubcategoryOption(subKey, idx);
      
      const delBtn = document.createElement('button');
      delBtn.textContent = "Elimina";
      delBtn.style.padding = "6px 10px";
      delBtn.style.fontSize = "12px";
      delBtn.style.background = "#aa0000";
      delBtn.onclick = ()=> deleteSubcategoryOption(subKey, idx);
      
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      optRow.appendChild(optInfo);
      optRow.appendChild(actions);
      box.appendChild(optRow);
    });
    
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const addSubBtn = document.createElement('button');
  addSubBtn.textContent = "+ Nuova Sottocategoria";
  addSubBtn.style.background = "#00aa00";
  addSubBtn.onclick = addNewSubcategory;
  actionsDiv.appendChild(addSubBtn);
  
  const backBtn = document.createElement('button');
  backBtn.textContent = "← Indietro";
  backBtn.onclick = openSettings;
  actionsDiv.appendChild(backBtn);
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Sottocategorie";
  showPopup();
}

function addNewSubcategory(){
  const name = prompt("Nome della sottocategoria (es: CAFFÈ CORRETTO):");
  if(!name) return;
  if(subcategories[name]){
    alert("Questa sottocategoria esiste già!");
    return;
  }
  subcategories[name] = [];
  saveData();
  openSubcategorySettings();
}

function deleteSubcategory(subKey){
  if(confirm(`Eliminare la sottocategoria "${subKey}" e tutte le sue opzioni?`)){
    delete subcategories[subKey];
    saveData();
    openSubcategorySettings();
  }
}

function addSubcategoryOption(subKey){
  const name = prompt("Nome opzione:");
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 3.00):");
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  subcategories[subKey].push({name, price});
  saveData();
  openSubcategorySettings();
}

function editSubcategoryOption(subKey, idx){
  const opt = subcategories[subKey][idx];
  const name = prompt("Nome opzione:", opt.name);
  if(!name) return;
  const priceStr = prompt("Prezzo (es: 3.00):", opt.price);
  if(!priceStr) return;
  const price = parseFloat(priceStr);
  if(isNaN(price)) return;
  
  subcategories[subKey][idx] = {name, price};
  saveData();
  openSubcategorySettings();
}

function deleteSubcategoryOption(subKey, idx){
  if(confirm(`Eliminare l'opzione "${subcategories[subKey][idx].name}"?`)){
    subcategories[subKey].splice(idx, 1);
    saveData();
    openSubcategorySettings();
  }
}

/* Render Modifiers */
function renderModifiers(){
  modifiersDiv.innerHTML = "";
  modifiersList.forEach(mod => {
    const btn = document.createElement('button');
    btn.setAttribute('data-mod', mod);
    btn.textContent = mod;
    modifiersDiv.appendChild(btn);
  });
}

/* Modifier Settings */
function openModifierSettings(){
  orderList.innerHTML = "";
  
  const title = document.createElement('div');
  title.textContent = "Gestisci Modificatori";
  title.style.fontWeight = "700";
  title.style.fontSize = "18px";
  title.style.marginBottom = "15px";
  orderList.appendChild(title);

  const subtitle = document.createElement('div');
  subtitle.textContent = "I modificatori vengono aggiunti al nome del prodotto";
  subtitle.style.fontSize = "14px";
  subtitle.style.marginBottom = "15px";
  subtitle.style.color = "#aaa";
  orderList.appendChild(subtitle);

  modifiersList.forEach((mod, idx) => {
    const box = document.createElement('div');
    box.style.border = "2px solid #444";
    box.style.borderRadius = "8px";
    box.style.padding = "12px";
    box.style.marginBottom = "10px";
    box.style.background = "#222";
    box.style.display = "flex";
    box.style.justifyContent = "space-between";
    box.style.alignItems = "center";
    
    const modName = document.createElement('div');
    modName.textContent = mod;
    modName.style.fontSize = "16px";
    modName.style.fontWeight = "700";
    
    const actions = document.createElement('div');
    actions.style.display = "flex";
    actions.style.gap = "8px";
    
    const editBtn = document.createElement('button');
    editBtn.textContent = "Modifica";
    editBtn.style.padding = "8px 12px";
    editBtn.style.fontSize = "14px";
    editBtn.onclick = ()=> editModifier(idx);
    
    const delBtn = document.createElement('button');
    delBtn.textContent = "Elimina";
    delBtn.style.padding = "8px 12px";
    delBtn.style.fontSize = "14px";
    delBtn.style.background = "#aa0000";
    delBtn.onclick = ()=> deleteModifier(idx);
    
    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    box.appendChild(modName);
    box.appendChild(actions);
    orderList.appendChild(box);
  });

  actionsDiv.innerHTML = "";
  
  const addBtn = document.createElement('button');
  addBtn.textContent = "+ Aggiungi Modificatore";
  addBtn.style.background = "#00aa00";
  addBtn.onclick = addModifier;
  actionsDiv.appendChild(addBtn);
  
  const backBtn3 = document.createElement('button');
  backBtn3.textContent = "← Indietro";
  backBtn3.onclick = openSettings;
  actionsDiv.appendChild(backBtn3);
  
  const closeBtn3 = document.createElement('button');
  closeBtn3.textContent = "Chiudi";
  closeBtn3.onclick = closePopup;
  actionsDiv.appendChild(closeBtn3);

  popupTitle.textContent = "Modificatori";
  showPopup();
}

function addModifier(){
  const name = prompt("Nome modificatore (es: SR, M, K):");
  if(!name) return;
  modifiersList.push(name.toUpperCase());
  renderModifiers();
  saveData();
  openModifierSettings();
}

function editModifier(idx){
  const current = modifiersList[idx];
  const name = prompt("Nome modificatore:", current);
  if(!name) return;
  modifiersList[idx] = name.toUpperCase();
  renderModifiers();
  saveData();
  openModifierSettings();
}

function deleteModifier(idx){
  if(confirm(`Eliminare il modificatore "${modifiersList[idx]}"?`)){
    modifiersList.splice(idx, 1);
    renderModifiers();
    saveData();
    openModifierSettings();
  }
}

/* Storico */
function openStorico(){
  currentTarget = {type:null, id:null};
  // Layout verticale - non serve nascondere colonna
  if(categoriesDiv) categoriesDiv.style.display = 'none';
  subcatsDiv.innerHTML = "";
  subcatsDiv.style.display = 'none';
  tempoPad.classList.add('hidden');
  cassaPad.classList.add('hidden');
  modifiersDiv.style.display = 'none';
  orderList.innerHTML = "";

  // Assicura che storico sia un array valido
  if(!storico || !Array.isArray(storico)) {
    storico = [];
  }

  console.log('Apertura storico - elementi presenti:', storico.length);

  if(storico.length === 0){
    const empty = document.createElement('div');
    empty.textContent = "Nessuno storico disponibile";
    orderList.appendChild(empty);
  } else {
    // mostra dal più recente
    storico.slice().reverse().forEach((entry, index)=>{
      console.log(`Creazione elemento storico ${index}:`, entry.id, entry.dateLabel);
      
      const box = document.createElement('div');
      box.style.border = "1px solid #444";
      box.style.borderRadius = "6px";
      box.style.padding = "6px";
      box.style.marginBottom = "8px";

      const titolo = document.createElement('div');
      titolo.style.fontWeight = "700";
      titolo.textContent = `Data: ${entry.dateLabel || entry.dateISO || entry.date} — Totale: €${(entry.totale||Object.values(entry.totali||{}).reduce((a,b)=>a+b,0)).toFixed(2)}`;
      box.appendChild(titolo);

      const inner = document.createElement('div');
      inner.style.marginTop = "6px";
      for(const k in (entry.totali||{})){
        const r = document.createElement('div');
        r.textContent = `${k.toUpperCase()}: €${entry.totali[k].toFixed(2)}`;
        inner.appendChild(r);
      }
      box.appendChild(inner);

      const actionsBox = document.createElement('div');
      actionsBox.style.display = "flex";
      actionsBox.style.gap = "8px";
      actionsBox.style.marginTop = "8px";

      const exp = document.createElement('button');
      exp.textContent = "Esporta";
      exp.onclick = ()=> {
        showConfirm('Confermi l\'esportazione di questo storico?', ()=>{
          exportSingleHistoric(entry);
        }, 'Esporta Storico');
      };

      const del = document.createElement('button');
      del.textContent = "Elimina";
      del.onclick = ()=> {
        showConfirm('Confermi l\'eliminazione di questo storico?', ()=>{
          console.log('Tentativo eliminazione storico con ID:', entry.id);
          console.log('Storico attuale:', storico.length, 'elementi');
          
          const idx = storico.findIndex(s=>s.id === entry.id);
          console.log('Indice trovato:', idx);
          
          if(idx !== -1) {
            console.log('Eliminazione elemento in posizione:', idx);
            storico.splice(idx, 1);
            console.log('Storico dopo eliminazione:', storico.length, 'elementi');
            
            saveData();
            
            // Forza il refresh della vista
            setTimeout(() => {
              openStorico();
            }, 100);
          } else {
            console.error('Elemento non trovato nello storico!');
            alert('Errore: elemento non trovato nello storico');
          }
        }, 'Elimina Storico');
      };

      actionsBox.appendChild(exp);
      actionsBox.appendChild(del);
      box.appendChild(actionsBox);

      orderList.appendChild(box);
    });
  }

  actionsDiv.innerHTML = "";
  const closeBtn = document.createElement('button');
  closeBtn.textContent = "Chiudi";
  closeBtn.onclick = closePopup;
  actionsDiv.appendChild(closeBtn);

  popupTitle.textContent = "Storico";
  showPopup();
}

function exportSingleHistoric(entry){
  const rows = [["Categoria","Totale (€)"]];
  for(const k in (entry.totali||{})){
    rows.push([k.toUpperCase(), (entry.totali[k]).toFixed(2).replace('.', ',')]);
  }
  rows.push(["TOTALE", ((entry.totale!==undefined)?entry.totale:Object.values(entry.totali||{}).reduce((a,b)=>a+b,0)).toFixed(2).replace('.', ',')]);
  const csv = rows.map(r=>r.join(";")).join("\n");
  const dateLabel = entry.dateLabel || entry.dateISO || new Date().toLocaleString();
  downloadCSV(csv, 'storico');
}

/* helper detect category */
function detectCategory(name){
  const s = (name||"").toLowerCase();
  if(s.includes("caff")) return "caffe";
  if(s.includes("pyraser")||s.includes("aria")||s.includes("guinness")||s.includes("spritz")) return "spina";
  // Controlla prima i cocktails con "lemon" (GIN LEMON, VODKA LEMON) prima di controllare LEMON SODA
  if(s.includes("gin lemon")||s.includes("vodka lemon")||s.includes("amaro")||s.includes("grappa")||s.includes("cocktail")||s.includes("baileys")||s.includes("jack")||s.includes("talisker")||s.includes("liquirizia")||s.includes("prugna cm")||s.includes("vodka tonic")||s.includes("jagerbomb")) return "super";
  if(s.includes("acqua")||s.includes("coca")||s.includes("tè")||s.includes("fanta")||s.includes("lemon")||s.includes("red bull")) return "frigo";
  if(s.includes("toast")||s.includes("pizzetta")||s.includes("hot dog")) return "snack";
  if(s.includes("tempo")) return "tempo";
  if(s.includes("quota")||s.includes("quote")) return "quote";
  if(s.includes("cassa")||s.includes("entrata")||s.includes("uscita")) return "cassa";
  return null;
}

/* delegazione click categorie */
categoriesDiv.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const key = btn.dataset.cat;
  if(!key) return;
  vibrate(VIBRATION_PATTERNS.tap);
  showSubcatsByKey(key);
});

/* click esterno per chiudere popup */
popup.addEventListener('click', e=>{ if(e.target === popup) closePopup(); });

/* init */
if(firebaseEnabled){
  setupFirebaseSync();
} else {
  loadData();
  renderTables();
  renderSavedButtons();
}

// helper: prova a inviare il CSV a App Inventor (WebViewer)
function sendCsvToAppInventor(csv) {
  try {
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      // prefisso unico per riconoscerlo nell'app
      AppInventor.setWebViewString("EXPORT_CSV::" + csv);
      return true;
    }
  } catch (e) {
    console.error("sendCsvToAppInventor error", e);
  }
  return false;
}

// genera ed esporta il CSV (fallback download + invio a AppInventor)
function exportTotalsToCSV() {
  try {
    // 1️⃣ Genera CSV con ordine categorie: caffe, spina, frigo, super, snack, tempo, quote, cassa
    let csv = "Categoria;Totale (€)\n";
    const categoriesOrder = ['caffe', 'spina', 'frigo', 'super', 'snack', 'tempo', 'quote', 'cassa'];
    categoriesOrder.forEach(k => {
      if(totals[k] !== undefined) {
        csv += `${k.toUpperCase()};${totals[k].toFixed(2).replace('.', ',')}\n`;
      }
    });
    const totaleCompl = Object.values(totals).reduce((a,b)=>a+b,0).toFixed(2).replace('.', ',');
    csv += `TOTALE COMPLESSIVO;${totaleCompl}\n`;

    // 2️⃣ Prova invio a Kodular / AppInventor
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      AppInventor.setWebViewString("SAVE_CSV::" + csv);
      setTimeout(() => {
        AppInventor.setWebViewString("SAVE_CSV_DONE");
      }, 100);
      return;
    }

    // 3️⃣ Scarica il file CSV
    downloadCSV(csv, 'totali');

  } catch(e) {
    console.error("Errore exportTotalsToCSV:", e);
  }
}


/* Funzione per scaricare CSV in locale */
function downloadCSV(csvContent, tipo) {
  try {
    const timestamp = new Date().toISOString().replace(/[:.]/g,'-');
    const filename = `${tipo}_${timestamp}.csv`;
    
    // Crea il blob CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // Scarica il file
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('✅ File CSV scaricato:', filename);
  } catch(e) {
    console.error('❌ Errore download CSV:', e);
    alert('Errore nel download del file.');
  }
}

/* Nascondi barra indirizzi e disabilita zoom */
window.addEventListener('load', () => {
  // Nascondi barra indirizzi con scroll
  setTimeout(() => {
    window.scrollTo(0, 1);
  }, 0);
  
  // Previeni zoom con gesture
  document.addEventListener('gesturestart', (e) => e.preventDefault());
  document.addEventListener('gesturechange', (e) => e.preventDefault());
  document.addEventListener('gestureend', (e) => e.preventDefault());
  
  // Previeni zoom con doppio tap
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
});

/* Register Service Worker */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => {
        console.log('✅ Service Worker registrato');
        
        // Controlla aggiornamenti ogni 60 secondi
        setInterval(() => {
          reg.update();
        }, 60000);
        
        // Notifica quando c'è un nuovo service worker in attesa
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('🔄 Nuovo aggiornamento disponibile!');
              // Opzionale: mostra notifica all'utente
              if(confirm('Nuova versione disponibile! Ricaricare?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(err => console.log('❌ Service Worker errore:', err));
  });
}

/* Gestione stato Online/Offline */
const offlineIndicator = document.getElementById('offline-indicator');

function updateOnlineStatus() {
  if (navigator.onLine) {
    offlineIndicator.style.display = 'none';
    console.log('🌐 Online');
    vibrate([20, 50, 20]); // Doppio tap per conferma online
  } else {
    offlineIndicator.style.display = 'block';
    console.log('📡 Offline - Modalità cache attiva');
    vibrate([100, 100, 100]); // Tripla vibrazione per avviso offline
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Controlla stato iniziale
updateOnlineStatus();

/* Previeni perdita dati non salvati */
window.addEventListener('beforeunload', (e) => {
  // Salva sempre prima di chiudere
  saveData();
});

/* Performance monitoring */
if ('performance' in window) {
  window.addEventListener('load', () => {
    setTimeout(() => {
      const perfData = performance.getEntriesByType('navigation')[0];
      if (perfData) {
        console.log('📊 Performance:', {
          'Caricamento DOM': Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart) + 'ms',
          'Caricamento completo': Math.round(perfData.loadEventEnd - perfData.loadEventStart) + 'ms',
          'Tempo totale': Math.round(perfData.loadEventEnd - perfData.fetchStart) + 'ms'
        });
      }
    }, 0);
  });
}
</script>
</body>
</html>
